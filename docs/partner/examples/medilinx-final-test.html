<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìµœì¢… í†µí•© í…ŒìŠ¤íŠ¸ - MediLinx íŒŒíŠ¸ë„ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #fff;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.8);
            color: white;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }
        
        .status.info {
            background: rgba(23, 162, 184, 0.8);
            color: white;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .highlight {
            background: rgba(255, 255, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ MediLinx Ã— Welno RAG ìµœì¢… í†µí•© í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h2>
            <p>ì‹¤ì œ íŒŒíŠ¸ë„ˆì‚¬(MediLinx) í™˜ê²½ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ ìœ„ì ¯ í†µí•©ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <ul>
                <li>âœ… MediLinx API Key ì‚¬ìš©</li>
                <li>âœ… ì‹¤ì œ ê²€ì§„ ë°ì´í„° í¬í•¨</li>
                <li>âœ… íŒŒíŠ¸ë„ˆ ë§¤ë‰´ì–¼ ê°€ì´ë“œ ì¤€ìˆ˜</li>
                <li>âœ… ì‹¤ì‹œê°„ ì±„íŒ… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h2>ğŸ¯ í…ŒìŠ¤íŠ¸ ì œì–´</h2>
            <button onclick="runFullTest()">ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button onclick="testApiConnection()">API ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button onclick="initializeWidget()">ìœ„ì ¯ ì´ˆê¸°í™”</button>
            <button onclick="openWidget()">ìœ„ì ¯ ì—´ê¸°</button>
            <button onclick="sendTestMessage()">í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡</button>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            
            <div id="status" class="status info">
                í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ. "ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
            <div id="results">
                <div class="status info">í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
            <div id="log" class="log">
                <div class="log-entry">[INFO] í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - MediLinx íŒŒíŠ¸ë„ˆ í…ŒìŠ¤íŠ¸ í™˜ê²½</div>
            </div>
        </div>
    </div>

    <!-- Welno RAG Chat Widget ë¡œë“œ -->
    <script src="WelnoRagChatWidget.js"></script>
    
    <script>
        // MediLinx íŒŒíŠ¸ë„ˆ ì„¤ì • (ì‹¤ì œ API Key ì‚¬ìš©)
        const MEDILINX_CONFIG = {
            apiKey: '5a9bb40b5108ecd8ef864658d5a2d5ab',
            baseUrl: 'http://localhost:8082',
            uuid: 'medilinx_final_test_' + Date.now(),
            hospitalId: 'medilinx_clinic',
            
            // MediLinx ê²€ì§„ ë°ì´í„° (ì‹¤ì œ í˜•ì‹)
            partnerData: {
                patient: {
                    name: 'ê¹€ìµœì¢…í…ŒìŠ¤íŠ¸',
                    birth_date: '1985-03-15',
                    sex: 'M',
                    phone: '010-1234-5678'
                },
                checkup_results: {
                    height: 172,
                    weight: 75,
                    bmi: 25.3,
                    systolic_bp: 135,
                    diastolic_bp: 85,
                    fasting_glucose: 105,
                    total_cholesterol: 220,
                    exam_date: '2024-01-20'
                },
                medical_history: [
                    '2023ë…„ ê³ í˜ˆì•• ì§„ë‹¨',
                    '2022ë…„ ë‹¹ë‡¨ ì „ë‹¨ê³„ ì§„ë‹¨'
                ]
            }
        };

        let widget = null;
        let testResults = {
            apiConnection: false,
            widgetInit: false,
            widgetOpen: false,
            messageTest: false
        };

        // ë¡œê·¸ í•¨ìˆ˜
        function addLog(message, type = 'INFO') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `[${type}] ${new Date().toLocaleTimeString()} - ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateResults() {
            const results = document.getElementById('results');
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            
            let html = `<div class="status ${passed === total ? 'success' : 'info'}">`;
            html += `í…ŒìŠ¤íŠ¸ ì§„í–‰ë¥ : ${passed}/${total} (${Math.round(passed/total*100)}%)</div>`;
            
            html += '<ul>';
            html += `<li>API ì—°ê²°: ${testResults.apiConnection ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</li>`;
            html += `<li>ìœ„ì ¯ ì´ˆê¸°í™”: ${testResults.widgetInit ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</li>`;
            html += `<li>ìœ„ì ¯ ì—´ê¸°: ${testResults.widgetOpen ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</li>`;
            html += `<li>ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸: ${testResults.messageTest ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</li>`;
            html += '</ul>';
            
            results.innerHTML = html;
        }

        // API ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testApiConnection() {
            addLog('API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'INFO');
            updateStatus('API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
            
            try {
                const response = await fetch(`${MEDILINX_CONFIG.baseUrl}/api/v1/rag-chat/partner/status`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${MEDILINX_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testResults.apiConnection = true;
                    addLog(`API ì—°ê²° ì„±ê³µ: ${data.partner_info.partner_name}`, 'SUCCESS');
                    updateStatus(`API ì—°ê²° ì„±ê³µ! íŒŒíŠ¸ë„ˆ: ${data.partner_info.partner_name}`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
            } catch (error) {
                testResults.apiConnection = false;
                addLog(`API ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'ERROR');
                updateStatus(`API ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
            
            updateResults();
        }

        // ìœ„ì ¯ ì´ˆê¸°í™”
        function initializeWidget() {
            addLog('ìœ„ì ¯ ì´ˆê¸°í™” ì‹œì‘...', 'INFO');
            updateStatus('ìœ„ì ¯ ì´ˆê¸°í™” ì¤‘...', 'info');
            
            try {
                if (widget) {
                    widget.destroy();
                }
                
                widget = new WelnoRagChatWidget({
                    ...MEDILINX_CONFIG,
                    
                    // UI ì„¤ì •
                    position: 'bottom-right',
                    buttonColor: '#667eea',
                    
                    // ì½œë°± ì„¤ì •
                    onOpen: function() {
                        testResults.widgetOpen = true;
                        addLog('ìœ„ì ¯ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'SUCCESS');
                        updateResults();
                    },
                    
                    onClose: function() {
                        addLog('ìœ„ì ¯ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.', 'INFO');
                    },
                    
                    onMessage: function(message) {
                        addLog(`ë©”ì‹œì§€ ${message.role}: ${message.content.substring(0, 50)}...`, 'INFO');
                        if (message.role === 'assistant') {
                            testResults.messageTest = true;
                            updateResults();
                        }
                    },
                    
                    onError: function(error) {
                        addLog(`ìœ„ì ¯ ì˜¤ë¥˜: ${error.message}`, 'ERROR');
                        updateStatus(`ìœ„ì ¯ ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                });
                
                widget.init();
                testResults.widgetInit = true;
                
                addLog('ìœ„ì ¯ ì´ˆê¸°í™” ì™„ë£Œ', 'SUCCESS');
                updateStatus('ìœ„ì ¯ ì´ˆê¸°í™” ì„±ê³µ! ìš°ì¸¡ í•˜ë‹¨ì— ì±„íŒ… ë²„íŠ¼ì´ í‘œì‹œë©ë‹ˆë‹¤.', 'success');
                
            } catch (error) {
                testResults.widgetInit = false;
                addLog(`ìœ„ì ¯ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'ERROR');
                updateStatus(`ìœ„ì ¯ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
            
            updateResults();
        }

        // ìœ„ì ¯ ì—´ê¸°
        function openWidget() {
            if (!widget) {
                updateStatus('ë¨¼ì € ìœ„ì ¯ì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            addLog('ìœ„ì ¯ ì—´ê¸° ì‹œë„...', 'INFO');
            widget.open();
        }

        // í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
        async function sendTestMessage() {
            if (!widget || !widget.state.isOpen) {
                updateStatus('ë¨¼ì € ìœ„ì ¯ì„ ì—´ì–´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            addLog('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì¤‘...', 'INFO');
            updateStatus('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì¤‘...', 'info');
            
            // ìœ„ì ¯ì˜ ì…ë ¥ì°½ì— ë©”ì‹œì§€ ì…ë ¥
            const testMessage = 'BMI 25.3ì´ê³  í˜ˆì••ì´ 135/85ì¸ë° ê±´ê°• ìƒíƒœê°€ ì–´ë–¤ê°€ìš”?';
            
            if (widget.elements.input) {
                widget.elements.input.value = testMessage;
                await widget.sendMessage();
                addLog('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ', 'SUCCESS');
            } else {
                addLog('ìœ„ì ¯ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'ERROR');
            }
        }

        // ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runFullTest() {
            addLog('=== ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'INFO');
            updateStatus('ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...', 'info');
            
            // 1. API ì—°ê²° í…ŒìŠ¤íŠ¸
            await testApiConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. ìœ„ì ¯ ì´ˆê¸°í™”
            if (testResults.apiConnection) {
                initializeWidget();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 3. ìœ„ì ¯ ì—´ê¸°
                if (testResults.widgetInit) {
                    openWidget();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // 4. ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•˜ë„ë¡ ì•ˆë‚´
                    if (testResults.widgetOpen) {
                        addLog('ìœ„ì ¯ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.', 'INFO');
                        updateStatus('í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ìœ„ì ¯ì—ì„œ ì§ì ‘ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.', 'success');
                    }
                }
            }
            
            addLog('=== ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'INFO');
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLog() {
            const log = document.getElementById('log');
            log.innerHTML = '<div class="log-entry">[INFO] ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            addLog('MediLinx íŒŒíŠ¸ë„ˆ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ', 'INFO');
            addLog(`API Key: ${MEDILINX_CONFIG.apiKey.substring(0, 20)}...`, 'INFO');
            addLog(`Base URL: ${MEDILINX_CONFIG.baseUrl}`, 'INFO');
            updateResults();
        });
    </script>
</body>
</html>