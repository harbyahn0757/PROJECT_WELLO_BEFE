# Welno 측 답변: 파트너 문의·확인 사항

**작성일**: 2026-02-07  
**대상**: 위젯 미노출 원인 확인 및 화이트리스트·개발 환경 문의에 대한 답변

---

## 1. “로드 완료”인데 `WelnoRagChatWidget` 이 undefined 인 현상에 대해

### Welno 측 결론: **도메인 때문에 생성자를 숨기는 동작은 없습니다.**

- 위젯 스크립트(`welno-rag-chat-widget.min.js`) 내부에는 **도메인/화이트리스트에 따라 `window.WelnoRagChatWidget` 을 노출하지 않도록 하는 로직이 없습니다.**
- 스크립트 실행 시 **UMD 패턴으로 항상** `window.WelnoRagChatWidget = WelnoRagChatWidget` 를 수행한 뒤, 그 다음에 `[WelnoRagChatWidget] 로드 완료` 로그를 찍습니다.
- 따라서 **“로드 완료”가 찍혔다면, 같은 실행 컨텍스트(같은 window)에서는 이미 `window.WelnoRagChatWidget` 이 설정된 상태가 정상**입니다.

가능한 원인 후보는 다음과 같습니다.

- **스크립트가 iframe 안에서 로드된 경우**  
  → `WelnoRagChatWidget` 은 **그 iframe의 window**에만 붙습니다. 부모 페이지에서 `window.WelnoRagChatWidget` 을 보면 undefined일 수 있습니다.
- **프록시 응답이 스크립트를 한 번 더 감싼 경우**  
  → 우리가 제공하는 원본은 “로드 완료” 직전에 전역에 생성자를 넣는 형태입니다. 프록시에서 스크립트를 래핑해 실행 컨텍스트가 달라지면(예: 별도 스코프/클로저) 전역에 노출되지 않을 수 있습니다.
- **캐시/빌드 이슈**  
  → 예전 빌드나 다른 버전이 로드되면, “로드 완료”만 있고 생성자 노출 로직이 없을 수 있습니다.

**추가로 확인해 주실 것:**

- “로드 완료”가 찍힌 **같은 페이지**의 **같은 window**에서, 로그 직후에 `window.WelnoRagChatWidget` 을 찍어보면 어떤지.
- 스크립트를 **iframe 없이** `https://welno.kindhabit.com/welno-api/static/welno-rag-chat-widget.min.js` 로 직접 로드했을 때는 정상 노출되는지.
- **도메인이 있는 운영/스테이징**에서도 동일 현상인지 (로컬만인지 여부).

---

## 2. 도메인 화이트리스트

### 2.1 생성자 노출과 화이트리스트

- **화이트리스트는 “스크립트가 전역에 생성자를 노출할지 여부”와 무관합니다.**
- 화이트리스트는 **API 호출 시**에만 사용됩니다(아래 3. 참고).

### 2.2 localhost / 실제 도메인 추가

- **개발·스테이징용**으로 다음 추가가 가능합니다.
  - `localhost` (필요 시 포트 포함, 예: `localhost:9000`)
  - 파트너 **실제 운영/스테이징 도메인** (예: `*.medilinx.com`, `staging.medilinx.com` 등)
- **절차·기준**
  - Welno 운영/담당자에게 **파트너 식별자(예: MediLinx) + 추가 희망 도메인 목록** 전달.
  - DB의 파트너 설정(`tb_partner_config`)에서 해당 파트너의 `config.iframe.domains` 에 도메인을 추가합니다.
  - `domains` 가 **빈 배열 `[]`** 이면 도메인 검사를 하지 않아, **어떤 오리진에서든 API 호출은 허용**됩니다(테스트 시 이렇게 둘 수도 있음).

---

## 3. Referer / 오리진 판단 기준

- **검사 대상:** API 요청 시 HTTP 헤더의 **`Referer`** (또는 `Referer` 가 없을 수 있음).
- **의미:** “지금 이 API를 호출한 **웹 페이지의 주소**”로 봅니다.  
  즉, **스크립트를 어디서 받아왔는지(프록시 URL)가 아니라, 그 스크립트가 돌고 있는 페이지의 오리진**입니다.
- **동작 요약**
  - 위젯이 `fetch(https://welno.kindhabit.com/welno-api/v1/rag-chat/partner/...)` 를 호출할 때, 브라우저가 붙이는 `Referer` 는 **현재 페이지 URL** (예: `http://localhost:9000/...` 또는 `https://www.medilinx.com/...`) 입니다.
  - Welno 백엔드는 이 `Referer` 를 파싱해 **host (netloc)** 만 추출한 뒤, 해당 파트너의 `allowed_domains` 와 비교합니다.
- **프록시 사용 시**
  - 스크립트를 `/api/welno/script.js` 처럼 **같은 오리진 프록시**로 받아와도, **API 호출은 브라우저가 Welno 도메인으로 직접** 보내므로, `Referer` 에는 **페이지 오리진**(예: `http://localhost:9000` 또는 실제 도메인)이 들어갑니다.
  - 따라서 **“페이지 오리진 기준으로 화이트리스트 검사”**가 맞고, 프록시 사용 여부와는 무관하게 동작합니다.

---

## 4. 에러/비허용 시 동작

### 4.1 “로드 완료”만 찍고 생성자를 안 넣는지

- **의도된 동작이 아닙니다.**  
  Welno 제공 스크립트는 **도메인과 관계없이**, 실행되면 항상 `window.WelnoRagChatWidget` 을 설정하고 “로드 완료”를 로그합니다.  
  “비허용 도메인이면 생성자만 숨긴다”는 로직은 없습니다.

### 4.2 비허용 도메인일 때 노출하는 메시지

- **API 호출**이 화이트리스트에 걸리면, **403** 과 함께 `detail` 로  
  `"허용되지 않은 도메인에서의 요청입니다: {domain}"` 이 내려갑니다.
- **스크립트 단**에서는 현재 “비허용 도메인” 전용 콘솔 메시지는 없습니다.  
  필요하다면, 추후 스크립트에 **“이 도메인은 Welno 파트너 화이트리스트에 등록되지 않았습니다”** 같은 한 줄 안내를 넣는 방안을 검토할 수 있습니다. (현재는 미구현)

---

## 5. MediLinx·테스트 도메인

- **현재 등록된 허용 도메인**  
  - 파트너별로 **DB `welno.tb_partner_config`** 의 `config.iframe.domains` 에 저장됩니다.  
  - MediLinx에 대해 “현재 어떤 도메인이 들어가 있는지”는 Welno 운영에서 DB 조회로 확인 가능합니다.
- **테스트용 도메인 추가**
  - **가능합니다.**  
    예: `localhost`, `localhost:9000`, `127.0.0.1`, `*.medilinx.com`, `staging.medilinx.com` 등.
  - **요청 방법:**  
    Welno 담당자에게 **파트너명(MediLinx) + 추가할 도메인 목록**을 전달해 주시면, 해당 파트너의 `iframe.domains` 에 반영합니다.  
    테스트만 할 때는 `domains` 를 비워 두어 “도메인 검사 생략”도 가능합니다.

---

## 6. 파트너 측에서 정리하면 좋은 것 (3. 확인 후 정리할 것)

- **화이트리스트 등록 절차**  
  - 운영/스테이징 도메인 및 필요 시 localhost는 Welno에 “파트너명 + 도메인 목록”으로 요청하면 됨.  
  - “도메인 미등록 시 증상”은 **API 403** 이며, **스크립트에서 생성자가 undefined 가 되는 현상과는 별개**임을 가이드에 명시하면 좋음.
- **위젯 초기화 실패 시 메시지**  
  - “비허용 도메인” 때문에 생성자가 안 보이는 것은 Welno 설계가 아님.  
  - 파트너 측 “Current origin may not be in Welno domain whitelist” 메시지는 **API/도메인 이슈용**으로 두고, **생성자 undefined** 원인(iframe, 프록시 래핑, 캐시 등)은 위 1번처럼 따로 점검하는 것이 좋음.
- **프록시 사용**  
  - 스크립트를 같은 오리진 프록시로 제공해도, **API는 페이지 오리진이 Referer로 전달**되므로 화이트리스트 정책과 충돌하지 않음.  
  - 권장: 가능하면 스크립트는 `https://welno.kindhabit.com/welno-api/static/welno-rag-chat-widget.min.js` 직접 로드(캐시·버전 관리 유리). 프록시 사용 시에는 **원본과 동일한 형태(래핑 없이)** 로 전달하는 것을 권장.
- **가이드 문서**  
  - “도메인 미등록 시”: **API 403** 과 메시지 설명, “Welno에 도메인 등록 요청” 절차 추가.  
  - “로드 완료인데 constructor undefined”: **도메인과 무관**이며, iframe/프록시/캐시 등 **실행 환경 점검** 항목으로 정리하는 것을 제안.

---

## 7. 요약 표

| 문의 항목 | Welno 답변 요약 |
|-----------|-----------------|
| 도메인 때문에 생성자 숨김? | **아니요.** 스크립트에는 그런 로직 없음. |
| Referer/오리진 기준 | **API 요청의 Referer = 페이지 URL.** 스크립트 출처(프록시) 아님. |
| 프록시 사용 시 | 페이지 오리진으로 검사되므로 정책상 문제 없음. 단, 스크립트는 래핑 없이 전달 권장. |
| localhost/도메인 추가 | 가능. 파트너명 + 도메인 목록 전달 시 `iframe.domains` 반영. 빈 배열이면 검사 생략. |
| 비허용 시 “로드 완료만” | 의도된 동작 아님. 원인은 iframe/프록시/캐시 등 환경 쪽 점검 필요. |
| 콘솔 안내 메시지 | 현재 스크립트에는 없음. 필요 시 추후 추가 검토 가능. |

이 문서는 위 문의에 대한 Welno 측 공식 답변 초안으로, 필요 시 내부 검토 후 파트너에 전달하시면 됩니다.
