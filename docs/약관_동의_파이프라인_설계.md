# ì•½ê´€ ë™ì˜ íŒŒì´í”„ë¼ì¸ ì„¤ê³„ ë° êµ¬í˜„

## ğŸ“‹ ê°œìš”

ì•½ê´€ ë™ì˜ ì •ë³´ë¥¼ **ë¡œì»¬(LocalStorage)**ê³¼ **ì„œë²„(PostgreSQL)**ì—ì„œ ê°ê° ê´€ë¦¬í•˜ë©°, ìœ íš¨ê¸°ê°„ê³¼ ë™ê¸°í™” ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ì…ë‹ˆë‹¤.

---

## ğŸ¯ í•µì‹¬ ì •ì±…

### 1. **ë¡œì»¬ ë™ì˜ (ì„œë²„ ë¯¸ë™ê¸°í™”)**
- **ìœ íš¨ê¸°ê°„**: 3ì¼
- **3ì¼ ë‚´ ì¬ë°©ë¬¸ ì‹œ**: 
  - í† ìŠ¤íŠ¸ ë©”ì‹œì§€: "YYYYë…„ MMì›” DDì¼ì— ë™ì˜í•˜ì‹  ì•½ê´€ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
  - ì•½ê´€ ëª¨ë‹¬ ìŠ¤í‚µ, ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
- **3ì¼ ì´ˆê³¼ ì‹œ**: 
  - ë¡œì»¬ ë°ì´í„° ì‚­ì œ
  - ì•½ê´€ ë™ì˜ ë‹¤ì‹œ ë°›ê¸°

### 2. **ì„œë²„ ë™ì˜ (ë™ê¸°í™” ì™„ë£Œ)**
- ë¡œì»¬ ì²´í¬ ë¶ˆí•„ìš”
- ì„œë²„ ë°ì´í„° ì‹ ë¢°
- ìœ íš¨ê¸°ê°„ ì œí•œ ì—†ìŒ
- íƒ€ì„ìŠ¤íƒ¬í”„ëŠ” ì„œë²„ ê¸°ì¤€

### 3. **ê° ì•½ê´€ë³„ ê°œë³„ ê´€ë¦¬**
- ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ (í•„ìˆ˜)
- ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ (í•„ìˆ˜)
- ë¯¼ê°ì •ë³´ ìˆ˜ì§‘ (í•„ìˆ˜)
- ë§ˆì¼€íŒ… í™œìš© (ì„ íƒ)
- **ê°ê° ë…ë¦½ì ì¸ íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ë™ê¸°í™” ìƒíƒœ ë³´ìœ **

---

## ğŸ“Š ë°ì´í„° êµ¬ì¡°

### **1. LocalStorage êµ¬ì¡°**

```typescript
interface IndividualTermAgreement {
  agreed: boolean;
  agreed_at: string | null;          // ISO 8601 timestamp
  expires_at: string | null;         // agreed_at + 3ì¼
  synced_to_server: boolean;         // ì„œë²„ ë™ê¸°í™” ì—¬ë¶€
  server_synced_at: string | null;   // ì„œë²„ ë™ê¸°í™” ì‹œì 
}

interface TermsAgreementLocal {
  uuid: string;
  partner_id: string;
  
  // ê° ì•½ê´€ë³„ ê°œë³„ ê´€ë¦¬
  terms_service: IndividualTermAgreement;
  terms_privacy: IndividualTermAgreement;
  terms_sensitive: IndividualTermAgreement;
  terms_marketing: IndividualTermAgreement;
  
  // ë©”íƒ€ë°ì´í„°
  last_updated: string;
  all_required_agreed: boolean;
}
```

**ì €ì¥ í‚¤**: `TERMS_AGREEMENT_{uuid}_{partner_id}`

**ì˜ˆì‹œ**:
```json
{
  "uuid": "abc-123-def",
  "partner_id": "kindhabit",
  "terms_service": {
    "agreed": true,
    "agreed_at": "2026-01-25T10:30:00.000Z",
    "expires_at": "2026-01-28T10:30:00.000Z",
    "synced_to_server": true,
    "server_synced_at": "2026-01-25T10:30:05.000Z"
  },
  "terms_privacy": {
    "agreed": true,
    "agreed_at": "2026-01-25T10:30:00.000Z",
    "expires_at": "2026-01-28T10:30:00.000Z",
    "synced_to_server": true,
    "server_synced_at": "2026-01-25T10:30:05.000Z"
  },
  "terms_sensitive": {
    "agreed": true,
    "agreed_at": "2026-01-25T10:30:00.000Z",
    "expires_at": "2026-01-28T10:30:00.000Z",
    "synced_to_server": false,
    "server_synced_at": null
  },
  "terms_marketing": {
    "agreed": false,
    "agreed_at": null,
    "expires_at": null,
    "synced_to_server": false,
    "server_synced_at": null
  },
  "last_updated": "2026-01-25T10:30:00.000Z",
  "all_required_agreed": true
}
```

---

### **2. PostgreSQL êµ¬ì¡°**

**í…Œì´ë¸”**: `welno.welno_patients`

**ì¶”ê°€ ì»¬ëŸ¼**:
```sql
-- JSONB í˜•ì‹ìœ¼ë¡œ ê° ì•½ê´€ë³„ ìƒì„¸ ì •ë³´ ì €ì¥
terms_agreement_detail JSONB

-- ëª¨ë“  í•„ìˆ˜ ì•½ê´€ ë™ì˜ ì™„ë£Œ ì‹œì 
terms_all_required_agreed_at TIMESTAMPTZ
```

**JSONB êµ¬ì¡°**:
```json
{
  "terms_service": {
    "agreed": true,
    "agreed_at": "2026-01-25T10:30:00Z",
    "version": "v1.0"
  },
  "terms_privacy": {
    "agreed": true,
    "agreed_at": "2026-01-25T10:30:00Z",
    "version": "v1.0"
  },
  "terms_sensitive": {
    "agreed": true,
    "agreed_at": "2026-01-25T10:30:00Z",
    "version": "v1.0"
  },
  "terms_marketing": {
    "agreed": false,
    "agreed_at": null,
    "version": "v1.0"
  }
}
```

---

## ğŸ”„ ì „ì²´ í”Œë¡œìš°

### **ì‹œë‚˜ë¦¬ì˜¤ 1: ìµœì´ˆ ë°©ë¬¸ (ë¡œì»¬/ì„œë²„ ë°ì´í„° ì—†ìŒ)**

```
1. ì‚¬ìš©ì ìº í˜ì¸ ì§„ì…
   â†“
2. checkAllTermsAgreement() í˜¸ì¶œ
   â†“
3. ì„œë²„ ì²´í¬ â†’ ì—†ìŒ
   â†“
4. ë¡œì»¬ ì²´í¬ â†’ ì—†ìŒ
   â†“
5. needsAgreement: true
   â†“
6. ì•½ê´€ ë™ì˜ ëª¨ë‹¬ í‘œì‹œ
   â†“
7. ì‚¬ìš©ì "ë™ì˜í•˜ê³  ì‹œì‘í•˜ê¸°" í´ë¦­
   â†“
8. saveTermsAgreement() í˜¸ì¶œ
   â†“
9. LocalStorage ì €ì¥ (synced_to_server: false, expires_at: +3ì¼)
   â†“
10. ì„œë²„ API í˜¸ì¶œ (/api/v1/campaigns/disease-prediction/register-patient/)
   â†“
11. DB ì €ì¥ (terms_agreement_detail JSONB)
   â†“
12. LocalStorage ì—…ë°ì´íŠ¸ (synced_to_server: true)
   â†“
13. ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
```

---

### **ì‹œë‚˜ë¦¬ì˜¤ 2: ì¬ë°©ë¬¸ (ë¡œì»¬ ë™ì˜ ìˆìŒ, 3ì¼ ì´ë‚´, ì„œë²„ ë¯¸ë™ê¸°í™”)**

```
1. ì‚¬ìš©ì ìº í˜ì¸ ì§„ì…
   â†“
2. checkAllTermsAgreement() í˜¸ì¶œ
   â†“
3. ì„œë²„ ì²´í¬ â†’ ì—†ìŒ
   â†“
4. ë¡œì»¬ ì²´í¬ â†’ ìˆìŒ
   â†“
5. ìœ íš¨ê¸°ê°„ ì²´í¬ â†’ 3ì¼ ì´ë‚´ (ìœ íš¨)
   â†“
6. synced_to_server ì²´í¬ â†’ false
   â†“
7. needsAgreement: false, showReminderToast: true
   â†“
8. í† ìŠ¤íŠ¸ í‘œì‹œ: "2026ë…„ 1ì›” 25ì¼ì— ë™ì˜í•˜ì‹  ì•½ê´€ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
   â†“
9. ì•½ê´€ ëª¨ë‹¬ ìŠ¤í‚µ
   â†“
10. ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
```

---

### **ì‹œë‚˜ë¦¬ì˜¤ 3: ì¬ë°©ë¬¸ (ì„œë²„ ë™ì˜ ìˆìŒ)**

```
1. ì‚¬ìš©ì ìº í˜ì¸ ì§„ì…
   â†“
2. checkAllTermsAgreement() í˜¸ì¶œ
   â†“
3. ì„œë²„ ì²´í¬ â†’ ìˆìŒ (terms_agreement_detail)
   â†“
4. í•„ìˆ˜ ì•½ê´€ ëª¨ë‘ ë™ì˜ í™•ì¸
   â†“
5. needsAgreement: false, showReminderToast: false
   â†“
6. í† ìŠ¤íŠ¸ í‘œì‹œ ì—†ìŒ (ì„œë²„ ë°ì´í„° ì‹ ë¢°)
   â†“
7. ì•½ê´€ ëª¨ë‹¬ ìŠ¤í‚µ
   â†“
8. ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
```

---

### **ì‹œë‚˜ë¦¬ì˜¤ 4: ì¬ë°©ë¬¸ (ë¡œì»¬ ë™ì˜ ë§Œë£Œ, 3ì¼ ì´ˆê³¼)**

```
1. ì‚¬ìš©ì ìº í˜ì¸ ì§„ì…
   â†“
2. checkAllTermsAgreement() í˜¸ì¶œ
   â†“
3. ì„œë²„ ì²´í¬ â†’ ì—†ìŒ
   â†“
4. ë¡œì»¬ ì²´í¬ â†’ ìˆìŒ
   â†“
5. ìœ íš¨ê¸°ê°„ ì²´í¬ â†’ 3ì¼ ì´ˆê³¼ (ë§Œë£Œ)
   â†“
6. isExpired: true
   â†“
7. LocalStorage ë°ì´í„° ì‚­ì œ
   â†“
8. needsAgreement: true
   â†“
9. ì•½ê´€ ë™ì˜ ëª¨ë‹¬ í‘œì‹œ (ì²˜ìŒë¶€í„° ë‹¤ì‹œ)
```

---

## ğŸ› ï¸ êµ¬í˜„ëœ íŒŒì¼

### **í”„ë¡ íŠ¸ì—”ë“œ**

1. **`src/utils/termsAgreement.ts`** (NEW)
   - `checkAllTermsAgreement()`: ì•½ê´€ ë™ì˜ ì²´í¬ (ë¡œì»¬ + ì„œë²„)
   - `saveTermsAgreement()`: ì•½ê´€ ë™ì˜ ì €ì¥ (ë¡œì»¬ + ì„œë²„)
   - `clearLocalTermsAgreement()`: ë¡œì»¬ ë°ì´í„° ì‚­ì œ

2. **`src/components/AuthForm.tsx`** (MODIFIED)
   - `onConfirm` í•¸ë“¤ëŸ¬ ê°œì„ 
   - `saveTermsAgreement()` ìœ í‹¸ ì‚¬ìš©
   - ê° ì•½ê´€ë³„ íƒ€ì„ìŠ¤íƒ¬í”„ ì „ë‹¬

3. **`src/campaigns/disease-prediction/index.tsx`** (MODIFIED)
   - ì§„ì… ì‹œ `checkAllTermsAgreement()` í˜¸ì¶œ
   - í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
   - ì•½ê´€ í•„ìš” ì‹œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸

### **ë°±ì—”ë“œ**

1. **`app/api/v1/endpoints/terms_agreement.py`** (NEW)
   - `GET /api/v1/terms/check`: ì•½ê´€ ë™ì˜ í™•ì¸
   - `GET /api/v1/terms/status/{uuid}`: ì•½ê´€ ìƒíƒœ ìƒì„¸ ì¡°íšŒ

2. **`app/services/wello_data_service.py`** (MODIFIED)
   - `save_terms_agreement_detail()`: ì•½ê´€ ìƒì„¸ ì •ë³´ ì €ì¥

3. **`app/api/v1/endpoints/campaign_payment.py`** (MODIFIED)
   - `register-patient` API: `terms_agreement_detail` ì²˜ë¦¬ ì¶”ê°€

4. **`app/api/v1/__init__.py`** (MODIFIED)
   - `terms_agreement` ë¼ìš°í„° ë“±ë¡

### **ë°ì´í„°ë² ì´ìŠ¤**

```sql
ALTER TABLE welno.welno_patients 
ADD COLUMN IF NOT EXISTS terms_agreement_detail JSONB,
ADD COLUMN IF NOT EXISTS terms_all_required_agreed_at TIMESTAMPTZ;
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### **1. ìµœì´ˆ ë°©ë¬¸ í…ŒìŠ¤íŠ¸**
1. ë¸Œë¼ìš°ì € ì‹œí¬ë¦¿ ëª¨ë“œ ì—´ê¸°
2. `http://localhost:9282/campaigns/disease-prediction?uuid=test001&partner=kindhabit` ì ‘ì†
3. ì•½ê´€ ë™ì˜ ëª¨ë‹¬ í‘œì‹œ í™•ì¸
4. ë™ì˜ â†’ LocalStorage ì €ì¥ í™•ì¸ (ê°œë°œì ë„êµ¬)
5. ì„œë²„ ì €ì¥ í™•ì¸ (DB ì¿¼ë¦¬)

### **2. ì¬ë°©ë¬¸ í…ŒìŠ¤íŠ¸ (3ì¼ ì´ë‚´)**
1. ê°™ì€ UUIDë¡œ ì¬ì ‘ì†
2. í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í™•ì¸
3. ì•½ê´€ ëª¨ë‹¬ ìŠ¤í‚µ í™•ì¸

### **3. ë§Œë£Œ í…ŒìŠ¤íŠ¸**
1. LocalStorage ë°ì´í„° ìˆ˜ë™ ìˆ˜ì • (expires_atì„ ê³¼ê±°ë¡œ)
2. ì¬ì ‘ì†
3. ì•½ê´€ ëª¨ë‹¬ ë‹¤ì‹œ í‘œì‹œ í™•ì¸

### **4. ì„œë²„ ë™ê¸°í™” í…ŒìŠ¤íŠ¸**
```bash
# DB í™•ì¸
cd /home/workspace/PROJECT_WELNO_BEFE/planning-platform/backend
python3 << 'EOF'
import sys, os
sys.path.insert(0, os.getcwd())
from app.core.database import db_manager
import asyncio

async def check():
    query = """
    SELECT uuid, name, terms_agreement_detail, terms_all_required_agreed_at
    FROM welno.welno_patients
    WHERE uuid = 'test001'
    """
    result = await db_manager.execute_one(query)
    if result:
        print("âœ… ì„œë²„ ë™ì˜ í™•ì¸:")
        print(f"  UUID: {result['uuid']}")
        print(f"  ì´ë¦„: {result['name']}")
        print(f"  ì•½ê´€ ìƒì„¸: {result['terms_agreement_detail']}")
        print(f"  ë™ì˜ ì‹œê°„: {result['terms_all_required_agreed_at']}")

asyncio.run(check())
EOF
```

---

## ğŸ” API ì—”ë“œí¬ì¸íŠ¸

### **GET /api/v1/terms/check**

**ìš”ì²­**:
```
GET /api/v1/terms/check?uuid=abc-123&partner_id=kindhabit
```

**ì‘ë‹µ**:
```json
{
  "agreed": true,
  "terms_detail": {
    "terms_service": {
      "agreed": true,
      "agreed_at": "2026-01-25T10:30:00Z"
    },
    "terms_privacy": {
      "agreed": true,
      "agreed_at": "2026-01-25T10:30:00Z"
    },
    "terms_sensitive": {
      "agreed": true,
      "agreed_at": "2026-01-25T10:30:00Z"
    },
    "terms_marketing": {
      "agreed": false,
      "agreed_at": null
    }
  },
  "terms_agreed_at": "2026-01-25T10:30:00Z",
  "message": "ì•½ê´€ ë™ì˜ ì •ë³´ ì¡°íšŒ ì™„ë£Œ"
}
```

### **POST /api/v1/campaigns/disease-prediction/register-patient/**

**ìš”ì²­**:
```json
{
  "uuid": "abc-123",
  "oid": "ORDER_123",
  "user_info": {
    "name": "í™ê¸¸ë™",
    "phone": "01012345678",
    "birth": "1990-01-01",
    "gender": "M"
  },
  "terms_agreement_detail": {
    "terms_service": {
      "agreed": true,
      "agreed_at": "2026-01-25T10:30:00Z"
    },
    "terms_privacy": {
      "agreed": true,
      "agreed_at": "2026-01-25T10:30:00Z"
    },
    "terms_sensitive": {
      "agreed": true,
      "agreed_at": "2026-01-25T10:30:00Z"
    },
    "terms_marketing": {
      "agreed": false,
      "agreed_at": null
    }
  },
  "api_key": "partner_api_key",
  "partner_id": "kindhabit"
}
```

---

## ğŸ“ˆ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì´í”„ë¼ì¸

```
[ì‚¬ìš©ì ë™ì˜ ë²„íŠ¼ í´ë¦­]
    â†“
[í”„ë¡ íŠ¸ì—”ë“œ: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±]
  now = new Date()
  expires_at = now + 3ì¼
    â†“
[LocalStorage ì €ì¥]
  {
    terms_service: {
      agreed: true,
      agreed_at: "2026-01-25T10:30:00.000Z",
      expires_at: "2026-01-28T10:30:00.000Z",
      synced_to_server: false,
      server_synced_at: null
    },
    ...
  }
    â†“
[ì„œë²„ API í˜¸ì¶œ]
  POST /api/v1/campaigns/disease-prediction/register-patient/
    â†“
[ë°±ì—”ë“œ: DB ì €ì¥]
  UPDATE welno.welno_patients 
  SET terms_agreement_detail = {...},
      terms_all_required_agreed_at = NOW()
    â†“
[í”„ë¡ íŠ¸ì—”ë“œ: LocalStorage ì—…ë°ì´íŠ¸]
  {
    terms_service: {
      ...
      synced_to_server: true,
      server_synced_at: "2026-01-25T10:30:05.000Z"
    },
    ...
  }
```

---

## âš™ï¸ ì£¼ìš” í•¨ìˆ˜

### **í”„ë¡ íŠ¸ì—”ë“œ**

#### `checkAllTermsAgreement(uuid, partnerId)`
- ì„œë²„ â†’ ë¡œì»¬ ìˆœì„œë¡œ ì²´í¬
- ê° ì•½ê´€ë³„ ìœ íš¨ì„± ê²€ì¦
- ë§Œë£Œëœ ì•½ê´€ ìë™ ì‚­ì œ
- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìƒì„±

#### `saveTermsAgreement(uuid, partnerId, termsAgreement, ...)`
- ë¡œì»¬ ì €ì¥ (ê° ì•½ê´€ë³„ íƒ€ì„ìŠ¤íƒ¬í”„)
- ì„œë²„ ì €ì¥ (ë¹„ë™ê¸°)
- ì„œë²„ ì„±ê³µ ì‹œ ë¡œì»¬ ë™ê¸°í™” í”Œë˜ê·¸ ì—…ë°ì´íŠ¸

### **ë°±ì—”ë“œ**

#### `GET /api/v1/terms/check`
- í™˜ì UUIDë¡œ ì•½ê´€ ë™ì˜ ì¡°íšŒ
- ê° ì•½ê´€ë³„ ìƒì„¸ ì •ë³´ ë°˜í™˜

#### `save_terms_agreement_detail(uuid, hospital_id, terms_agreement_detail)`
- JSONBë¡œ ì•½ê´€ ìƒì„¸ ì €ì¥
- í•„ìˆ˜ ì•½ê´€ ëª¨ë‘ ë™ì˜ ì‹œ `terms_all_required_agreed_at` ì—…ë°ì´íŠ¸

---

## ğŸ¯ í–¥í›„ ê°œì„  ì‚¬í•­

1. **ì•½ê´€ ë²„ì „ ê´€ë¦¬**
   - ì•½ê´€ ë‚´ìš© ë³€ê²½ ì‹œ ë²„ì „ ì¶”ì 
   - êµ¬ë²„ì „ ë™ì˜ìì—ê²Œ ì¬ë™ì˜ ìš”ì²­

2. **ë™ê¸°í™” ì¬ì‹œë„ ë¡œì§**
   - ì„œë²„ ì €ì¥ ì‹¤íŒ¨ ì‹œ ë°±ê·¸ë¼ìš´ë“œ ì¬ì‹œë„
   - Service Worker í™œìš©

3. **ë¶„ì„ ë° í†µê³„**
   - ì•½ê´€ë³„ ë™ì˜ìœ¨ ëŒ€ì‹œë³´ë“œ
   - ë§Œë£Œ í›„ ì¬ë™ì˜ìœ¨ ë¶„ì„

4. **ë§ˆì¼€íŒ… ì•½ê´€ ë³„ë„ UI**
   - í•„ìˆ˜ ì•½ê´€ê³¼ ì„ íƒ ì•½ê´€ ì‹œê°ì  ë¶„ë¦¬
   - ë§ˆì¼€íŒ… ì•½ê´€ ë‚˜ì¤‘ì— ë™ì˜ ì˜µì…˜

---

## ğŸ“ ì‘ì„±ì¼

2026-01-25

## ì‘ì„±ì

AI Assistant (Claude Sonnet 4.5)
