# 폐 관련 문제 원인 보고서

**생성일**: 2026-01-13  
**작업일자**: 2026-01-13  
**작업내용**: 폐 관련 잘못된 분석 원인 보고서

---

## 📋 문제 요약

**환자**: [이름 삭제됨] (UUID: [UUID 삭제됨])  
**병원**: PEERNINE  
**문제**: 실제로는 폐 관련 이상 소견이 없었는데, 시스템이 "2021년 폐 건강 이상 소견"이라고 잘못 분석함

---

## 🔍 실제 데이터 확인 결과

### 1. 건강검진 데이터 (실제)
```
2021년 09/28 검진:
- 폐결핵 흉부질환: Value = "정상" ✅
- 만성폐쇄성폐질환: Value = "" (빈 문자열)
  - ItemReferences:
    - "정상": "1) FEV1/FVC 70% 이상..."
    - "만성폐쇄성폐질환의심": "..."
    - "기타 폐기능 이상": "..."
```

**결론**: 폐 관련 이상 소견 없음 (모두 정상)

### 2. 문진 데이터
```
- 흡연: ex_smoker (과거 흡연자) ⚠️
- 가족력: ['diabetes', 'hypertension']
```

**실제 원인**: 과거 흡연자이기 때문에 폐 관련 우려가 있는 것 (이상 소견 아님)

### 3. 설계 결과 (잘못된 분석)
```
Analysis: "특히 2021년 폐 건강 이상 소견 이후 제대로 된 확인이 없었다는 점이 가장 큰 구멍입니다"
```

**문제**: 실제로는 이상 소견이 없었는데 잘못 언급됨

---

## 🐛 버그 원인

### 버그 위치
**파일**: `planning-platform/backend/app/services/checkup_design/step1_prompt.py`  
**라인**: 218-242

### 문제 코드
```python
for ref in item["ItemReferences"]:
    ref_name = ref.get("Name") or ""
    
    # 정상(A) 항목은 제외 (정상이므로 리스트에 추가하지 않음)
    if "정상(A)" in ref_name:  # ❌ 문제: "정상(A)"만 체크
        item_status = "normal"
        break
    # 이상 항목
    elif "질환의심" in ref_name or "이상" in ref_name:
        item_status = "abnormal"  # ❌ 여기서 잘못 판단됨
        break
```

### 실제 데이터의 ItemReferences
```json
[
  {"Name": "정상", "Value": "1) FEV1/FVC 70% 이상..."},  // ← "정상(A)"가 아님!
  {"Name": "만성폐쇄성폐질환의심", "Value": "..."},
  {"Name": "기타 폐기능 이상", "Value": "..."}
]
```

### 버그 발생 과정

1. **코드는 `"정상(A)"`만 체크**
   - 실제 데이터는 `"정상"` (A 없음)
   - `"정상"`을 찾지 못함

2. **다음 조건으로 넘어감**
   - `"만성폐쇄성폐질환의심"`에 `"질환의심"`이 포함되어 있음
   - `elif "질환의심" in ref_name` 조건에 걸림

3. **잘못된 판단**
   - `item_status = "abnormal"`로 설정됨
   - 프롬프트에 "이상 항목"으로 표시됨

4. **GPT가 잘못된 정보로 분석**
   - 프롬프트: "만성폐쇄성폐질환:   (이상)"
   - GPT 분석: "2021년 폐 건강 이상 소견"

---

## 📊 프롬프트 실제 출력 (버그 확인)

**파일**: `planning-platform/backend/logs/planning_20260112/20260112_225033_d0b25dd5/step1_prompt.txt`

```
### 1. 2021년년 09/28 - 이루탄메디케어의원
**이상 항목:**
- 만성폐쇄성폐질환:   (이상)  ❌ 잘못됨!
```

**실제로는 정상이어야 함**

---

## 🔧 수정 방안

### 수정 1: 정상 체크 로직 개선

**현재 코드** (라인 226):
```python
if "정상(A)" in ref_name:
```

**수정 후**:
```python
if "정상" in ref_name:  # "정상", "정상(A)", "정상(B)" 모두 포함
```

### 수정 2: 우선순위 로직 개선 (더 안전)

정상을 먼저 확인하도록 순서 변경:

```python
for ref in item["ItemReferences"]:
    ref_name = ref.get("Name") or ""
    
    # 정상 체크 (우선순위 1) - 먼저 확인
    if "정상" in ref_name:
        item_status = "normal"
        break
    # 이상 체크 (우선순위 2)
    elif "질환의심" in ref_name or "이상" in ref_name:
        item_status = "abnormal"
        break
    # 경계 체크 (우선순위 3)
    elif "경계" in ref_name:
        item_status = "warning"
        break
```

---

## 📋 영향 범위

### 영향 받는 파일
1. `planning-platform/backend/app/services/checkup_design/step1_prompt.py` (라인 218-242)
2. `planning-platform/backend/app/services/checkup_design/step2_priority1.py` (비슷한 로직 확인 필요)
3. `planning-platform/backend/app/services/checkup_design/prompt.py` (legacy 코드 확인 필요)

### 영향 받는 환자
- 폐기능검사에서 `"정상"` (A 없음) 기준을 사용하는 모든 환자
- 특히 만성폐쇄성폐질환 검사 항목

---

## ✅ 수정 후 검증 방법

1. **동일 환자로 재테스트**
   - 프롬프트에 "이상 항목"으로 표시되지 않아야 함
   - GPT 응답에 "2021년 폐 건강 이상 소견" 언급이 없어야 함
   - "과거 흡연 이력으로 인한 우려"로 올바르게 표현되어야 함

2. **다른 환자 데이터로 테스트**
   - "정상" 기준을 사용하는 다른 검사 항목도 확인

---

## 🎯 결론

**원인**: 코드가 `"정상(A)"`만 체크하는데, 실제 데이터는 `"정상"` (A 없음)을 사용하여 정상을 찾지 못하고, 다음 조건인 `"질환의심"`에 걸려 이상으로 잘못 판단됨

**해결**: `"정상(A)"` → `"정상"`으로 수정하여 "정상", "정상(A)", "정상(B)" 모두 인식하도록 변경

**우선순위**: **High (즉시 수정 필요)**

---

## ✅ 수정 완료

### 수정된 파일
1. ✅ `planning-platform/backend/app/services/checkup_design/step1_prompt.py` (라인 226)
2. ✅ `planning-platform/backend/app/services/checkup_design/step2_priority1.py` (라인 191)
3. ✅ `planning-platform/backend/app/services/checkup_design/prompt.py` (라인 2165)
4. ✅ `planning-platform/backend/app/services/checkup_design/persona.py` (라인 256)

### 수정 내용
- `"정상(A)"` → `"정상"`으로 변경
- `"정상(B)"` 체크 제거 (이미 `"정상"`에 포함됨)
- `"경계"` 체크는 유지 (정상과 구분)

### 수정 후 예상 결과
- 만성폐쇄성폐질환: Value = "", ItemReferences에 "정상" 있음
  - ✅ 정상으로 올바르게 처리됨
  - ✅ 프롬프트에 "이상 항목"으로 표시되지 않음
  - ✅ GPT가 "2021년 폐 건강 이상 소견"이라고 언급하지 않음
  - ✅ "과거 흡연 이력으로 인한 우려"로 올바르게 표현됨
