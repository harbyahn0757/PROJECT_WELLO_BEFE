# 폐 관련 버그 분석 및 수정 방안

**생성일**: 2026-01-13  
**작업일자**: 2026-01-13  
**작업내용**: 폐 관련 버그 분석 및 수정 방안 (Value/ItemReferences 처리)

---

## 🐛 버그 확인

### 문제 상황
- **실제 데이터**: 폐 관련 이상 소견 없음 (모두 정상)
- **프롬프트 출력**: "만성폐쇄성폐질환:   (이상)" ❌
- **GPT 분석 결과**: "2021년 폐 건강 이상 소견" ❌

### 버그 원인

**파일**: `planning-platform/backend/app/services/checkup_design/step1_prompt.py`
**라인**: 218-242

**문제 코드**:
```python
for ref in item["ItemReferences"]:
    ref_name = ref.get("Name") or ""
    
    # 정상(A) 항목은 제외 (정상이므로 리스트에 추가하지 않음)
    if "정상(A)" in ref_name:
        item_status = "normal"
        break
    # 이상 항목
    elif "질환의심" in ref_name or "이상" in ref_name:
        item_status = "abnormal"
        break
```

**실제 데이터의 ItemReferences**:
```json
[
  {"Name": "정상", "Value": "1) FEV1/FVC 70% 이상..."},
  {"Name": "만성폐쇄성폐질환의심", "Value": "..."},
  {"Name": "기타 폐기능 이상", "Value": "..."}
]
```

**버그 원인**:
1. 코드는 `"정상(A)"`만 체크함
2. 실제 데이터는 `"정상"` (A 없음)
3. `"정상"`을 찾지 못해서 다음 조건으로 넘어감
4. `"만성폐쇄성폐질환의심"`에 `"질환의심"`이 포함되어 있어서 `abnormal`로 판단됨
5. 결과: 정상인데 이상으로 잘못 분류됨

---

## 🔧 수정 방안

### 수정 1: 정상 체크 로직 개선 (즉시 적용)

```python
# 수정 전
if "정상(A)" in ref_name:
    item_status = "normal"
    break

# 수정 후
if "정상" in ref_name:  # "정상(A)", "정상(B)", "정상" 모두 포함
    item_status = "normal"
    break
```

### 수정 2: 우선순위 로직 개선 (더 안전)

```python
# ItemReferences를 순서대로 확인하되, 정상을 우선 확인
for ref in item["ItemReferences"]:
    ref_name = ref.get("Name") or ""
    
    # 정상 체크 (우선순위 1) - "정상", "정상(A)", "정상(B)" 모두 포함
    if "정상" in ref_name:
        item_status = "normal"
        break
    # 이상 체크 (우선순위 2)
    elif "질환의심" in ref_name or "이상" in ref_name:
        item_status = "abnormal"
        break
    # 경계 체크 (우선순위 3)
    elif "경계" in ref_name:
        item_status = "warning"
        break
```

### 수정 3: Value가 비어있을 때 처리 개선

```python
# Value가 비어있고 ItemReferences에 "정상" 기준이 있으면 명시적으로 표시
if item_value == "" or item_value is None:
    # ItemReferences에서 정상 기준 확인
    has_normal_ref = any("정상" in ref.get("Name", "") for ref in item.get("ItemReferences", []))
    if has_normal_ref:
        # 정상으로 처리하되, GPT에게 명확히 전달
        # (이미 위의 로직에서 처리되지만, 추가 안전장치)
        pass
```

---

## 📋 수정 적용 위치

1. **step1_prompt.py** (라인 218-242)
2. **step2_priority1.py** (비슷한 로직이 있을 수 있음)
3. **prompt.py** (legacy 코드에도 있을 수 있음)

---

## ✅ 수정 후 검증

1. 실제 데이터로 테스트
   - 만성폐쇄성폐질환: Value = "", ItemReferences에 "정상" 있음
   - → 정상으로 처리되어야 함
   - → 프롬프트에 "이상 항목"으로 표시되지 않아야 함

2. GPT 응답 확인
   - "2021년 폐 건강 이상 소견" 언급이 사라져야 함
   - "과거 흡연 이력으로 인한 우려"로 올바르게 표현되어야 함

---

## 🎯 우선순위

**High (즉시 수정)**: step1_prompt.py의 정상 체크 로직 수정
