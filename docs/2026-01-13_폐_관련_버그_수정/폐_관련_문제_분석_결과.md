# 폐 관련 문제 분석 결과

**생성일**: 2026-01-13  
**작업일자**: 2026-01-13  
**작업내용**: 폐 관련 문제 분석 결과 (건강검진 데이터·문진·설계 결과)

---

## 🔍 문제 확인

### 1. 실제 건강검진 데이터
- **2021년 폐결핵 흉부질환**: `Value = "정상"` ✅
- **2021년 만성폐쇄성폐질환**: `Value = ""` (빈 문자열) ✅
- **결론**: 폐 관련 이상 소견 없음 (모두 정상)

### 2. 문진 데이터
- **흡연**: `ex_smoker` (과거 흡연자) ⚠️
- 이것이 폐 관련 우려의 **실제 원인**

### 3. 설계 결과 (Analysis 필드)
- **잘못된 언급**: "2021년 폐 건강 이상 소견 이후 제대로 된 확인이 없었다는 점이 가장 큰 구멍입니다"
- **실제로는**: 폐 관련 이상 소견이 없었음
- **올바른 해석**: 과거 흡연자(ex_smoker)이기 때문에 폐 관련 우려가 있는 것

---

## 🐛 문제 원인 분석

### 가능한 원인 1: GPT/Gemini의 잘못된 해석
- 건강검진 데이터에서 "만성폐쇄성폐질환" 항목의 `Value = ""` (빈 문자열)을 받음
- "만성폐쇄성폐질환"이라는 이름과 빈 Value를 보고 "이상 소견"으로 잘못 해석
- 실제로는 `ItemReferences`에 "정상" 기준이 있어서 정상이어야 함

### 가능한 원인 2: 프롬프트의 데이터 전달 방식
- `step1_prompt.py`의 218-242 라인에서 건강검진 데이터 처리
- `ItemReferences`를 확인하여 상태 분류:
  - "정상(A)" → normal
  - "질환의심" 또는 "이상" → abnormal
  - "정상(B)" 또는 "경계" → warning
- **문제**: Value가 빈 문자열("")일 때, ItemReferences에 "정상" 기준이 있어도 GPT가 이를 이상으로 해석할 수 있음

### 가능한 원인 3: 프롬프트 지시사항 부족
- GPT에게 "Value가 비어있으면 ItemReferences를 확인하라"는 명확한 지시가 없을 수 있음
- "만성폐쇄성폐질환"이라는 질환명만 보고 자동으로 "이상 소견"으로 해석

---

## 🔧 해결 방안

### 1. 프롬프트 개선 (즉시 적용 가능)
```python
# step1_prompt.py의 건강검진 데이터 처리 부분 개선
# Value가 빈 문자열이거나 없을 때:
# - ItemReferences를 먼저 확인
# - "정상" 기준이 있으면 정상으로 표시
# - 명확한 지시사항 추가: "Value가 비어있어도 ItemReferences에 정상 기준이 있으면 정상으로 처리"
```

### 2. 데이터 전처리 개선
```python
# 건강검진 데이터를 GPT에 전달하기 전에 전처리
# Value가 비어있고 ItemReferences에 "정상" 기준이 있으면:
# - Value를 "정상"으로 명시적으로 설정
# - 또는 상태를 명확히 표시: "정상 (검사값 없음, 기준: 정상)"
```

### 3. GPT 응답 검증 로직 추가
```python
# GPT 응답에서 "이상 소견" 언급 시 검증
# - 실제 건강검진 데이터와 대조
# - 이상 소견이 없는데 언급되면 경고 또는 수정
```

### 4. 프롬프트에 명확한 지시사항 추가
```
**중요: 건강검진 데이터 해석 규칙**
1. Value가 비어있거나 없을 때:
   - ItemReferences를 먼저 확인
   - "정상(A)" 또는 "정상" 기준이 있으면 → 정상으로 처리
   - "질환의심" 또는 "이상" 기준만 있을 때만 → 이상으로 처리

2. 질환명만 보고 판단하지 말 것:
   - "만성폐쇄성폐질환"이라는 이름만으로 이상 소견으로 판단 금지
   - 반드시 Value와 ItemReferences를 확인

3. 과거 흡연자(ex_smoker)의 경우:
   - 건강검진 데이터에 이상 소견이 없으면 "과거 흡연 이력으로 인한 우려"로 표현
   - "이상 소견"이라는 표현 사용 금지
```

---

## 📋 확인 사항

1. ✅ 실제 건강검진 데이터: 폐 관련 이상 소견 없음
2. ✅ 문진 데이터: 과거 흡연자(ex_smoker) 확인
3. ❌ 설계 결과: "2021년 폐 건강 이상 소견" 잘못 언급
4. 🔍 원인: GPT가 빈 Value와 질환명을 보고 잘못 해석

---

## 🎯 수정 우선순위

1. **High**: 프롬프트에 명확한 지시사항 추가 (즉시)
2. **Medium**: 데이터 전처리 개선 (다음 배포)
3. **Low**: GPT 응답 검증 로직 추가 (향후)
