# Step 2-1 & 2-2 연결성 강화 및 세일즈 전략 (RAG 기반)

**생성일**: 미상  
**작업일자**: 미상  
**작업내용**: Step 2-1·2-2 연결성 강화 및 RAG 기반 세일즈 전략

---

## 1. 개요
*   **목표**: RAG(임상 근거)와 환자 데이터를 Step 2-1(임상 판단)에서 Step 2-2(세일즈 제안)로 **끊김 없이 연결**하여, **"의학적 근거에 기반한 강력한 업셀링(Gap Selling)"**을 구현한다.
*   **현상**: 2-1과 2-2가 단절되어 있어, 2-2 단계에서 임상 근거를 활용하지 못하고 AI가 내용을 지어내거나(Halucination) 평이한 제안에 그침.

---

## 2. 이상적인 데이터 흐름 (Pipeline)

### [Step 2-1] Priority 1 (필수/임상)
*   **역할**: "당신은 **환자**입니다." (임상적 위험 요인 분석 및 필수 검사 매핑)
*   **입력**: 환자 데이터(나이, 가족력, 기저질환)
*   **RAG 검색**: "고혈압 합병증", "당뇨 선별검사 기준" 등 **질환 중심 검색**
*   **출력 (Output)**: 
    *   `priority_1`: 필수 검진 항목 (예: 혈압, 혈당)
    *   `rag_evidence_context`: **검색된 임상 가이드라인 원문 (★ 핵심 재료)**

### [Bridge] 데이터 전달 (Key Point)
*   **전달 항목**: 
    1. `step1_result` (환자 페르소나)
    2. `step2_1_result` (필수 검사 목록)
    3. **`rag_evidence_context` (Step 2-1에서 찾은 임상 근거)** ← **기존 누락 포인트**
*   **목적**: Step 2-2가 "맨땅"에서 시작하는 게 아니라, 2-1이 찾아준 "근거" 위에서 시작하도록 함.

### [Step 2-2] Priority 2, 3 & Strategy (세일즈/Upselling)
*   **역할**: "당신은 **주치의/세일즈맨**입니다." (미충족 수요 발굴 및 정밀 검사 제안)
*   **입력**: Step 2-1 결과 + RAG Evidence
*   **RAG 검색 (추가)**: "경동맥 초음파 효용성", "폐암 CT 사각지대" 등 **검사 항목(Upselling) 중심 검색**
*   **출력 (Output)**:
    *   `priority_2, 3`: 정밀/선택 검사
    *   `strategies`: **Gap Selling 논리 (Anchor → Gap → Offer)**

---

## 3. 프롬프트 구성 및 논리 (Gap Selling)

Step 2-2 프롬프트는 2-1의 결과를 **'Anchor(미끼/기반)'**로 삼아 Upselling을 유도해야 합니다.

### 논리 구조 (Bridge Strategy)

| 단계 | 구성 요소 | 내용 예시 | 프롬프트 지시 (Instruction) |
| :--- | :--- | :--- | :--- |
| **1. Anchor** | **현재 상태 & 2-1 결과** | "현재 혈압이 경계 수치이며, 2-1 단계에서 혈압 측정을 권고받으셨습니다." | "Step 2-1에서 추천된 기본 검사와 환자의 현재 상태(위험 요인)를 언급하여 공감을 형성하세요." |
| **2. Gap** | **한계점 (공포/위험)** | "하지만 혈압 수치만으로는 혈관 안쪽이 좁아졌는지, 찌꺼기(플라크)가 껴있는지는 **절대 알 수 없습니다.**" | "**RAG Evidence**를 인용하여, 기본 검사만으로는 확인할 수 없는 **치명적인 사각지대**를 구체적으로 지적하세요." |
| **3. Offer** | **해결책 (Upselling)** | "경동맥 초음파를 통해 혈관 속을 눈으로 직접 확인해야 뇌졸중을 막을 수 있습니다." | "그 사각지대를 완벽하게 해결할 수 있는 **정밀 검사**를 제안하고, 그 검사만의 **차별화된 가치**를 설명하세요." |

---

## 4. 최종 결과물 예시 (JSON)

우리가 원하는 최종 응답 퀄리티는 다음과 같습니다. (시뮬레이션 검증 완료)

```json
{
  "strategies": [
    {
      "target": "경동맥 초음파",
      "step1_anchor": "안광수님은 고혈압 가족력이 있고 현재 혈압이 140/90으로 높습니다. Step 2-1에서 혈압 관리가 최우선이라고 말씀드렸습니다.",
      "step2_gap": "하지만 혈압계로는 혈관벽이 얼마나 딱딱해졌는지(동맥경화), 뇌로 가는 혈관이 좁아지진 않았는지 알 수 없습니다. 이는 뇌졸중의 '숨은 뇌관'입니다.",
      "step3_offer": "경동맥 초음파로 혈관 내부를 직접 들여다보세요. 혈관 나이를 눈으로 확인하고 뇌졸중을 선제적으로 차단할 수 있습니다.",
      "doctor_recommendation": {
        "reason": "고혈압 가족력과 흡연 이력은 혈관 손상을 가속화합니다.",
        "evidence": "2022년 고혈압 진료지침에 따르면 '고혈압 환자의 심혈관 위험 평가를 위해 경동맥 초음파가 권고된다'고 명시되어 있습니다.",
        "message": "혈압약만 믿지 마세요. 혈관 속을 봐야 안심할 수 있습니다."
      }
    }
  ]
}
```

---

## 5. 개선 포인트 (Action Items)

### [Backend]
1.  **파이프라인 연결**: `checkup_design.py`에서 Step 2-1의 `rag_evidence_context`를 Step 2-2로 전달하도록 수정.
2.  **RAG 쿼리 보강**: Step 2-2에서 Upselling 항목(CT, 초음파, 액체생검 등)에 대한 추가 RAG 검색 로직 구현.

### [Prompt]
1.  **Evidence 강제 주입**: Step 2-2 프롬프트에 `[Critical Evidence]` 섹션을 만들고, 전달받은 RAG 텍스트를 그대로 삽입.
2.  **Few-shot 예시 추가**: "Anchor/Gap/Offer"를 어떻게 써야 하는지 보여주는 **구체적인 작성 예시(Few-shot)** 3개 추가.

### [Frontend 대응]
1.  **근거 데이터 구조화**: API 응답에 `rag_evidences` 리스트를 포함시켜, 프론트에서 "신뢰도 뱃지"나 "근거 팝업"으로 활용 가능하게 함.

