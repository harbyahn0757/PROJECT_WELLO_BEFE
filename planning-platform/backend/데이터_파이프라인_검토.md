# 데이터 파이프라인 전체 검토 (RAG → 프론트엔드)

## 실행 시간: 2025-12-05 20:45

---

## 🔥 핵심 문제: 풍부한 RAG 데이터를 프론트엔드에 전달 안함

### 현재 상황

**RAG에서 가져오는 데이터:**
```python
response.source_nodes[0] = {
    "score": 0.499,
    "node": {
        "metadata": {
            "file_name": "2025 당뇨병 진료지침_요약문_수정본(25.11.28).pdf",
            "page_label": 42,
            "document_id": "3120d60bb4c336636af4e91939224aa8b3bf61c1ea64f4088a"
        },
        "text": "82\n\n# 01 당뇨병환자의 포괄적 관리\n\n## 2형당뇨병 선별검사\n\n..."
    }
}
```

**백엔드 API 응답:**
```json
{
  "recommended_items": [
    {
      "name": "경동맥 초음파",
      "reason": "과거 검진에서 혈압이 경계 이상이었고...",
      "evidence": "※ 대한고혈압학회 가이드라인, Level A 에비던스"  // ← 이것만!
    }
  ]
}
```

**프론트엔드 표시:**
```
※ 대한고혈압학회 가이드라인, Level A 에비던스
```

### 문제점

1. **RAG 메타데이터 손실**: 문서명, 페이지, 실제 텍스트 모두 버림
2. **API 응답 구조 미흡**: evidence 필드가 단순 문자열
3. **프론트엔드 표시 부족**: 인용구, 출처, 신뢰도 표시 안함

---

## 📊 전체 데이터 파이프라인

### 1단계: RAG 검색 (현재)
```python
rag_result = query_engine.query("44세 남성 당뇨 가족력 혈당검사 필요성")

# 풍부한 데이터
rag_result.source_nodes[0] = {
    "score": 0.499,
    "node.metadata.file_name": "2025 당뇨병 진료지침.pdf",
    "node.metadata.page_label": 42,
    "node.text": "직계 가족에 당뇨가 있으면 선별검사 필요..."
}
```

### 2단계: 프롬프트 생성 (현재 - 문제!)
```python
# 현재: response.response만 사용 (88자)
evidence_text = rag_result.response
evidence_parts.append(f"## 가이드라인\n{evidence_text}\n")

# 문제: source_nodes 버림!
```

### 3단계: LLM 응답 (현재)
```json
{
  "evidence": "※ 대한고혈압학회 가이드라인, Level A 에비던스"
}
```

### 4단계: API 응답 (현재 - 구조 미흡!)
```json
{
  "recommended_items": [
    {
      "evidence": "※ 대한고혈압학회 가이드라인, Level A 에비던스"
    }
  ]
}
```

### 5단계: 프론트엔드 표시 (현재 - 단순!)
```tsx
<div className="evidence">
  {item.evidence}  {/* 단순 문자열 */}
</div>
```

---

## ✅ 개선된 데이터 파이프라인

### 1단계: RAG 검색 → 구조화된 에비던스 추출

```python
async def get_medical_evidence_from_rag_enhanced(...) -> Dict[str, Any]:
    """
    Returns:
        {
            "context_text": "프롬프트에 포함할 텍스트 (1500자+)",
            "structured_evidences": [
                {
                    "query": "44세 남성 당뇨 가족력 혈당검사",
                    "source_document": "2025 당뇨병 진료지침",
                    "page": 42,
                    "citation": "직계 가족(부모, 형제자매)에 당뇨병이 있는 경우 19세 이상의 모든 성인은...",
                    "full_text": "... 전체 텍스트 500자 ...",
                    "confidence_score": 0.499,
                    "organization": "대한당뇨학회",
                    "year": "2025"
                }
            ]
        }
    """
    structured_evidences = []
    
    for query in queries:
        rag_result = query_engine.query(query)
        
        if hasattr(rag_result, 'source_nodes'):
            for node in rag_result.source_nodes[:3]:
                metadata = node.node.metadata
                text = node.node.text
                score = node.score
                
                # 메타데이터 파싱
                file_name = metadata.get('file_name', '').replace('.pdf', '')
                page = metadata.get('page_label', 'N/A')
                
                # 인용구 추출 (첫 200자)
                citation = extract_meaningful_citation(text, query)
                
                # 조직명, 연도 추출
                org, year = extract_organization_and_year(file_name)
                
                structured_evidences.append({
                    "query": query,
                    "source_document": file_name,
                    "page": page,
                    "citation": citation,
                    "full_text": text[:500],
                    "confidence_score": score,
                    "organization": org,
                    "year": year
                })
    
    return {
        "context_text": format_for_prompt(structured_evidences),
        "structured_evidences": structured_evidences
    }
```

### 2단계: 프롬프트 생성 → 상세 에비던스 포함

```python
rag_data = await get_medical_evidence_from_rag_enhanced(...)

# 프롬프트에 상세 에비던스 포함
prompt += f"""
[Critical Evidence: 검색된 의학 가이드라인]

{rag_data['context_text']}

### 1. 당뇨 가족력과 선별검사
출처: 2025 당뇨병 진료지침 (대한당뇨학회)

"직계 가족(부모, 형제자매)에 당뇨병이 있는 경우 19세 이상의 모든 성인은 
당뇨병 선별검사를 받아야 한다. 특히 35세 이상이거나 과체중(BMI 23 이상)인 
경우 반드시 검사가 필요하다."

신뢰도 점수: 0.499 (높음)

---

**에비던스 작성 규칙:**
- 위 인용구를 그대로 사용하세요
- "[문서명]에 따르면 '인용구'라고 명시되어 있습니다" 형식
- "Level A", "42페이지" 같은 메타 정보만 나열 금지
"""

# 구조화된 에비던스를 별도로 저장 (API 응답에 포함)
request_context['rag_evidences'] = rag_data['structured_evidences']
```

### 3단계: LLM 응답 → evidence 필드에 인용구 포함

```json
{
  "recommended_items": [
    {
      "name": "혈당검사",
      "reason": "44세 남성으로 당뇨 가족력이 있는 경우...",
      "evidence": "2025 당뇨병 진료지침에 따르면 '직계 가족(부모, 형제자매)에 당뇨병이 있는 경우 19세 이상의 모든 성인은 당뇨병 선별검사를 받아야 한다'고 명시되어 있습니다. 특히 35세 이상이거나 과체중(BMI 23 이상)인 경우 반드시 검사가 필요하며, 이는 대한당뇨학회의 공식 권고사항입니다."
    }
  ]
}
```

### 4단계: API 응답 → 구조화된 에비던스 추가

```json
{
  "recommended_items": [
    {
      "name": "혈당검사",
      "reason": "44세 남성으로 당뇨 가족력이 있는 경우...",
      "evidence": "2025 당뇨병 진료지침에 따르면 '직계 가족에...'",
      
      // 새로 추가: 구조화된 에비던스 메타데이터
      "evidence_details": {
        "source_document": "2025 당뇨병 진료지침",
        "organization": "대한당뇨학회",
        "year": "2025",
        "confidence_score": 0.499,
        "citation": "직계 가족(부모, 형제자매)에 당뇨병이 있는 경우..."
      }
    }
  ],
  
  // 새로 추가: 전체 RAG 검색 결과 (선택적)
  "rag_evidences": [
    {
      "query": "44세 남성 당뇨 가족력 혈당검사 필요성",
      "source_document": "2025 당뇨병 진료지침",
      "page": 42,
      "citation": "...",
      "confidence_score": 0.499
    }
  ]
}
```

### 5단계: 프론트엔드 표시 → 풍부한 UI

```tsx
interface EvidenceDetails {
  source_document: string;
  organization: string;
  year: string;
  confidence_score: number;
  citation: string;
}

interface RecommendedItem {
  name: string;
  reason: string;
  evidence: string;
  evidence_details?: EvidenceDetails;
}

// 컴포넌트
const RecommendedItemCard: React.FC<{item: RecommendedItem}> = ({item}) => {
  return (
    <div className="recommended-item-card">
      <h3>{item.name}</h3>
      
      <div className="reason">
        <strong>추천 이유:</strong>
        <p>{item.reason}</p>
      </div>
      
      {/* 기존: 단순 텍스트 */}
      <div className="evidence">
        <strong>의학적 근거:</strong>
        <p>{item.evidence}</p>
      </div>
      
      {/* 새로 추가: 구조화된 에비던스 UI */}
      {item.evidence_details && (
        <div className="evidence-details">
          <div className="evidence-source">
            <span className="source-icon">📄</span>
            <span className="source-text">
              {item.evidence_details.source_document} 
              ({item.evidence_details.organization}, {item.evidence_details.year})
            </span>
          </div>
          
          {/* 신뢰도 표시 */}
          <div className="confidence-badge">
            {item.evidence_details.confidence_score >= 0.4 ? (
              <span className="confidence-high">높은 신뢰도</span>
            ) : (
              <span className="confidence-medium">중간 신뢰도</span>
            )}
          </div>
          
          {/* 인용구 강조 */}
          <blockquote className="citation">
            "{item.evidence_details.citation}"
          </blockquote>
        </div>
      )}
    </div>
  );
};
```

---

## 📋 추가 TODO 항목

### TODO-16: API 응답 구조 확장
- **우선순위**: 🔴🔴 최고
- **위치**: `checkup_design.py:972-998` - API 응답 생성
- **작업**:
  1. `recommended_items[].evidence_details` 필드 추가
  2. `rag_evidences` 최상위 필드 추가
  3. 구조화된 에비던스 메타데이터 포함
  4. TypeScript 타입 정의 업데이트
- **예상**: ~60 lines, 1시간

### TODO-17: 프론트엔드 에비던스 UI 컴포넌트
- **우선순위**: 🔴🔴 최고
- **위치**: 새 파일 `EvidenceDisplay.tsx` + SCSS
- **작업**:
  1. 구조화된 에비던스 표시 컴포넌트
  2. 출처 문서, 조직명, 연도 표시
  3. 신뢰도 배지 (높음/중간/낮음)
  4. 인용구 blockquote 스타일
  5. 모바일 반응형
- **예상**: ~150 lines, 2시간

### TODO-18: 데이터 파이프라인 변수 추가
- **우선순위**: 🔴 높음
- **위치**: `checkup_design_prompt.py` + `checkup_design.py`
- **작업**:
  1. RAG 검색 결과를 API 응답까지 전달하는 변수 추가
  2. `request_context['rag_evidences']` 활용
  3. 각 단계에서 데이터 손실 방지
  4. 로깅 추가 (어느 단계에서 몇 개의 에비던스?)
- **예상**: ~80 lines, 1-2시간

---

## 🎯 데이터 흐름 검증 체크리스트

### RAG → 프롬프트
- [ ] source_nodes의 모든 데이터 추출
- [ ] 문서명, 페이지, 텍스트, 신뢰도 저장
- [ ] 인용구 추출 로직
- [ ] 프롬프트에 상세 포함

### 프롬프트 → LLM
- [ ] LLM이 인용구를 그대로 사용하도록 지시
- [ ] evidence 필드 형식 명확히 지정
- [ ] "Level A" 같은 메타 정보 금지

### LLM → API 응답
- [ ] evidence 필드에 인용구 포함 확인
- [ ] evidence_details 필드 추가
- [ ] rag_evidences 최상위 필드 추가
- [ ] TypeScript 타입 정의

### API 응답 → 프론트엔드
- [ ] evidence_details 파싱
- [ ] 출처 문서 표시
- [ ] 신뢰도 배지 표시
- [ ] 인용구 blockquote 표시
- [ ] 모바일 반응형

---

## 📊 예상 UI

### Before (현재)
```
추천 이유: 과거 검진에서 혈압이 경계 이상이었고...

의학적 근거: ※ 대한고혈압학회 가이드라인, Level A 에비던스
```

### After (개선)
```
추천 이유: 과거 검진에서 혈압이 경계 이상이었고...

의학적 근거:
📄 2025 당뇨병 진료지침 (대한당뇨학회, 2025) [높은 신뢰도]

"직계 가족(부모, 형제자매)에 당뇨병이 있는 경우 19세 이상의 모든 성인은 
당뇨병 선별검사를 받아야 한다."

특히 35세 이상이거나 과체중(BMI 23 이상)인 경우 반드시 검사가 필요하며, 
이는 대한당뇨학회의 공식 권고사항입니다.
```

---

**작성자**: AI Assistant  
**날짜**: 2025-12-05 20:45
