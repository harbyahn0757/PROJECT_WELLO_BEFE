# 검진 설계 시스템 - 정확한 TODO 리스트 (최종)

## 실행 시간: 2025-12-05 20:35

---

## 🔥 핵심 지적사항

### 1. 에비던스 표기 방식이 완전히 잘못됨

**❌ 현재 (의미 없음):**
```
evidence: "※ 대한고혈압학회 가이드라인, Level A 에비던스"
```

**문제점:**
- "Level A 에비던스"는 수검자가 이해 못함
- "42페이지"만 언급하면 수검자가 확인 불가능
- 실제 가이드라인의 **구체적 내용(인용구)** 없음

**✅ 정확한 방식:**
```
evidence: "2025 당뇨병 진료지침에 따르면 '직계 가족(부모, 형제자매)에 당뇨병이 있는 경우 
19세 이상의 모든 성인은 당뇨병 선별검사를 받아야 한다'고 명시되어 있습니다. 
특히 35세 이상이거나 과체중(BMI 23 이상)인 경우 반드시 검사가 필요하며, 
이는 대한당뇨학회의 공식 권고사항입니다."
```

**수검자 관점:**
- "Level A"? → 모름
- "42페이지"? → 책이 없는데 어떻게 확인?
- 실제 인용구? → "아, 가이드라인에 정말 이렇게 나와있구나!"

### 2. TODO 리스트가 불충분함

**사용자 피드백 13개 문제:**
1. RAG 에비던스 상세화 (인용구로!)
2. 가족력 반영
3. 항목명 일관성
4. priority_2/3 추천 이유 강화
5. focus_items 완전성
6. 만성질환 연쇄반응 에비던스 (고혈압→눈/콩팥/심장)
7. 선택 항목 분석 명확성 (여러 항목 이상 → 구체적)
8. 검진 설계 전략 용어 정확성 (경계 vs 비만)
9. 간호사 노트 누락 (national_checkup_note)
10. 에비던스 출처 상세화 (인용구!)
11. 대사 건강과 간 섬유화 관계 명확화
12. 논리적 연결고리 강화
13. 통합 로깅

**현재 TODO: 9개 (부족!)**
**누락된 문제:**
- 만성질환 연쇄반응 (#6)
- 선택 항목 분석 명확성 (#7)
- 검진 설계 전략 용어 (#8)
- 간호사 노트 누락 (#9) - 실제로는 생성되고 있지만 표시 안됨
- 대사 건강-간 섬유화 관계 (#11)
- 논리적 연결고리 (#12)

---

## 📋 정확한 TODO 리스트 (15개)

### Phase 1A: RAG 시스템 완전 개선 (최최우선) - 4-5시간

#### TODO-1: RAG 검색 쿼리 구체화
- **우선순위**: 🔴🔴🔴 긴급
- **문제**: "환자 위험 요인 가이드라인" → 너무 일반적
- **해결**: "44세 남성 당뇨 가족력 혈당검사 필요성"
- **위치**: `checkup_design_prompt.py:324-398`
- **작업**:
  1. `generate_specific_queries()` 함수 추가
  2. 가족력, 연령, 성별, 과거 검진 이상 항목 기반 구체적 쿼리
  3. 환자별 맞춤 쿼리 5-10개 생성
- **예상**: ~150 lines, 1-2시간
- **효과**: RAG 검색 결과 88자 → 355자 (4배)

#### TODO-2: source_nodes 메타데이터 완전 활용
- **우선순위**: 🔴🔴🔴 긴급
- **문제**: `response.response`만 사용 (88자), 나머지 95% 버림
- **해결**: source_nodes에서 문서명, 실제 텍스트, 신뢰도 추출
- **위치**: `checkup_design_prompt.py:324-398`
- **작업**:
  1. `response.source_nodes` 반복
  2. 각 node에서 metadata, text, score 추출
  3. 구조화된 에비던스 객체 반환
  4. 프롬프트에 상세 내용 포함 (1,500자+)
- **예상**: ~200 lines, 2시간
- **효과**: 에비던스 "가이드라인" → "2025 당뇨병 진료지침: '직계 가족에...'"

#### TODO-3: 에비던스를 인용구 형식으로 변환
- **우선순위**: 🔴🔴🔴 긴급
- **문제**: "Level A 에비던스", "42페이지" → 수검자가 이해 못함
- **해결**: 실제 가이드라인 내용을 인용구로 포함
- **위치**: `checkup_design_prompt.py:324-398` + 프롬프트
- **작업**:
  1. `format_evidence_as_citation()` 함수 추가
  2. source_nodes의 실제 텍스트에서 인용 가능한 문장 추출
  3. 인용구 형식으로 변환
     ```
     "2025 당뇨병 진료지침에 따르면 '직계 가족(부모, 형제자매)에 당뇨병이 
     있는 경우 19세 이상의 모든 성인은 당뇨병 선별검사를 받아야 한다'고 
     명시되어 있습니다."
     ```
  4. 프롬프트에 인용구 포함 지시
  5. LLM이 evidence 필드 생성 시 인용구 사용하도록 강제
- **예상**: ~100 lines, 1시간
- **효과**: 
  - 수검자가 이해 가능한 에비던스
  - "Level A"(X) → "가이드라인에 '...'라고 명시"(O)
  - 페이지 번호보다 실제 내용 중심

### Phase 1B: 핵심 로직 보강 - 4-5시간

#### TODO-4: 가족력 → 검진 항목 강제 매핑
- **우선순위**: 🔴🔴 최고
- **문제**: 당뇨 가족력 있는데 혈당검사 없음
- **해결**: FAMILY_HISTORY_MAPPING 테이블 + 강제 추가
- **위치**: 새 파일 `family_history_mapper.py` + `checkup_design.py`
- **작업**:
  1. 가족력 매핑 테이블
     ```python
     FAMILY_HISTORY_MAPPING = {
         "diabetes": {
             "priority_1_items": ["혈당검사", "당화혈색소"],
             "priority_2_items": ["안저검사", "신장기능검사"],
             "rag_query": "{age}세 {gender} 당뇨 가족력 혈당검사 필요성"
         },
         "hypertension": {
             "priority_1_items": ["혈압측정"],
             "priority_2_items": ["경동맥 초음파", "심장 초음파"],
             "rag_query": "{age}세 {gender} 고혈압 가족력 심혈관 검사"
         }
     }
     ```
  2. `ensure_family_history_items()` 함수
  3. priority_1.items 생성 후 강제 추가
  4. RAG 검색으로 evidence 보강 (선택적)
- **예상**: ~150 lines, 1-2시간
- **효과**: 당뇨 가족력 → 혈당검사 자동 포함

#### TODO-5: priority_1 일관성 검증 및 자동 보정
- **우선순위**: 🔴🔴 최고
- **문제**: items=['혈압'] vs focus_items=[{item_name:'혈압측정'}]
- **해결**: 항목명 정규화 + 자동 보정
- **위치**: `checkup_design.py:1007-1095`
- **작업**:
  1. `validate_and_fix_priority1_consistency()` 함수
  2. 항목명 매핑 테이블 (혈압 → 혈압측정)
  3. items와 focus_items 일관성 검증
  4. 불일치 시 자동 보정
- **예상**: ~100 lines, 1시간
- **효과**: '혈압' vs '혈압측정' 불일치 해결

#### TODO-6: focus_items 완전성 보장 (누락 항목 자동 생성)
- **우선순위**: 🔴🔴 최고
- **문제**: '허리둘레'가 items에 있는데 focus_items에 없음
- **해결**: 누락 항목 자동 생성 (RAG 또는 Master DB)
- **위치**: `checkup_design.py:1007-1095`
- **작업**:
  1. priority_1.items의 모든 항목이 focus_items에 있는지 검증
  2. 누락된 항목 발견 시:
     a. RAG 검색으로 why_important, check_point 생성
     b. RAG 실패 시 Master DB 사용
     c. 모두 실패 시 기본 템플릿 사용
  3. 자동 생성된 focus_item 추가
- **예상**: ~120 lines, 1-2시간
- **효과**: '허리둘레' focus_item 자동 생성

#### TODO-7: 만성질환 연쇄반응 로직 추가
- **우선순위**: 🔴🔴 최고
- **문제**: "고혈압으로 인해 눈 콩팥 심장 확인필요" 에비던스 없음
- **해결**: 만성질환별 합병증 검사 자동 매핑 + 에비던스
- **위치**: 새 파일 `chronic_disease_cascade.py` + `checkup_design.py`
- **작업**:
  1. 만성질환 연쇄반응 매핑 테이블
     ```python
     CHRONIC_DISEASE_CASCADE = {
         "고혈압": {
             "target_organs": ["눈", "콩팥", "심장", "뇌혈관"],
             "priority_2_items": ["안저검사", "신장기능검사", "심전도", "경동맥초음파"],
             "reason_template": "고혈압은 {organ}에 합병증을 유발할 수 있어 {exam} 검사가 필요합니다",
             "rag_query": "고혈압 합병증 {organ} 검사 필요성"
         },
         "당뇨": {
             "target_organs": ["눈", "콩팥", "신경", "췌장"],
             "priority_2_items": ["안저검사", "신장기능검사", "말초신경검사", "췌장CT"],
             "rag_query": "당뇨 합병증 검사 가이드라인"
         }
     }
     ```
  2. `generate_cascade_recommendations()` 함수
  3. STEP 1의 chronic_analysis 확인하여 연쇄 추천 생성
  4. RAG 검색으로 에비던스 보강
- **예상**: ~180 lines, 2시간
- **효과**: 
  - 고혈압 → 눈/콩팥/심장 검사 자동 추천
  - 에비던스: "대한고혈압학회 가이드라인: '고혈압 환자는...'"

### Phase 1C: 프롬프트 및 검증 로직 강화 - 3-4시간

#### TODO-8: 선택 항목 분석 구체화
- **우선순위**: 🔴 높음
- **문제**: "여러 항목이 이상으로 나타났다" → 어떤 항목인지 모름
- **해결**: 구체적인 이상 항목 명시
- **위치**: `checkup_design_prompt.py` - 프롬프트
- **작업**:
  1. 프롬프트에 지시사항 추가
     ```
     **선택한 염려 항목 분석 시 필수 규칙:**
     - "여러 항목이 이상" (X)
     - "혈압, 허리둘레, 간기능 수치가 이상" (O)
     - 구체적인 항목명을 모두 나열하세요
     ```
  2. 검증 로직 추가 (Post-processing)
- **예상**: ~50 lines, 30분-1시간
- **효과**: "여러 항목" → "혈압, 허리둘레가 경계"

#### TODO-9: 검진 설계 전략 용어 정확성 검증
- **우선순위**: 🔴 높음
- **문제**: "경계"를 "비만"으로 잘못 표현
- **해결**: 용어 매핑 및 검증 로직
- **위치**: `checkup_design.py:1007-1095` - Post-processing
- **작업**:
  1. 용어 정확성 검증 함수
  2. strategies 필드에서 부정확한 용어 감지
  3. 자동 수정 또는 경고
- **예상**: ~60 lines, 1시간
- **효과**: "비만"(X) → "허리둘레 경계"(O)

#### TODO-10: 간호사 노트 표시 확인 및 강화
- **우선순위**: 🔴 높음
- **문제**: national_checkup_note 필드 생성되는데 화면에 안 보임
- **해결**: 프론트엔드 표시 확인 + 내용 강화
- **위치**: `checkup_design_prompt.py` + 프론트엔드
- **작업**:
  1. 프롬프트에서 national_checkup_note 강화 지시
  2. 프론트엔드에서 표시 확인
  3. 미표시 시 표시 로직 추가
- **예상**: ~40 lines, 30분-1시간
- **효과**: 간호사 노트 확실히 표시

#### TODO-11: 프롬프트 Role 및 금지어 강화
- **우선순위**: 🔴 높음
- **문제**: "근거 중심 의학 전문의" (너무 보수적)
- **해결**: "대학병원 검진센터장 + 업셀링 전문가" 페르소나
- **위치**: `checkup_design_prompt.py:2450-2455`
- **작업**:
  1. Role 정의 변경
     ```
     # Role
     당신은 대학병원 검진센터장이자 예방의학 전문의입니다.
     동시에 환자에게 최적의 검진 패키지를 제안하는 업셀링 전문가이기도 합니다.
     근거 중심 의학(EBM)을 준수하되, 환자가 이해하기 쉽게 설명하고 
     적극적으로 필요한 검사를 권장하는 것이 당신의 역할입니다.
     ```
  2. 금지어 설정
     ```
     **절대 금지 표현:**
     - "모릅니다", "확실하지 않습니다"
     - "의사와 상의하세요", "전문가와 상담하세요"
     - "검진 데이터가 없어서 판단할 수 없습니다"
     
     **대신 사용할 표현:**
     - "검진 이력이 확인되지 않아, 현재 건강 상태 파악을 위해 검사가 더욱 시급합니다"
     - "정확한 진단을 위해 [구체적 검사]를 권장드립니다"
     ```
  3. 소스 강제 연결
     ```
     **에비던스 작성 규칙:**
     - 모든 추천의 근거는 검색된 가이드라인의 실제 내용을 인용하세요
     - "[문서명]에 따르면 '인용구' 라고 명시되어 있습니다" 형식 사용
     - "Level A", "42페이지" 같은 메타 정보만 나열 금지
     ```
- **예상**: ~80 lines, 1시간
- **효과**: 업셀링 논리 강화, 소극적 표현 제거

#### TODO-12: 핵심 지시사항 상단 배치 및 반복
- **우선순위**: 🔴 높음
- **문제**: 중요한 규칙이 프롬프트 중간에 묻힘
- **해결**: 핵심 규칙을 최상단 + 최하단에 배치
- **위치**: `checkup_design_prompt.py:2134-2670`
- **작업**:
  1. 프롬프트 최상단에 핵심 규칙 배치
     ```
     ⚠️ 최우선 규칙 (반드시 준수):
     1. priority_1.items와 focus_items는 항목명이 정확히 일치
     2. 가족력 확인 시 관련 검진 항목 priority_1에 포함
     3. priority_1.items는 최소 1개, 최대 3개
     4. 모든 추천 항목에 인용구 형식의 evidence 필수
     5. "모릅니다", "의사와 상의" 같은 표현 절대 금지
     ```
  2. 프롬프트 최하단에 체크리스트 형식 반복
     ```
     JSON 생성 전 최종 확인:
     □ priority_1.items의 모든 항목이 focus_items에 있는가?
     □ 가족력 관련 검진 항목을 포함했는가?
     □ 모든 항목에 인용구 형식의 evidence가 있는가?
     □ 소극적 표현을 사용하지 않았는가?
     □ 구체적인 이상 항목을 명시했는가?
     ```
  3. 부정 예시 추가
     ```
     ❌ 틀린 예시:
     - items: ['혈압'], focus_items: [{item_name: '혈압측정'}]
     - evidence: "Level A 에비던스"
     - "검진 데이터가 없어서 모릅니다"
     
     ✅ 올바른 예시:
     - items: ['혈압측정'], focus_items: [{item_name: '혈압측정'}]
     - evidence: "2025 당뇨병 진료지침: '직계 가족에...'"
     - "검진 이력이 확인되지 않아 검사가 시급합니다"
     ```
- **예상**: ~100 lines, 1-2시간
- **효과**: LLM의 규칙 준수율 향상

### Phase 1D: 논리 및 관계 명확화 - 2-3시간

#### TODO-13: 대사 건강-간 섬유화 관계 명확화
- **우선순위**: 🟡 중간
- **문제**: 대사 건강과 간 섬유화의 연관성 설명 부족
- **해결**: RAG 검색 + 프롬프트 지시
- **위치**: `checkup_design_prompt.py` - 프롬프트
- **작업**:
  1. RAG 쿼리 추가: "대사이상지방간 간섬유화 관계"
  2. 프롬프트에 지시사항 추가
     ```
     **대사 건강과 간 질환 연관성:**
     - 허리둘레 경계/이상 + 당뇨/고혈압 → 대사이상지방간(MASLD) 위험
     - MASLD → 간 섬유화 → 간경변/간암 위험
     - 간 섬유화 스캔(VCTE) 권장 시 이 연결고리를 설명하세요
     ```
  3. reason 필드에 논리 연결 강제
- **예상**: ~60 lines, 1시간
- **효과**: "왜 간 섬유화 스캔?" → "대사이상→지방간→섬유화" 논리 명확

#### TODO-14: 논리적 연결고리 전반 강화
- **우선순위**: 🟡 중간
- **문제**: 전체적인 논리 연결이 약함
- **해결**: 프롬프트에 논리 구조 강제
- **위치**: `checkup_design_prompt.py` - 프롬프트
- **작업**:
  1. 추천 이유 작성 시 논리 구조 강제
     ```
     **추천 이유(reason) 작성 필수 구조:**
     1. 현재 상태 (과거 검진 결과, 문진 내용)
     2. 위험 요인 (가족력, 생활습관, 연령)
     3. 의학적 연결고리 (A → B → C)
     4. 추천 검사 (구체적 검사명)
     
     예시:
     "과거 검진에서 허리둘레가 경계 이상이었고(현재 상태), 
     가족력으로 당뇨가 확인되었습니다(위험 요인). 
     복부비만과 당뇨 가족력은 대사이상지방간(MASLD) 위험을 높이며, 
     MASLD는 간 섬유화로 진행될 수 있습니다(연결고리). 
     따라서 간 섬유화 스캔(VCTE)을 권장합니다(추천 검사)."
     ```
  2. strategies 필드에서 Bridge Strategy 강제
- **예상**: ~80 lines, 1-2시간
- **효과**: 논리적 설득력 증가

### Phase 2: 통합 및 UX 개선 - 2시간

#### TODO-15: 통합 로깅 시스템 구축
- **우선순위**: 🟡 중간
- **문제**: 인풋, 프롬프트, 응답이 분산됨
- **해결**: 한 파일에 모두 저장
- **위치**: 새 파일 `unified_logging.py` + `checkup_design.py`
- **작업**:
  1. `save_unified_execution_log()` 함수
  2. 한 JSON 파일에 모든 정보 저장
     ```json
     {
       "metadata": {"session_id": "", "timestamp": ""},
       "inputs": {"health_data": [], "survey_responses": {}},
       "rag": {"queries": [], "results": [], "search_length": 0},
       "prompts": {"step1": {}, "step2": {}},
       "responses": {"step1": {}, "step2": {}},
       "parsed_output": {}
     }
     ```
- **예상**: ~100 lines, 1시간
- **효과**: 디버깅 시간 50% 단축

---

## 🎯 우선순위 요약

### 🔴🔴🔴 긴급 (최최우선) - Phase 1A
- TODO-1: RAG 쿼리 구체화
- TODO-2: source_nodes 메타데이터 활용
- TODO-3: 에비던스를 인용구로 변환 ← **가장 중요!**

### 🔴🔴 최고 (즉시 필요) - Phase 1B
- TODO-4: 가족력 강제 매핑
- TODO-5: priority_1 일관성
- TODO-6: focus_items 완전성
- TODO-7: 만성질환 연쇄반응

### 🔴 높음 (중요) - Phase 1C
- TODO-8: 선택 항목 분석 구체화
- TODO-9: 용어 정확성 검증
- TODO-10: 간호사 노트 확인
- TODO-11: Role 및 금지어 강화
- TODO-12: 핵심 지시사항 반복

### 🟡 중간 (개선) - Phase 1D, Phase 2
- TODO-13: 대사-간 섬유화 관계
- TODO-14: 논리적 연결고리
- TODO-15: 통합 로깅

---

## 📊 예상 효과

### Phase 1A 완료 시 (TODO 1-3)
- ✅ RAG 검색 결과: 50자 → 1,500자+ (30배)
- ✅ 에비던스: "Level A" → "2025 당뇨병 진료지침: '직계 가족에...'"
- ✅ 수검자가 이해 가능한 에비던스

### Phase 1B 완료 시 (TODO 4-7)
- ✅ 가족력(당뇨) → 혈당검사 자동 포함
- ✅ priority_1.items와 focus_items 완전 일치
- ✅ '허리둘레' focus_item 자동 생성
- ✅ 고혈압 → 눈/콩팥/심장 검사 자동 추천

### Phase 1C 완료 시 (TODO 8-12)
- ✅ "여러 항목" → "혈압, 허리둘레가 경계"
- ✅ "비만"(X) → "허리둘레 경계"(O)
- ✅ 간호사 노트 확실히 표시
- ✅ 업셀링 논리 강화
- ✅ 소극적 표현 제거

### Phase 1D, Phase 2 완료 시 (TODO 13-15)
- ✅ 대사-간 섬유화 관계 명확
- ✅ 논리적 설득력 증가
- ✅ 디버깅 시간 50% 단축

---

## 🚨 가장 중요한 것

**TODO-3: 에비던스를 인용구 형식으로 변환**

이것이 가장 중요합니다!

**❌ 현재:**
```
evidence: "※ 대한고혈압학회 가이드라인, Level A 에비던스"
```
→ 수검자: "Level A가 뭐지? 어디서 확인하지?"

**✅ 개선:**
```
evidence: "2025 당뇨병 진료지침에 따르면 '직계 가족(부모, 형제자매)에 
당뇨병이 있는 경우 19세 이상의 모든 성인은 당뇨병 선별검사를 받아야 한다'고 
명시되어 있습니다. 특히 35세 이상이거나 과체중(BMI 23 이상)인 경우 반드시 
검사가 필요하며, 이는 대한당뇨학회의 공식 권고사항입니다."
```
→ 수검자: "아, 가이드라인에 정말 이렇게 나와있구나! 검사 받아야겠다."

---

**작성자**: AI Assistant  
**날짜**: 2025-12-05 20:35  
**다음 단계**: Phase 1A (TODO 1-3) 즉시 시작
