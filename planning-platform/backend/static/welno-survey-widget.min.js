var RATING_LABELS_DEFAULT=["매우불만족","불만족","보통","만족","매우만족"],NPS_LABELS_DEFAULT=["전혀 아니다","아니다","보통","그렇다","매우 그렇다"],DEFAULT_SURVEY_FIELDS=[{key:"overall_satisfaction",label:"전반적 만족도",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:RATING_LABELS_DEFAULT,section:"overall"}},{key:"reservation_process",label:"예약 과정",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:RATING_LABELS_DEFAULT}},{key:"facility_cleanliness",label:"시설 청결",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:RATING_LABELS_DEFAULT}},{key:"staff_kindness",label:"직원 친절",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:RATING_LABELS_DEFAULT}},{key:"waiting_time",label:"대기 시간",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:RATING_LABELS_DEFAULT}},{key:"result_explanation",label:"검진 결과 설명",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:RATING_LABELS_DEFAULT}},{key:"revisit_intention",label:"재방문 의향",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:NPS_LABELS_DEFAULT}},{key:"recommendation",label:"추천 의향",type:"rating",required:!0,options:null,config:{min:1,max:5,labels:NPS_LABELS_DEFAULT}},{key:"best_experience",label:"가장 좋았던 점",type:"text",required:!1,options:null,config:{}},{key:"improvement_suggestion",label:"개선이 필요한 점",type:"text",required:!1,options:null,config:{}},{key:"free_text",label:"기타 하실 말씀",type:"text",required:!1,options:null,config:{}}];class WelnoSurveyWidget{constructor(e){if(!e||!e.apiKey||!e.hospitalId)return console.warn("[WelnoSurveyWidget] apiKey와 hospitalId는 필수입니다."),this._disabled=!0,this.config={},this.state={},void(this.elements={});var t=e.baseUrl||("undefined"!=typeof window?window.location.origin:""),i=e.hospitalName||e.partnerData&&e.partnerData.partner_hospital_name||null;this.config={apiKey:e.apiKey,hospitalId:e.hospitalId,hospitalName:i,baseUrl:t,uuid:e.uuid||"survey_"+Date.now(),position:e.position||"bottom-right",primaryColor:e.primaryColor||"#7B5E4F",buttonLabel:e.buttonLabel||"만족도 조사",title:e.title||"병원 만족도 설문",subtitle:e.subtitle||"소중한 의견을 남겨주세요",onSubmit:e.onSubmit||null,onError:e.onError||null,autoOpen:e.autoOpen||!1,hideButton:e.hideButton||!1},this.state={isOpen:!1,isSubmitting:!1,isSubmitted:!1,isInitialized:!1,ratings:{}},this.surveyFields=DEFAULT_SURVEY_FIELDS,this.templateId=null,this.elements={},this.cssPrefix="welno-survey-widget"}async fetchSurveyConfig(){try{var e=this.config.baseUrl+"/welno-api/v1/hospital-survey/config?hospital_id="+encodeURIComponent(this.config.hospitalId);this.config.hospitalName&&(e+="&hospital_name="+encodeURIComponent(this.config.hospitalName));var t=await fetch(e,{method:"GET",headers:{"X-API-Key":this.config.apiKey}});if(!t.ok)throw new Error("HTTP "+t.status);var i=await t.json();i.questions&&Array.isArray(i.questions)&&i.questions.length>0&&(this.surveyFields=i.questions),i.template_id&&(this.templateId=i.template_id)}catch(e){console.warn("[WelnoSurveyWidget] 설문 설정 로드 실패, 기본 필드 사용:",e.message),this.surveyFields=DEFAULT_SURVEY_FIELDS,this.templateId=null}}async init(){if(!this._disabled&&!this.state.isInitialized)try{await this.fetchSurveyConfig(),this.injectStyles(),this.createDOM(),this.bindEvents(),this.state.isInitialized=!0,this.config.autoOpen&&setTimeout(function(){this.open()}.bind(this),500)}catch(e){console.warn("[WelnoSurveyWidget] 초기화 실패:",e.message||e)}}injectStyles(){var e=this.cssPrefix+"-styles";if(!document.getElementById(e)){if(!document.getElementById("welno-noto-sans-kr"))try{var t=document.createElement("link");t.id="welno-noto-sans-kr",t.rel="stylesheet",t.href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap",t.onerror=function(){},document.head.appendChild(t)}catch(e){}var i=this.config.primaryColor,n=this.cssPrefix,o="."+n+'-container {  position: fixed;  z-index: 9999;  font-family: "Noto Sans KR", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;  font-size: 15px;  line-height: 1.4;  color: #333;  box-sizing: border-box;}.'+n+"-container *, ."+n+"-container *::before, ."+n+"-container *::after { box-sizing: border-box; }."+n+"-container.position-bottom-right { bottom: 24px; right: 24px; }."+n+"-container.position-bottom-left { bottom: 24px; left: 24px; }."+n+"-button {  display: flex; align-items: center; gap: 8px;  padding: 12px 20px;  border: none; border-radius: 28px;  background: "+i+";  color: #fff;  font-size: 14px; font-weight: 600;  box-shadow: 0 4px 12px rgba(0,0,0,0.15);  cursor: pointer;  transition: all 0.3s ease;  outline: none;}."+n+"-button:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }."+n+"-button svg { width: 18px; height: 18px; flex-shrink: 0; }."+n+"-overlay {  position: fixed; inset: 0;  background: rgba(0,0,0,0.5);  display: none;  align-items: center; justify-content: center;  z-index: 10000;  animation: "+n+"-fadeIn 0.25s ease-out;}."+n+"-overlay.open { display: flex; }@keyframes "+n+"-fadeIn { from { opacity: 0; } to { opacity: 1; } }."+n+"-panel {  background: #fff;  border-radius: 20px;  width: 420px; max-width: 92vw;  max-height: 90vh;  overflow-y: auto;  box-shadow: 0 20px 60px rgba(0,0,0,0.2);  animation: "+n+"-slideUp 0.3s ease-out;}@keyframes "+n+"-slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }."+n+"-header {  background: "+i+";  color: #fff;  padding: 20px 24px;  border-radius: 20px 20px 0 0;  display: flex; justify-content: space-between; align-items: flex-start;}."+n+"-header h3 { margin: 0 0 4px; font-size: 18px; font-weight: 700; }."+n+"-header p { margin: 0; font-size: 13px; opacity: 0.85; }."+n+"-close {  background: none; border: none;  color: #fff; font-size: 22px;  cursor: pointer; padding: 4px;  border-radius: 4px; line-height: 1;}."+n+"-close:hover { background: rgba(255,255,255,0.15); }."+n+"-body { padding: 24px; }."+n+"-field { margin-bottom: 20px; }."+n+"-field-label {  font-size: 14px; font-weight: 600; color: #333;  margin-bottom: 8px; display: block;}."+n+"-stars {  display: flex; gap: 6px;}."+n+"-star {  padding: 6px 10px;  border: 1.5px solid #ddd;  border-radius: 20px;  background: #fff;  cursor: pointer;  display: flex; align-items: center; justify-content: center;  font-size: 12px;  font-weight: 500;  transition: all 0.15s;  color: #999;  white-space: nowrap;}."+n+"-star:hover { transform: scale(1.05); }."+n+'-star[data-level="1"]:hover { border-color: #c62828; color: #c62828; }.'+n+'-star[data-level="2"]:hover { border-color: #ef6c00; color: #ef6c00; }.'+n+'-star[data-level="3"]:hover { border-color: #fbc02d; color: #9e8600; }.'+n+'-star[data-level="4"]:hover { border-color: #66bb6a; color: #388e3c; }.'+n+'-star[data-level="5"]:hover { border-color: #2e7d32; color: #2e7d32; }.'+n+"-star.selected {  color: #fff;}."+n+'-star.selected[data-level="1"] { background: #c62828; border-color: #c62828; }.'+n+'-star.selected[data-level="2"] { background: #ef6c00; border-color: #ef6c00; }.'+n+'-star.selected[data-level="3"] { background: #fbc02d; border-color: #fbc02d; color: #333; }.'+n+'-star.selected[data-level="4"] { background: #66bb6a; border-color: #66bb6a; }.'+n+'-star.selected[data-level="5"] { background: #2e7d32; border-color: #2e7d32; }.'+n+"-comment {  width: 100%;  min-height: 80px;  padding: 12px;  border: 1px solid #ddd;  border-radius: 12px;  font-size: 14px;  font-family: inherit;  resize: vertical;  outline: none;  transition: border-color 0.2s;}."+n+"-comment:focus { border-color: "+i+"; }."+n+"-submit {  width: 100%;  padding: 14px;  background: "+i+";  color: #fff;  border: none;  border-radius: 12px;  font-size: 16px;  font-weight: 700;  cursor: pointer;  transition: all 0.2s;  margin-top: 8px;}."+n+"-submit:hover:not(:disabled) { filter: brightness(0.9); }."+n+"-submit:disabled { opacity: 0.5; cursor: not-allowed; }."+n+"-thanks {  text-align: center;  padding: 60px 24px;}."+n+"-thanks-icon {  font-size: 48px;  margin-bottom: 16px;}."+n+"-thanks h3 {  margin: 0 0 8px;  font-size: 20px;  font-weight: 700;  color: #333;}."+n+"-thanks p {  margin: 0;  font-size: 14px;  color: #666;}."+n+"-radio-group {  display: flex;  flex-direction: column;  gap: 8px;  width: 100%;  padding: 0 4px;}."+n+"-radio-item {  display: flex;  align-items: center;  gap: 8px;  padding: 8px 12px;  border: 1px solid #e0e0e0;  border-radius: 8px;  cursor: pointer;  transition: all 0.2s;  font-size: 14px;}."+n+"-radio-item:hover {  border-color: "+i+";  background: "+i+"11;}."+n+"-radio-item.selected {  border-color: "+i+";  background: "+i+"22;}."+n+'-radio-item input[type="radio"],.'+n+'-radio-item input[type="checkbox"] {  accent-color: '+i+";  width: 16px;  height: 16px;}."+n+"-checkbox-group {  display: flex;  flex-direction: column;  gap: 8px;  width: 100%;  padding: 0 4px;}."+n+"-checkbox-item {  display: flex;  align-items: center;  gap: 8px;  padding: 8px 12px;  border: 1px solid #e0e0e0;  border-radius: 8px;  cursor: pointer;  transition: all 0.2s;  font-size: 14px;}."+n+"-checkbox-item:hover {  border-color: "+i+";  background: "+i+"11;}."+n+"-checkbox-item.selected {  border-color: "+i+";  background: "+i+"22;}."+n+'-text-input {  width: 100%;  min-height: 80px;  padding: 10px 12px;  border: 1px solid #e0e0e0;  border-radius: 8px;  font-family: "Noto Sans KR", sans-serif;  font-size: 14px;  resize: vertical;  outline: none;  transition: border-color 0.2s;  box-sizing: border-box;}.'+n+"-text-input:focus {  border-color: "+i+";}."+n+"-rating-buttons {  display: flex;  justify-content: center;  gap: 6px;  flex-wrap: wrap;}."+n+"-section-header {  text-align: center;  margin-bottom: 8px;}."+n+"-section-header span {  font-size: 16px;  font-weight: 700;  color: "+i+";}."+n+"-section-divider {  height: 1px;  background: #e0e0e0;  margin: 16px 0 12px;}."+n+"-section-subheader {  font-size: 13px;  font-weight: 600;  color: #888;  margin-bottom: 12px;}."+n+"-field--overall {  background: "+i+"08;  border-radius: 12px;  padding: 12px;  border: 1px solid "+i+"22;}@media (max-width: 480px) {  ."+n+"-panel {    width: 100%; max-width: 100%;    border-radius: 16px 16px 0 0;    position: fixed; bottom: 0; left: 0; right: 0;    max-height: 88vh;    -webkit-overflow-scrolling: touch;  }  ."+n+"-header {    border-radius: 16px 16px 0 0;    padding: 14px 16px;  }  ."+n+"-header h3 { font-size: 15px; margin: 0 0 2px; }  ."+n+"-header p { font-size: 12px; }  ."+n+"-close { font-size: 20px; padding: 2px; }  ."+n+"-body { padding: 16px; }  ."+n+"-field { margin-bottom: 16px; }  ."+n+"-field-label { font-size: 13px; margin-bottom: 6px; }  ."+n+"-rating-buttons { gap: 4px; }  ."+n+"-star {    padding: 8px 0; flex: 1; min-width: 0;    font-size: 11px; border-radius: 8px;    text-align: center; justify-content: center;  }  ."+n+"-comment { min-height: 60px; padding: 10px; font-size: 13px; border-radius: 8px; }  ."+n+"-text-input { min-height: 60px; padding: 10px; font-size: 13px; }  ."+n+"-radio-item, ."+n+"-checkbox-item { padding: 8px 10px; font-size: 13px; }  ."+n+"-submit { padding: 12px; font-size: 15px; border-radius: 10px; margin-top: 4px; }  ."+n+"-thanks { padding: 40px 16px; }  ."+n+"-thanks h3 { font-size: 17px; }  ."+n+"-thanks p { font-size: 13px; }  ."+n+"-section-header span { font-size: 14px; }  ."+n+"-section-subheader { font-size: 12px; margin-bottom: 8px; }  ."+n+"-section-divider { margin: 12px 0 8px; }  ."+n+"-field--overall { padding: 10px; }  ."+n+"-container { bottom: 12px; right: 12px; }  ."+n+"-button { padding: 10px 16px; font-size: 13px; gap: 6px; }  ."+n+"-button svg { width: 16px; height: 16px; }}",s=document.createElement("style");s.id=e,s.textContent=o,document.head.appendChild(s)}}createDOM(){var e=this.cssPrefix;this.elements.container=document.createElement("div"),this.elements.container.className=e+"-container position-"+this.config.position,this.elements.button=document.createElement("button"),this.elements.button.className=e+"-button",this.elements.button.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3H14z"/><path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg><span>'+this.config.buttonLabel+"</span>",this.elements.overlay=document.createElement("div"),this.elements.overlay.className=e+"-overlay";var t=document.createElement("div");t.className=e+"-panel";var i=document.createElement("div");i.className=e+"-header",i.innerHTML="<div><h3>"+this.config.title+"</h3><p>"+this.config.subtitle+'</p></div><button class="'+e+'-close" aria-label="닫기">&times;</button>',this.elements.body=document.createElement("div"),this.elements.body.className=e+"-body",this.renderForm(),t.appendChild(i),t.appendChild(this.elements.body),this.elements.overlay.appendChild(t),this.elements.panel=t,this.config.hideButton||(this.elements.container.appendChild(this.elements.button),document.body.appendChild(this.elements.container)),document.body.appendChild(this.elements.overlay)}renderForm(){var e=this.cssPrefix,t=this;this.elements.body.innerHTML="";var i=this.surveyFields||DEFAULT_SURVEY_FIELDS,n=!1,o=!1;if(i.forEach(function(i){try{var s=i.config&&"overall"===i.config.section;if(s&&!n){var a=document.createElement("div");a.className=e+"-section-header",a.innerHTML="<span>"+(i.label||"전반적 만족도")+"</span>",t.elements.body.appendChild(a),n=!0}else if(!s&&!o&&n){var r=document.createElement("div");r.className=e+"-section-divider",t.elements.body.appendChild(r);var l=document.createElement("div");l.className=e+"-section-subheader",l.textContent="세부 항목",t.elements.body.appendChild(l),o=!0}var d=document.createElement("div");if(d.className=e+"-field"+(s?" "+e+"-field--overall":""),!s){var c=document.createElement("span");c.className=e+"-field-label",c.textContent=i.label||"",d.appendChild(c)}"rating"===i.type?t._renderRatingField(d,i):"text"===i.type?t._renderTextField(d,i):"single_choice"===i.type?t._renderSingleChoiceField(d,i):"multiple_choice"===i.type&&t._renderMultipleChoiceField(d,i),t.elements.body.appendChild(d)}catch(e){console.warn("[WelnoSurveyWidget] 필드 렌더링 실패:",i.key,e.message)}}),!i.some(function(e){return"text"===e.type})){var s=document.createElement("div");s.className=e+"-field";var a=document.createElement("span");a.className=e+"-field-label",a.textContent="추가 의견 (선택)",s.appendChild(a),this.elements.comment=document.createElement("textarea"),this.elements.comment.className=e+"-comment",this.elements.comment.placeholder="개선할 점이나 좋았던 점을 자유롭게 남겨주세요...",s.appendChild(this.elements.comment),this.elements.body.appendChild(s)}this.elements.submitBtn=document.createElement("button"),this.elements.submitBtn.className=e+"-submit",this.elements.submitBtn.textContent="제출하기",this.elements.submitBtn.disabled=!0,this.elements.body.appendChild(this.elements.submitBtn)}_renderRatingField(e,t){var i=this.cssPrefix,n=this,o=t.config&&t.config.min?t.config.min:1,s=t.config&&t.config.max?t.config.max:5,a=t.config&&t.config.labels?t.config.labels:RATING_LABELS_DEFAULT,r=document.createElement("div");r.className=i+"-rating-buttons";for(var l=o;l<=s;l++)(function(e,o){var s=document.createElement("button");s.className=i+"-star",s.type="button";var l=a[o]||String(e);s.textContent=l,s.setAttribute("data-field",t.key),s.setAttribute("data-score",String(e)),s.setAttribute("data-level",String(e)),s.addEventListener("click",function(){n.state.ratings[t.key]=e;for(var o=r.querySelectorAll("."+i+"-star"),s=0;s<o.length;s++){parseInt(o[s].getAttribute("data-score"),10)===e?o[s].classList.add("selected"):o[s].classList.remove("selected")}n.updateSubmitState()}),r.appendChild(s)})(l,l-o);e.appendChild(r)}_renderTextField(e,t){var i=this.cssPrefix,n=this,o=document.createElement("textarea");o.className=i+"-text-input",o.placeholder=t.label||"",o.setAttribute("data-field",t.key),o.addEventListener("input",function(){var e=o.value.trim();e?n.state.ratings[t.key]=e:delete n.state.ratings[t.key],n.updateSubmitState()}),e.appendChild(o)}_renderSingleChoiceField(e,t){var i=this.cssPrefix,n=this,o=t.options||[],s=document.createElement("div");s.className=i+"-radio-group",o.forEach(function(e){var o=document.createElement("label");o.className=i+"-radio-item";var a=document.createElement("input");a.type="radio",a.name="welno_survey_"+t.key,a.value=e;var r=document.createTextNode(e);a.addEventListener("change",function(){n.state.ratings[t.key]=e;for(var a=s.querySelectorAll("."+i+"-radio-item"),r=0;r<a.length;r++)a[r].classList.remove("selected");o.classList.add("selected"),n.updateSubmitState()}),o.appendChild(a),o.appendChild(r),s.appendChild(o)}),e.appendChild(s)}_renderMultipleChoiceField(e,t){var i=this.cssPrefix,n=this,o=t.options||[],s=document.createElement("div");s.className=i+"-checkbox-group",o.forEach(function(e){var o=document.createElement("label");o.className=i+"-checkbox-item";var a=document.createElement("input");a.type="checkbox",a.value=e;var r=document.createTextNode(e);a.addEventListener("change",function(){Array.isArray(n.state.ratings[t.key])||(n.state.ratings[t.key]=[]),a.checked?(n.state.ratings[t.key].push(e),o.classList.add("selected")):(n.state.ratings[t.key]=n.state.ratings[t.key].filter(function(t){return t!==e}),o.classList.remove("selected"),0===n.state.ratings[t.key].length&&delete n.state.ratings[t.key]),n.updateSubmitState()}),o.appendChild(a),o.appendChild(r),s.appendChild(o)}),e.appendChild(s)}updateSubmitState(){var e=this,t=this.surveyFields.filter(function(e){return e.required}).every(function(t){var i=e.state.ratings[t.key];return null!=i&&""!==i&&(!Array.isArray(i)||0!==i.length)});this.elements.submitBtn&&(this.elements.submitBtn.disabled=!t||this.state.isSubmitting)}renderThanks(){var e=this.cssPrefix;this.elements.body.innerHTML='<div class="'+e+'-thanks"><h3>감사합니다!</h3><p>소중한 의견이 접수되었습니다.<br>더 나은 서비스를 위해 노력하겠습니다.</p></div>'}bindEvents(){var e=this,t=this.cssPrefix;this.elements.button.addEventListener("click",function(){e.open()}),this.elements.overlay.querySelector("."+t+"-close").addEventListener("click",function(){e.close()}),this.elements.overlay.addEventListener("click",function(t){t.target===e.elements.overlay&&e.close()}),this._submitHandler=function(){e.submit()},this.elements.submitBtn.addEventListener("click",this._submitHandler)}open(){this.state.isOpen||(this.state.isOpen=!0,this.elements.overlay.classList.add("open"))}close(){this.state.isOpen&&(this.state.isOpen=!1,this.elements.overlay.classList.remove("open"),this.state.isSubmitted&&(this.state.isSubmitted=!1,this.state.ratings={},this.renderForm(),this.bindFormEvents()))}bindFormEvents(){var e=this;this.elements.submitBtn&&(this._submitHandler&&this.elements.submitBtn.removeEventListener("click",this._submitHandler),this._submitHandler=function(){e.submit()},this.elements.submitBtn.addEventListener("click",this._submitHandler))}async submit(){if(!this.state.isSubmitting){this.state.isSubmitting=!0,this.elements.submitBtn.disabled=!0,this.elements.submitBtn.textContent="제출 중...";try{var e,t;e=this.config.baseUrl+"/welno-api/v1/hospital-survey/submit-dynamic",t={hospital_id:this.config.hospitalId,hospital_name:this.config.hospitalName||void 0,template_id:this.templateId||void 0,answers:this.state.ratings,free_comment:this.elements.comment?this.elements.comment.value.trim():"",respondent_uuid:this.config.uuid};var i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify(t)});if(!i.ok){var n=await i.json().catch(function(){return{}});throw new Error(n.detail||"HTTP "+i.status)}this.state.isSubmitted=!0,this.renderThanks(),this.config.onSubmit&&this.config.onSubmit(t);var o=this;setTimeout(function(){o.close()},3e3)}catch(e){console.error("[WelnoSurveyWidget] 제출 실패:",e),this.config.onError&&this.config.onError(e),this.elements.submitBtn.textContent="제출 실패 - 다시 시도",this.elements.submitBtn.disabled=!1}finally{this.state.isSubmitting=!1}}}destroy(){this.elements.container&&this.elements.container.parentNode&&this.elements.container.parentNode.removeChild(this.elements.container),this.elements.overlay&&this.elements.overlay.parentNode&&this.elements.overlay.parentNode.removeChild(this.elements.overlay);var e=document.getElementById(this.cssPrefix+"-styles");e&&e.remove(),this.state.isInitialized=!1}}WelnoSurveyWidget.create=function(e){try{var t=new WelnoSurveyWidget(e);return t.init().catch(function(e){console.warn("[WelnoSurveyWidget] init error:",e.message||e)}),t}catch(e){return console.warn("[WelnoSurveyWidget] create error:",e.message||e),null}},"undefined"!=typeof module&&module.exports?(module.exports=WelnoSurveyWidget,module.exports.default=WelnoSurveyWidget):"function"==typeof define&&define.amd?define([],function(){return WelnoSurveyWidget}):window.WelnoSurveyWidget=WelnoSurveyWidget;