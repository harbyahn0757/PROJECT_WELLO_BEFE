var PARTNER_DEFAULT_ICON={"5a9bb40b5108ecd8ef864658d5a2d5ab":"/welno-api/static/mdx_icon.png"},THEME_TOKENS={default:{headerBg:"#7B5E4F",accent:"#7B5E4F",accentHover:"#6B4E3F",welcomeText:"#7B5E4F",userBubble:"#7B5E4F",buttonColor:"#A69B8F",borderSubtle:"rgba(123, 94, 79, 0.1)"},navy:{headerBg:"#1e3a5f",accent:"#2c5282",accentHover:"#234a75",welcomeText:"#1e3a5f",userBubble:"#2c5282",buttonColor:"#2c5282",borderSubtle:"rgba(30, 58, 95, 0.12)"}};class WelnoRagChatWidget{constructor(e){if(!e.apiKey)throw new Error("WelnoRagChatWidget: apiKey is required");var n=e.baseUrl||("undefined"!=typeof window?window.location.origin:""),t=e.chatIconUrl||null;!t&&e.apiKey&&PARTNER_DEFAULT_ICON[e.apiKey]&&(t=n.replace(/\/$/,"")+PARTNER_DEFAULT_ICON[e.apiKey]);var s=e.partnerData||null;if("string"==typeof s)try{s=JSON.parse(s)}catch(e){s=null}this.config={apiKey:e.apiKey,baseUrl:n,uuid:e.uuid||"widget_user_"+Date.now(),hospitalId:e.hospitalId||"widget_partner",partnerData:s,position:e.position||"bottom-right",theme:e.theme||"default",buttonColor:e.buttonColor||"#A69B8F",chatIconUrl:t,autoOpen:e.autoOpen||!1,welcomeMessage:e.welcomeMessage||"ì•ˆë…•í•˜ì„¸ìš”! ê±´ê°•ê³¼ ì˜ì–‘ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”. ğŸ˜Š",onOpen:e.onOpen||null,onClose:e.onClose||null,onMessage:e.onMessage||null,onError:e.onError||null},this.state={isOpen:!1,isLoading:!1,messages:[],sessionId:null,suggestions:[],isInitialized:!1,assistantMsgCount:0},this.elements={container:null,button:null,window:null,messagesContainer:null,input:null,sendButton:null},this.cssPrefix="welno-rag-widget"}async init(){if(this.state.isInitialized)console.warn("[WelnoRagChatWidget] ì´ë¯¸ ì´ˆê¸°í™”ë¨");else try{await this.fetchRemoteConfig(),this.injectStyles(),this.createDOM(),this.bindEvents(),this.state.sessionId=`temp_${this.config.uuid}_${Date.now()}`,this.warmup(),this.addMessage("assistant",this.config.welcomeMessage),this.config.autoOpen&&setTimeout(()=>this.open(),500),this.state.isInitialized=!0}catch(e){console.warn("[WelnoRagChatWidget] ìœ„ì ¯ í™œì„±í™” ì¡°ê±´ ë¯¸ì¶©ì¡± (ë“±ë¡ë˜ì§€ ì•Šì€ íŒŒíŠ¸ë„ˆ/ë³‘ì›):",e.message),this.destroy()}}async fetchRemoteConfig(){try{var e="welno";"5a9bb40b5108ecd8ef864658d5a2d5ab"===this.config.apiKey&&(e="medilinx");var n=`${this.config.baseUrl}/welno-api/v1/admin/embedding/config/frontend?partner_id=${e}`;this.config.hospitalId&&(n+=`&hospital_id=${this.config.hospitalId}`);const t=await fetch(n);if(!t.ok)throw new Error(`ë“±ë¡ë˜ì§€ ì•Šì€ ë³‘ì› ë˜ëŠ” íŒŒíŠ¸ë„ˆì…ë‹ˆë‹¤. (HTTP ${t.status})`);{const e=await t.json();e.theme&&e.theme.primary_color&&(this.config.buttonColor=e.theme.primary_color,this.config.themeData=e.theme),e.theme&&e.theme.icon_url&&(this.config.chatIconUrl=e.theme.icon_url),e.welcome_message&&(this.config.welcomeMessage=e.welcome_message),e.partner_name&&(this.config.partnerName=e.partner_name)}}catch(e){throw console.error("[WelnoRagChatWidget] ì„œë²„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:",e),e}}injectStyles(){const e=`${this.cssPrefix}-styles`;if(document.getElementById(e))return;if(!document.getElementById("welno-noto-sans-kr"))try{const e=document.createElement("link");e.id="welno-noto-sans-kr",e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap",e.onerror=function(){},document.head.appendChild(e)}catch(e){}var n="navy"===this.config.theme?"navy":"default",t=THEME_TOKENS[n],s=this.config.buttonColor||t.buttonColor,i=this.config.themeData&&this.config.themeData.primary_color||t.headerBg;const o=`\n      /* Welno RAG Chat Widget Styles */\n      .${this.cssPrefix}-container {\n        position: fixed;\n        z-index: 9999;\n        font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        font-size: 15px;\n        line-height: 1.4;\n        color: #333;\n        box-sizing: border-box;\n      }\n      \n      .${this.cssPrefix}-container *,\n      .${this.cssPrefix}-container *::before,\n      .${this.cssPrefix}-container *::after {\n        box-sizing: border-box;\n      }\n\n      /* ìœ„ì¹˜ë³„ ìŠ¤íƒ€ì¼ */\n      .${this.cssPrefix}-container.position-bottom-right {\n        bottom: 24px;\n        right: 24px;\n      }\n      \n      .${this.cssPrefix}-container.position-bottom-left {\n        bottom: 24px;\n        left: 24px;\n      }\n      \n      .${this.cssPrefix}-container.position-top-right {\n        top: 24px;\n        right: 24px;\n      }\n      \n      .${this.cssPrefix}-container.position-top-left {\n        top: 24px;\n        left: 24px;\n      }\n\n      /* ì±„íŒ… ë²„íŠ¼ */\n      .${this.cssPrefix}-button {\n        width: 56px;\n        height: 56px;\n        min-width: 56px;\n        min-height: 56px;\n        padding: 0;\n        border: none;\n        border-radius: 50%;\n        background: ${s};\n        color: white;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.3s ease;\n        outline: none;\n        overflow: hidden;\n        position: relative;\n      }\n\n      .${this.cssPrefix}-button:hover {\n        transform: scale(1.1);\n        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);\n        filter: brightness(0.9);\n      }\n\n      .${this.cssPrefix}-button.active {\n        filter: brightness(0.9);\n      }\n\n      /* íŒŒíŠ¸ë„ˆ ì•„ì´ì½˜: ì´ë¯¸ì§€ì¼ ë•ŒëŠ” ì›í˜• ë²„íŠ¼ ì „ì²´ë¥¼ ê½‰ ì±„ì›€, SVGëŠ” 24x24 ìœ ì§€ */\n      .${this.cssPrefix}-button .${this.cssPrefix}-icon-slot {\n        position: absolute;\n        inset: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        overflow: hidden;\n      }\n      .${this.cssPrefix}-button .${this.cssPrefix}-icon-slot svg {\n        width: 24px;\n        height: 24px;\n        flex-shrink: 0;\n        display: block;\n      }\n      .${this.cssPrefix}-button .${this.cssPrefix}-icon-slot img {\n        position: absolute;\n        inset: 0;\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        object-position: center;\n        display: block;\n      }\n\n      /* ì±„íŒ… ì°½ */\n      .${this.cssPrefix}-window {\n        position: absolute;\n        bottom: 70px;\n        right: 0;\n        width: 400px; /* 360px -> 400px */\n        height: 650px; /* 550px -> 650px */\n        background: #FFFAF2;\n        border-radius: 20px;\n        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);\n        display: none;\n        flex-direction: column;\n        overflow: hidden;\n        border: 1px solid ${t.borderSubtle};\n        animation: slideInUp 0.3s ease-out;\n      }\n\n      .${this.cssPrefix}-window.open {\n        display: flex;\n      }\n\n      .${this.cssPrefix}-container.position-bottom-left .${this.cssPrefix}-window {\n        right: auto;\n        left: 0;\n      }\n\n      .${this.cssPrefix}-container.position-top-right .${this.cssPrefix}-window {\n        bottom: auto;\n        top: 70px;\n      }\n\n      .${this.cssPrefix}-container.position-top-left .${this.cssPrefix}-window {\n        bottom: auto;\n        top: 70px;\n        right: auto;\n        left: 0;\n      }\n\n      @keyframes slideInUp {\n        from {\n          transform: translateY(20px);\n          opacity: 0;\n        }\n        to {\n          transform: translateY(0);\n          opacity: 1;\n        }\n      }\n\n      /* í—¤ë” */\n      .${this.cssPrefix}-header {\n        background: ${i};\n        color: white;\n        padding: 12px 16px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      }\n\n      .${this.cssPrefix}-header h3 {\n        margin: 0;\n        font-size: 16px;\n        font-weight: 600;\n        letter-spacing: -0.5px;\n      }\n\n      .${this.cssPrefix}-close-button {\n        background: none;\n        border: none;\n        color: white;\n        font-size: 20px;\n        cursor: pointer;\n        padding: 4px;\n        border-radius: 4px;\n        transition: background-color 0.2s;\n      }\n\n      .${this.cssPrefix}-close-button:hover {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      /* ì›°ì»´ ë²„ë¸” - ë·°í¬íŠ¸ ê¸°ì¤€ ê³ ì • ìœ„ì¹˜ë¡œ ê°€ë¡œ ë„ˆë¹„ í™œìš© (!important ì¶”ê°€ë¡œ ê°•ì œ ì ìš©) */\n      .${this.cssPrefix}-welcome-bubble {\n        position: fixed !important;\n        background: white !important;\n        padding: 12px 18px !important;\n        border-radius: 16px !important;\n        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;\n        border: 1px solid ${s} !important;\n        width: max-content !important;\n        min-width: 240px !important;\n        max-width: min(80vw, 320px) !important;\n        white-space: normal !important;\n        word-break: normal !important;\n        opacity: 0;\n        transform: translateY(10px);\n        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n        pointer-events: none;\n        cursor: pointer;\n        z-index: 9998 !important;\n      }\n      .${this.cssPrefix}-container.position-bottom-right .${this.cssPrefix}-welcome-bubble {\n        right: 24px !important;\n        bottom: 96px !important;\n        left: auto !important;\n        top: auto !important;\n      }\n      .${this.cssPrefix}-container.position-bottom-left .${this.cssPrefix}-welcome-bubble {\n        left: 24px !important;\n        bottom: 96px !important;\n        right: auto !important;\n        top: auto !important;\n      }\n      .${this.cssPrefix}-container.position-top-right .${this.cssPrefix}-welcome-bubble {\n        right: 24px !important;\n        top: 96px !important;\n        bottom: auto !important;\n        left: auto !important;\n      }\n      .${this.cssPrefix}-container.position-top-left .${this.cssPrefix}-welcome-bubble {\n        left: 24px !important;\n        top: 96px !important;\n        right: auto !important;\n        bottom: auto !important;\n      }\n\n      .${this.cssPrefix}-welcome-bubble.visible {\n        opacity: 1;\n        transform: translateY(0);\n        pointer-events: auto;\n      }\n\n      .${this.cssPrefix}-welcome-bubble::after {\n        content: '';\n        position: absolute;\n        bottom: -8px;\n        right: 20px;\n        width: 0;\n        height: 0;\n        border-left: 8px solid transparent;\n        border-right: 8px solid transparent;\n        border-top: 8px solid ${s};\n      }\n\n      .${this.cssPrefix}-welcome-bubble::before {\n        content: '';\n        position: absolute;\n        bottom: -6px;\n        right: 21px;\n        width: 0;\n        height: 0;\n        border-left: 7px solid transparent;\n        border-right: 7px solid transparent;\n        border-top: 7px solid white;\n        z-index: 1;\n      }\n\n      .${this.cssPrefix}-welcome-bubble-text {\n        font-weight: 500;\n        color: ${s};\n        font-size: 14px;\n        line-height: 1.4;\n      }\n      @media (max-width: 480px) {\n        .${this.cssPrefix}-welcome-bubble {\n          min-width: 200px;\n          max-width: min(80vw, 320px);\n        }\n      }\n\n      @keyframes bubbleBounce {\n        0%, 100% { transform: translateY(0); }\n        50% { transform: translateY(-5px); }\n      }\n\n      .${this.cssPrefix}-welcome-bubble.visible {\n        animation: bubbleBounce 3s infinite ease-in-out;\n      }\n\n      /* ë©”ì‹œì§€ ì˜ì—­ - ë©”ì‹œì§€ê°€ ì ì„ ë•Œ í•˜ë‹¨ë¶€í„° ìŒ“ì„ (ì±„íŒ… UX) */\n      .${this.cssPrefix}-messages {\n        flex: 1;\n        overflow-y: auto;\n        padding: 20px;\n        background: #FFFAF2;\n        display: flex;\n        flex-direction: column;\n      }\n\n      /* ë©”ì‹œì§€ê°€ ì ì„ ë•Œ ë¹ˆ ê³µê°„ì„ ìœ„ìª½ìœ¼ë¡œ ë°€ì–´ ë©”ì‹œì§€ë¥¼ ì…ë ¥ì°½ ê°€ê¹Œì´ ë°°ì¹˜ */\n      .${this.cssPrefix}-messages::before {\n        content: '';\n        flex: 1 1 auto;\n      }\n\n      .${this.cssPrefix}-message {\n        margin-bottom: 16px;\n        display: flex;\n        flex-direction: column;\n      }\n\n      .${this.cssPrefix}-message.user {\n        align-items: flex-end;\n      }\n\n      .${this.cssPrefix}-message.assistant {\n        align-items: flex-start;\n      }\n\n      .${this.cssPrefix}-message-bubble {\n        max-width: 85%;\n        padding: 12px 16px;\n        border-radius: 18px;\n        word-wrap: break-word;\n        line-height: 1.6;\n        font-size: 14.5px;\n      }\n\n      .${this.cssPrefix}-message.user .${this.cssPrefix}-message-bubble {\n        background: ${s};\n        color: white;\n        border-bottom-right-radius: 2px;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      }\n\n      .${this.cssPrefix}-message.assistant .${this.cssPrefix}-message-bubble {\n        background: #F8EDDA;\n        color: #4A3A34;\n        border-bottom-left-radius: 2px;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);\n      }\n\n      .${this.cssPrefix}-message-bubble ul,\n      .${this.cssPrefix}-message-bubble ol {\n        margin: 4px 0 !important;\n        padding-left: 20px !important;\n        list-style: disc !important;\n      }\n      .${this.cssPrefix}-message-bubble ol {\n        list-style: decimal !important;\n      }\n      .${this.cssPrefix}-message-bubble li {\n        margin: 2px 0 !important;\n        display: list-item !important;\n        line-height: 1.5 !important;\n      }\n\n      .${this.cssPrefix}-message-footer {\n        margin-top: 4px;\n        padding: 0 4px;\n      }\n\n      .${this.cssPrefix}-message-footer-row {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: 8px;\n      }\n\n      .${this.cssPrefix}-message-time {\n        font-size: 11px;\n        color: #999;\n      }\n\n      /* ë¡œë”© ì¸ë””ì¼€ì´í„° (ë§í’ì„  ì—†ì´ ì  ì„¸ ê°œë§Œ) */\n      .${this.cssPrefix}-loading-wrap {\n        display: flex;\n        align-items: center;\n        align-self: flex-start;\n        padding: 8px 0;\n      }\n\n      .${this.cssPrefix}-loading-dots {\n        display: flex;\n        gap: 4px;\n      }\n\n      .${this.cssPrefix}-loading-dot {\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        background: #999;\n        animation: loadingDot 1.4s infinite ease-in-out both;\n      }\n\n      .${this.cssPrefix}-loading-dot:nth-child(1) { animation-delay: -0.32s; }\n      .${this.cssPrefix}-loading-dot:nth-child(2) { animation-delay: -0.16s; }\n\n      @keyframes loadingDot {\n        0%, 80%, 100% {\n          transform: scale(0);\n        }\n        40% {\n          transform: scale(1);\n        }\n      }\n\n      /* ì…ë ¥ ì˜ì—­ */\n      .${this.cssPrefix}-input-area {\n        padding: 16px 20px;\n        background: white;\n        border-top: 1px solid #E5E5E5;\n        display: flex;\n        gap: 12px;\n        align-items: flex-end;\n      }\n\n      .${this.cssPrefix}-input {\n        flex: 1;\n        border: 1px solid #E5E5E5;\n        border-radius: 20px;\n        padding: 10px 16px;\n        font-size: 15px;\n        outline: none;\n        resize: none;\n        min-height: 20px;\n        max-height: 100px;\n        font-family: inherit;\n      }\n\n      .${this.cssPrefix}-input:focus {\n        border-color: ${s};\n      }\n\n      .${this.cssPrefix}-send-button {\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        background: ${s};\n        color: white;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: background-color 0.2s;\n        flex-shrink: 0;\n      }\n\n      .${this.cssPrefix}-send-button:hover {\n        filter: brightness(0.9);\n      }\n\n      .${this.cssPrefix}-send-button:disabled {\n        background: #CCC;\n        cursor: not-allowed;\n      }\n\n      .${this.cssPrefix}-send-button svg {\n        width: 16px;\n        height: 16px;\n      }\n\n      /* ë°˜ì‘í˜•: ëª¨ë°”ì¼ì—ì„œ ì „ì²´ í™”ë©´ ê½‰ ì±„ìš°ê¸° */\n      @media (max-width: 480px) {\n        .${this.cssPrefix}-window {\n          width: 100% !important;\n          height: 100dvh !important;\n          height: 100vh !important;\n          height: -webkit-fill-available !important;\n          bottom: 0 !important;\n          right: 0 !important;\n          top: 0 !important;\n          left: 0 !important;\n          border-radius: 0 !important;\n          max-width: none !important;\n          max-height: none !important;\n          position: fixed !important;\n        }\n\n        .${this.cssPrefix}-window .${this.cssPrefix}-header {\n          padding-top: max(12px, env(safe-area-inset-top));\n          flex-shrink: 0;\n        }\n\n        .${this.cssPrefix}-window .${this.cssPrefix}-messages {\n          flex: 1;\n          min-height: 0;\n          overflow-y: auto;\n          -webkit-overflow-scrolling: touch;\n        }\n\n        .${this.cssPrefix}-window .${this.cssPrefix}-input-area {\n          flex-shrink: 0;\n          padding-bottom: max(16px, env(safe-area-inset-bottom));\n          position: sticky;\n          bottom: 0;\n          z-index: 10;\n          background: white;\n        }\n\n        .${this.cssPrefix}-container {\n          bottom: 0 !important;\n          right: 0 !important;\n          width: 100% !important;\n          height: 100% !important;\n          pointer-events: none; /* ì»¨í…Œì´ë„ˆ ìì²´ëŠ” í´ë¦­ í†µê³¼ */\n        }\n\n        .${this.cssPrefix}-container > * {\n          pointer-events: auto; /* ìì‹ ìš”ì†ŒëŠ” í´ë¦­ ê°€ëŠ¥ */\n        }\n\n        .${this.cssPrefix}-button {\n          bottom: 24px !important;\n          right: 24px !important;\n          position: fixed !important;\n          z-index: 10001;\n        }\n\n        /* ì±„íŒ…ì°½ì´ ì—´ë ¸ì„ ë•Œ í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì»¨í…Œì´ë„ˆ í´ë˜ìŠ¤ ê¸°ì¤€) */\n        .${this.cssPrefix}-container.is-open .${this.cssPrefix}-button {\n          display: none !important;\n        }\n      }\n\n      /* í—¤ë” ê³ ì • ë° ë©”ì‹œì§€ ì˜ì—­ ë…ë¦½ ìŠ¤í¬ë¡¤ ê°•í™” */\n      .${this.cssPrefix}-window {\n        display: none;\n        flex-direction: column;\n        height: 650px;\n        position: relative; /* ìì‹ ìš”ì†Œ í¬ì§€ì…”ë‹ ê¸°ì¤€ */\n      }\n      .${this.cssPrefix}-window.open {\n        display: flex !important;\n      }\n      .${this.cssPrefix}-header {\n        flex-shrink: 0;\n        z-index: 2;\n      }\n      .${this.cssPrefix}-messages {\n        flex: 1;\n        overflow-y: auto;\n        -webkit-overflow-scrolling: touch;\n        padding-bottom: 20px;\n      }\n      .${this.cssPrefix}-input-area {\n        flex-shrink: 0;\n        z-index: 2;\n        background: white;\n      }\n\n      /* ì†ŒìŠ¤ ì•„ì½”ë””ì–¸: ì‹œê°„ ì˜† í† ê¸€ + ì•„ë˜ì— ë¦¬ìŠ¤íŠ¸ í™•ì¥ */\n      .${this.cssPrefix}-sources-toggle {\n        cursor: pointer;\n        display: inline-flex;\n        align-items: center;\n        gap: 3px;\n        padding: 0;\n        border: none;\n        background: none;\n        font-size: 11px;\n        font-weight: 600;\n        color: ${s};\n        user-select: none;\n        white-space: nowrap;\n      }\n      .${this.cssPrefix}-sources-toggle:hover { opacity: 0.7; }\n      .${this.cssPrefix}-sources-chevron {\n        font-size: 7px;\n        display: inline-block;\n        transition: transform 0.2s;\n      }\n      .${this.cssPrefix}-sources-toggle.is-open .${this.cssPrefix}-sources-chevron {\n        transform: rotate(180deg);\n      }\n      .${this.cssPrefix}-sources-list {\n        margin: 6px 0 0 !important;\n        padding: 0 !important;\n        flex-direction: column !important;\n        gap: 4px !important;\n      }\n      .${this.cssPrefix}-sources-list[data-open="false"] {\n        display: none !important;\n      }\n      .${this.cssPrefix}-sources-list[data-open="true"] {\n        display: flex !important;\n      }\n      .${this.cssPrefix}-source {\n        display: block !important;\n        font-size: 12px !important;\n        color: #555 !important;\n        padding: 6px 8px !important;\n        background: rgba(0,0,0,0.04) !important;\n        border-radius: 6px !important;\n        border-left: 2px solid ${s} !important;\n        white-space: normal !important;\n        word-break: break-word !important;\n        line-height: 1.4 !important;\n        visibility: visible !important;\n        opacity: 1 !important;\n        height: auto !important;\n        overflow: visible !important;\n      }\n\n      /* ì œì•ˆ ì§ˆë¬¸ */\n      .${this.cssPrefix}-suggestions {\n        margin-top: 12px;\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n      }\n\n      .${this.cssPrefix}-suggestion {\n        background: #F8F8F8;\n        border: 1px solid #E5E5E5;\n        border-radius: 16px;\n        padding: 6px 12px;\n        font-size: 13px;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .${this.cssPrefix}-suggestion:hover {\n        background: ${s};\n        color: white;\n        border-color: ${s};\n      }\n\n      .${this.cssPrefix}-disclaimer {\n        text-align: center;\n        padding: 6px 12px;\n        margin: 4px 0 12px;\n        font-size: 11px;\n        color: #999;\n        background: #f5f5f5;\n        border-radius: 8px;\n        line-height: 1.5;\n      }\n    `,r=document.createElement("style");r.id=e,r.textContent=o,document.head.appendChild(r)}createDOM(){this.elements.container=document.createElement("div"),this.elements.container.className=`${this.cssPrefix}-container position-${this.config.position}`,this.elements.button=document.createElement("button"),this.elements.button.className=`${this.cssPrefix}-button`,this.elements.button.innerHTML=this.getChatIcon(),this.elements.button.setAttribute("aria-label","ì±„íŒ… ì—´ê¸°"),this.elements.welcomeBubble=document.createElement("div"),this.elements.welcomeBubble.className=`${this.cssPrefix}-welcome-bubble`,this.elements.welcomeBubble.innerHTML=`<div class="${this.cssPrefix}-welcome-bubble-text">ê²€ì§„ ê²°ê³¼ í™•ì¸í•˜ê¸° âœ¨</div>`,this.elements.window=document.createElement("div"),this.elements.window.className=`${this.cssPrefix}-window`;const e=document.createElement("div");e.className=`${this.cssPrefix}-header`,e.innerHTML=`\n      <h3>MediArc</h3>\n      <button class="${this.cssPrefix}-close-button" aria-label="ì±„íŒ… ë‹«ê¸°">Ã—</button>\n    `,this.elements.messagesContainer=document.createElement("div"),this.elements.messagesContainer.className=`${this.cssPrefix}-messages`;const n=document.createElement("div");n.className=`${this.cssPrefix}-input-area`,this.elements.input=document.createElement("textarea"),this.elements.input.className=`${this.cssPrefix}-input`,this.elements.input.placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...",this.elements.input.rows=1,this.elements.sendButton=document.createElement("button"),this.elements.sendButton.className=`${this.cssPrefix}-send-button`,this.elements.sendButton.innerHTML=this.getSendIcon(),this.elements.sendButton.setAttribute("aria-label","ë©”ì‹œì§€ ì „ì†¡"),n.appendChild(this.elements.input),n.appendChild(this.elements.sendButton),this.elements.window.appendChild(e),this.elements.window.appendChild(this.elements.messagesContainer),this.elements.window.appendChild(n),this.elements.container.appendChild(this.elements.welcomeBubble),this.elements.container.appendChild(this.elements.button),this.elements.container.appendChild(this.elements.window),document.body.appendChild(this.elements.container)}bindEvents(){this.elements.button.addEventListener("click",()=>{this.state.isOpen?this.close():this.open()}),this.elements.welcomeBubble.addEventListener("click",()=>{this.open(),this.elements.welcomeBubble.classList.remove("visible")});this.elements.window.querySelector(`.${this.cssPrefix}-close-button`).addEventListener("click",()=>this.close()),this.elements.sendButton.addEventListener("click",()=>this.sendMessage()),this.elements.input.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),this.elements.input.addEventListener("input",()=>{this.elements.input.style.height="auto",this.elements.input.style.height=Math.min(this.elements.input.scrollHeight,100)+"px"}),document.addEventListener("click",e=>{this.state.isOpen&&this.elements.container.contains(e.target)}),window.innerWidth<=480&&window.visualViewport&&(this._handleViewportResize=()=>{if(!this.state.isOpen)return;const e=window.visualViewport.height;window.innerHeight-e>50?(this.elements.window.style.height=`${e}px`,this.elements.window.style.top=`${window.visualViewport.offsetTop}px`,this.scrollToBottom()):(this.elements.window.style.height="",this.elements.window.style.top="")},window.visualViewport.addEventListener("resize",this._handleViewportResize),window.visualViewport.addEventListener("scroll",this._handleViewportResize)),this.elements.input.addEventListener("focus",()=>{setTimeout(()=>this.scrollToBottom(),300)})}open(){this.state.isOpen||(this.state.isOpen=!0,this.elements.window.classList.add("open"),this.elements.container.classList.add("is-open"),this.elements.button.classList.add("active"),this.elements.button.innerHTML=this.getCloseIcon(),this.elements.welcomeBubble&&this.elements.welcomeBubble.classList.remove("visible"),window.innerWidth<=480&&(this._prevBodyOverflow=document.body.style.overflow,document.body.style.overflow="hidden"),setTimeout(()=>{this.elements.input.focus()},300),this.config.onOpen&&this.config.onOpen())}close(){this.state.isOpen&&(this.state.isOpen=!1,this.elements.window.classList.remove("open"),this.elements.container.classList.remove("is-open"),this.elements.button.classList.remove("active"),this.elements.button.innerHTML=this.getChatIcon(),window.innerWidth<=480&&(document.body.style.overflow=this._prevBodyOverflow||"",this.elements.window.style.height="",this.elements.window.style.top=""),this.config.onClose&&this.config.onClose())}async sendMessage(){const e=this.elements.input.value.trim();if(e&&!this.state.isLoading)try{this.addMessage("user",e),this.elements.input.value="",this.elements.input.style.height="auto",this.setLoading(!0),await this.callPartnerAPI(e)}catch(e){console.error("[WelnoRagChatWidget] ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:",e),"AbortError"===e.name?this.handleError("ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",e):this.handleError("ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",e)}finally{this.setLoading(!1)}}async callPartnerAPI(e){const n={uuid:this.config.uuid,hospital_id:this.config.hospitalId,message:e,session_id:this.state.sessionId};this.config.partnerData&&(n.health_data=this.config.partnerData);const t=new AbortController,s=setTimeout(()=>t.abort(),3e4),i=await fetch(`${this.config.baseUrl}/welno-api/v1/rag-chat/partner/message`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify(n),signal:t.signal});if(clearTimeout(s),!i.ok){const e=await i.json().catch(()=>({}));throw new Error(e.detail||`HTTP ${i.status}: ${i.statusText}`)}await this.handleStreamingResponse(i)}async handleStreamingResponse(e){const n=e.body.getReader(),t=new TextDecoder;let s="",i="",o=null;const r=e=>{if(e.startsWith("data: "))try{const n=JSON.parse(e.slice(6));n.answer&&(i+=n.answer,o||(o=this.addMessage("assistant","")),this.updateMessageContent(o,i)),n.done&&(n.sources&&n.sources.length>0&&this.addSources(o,n.sources),n.suggestions&&n.suggestions.length>0&&this.addSuggestions(o,n.suggestions),this.state.assistantMsgCount++,1===this.state.assistantMsgCount&&this.addDisclaimer())}catch(n){console.error("[WelnoWidget] SSE íŒŒì‹± ì—ëŸ¬:",n.message,"| line:",e.substring(0,200))}};try{for(;;){const{done:e,value:i}=await n.read();if(e)break;s+=t.decode(i,{stream:!0});const o=s.split("\n");s=o.pop()||"";for(const e of o)r(e.trim())}s.trim()&&r(s.trim())}finally{n.releaseLock()}}_renderMessageHtml(e){if(null==e||""===e)return"";for(var n=String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),t=(n=n.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).split("\n"),s=[],i=!1,o=!1,r=0;r<t.length;r++){var a=t[r],l=a.match(/^\s*[*\-]\s+(.+)$/),c=l?null:a.match(/^\s*(\d+)[.)]\s+(.+)$/);l?(o&&(s.push("</ol>"),o=!1),i||(s.push("<ul>"),i=!0),s.push("<li>"+l[1]+"</li>")):c?(i&&(s.push("</ul>"),i=!1),o||(s.push("<ol>"),o=!0),s.push("<li>"+c[2]+"</li>")):(i&&(s.push("</ul>"),i=!1),o&&(s.push("</ol>"),o=!1),""===a.trim()?s.push("<br>"):s.push(a+"<br>"))}return i&&s.push("</ul>"),o&&s.push("</ol>"),s.join("")}addMessage(e,n){const t=document.createElement("div");t.className=`${this.cssPrefix}-message ${e}`;const s=document.createElement("div");s.className=`${this.cssPrefix}-message-bubble`,s.innerHTML=this._renderMessageHtml(n);const i=document.createElement("div");i.className=`${this.cssPrefix}-message-footer`;const o=document.createElement("div");o.className=`${this.cssPrefix}-message-footer-row`;const r=document.createElement("div");return r.className=`${this.cssPrefix}-message-time`,r.textContent=(new Date).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"}),o.appendChild(r),i.appendChild(o),t.appendChild(s),t.appendChild(i),this.elements.messagesContainer.appendChild(t),this.scrollToBottom(),this.state.messages.push({role:e,content:n,timestamp:(new Date).toISOString()}),this.config.onMessage&&this.config.onMessage({role:e,content:n}),t}updateMessageContent(e,n){e.querySelector(`.${this.cssPrefix}-message-bubble`).innerHTML=this._renderMessageHtml(n),this._scrollRAF||(this._scrollRAF=requestAnimationFrame(()=>{this._scrollRAF=null;const e=this.elements.messagesContainer;if(!e)return;e.scrollHeight-e.scrollTop-e.clientHeight<80&&(e.scrollTop=e.scrollHeight)}))}addSources(e,n){if(!n||0===n.length)return;if(!e)return;const t=this.cssPrefix,s=document.createElement("span");s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.className=`${t}-sources-toggle`,s.innerHTML=`<span>ì°¸ê³  ë¬¸í—Œ</span><span class="${t}-sources-chevron" aria-hidden="true">â–¼</span>`;const i=document.createElement("div");i.className=`${t}-sources-list`,i.setAttribute("data-open","true"),s.classList.add("is-open"),n.forEach(e=>{const n=document.createElement("div");n.className=`${t}-source`;let s="";e.category?s+=`[${e.category}] `:"hospital"===e.source_type&&(s+="[ë³‘ì› ìë£Œ] "),s+=e.title||"ì°¸ê³ ìë£Œ",e.page&&(s+=` (p.${e.page})`),n.textContent=s,n.title=(e.text||"").substring(0,200),i.appendChild(n)}),s.onclick=function(e){e.preventDefault(),e.stopPropagation();var n="true"===i.getAttribute("data-open");return i.setAttribute("data-open",n?"false":"true"),s.classList.toggle("is-open"),!1};const o=e.querySelector(`.${t}-message-footer-row`),r=e.querySelector(`.${t}-message-footer`);o&&o.appendChild(s),r?r.appendChild(i):e.appendChild(i);const a=e.querySelector(`.${t}-message-bubble`);a&&r&&(r.style.width=a.offsetWidth+"px")}addSuggestions(e,n){if(!n||0===n.length)return;const t=document.createElement("div");t.className=`${this.cssPrefix}-suggestions`,n.slice(0,3).forEach(e=>{const n=document.createElement("button");n.className=`${this.cssPrefix}-suggestion`,n.textContent=e,n.addEventListener("click",()=>{this.elements.input.value=e,this.elements.input.focus()}),t.appendChild(n)}),e.appendChild(t)}addDisclaimer(){const e=document.createElement("div");e.className=`${this.cssPrefix}-disclaimer`,e.textContent="ë³¸ ì„œë¹„ìŠ¤ëŠ” ì°¸ê³ ìš©ì´ë©°, ì˜í•™ì  ìë¬¸ì´ë‚˜ ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ì „ë¬¸ ì˜ë£Œì§„ê³¼ ìƒë‹´í•˜ì„¸ìš”.",this.elements.messagesContainer.appendChild(e),this.scrollToBottom()}setLoading(e){if(this.state.isLoading=e,this.elements.sendButton.disabled=e,e){const e=document.createElement("div");e.className=`${this.cssPrefix}-loading-wrap`,e.id="loading-indicator",e.innerHTML=`\n        <div class="${this.cssPrefix}-loading-dots">\n          <div class="${this.cssPrefix}-loading-dot"></div>\n          <div class="${this.cssPrefix}-loading-dot"></div>\n          <div class="${this.cssPrefix}-loading-dot"></div>\n        </div>\n      `,this.elements.messagesContainer.appendChild(e),this.scrollToBottom()}else{const e=document.getElementById("loading-indicator");e&&e.remove()}}scrollToBottom(){requestAnimationFrame(()=>{const e=this.elements.messagesContainer;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})})}handleError(e,n){console.error("[WelnoRagChatWidget] ì—ëŸ¬:",n),this.addMessage("assistant",`ì£„ì†¡í•©ë‹ˆë‹¤. ${e}`),this.config.onError&&this.config.onError(n)}getChatIcon(){const e=`${this.cssPrefix}-icon-slot`;return this.config.chatIconUrl?`<span class="${e}"><img src="${this.config.chatIconUrl}" alt="ì±„íŒ… ì—´ê¸°" /></span>`:`\n      <span class="${e}">\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n          <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n        </svg>\n      </span>\n    `}getCloseIcon(){return'\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n      </svg>\n    '}getSendIcon(){return'\n      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">\n        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n      </svg>\n    '}async warmup(){if(this.config.partnerData)try{const e=await fetch(`${this.config.baseUrl}/welno-api/v1/rag-chat/partner/warmup`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({uuid:this.config.uuid,hospital_id:this.config.hospitalId,health_data:this.config.partnerData})});if(e.ok){const n=await e.json();if(n.session_id&&(this.state.sessionId=n.session_id),n.greeting){const e=(n.greeting||"").replace(/<br\s*\/?>/gi," ").replace(/\s+/g," ").trim();this.elements.welcomeBubble.querySelector(`.${this.cssPrefix}-welcome-bubble-text`).textContent=e,setTimeout(()=>{this.state.isOpen||this.elements.welcomeBubble.classList.add("visible")},1e3)}}}catch(e){console.warn("[WelnoRagChatWidget] ì›œì—… ì‹¤íŒ¨:",e)}}destroy(){this._handleViewportResize&&window.visualViewport&&(window.visualViewport.removeEventListener("resize",this._handleViewportResize),window.visualViewport.removeEventListener("scroll",this._handleViewportResize)),window.innerWidth<=480&&(document.body.style.overflow=this._prevBodyOverflow||""),this.elements.container&&this.elements.container.parentNode&&this.elements.container.parentNode.removeChild(this.elements.container);const e=document.getElementById(`${this.cssPrefix}-styles`);e&&!document.querySelector(`.${this.cssPrefix}-container`)&&e.remove(),this.state.isInitialized=!1}}"undefined"!=typeof module&&module.exports?(module.exports=WelnoRagChatWidget,module.exports.default=WelnoRagChatWidget):"function"==typeof define&&define.amd?define([],function(){return WelnoRagChatWidget}):window.WelnoRagChatWidget=WelnoRagChatWidget;