# 검진 설계 시스템 - 정확한 현재 상황 분석

## 실행 시간: 2025-12-05 20:25

---

## 1. 실제 로그 데이터 분석 결과

### 응답 데이터 (gpt_response_20251205_201753.json)

#### priority_1 구조
```json
{
  "title": "1순위: 관리하실 항목이에요",
  "description": "일반검진 결과지를 확인하실 때...",
  "items": ["혈압", "허리둘레"],
  "national_checkup_items": ["혈압", "허리둘레"],
  "national_checkup_note": "일반검진 결과지를 확인하실 때, 혈압과 허리둘레가 경계 이상으로 나타났으므로 잘 살펴보시길 바랍니다.",
  "focus_items": [
    {
      "item_name": "혈압측정",
      "why_important": "혈압이 경계 이상으로 나타났으므로...",
      "check_point": "정기적으로 혈압을 측정하고..."
    }
  ]
}
```

#### recommended_items (2개 카테고리)

**심혈관검진 (priority: 2)**
- 경동맥 초음파
  - reason: "과거 검진에서 혈압이 경계 이상이었고, 가족력으로 고혈압이 확인되었으므로 이 검진이 필요합니다."
  - evidence: "※ 대한고혈압학회 가이드라인, Level A 에비던스"
- 심장 초음파
  - reason: "과거 검진에서 혈압이 경계 이상이었고, 가족력으로 심장질환이 확인되었으므로 이 검진이 필요합니다."
  - evidence: "※ 대한심장학회 가이드라인, Level A 에비던스"

**대사검진 (priority: 3)**
- 간 섬유화 스캔
  - reason: "과거 검진에서 허리둘레가 경계 이상이었고, 가족력으로 당뇨가 확인되었으므로 이 검진이 필요합니다."
  - evidence: "※ 대한소화기학회 가이드라인, Level A 에비던스"
- 인슐린 저항성 검사
  - reason: "과거 검진에서 허리둘레가 경계 이상이었고, 가족력으로 당뇨가 확인되었으므로 이 검진이 필요합니다."
  - evidence: "※ 대한당뇨학회 가이드라인, Level A 에비던스"

---

## 2. 확인된 정확한 문제점

### 🔴 문제 1: priority_1.items와 focus_items 항목명 불일치 (최심각)

**현상:**
- priority_1.items = `['혈압', '허리둘레']` (2개)
- focus_items = `[{item_name: '혈압측정'}]` (1개)

**세부 문제:**
1. **항목명 불일치**: '혈압' ≠ '혈압측정'
2. **항목 누락**: '허리둘레'가 focus_items에 완전히 없음
3. **개수 불일치**: items는 2개인데 focus_items는 1개

**화면 영향:**
- "주요 사항은 아래와 같아요" 섹션: ['혈압', '허리둘레'] 표시
- "관리하실 항목이에요" 섹션: ['혈압측정']만 표시
- → 사용자가 "허리둘레를 보라고 했는데 왜 설명이 없지?" 혼란

**근본 원인:**
- `merge_checkup_design_responses` 함수에 일관성 검증 로직 없음
- LLM이 프롬프트 지시사항을 부분적으로 무시함
- DB의 정확한 항목명('혈압측정') vs LLM이 생성한 일반명('혈압') 매칭 실패

---

### 🔴 문제 2: 가족력(당뇨) 반영 누락 (최심각)

**현상:**
- 문진에서 가족력(당뇨) 확인됨
- priority_1.items = `['혈압', '허리둘레']`
- → **'혈당검사' 없음**

**의학적 문제:**
- 당뇨 가족력이 있는데 혈당검사를 priority_1에서 제외함
- 이는 의학적으로 중요한 항목을 누락하는 것

**현재 로직:**
- 프롬프트에 지시사항만 있음: "가족력에 당뇨가 있으면 '혈당검사'를 priority_1.items에 포함"
- LLM이 이를 무시함
- 코드 레벨 강제 로직 없음

---

### 🟡 문제 3: focus_items 완전성 보장 실패 (중요)

**현상:**
- priority_1.items에 있는 모든 항목이 focus_items에 있어야 함
- 현재: '허리둘레'가 focus_items에 없음

**영향:**
- "주요 사항"에 '허리둘레'가 표시되지만
- "관리하실 항목" 섹션에서 왜 중요한지, 어떻게 확인해야 하는지 설명 없음

---

### 🟡 문제 4: recommended_items의 reason이 드라이함 (중요)

**현상:**
```
reason: "과거 검진에서 혈압이 경계 이상이었고, 가족력으로 고혈압이 확인되었으므로 이 검진이 필요합니다."
```

**문제점:**
- 너무 기계적이고 딱딱함
- 의학적 맥락 부족 (왜 경동맥 초음파가 필요한지 구체적 설명 없음)
- "경계 이상" → "뇌졸중 위험"으로 연결되는 논리 누락

**원인:**
- RAG 검색 결과가 50자로 너무 짧음
- LLM이 기본적인 템플릿만 사용

---

### 🟡 문제 5: evidence가 일반적이고 출처 불명확 (중요)

**현상:**
```
evidence: "※ 대한고혈압학회 가이드라인, Level A 에비던스"
```

**문제점:**
- 어느 가이드라인인지 모름 (2024년? 2025년? 고혈압 진료지침?)
- 어느 섹션인지 모름
- 실제 내용이 무엇인지 모름
- URL 없음

**원인:**
- RAG 검색 결과의 메타데이터(source_nodes) 활용 안함
- `response.response`만 추출

---

### 🟢 문제 6: RAG 검색 결과가 50자로 매우 짧음 (개선 필요)

**현상:**
- RAG 검색 결과: 50자
- 실제 내용: "**⚠️ 매우 중요: 아래 내용에 기반해서만 답변하세요. 이 내용이 최우선 근거입니다.**"

**원인:**
- 검색 쿼리가 너무 일반적: "환자 위험 요인에 대한 의학 가이드라인: {patient_summary}"
- 벡터 DB 데이터 부족 가능성
- LlamaCloud 설정 문제 가능성

---

### 🟢 문제 7: 통합 로깅 없음 (개선 필요)

**현상:**
- 프롬프트: `gpt_prompt_*.json`
- 응답: `gpt_response_*.json`
- 입력 데이터: 로그 없음

**문제점:**
- 디버깅 시 파일 3개를 매칭해야 함
- 입력 데이터(health_data, prescription_data 등) 추적 불가

---

### ✅ 정상 동작 확인

1. **national_checkup_note 존재함**
   - "일반검진 결과지를 확인하실 때, 혈압과 허리둘레가 경계 이상으로 나타났으므로 잘 살펴보시길 바랍니다."
   - 간호사 노트는 생성되고 있음

2. **recommended_items에 evidence 포함됨**
   - 비록 일반적이지만 evidence 필드는 생성됨

3. **strategies 생성됨**
   - Bridge Strategy 구조 사용됨

---

## 3. 코드 레벨 원인 분석

### 원인 1: `merge_checkup_design_responses`에 검증 로직 없음

**위치:** `planning-platform/backend/app/api/v1/endpoints/checkup_design.py:1007-1095`

**문제:**
```python
def merge_checkup_design_responses(step1_result, step2_result):
    # ... 단순 병합만 수행 ...
    merged_result = {
        "summary": safe_get(step2_result, "summary", {}),
        # ...
    }
    
    # ❌ priority_1.items와 focus_items 일관성 검증 없음
    # ❌ 가족력 반영 검증 없음
    # ❌ focus_items 완전성 검증 없음
    
    return merged_result
```

**해결 필요:**
- Post-processing 검증 함수 추가
- 불일치 시 자동 보정 또는 에러

### 원인 2: 가족력 매핑 로직이 코드에 없음

**위치:** 전체 코드베이스

**문제:**
- 가족력 → 검진 항목 매핑이 프롬프트 지시사항에만 의존
- LLM이 이를 무시해도 강제할 방법 없음

**해결 필요:**
- 가족력 매핑 테이블 추가
- 코드 레벨에서 강제 추가 로직

### 원인 3: RAG 검색 쿼리가 너무 일반적

**위치:** `planning-platform/backend/app/services/checkup_design_prompt.py:346-383`

**문제:**
```python
base_query = f"환자 위험 요인에 대한 의학 가이드라인: {patient_summary}"
```

**해결 필요:**
- 더 구체적인 쿼리 생성
- 연령, 성별, 구체적 위험 요인 포함

### 원인 4: RAG 메타데이터 미활용

**위치:** `planning-platform/backend/app/services/checkup_design_prompt.py:324-398`

**문제:**
```python
async def get_medical_evidence_from_rag(...) -> str:
    # ...
    evidence_parts.append(f"## {concern_name} 관련 가이드라인\n{concern_response.response}\n")
    # ❌ source_nodes, metadata 무시
    return "\n".join(evidence_parts)
```

**해결 필요:**
- `response.source_nodes`에서 메타데이터 추출
- 구조화된 에비던스 객체 반환

---

## 4. 정확한 TODO 리스트 (우선순위)

### Phase 1: 핵심 로직 보강 (즉시 필요)

#### TODO 1: priority_1 일관성 검증 및 자동 보정
- **우선순위**: 🔴 최고
- **위치**: `checkup_design.py` - `merge_checkup_design_responses` 함수
- **작업**:
  1. `validate_and_fix_priority1_consistency()` 함수 추가
  2. items와 focus_items 일관성 검증
  3. 불일치 시 자동 보정 (focus_items에 누락된 항목 추가)
  4. 항목명 정규화 (DB 항목명 매칭)
- **예상 코드 라인**: ~100 lines

#### TODO 2: 가족력 → 검진 항목 강제 매핑
- **우선순위**: 🔴 최고
- **위치**: 새 파일 `family_history_mapper.py` + `checkup_design.py` 통합
- **작업**:
  1. 가족력 매핑 테이블 작성
     ```python
     FAMILY_HISTORY_MAPPING = {
         "당뇨": ["혈당검사", "당화혈색소"],
         "고혈압": ["혈압측정"],
         # ...
     }
     ```
  2. `ensure_family_history_items()` 함수 추가
  3. priority_1.items 생성 후 강제로 추가
  4. RAG 검증 로직 (선택적)
- **예상 코드 라인**: ~150 lines

#### TODO 3: focus_items 완전성 보장
- **우선순위**: 🔴 최고
- **위치**: `checkup_design.py` - `merge_checkup_design_responses` 함수
- **작업**:
  1. priority_1.items의 모든 항목이 focus_items에 있는지 검증
  2. 누락된 항목에 대해 기본 focus_item 생성
  3. Master DB 또는 LLM으로 why_important, check_point 생성
- **예상 코드 라인**: ~80 lines

#### TODO 4: 통합 로깅 시스템
- **우선순위**: 🟡 높음
- **위치**: 새 파일 `unified_logging.py` + `checkup_design.py` 통합
- **작업**:
  1. `save_unified_execution_log()` 함수 추가
  2. 입력, 프롬프트, 응답, 파싱 결과를 한 파일에 저장
  3. 구조화된 JSON 형식
- **예상 코드 라인**: ~100 lines

### Phase 2: RAG 시스템 개선

#### TODO 5: RAG 검색 쿼리 구체화
- **우선순위**: 🟡 높음
- **위치**: `checkup_design_prompt.py` - `get_medical_evidence_from_rag` 함수
- **작업**:
  1. 연령, 성별, 구체적 위험 요인 포함한 쿼리 생성
  2. 다단계 검색 (broad → specific)
  3. 검색 결과 부족 시 재검색
- **예상 코드 라인**: ~120 lines

#### TODO 6: RAG 메타데이터 활용 및 에비던스 강화
- **우선순위**: 🟡 높음
- **위치**: `checkup_design_prompt.py` - `get_medical_evidence_from_rag` 함수
- **작업**:
  1. `response.source_nodes`에서 메타데이터 추출
  2. 구조화된 에비던스 객체 반환
  3. 프롬프트에 상세 출처 포함
  4. 계층적 에비던스 생성 (RAG → Master DB → 모델 보강)
- **예상 코드 라인**: ~200 lines

### Phase 3: 프롬프트 및 UX 개선

#### TODO 7: 프롬프트 최적화
- **우선순위**: 🟢 중간
- **위치**: `checkup_design_prompt.py` - `create_checkup_design_prompt_step2` 함수
- **작업**:
  1. 핵심 지시사항 상단 배치 + 반복
  2. 부정 예시 추가 (❌ 틀린 예시)
  3. Constraint Verification Step 추가
- **예상 코드 라인**: ~50 lines (프롬프트 수정)

#### TODO 8: recommended_items reason 상세화
- **우선순위**: 🟢 중간
- **위치**: `checkup_design_prompt.py` - 프롬프트 + LLM 보강 함수
- **작업**:
  1. reason 템플릿 개선
  2. 의학적 논리 연결 강화 (예: 경계 → 합병증 위험)
  3. RAG 결과 부족 시 모델 보강
- **예상 코드 라인**: ~100 lines

---

## 5. 작업 순서 및 예상 시간

### Phase 1 (즉시 시작)
1. **TODO 1**: priority_1 일관성 검증 - 1-2시간
2. **TODO 2**: 가족력 강제 매핑 - 1-2시간
3. **TODO 3**: focus_items 완전성 보장 - 1시간
4. **TODO 4**: 통합 로깅 - 1시간

**Phase 1 완료 후 테스트 요청**

### Phase 2 (Phase 1 완료 후)
5. **TODO 5**: RAG 쿼리 구체화 - 2시간
6. **TODO 6**: RAG 메타데이터 & 에비던스 강화 - 2-3시간

**Phase 2 완료 후 테스트 요청**

### Phase 3 (Phase 2 완료 후)
7. **TODO 7**: 프롬프트 최적화 - 1시간
8. **TODO 8**: reason 상세화 - 1-2시간

---

## 6. 예상 효과

### Phase 1 완료 시
- ✅ priority_1.items와 focus_items 완전 일치
- ✅ 가족력 반영 보장 (당뇨 → 혈당검사 자동 포함)
- ✅ "주요 사항"의 모든 항목이 "관리하실 항목"에 표시
- ✅ 디버깅 시간 50% 단축 (통합 로그)

### Phase 2 완료 시
- ✅ 에비던스 품질 향상 (문서명, 섹션, 내용 포함)
- ✅ RAG 검색 결과 길이 증가 (50자 → 500자+)
- ✅ 출처 명확화

### Phase 3 완료 시
- ✅ 추천 이유 설득력 증가
- ✅ 전체적인 논리성 강화
- ✅ 사용자 신뢰도 향상

---

**작성자**: AI Assistant  
**날짜**: 2025-12-05 20:25  
**다음 단계**: Phase 1 작업 시작 승인 대기
