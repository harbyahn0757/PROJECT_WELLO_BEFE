
# 검진 설계 개선 방안 상세 검토

## 📋 현재 상황

### 현재 구조 (1회 호출)
```
STEP 1 (gpt-4o-mini)
└─ 분석 + 위험도 평가
   ↓ (15초)
   
STEP 2 (gpt-4o)
└─ RAG (9개 에비던스) + 전체 검진 설계
   ↓ (25초)
   
총 40초 → 한 번에 화면 표시
```

### 문제점
1. ❌ 프롬프트 너무 길어서 (21KB) 세밀한 지침 무시
2. ❌ "A는 기본입니다. 하지만 B가 필요합니다." 패턴 반복
3. ❌ 5가지 스타일 적용 안됨
4. ❌ 업셀링 메시지 약함

---

## 🎯 제안 방안 1: RAG 강화 + GPT 분할 호출

### 새로운 구조
```
STEP 1 (gpt-4o-mini)
└─ 분석 + 위험도 평가
   ↓ (15초)

STEP 2-A: RAG 검색 (병렬)
├─ 가족력별 에비던스 (5-10개 쿼리)
├─ 만성질환별 에비던스 (3-5개 쿼리)
├─ 선택 항목별 에비던스 (2-3개 쿼리)
└─ 총 10-18개 쿼리 → 풍부한 에비던스
   ↓ (10초, 병렬 처리)

STEP 2-B: Priority 1 설계 (gpt-4o)
└─ 일반검진 주의 항목만 집중
   ↓ (5초) → 🎨 화면 표시 1
   
STEP 2-C: Priority 2 설계 (gpt-4o)
└─ 병원 추천 항목만 집중
   ↓ (7초) → 🎨 화면 표시 2
   
STEP 2-D: Priority 3 설계 (gpt-4o)
└─ 선택 검진 항목만 집중
   ↓ (5초) → 🎨 화면 표시 3
   
STEP 2-E: Strategies 생성 (gpt-4o)
└─ 업셀링 전략만 집중
   ↓ (8초) → 🎨 화면 표시 4

총 50초 → 점진적 화면 표시 (4단계)
```

### 장점 ✅
1. **각 호출마다 프롬프트 짧아짐** (5KB 이하)
   - 세밀한 지침 준수 가능
   - 5가지 스타일 적용 가능
   
2. **사용자 경험 개선**
   - 40초 대기 → 5초마다 결과 표시
   - 진행 상황 투명성
   
3. **RAG 에비던스 풍부**
   - 9개 → 20-30개로 증가 가능
   - 각 항목별 구체적 근거

4. **업셀링 강화**
   - 각 Priority별 최적화된 메시지
   - 독립된 호출로 집중도 높임

### 단점 ❌
1. **API 호출 증가**
   - 2회 → 5회 (비용 2.5배)
   
2. **총 시간 증가**
   - 40초 → 50초 (25% 증가)
   
3. **구현 복잡도**
   - 백엔드: 5개 엔드포인트 또는 상태 관리
   - 프론트엔드: 점진적 렌더링 로직

---

## 🎯 제안 방안 2: Streaming Response (OpenAI Stream API)

### 새로운 구조
```
STEP 2 (gpt-4o, streaming=True)
└─ 한 번 호출하되, 응답을 실시간 스트리밍
   ↓
   {
     "priority_1": {...}  → 🎨 즉시 표시
   }
   ↓ (5초 후)
   {
     "priority_2": {...}  → 🎨 즉시 표시
   }
   ↓ (5초 후)
   {
     "priority_3": {...}  → 🎨 즉시 표시
   }
```

### 장점 ✅
1. **API 호출 1회** (비용 동일)
2. **점진적 표시** (UX 개선)
3. **구현 중간 복잡도**

### 단점 ❌
1. **프롬프트 여전히 길다** (21KB)
   - 스타일 지침 무시 가능
2. **JSON streaming 파싱 복잡**

---

## 🎯 제안 방안 3: 하이브리드 (추천!) ⭐

### 새로운 구조
```
STEP 1 (gpt-4o-mini)
└─ 분석 (현재와 동일)
   ↓ (15초)

STEP 2-RAG (병렬 검색)
└─ 풍부한 에비던스 수집 (20-30개)
   ↓ (10초)

STEP 2-1: Summary + Priority 1 (gpt-4o)
├─ 프롬프트: 5KB (RAG 에비던스 + Priority 1 지침만)
└─ 출력: summary + priority_1 + focus_items
   ↓ (8초) → 🎨 화면 표시 1

STEP 2-2: Priority 2 + Priority 3 + Strategies (gpt-4o)
├─ 프롬프트: 8KB (RAG 에비던스 + STEP 2-1 결과 요약 + 업셀링 지침)
└─ 출력: priority_2 + priority_3 + strategies + doctor_comment
   ↓ (12초) → 🎨 화면 표시 2

총 45초, API 3회
```

### 장점 ✅
1. **프롬프트 적정 길이** (5-8KB)
   - 지침 준수율 높음
   - 스타일 다양화 가능
   
2. **비용 합리적**
   - 2회 → 3회 (50% 증가)
   
3. **UX 개선**
   - 2단계 점진 표시
   - 핵심 먼저, 업셀링 나중
   
4. **구현 난이도 중간**

### 단점 ❌
1. **API 1회 추가**
2. **프론트엔드 수정 필요**

---

## 📊 방안 비교표

| 항목 | 현재 | 방안1 (5회) | 방안2 (Stream) | 방안3 (3회) ⭐ |
|------|------|------------|---------------|--------------|
| API 호출 | 2회 | 5회 | 2회 | 3회 |
| 총 시간 | 40초 | 50초 | 40초 | 45초 |
| 프롬프트 길이 | 21KB | 5KB | 21KB | 5-8KB |
| 점진적 표시 | ❌ | ✅ (4단계) | ✅ (실시간) | ✅ (2단계) |
| 스타일 다양화 | ❌ | ✅ | △ | ✅ |
| 구현 난이도 | - | 높음 | 중간 | 중간 |
| 비용 증가 | - | 150% | 0% | 50% |

---

## 💡 권장 방안: **방안 3 (하이브리드)** ⭐

### 이유
1. ✅ 프롬프트 길이 문제 해결 (5-8KB)
2. ✅ 스타일 다양화 가능
3. ✅ 점진적 표시로 UX 개선
4. ✅ 비용 합리적 (50% 증가)
5. ✅ 구현 난이도 적정

### 구현 순서
1. **백엔드**: STEP 2를 2-1, 2-2로 분할
2. **프론트엔드**: ProcessingModal 단계 추가
3. **테스트**: 각 단계별 응답 확인

---

## 🔧 기술적 세부사항

### 프론트엔드 변경 (ProcessingModal 활용)
```typescript
// 현재
processingStage: 'preparing' | 'analyzing' | 'designing' | 'finalizing'

// 개선
processingStage: 
  | 'preparing'    // 데이터 준비
  | 'analyzing'    // STEP 1 분석
  | 'searching'    // RAG 검색
  | 'priority1'    // Priority 1 설계 → 화면 표시 1
  | 'upselling'    // Priority 2,3 + Strategies → 화면 표시 2
  | 'complete'
```

### 백엔드 변경
```python
# 엔드포인트 분할
POST /api/v1/checkup-design/create-step2-priority1
POST /api/v1/checkup-design/create-step2-upselling

# 또는 단일 엔드포인트 + 단계별 반환
POST /api/v1/checkup-design/create-step2-progressive
→ yield priority1_result
→ yield upselling_result
```

---

## ⚖️ 최종 의견

**방안 3 (하이브리드, 3회 호출)**이 가장 현실적입니다.

- 프롬프트 길이 문제 해결
- 사용자 경험 개선
- 비용 합리적
- 구현 가능

진행하시겠습니까?

