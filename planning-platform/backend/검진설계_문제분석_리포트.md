# 검진 설계 시스템 문제 분석 리포트

## 실행 시간: 2025-12-05 20:20

---

## 1. 사용자 피드백 요약

### 1.1 RAG 에비던스 문제
- **문제**: 에비던스가 있으면 출처만이 아니라 실제 에비던스 내용을 보여줘야 함
- **현상**: RAG 검색 결과가 50자로 매우 짧음
- **요구사항**: 어느 문서에 어떤 내용이 있었는지까지 RAG가 가져와야 함

### 1.2 가족력 반영 문제
- **문제**: 가족력(당뇨)이 있는데 priority_1.items에 '혈당검사'가 없음
- **현상**: 프롬프트에 지시사항이 있지만 실제로 반영되지 않음
- **요구사항**: 
  * RAG 데이터를 먼저 확인
  * 없으면 모델을 한번 더 써서라도 확인
  * 병렬 처리 가능
  * 억지로 끼워맞추지 말고 의학적으로 타당한지 확인

### 1.3 항목명 일관성 문제
- **문제**: priority_1.items = ['혈압', '허리둘레'], focus_items = [{item_name: '혈압측정'}]
- **현상**: '혈압' vs '혈압측정' - 이름이 정확히 일치하지 않음
- **요구사항**: "혈압"이면 그냥 "혈압"으로 통일, 엄격하게 처리

### 1.4 priority_2/3 추천 이유 부족
- **문제**: 경동맥 초음파, 심장 초음파를 왜 추천하는지 이유가 드라이함
- **현상**: "과거 검진에서 허리둘레가 경계 이상이었고, 가족력으로 당뇨가 확인되었으므로"
- **요구사항**: 에비던스 기반으로 더 상세하게, 필요하면 모델을 한번 더 돌려서라도 다채롭게

### 1.5 focus_items 누락
- **문제**: "주요 사항"에 '혈압', '허리둘레'가 표시되었지만 "관리하실 항목"에는 '혈압측정'만 있음
- **현상**: priority_1.items와 focus_items 불일치
- **요구사항**: "주요 사항"에 나온 게 다 "관리하실 항목"에 나와야 함

### 1.6 만성질환 연쇄반응 에비던스 부족
- **문제**: "고혈압으로 인해 눈 콩팥 심장 확인필요" 이것도 에비던스 필요
- **현상**: 논리나 근거가 너무 약함
- **요구사항**: 에비던스 기반 설명

### 1.7 선택 항목 분석 모호함
- **문제**: "여러 항목이 이상으로 나타났다"고 하는데 어떤 이상항목을 반영했는지 모름
- **요구사항**: 구체적인 이상항목 명시

### 1.8 검진 설계 전략 용어 부정확
- **문제**: "경계"를 "비만"이라고 표현하고 있음
- **요구사항**: 정확한 용어 사용

### 1.9 간호사 노트 없음
- **문제**: "관리하실 항목이에요" 섹션에 간호사 글이 없음
- **현상**: national_checkup_note 필드가 비어있거나 표시되지 않음

### 1.10 에비던스 출처 불충분
- **문제**: "가이드라인"이라고만 나오는데, 어느 문서에 어떤 내용이 있었는지까지 필요
- **요구사항**: RAG가 문서명, 섹션, 내용까지 가져와야 함

### 1.11 대사 건강과 간 섬유화 관계 불명확
- **문제**: 이 관계가 명확하지 않음
- **요구사항**: 의학적 근거 명확화

### 1.12 논리/논법 부족
- **문제**: 논리적 연결이 약함
- **요구사항**: 논리적 연결고리 강화

### 1.13 통합 로깅 미흡
- **문제**: 인풋 데이터, 프롬프트, 모델 응답이 분산되어 있음
- **요구사항**: 실행시마다 한 파일에 모두 로그로 남겨서 보고

---

## 2. 코드 레벨 원인 분석

### 2.1 RAG 시스템 관련

#### 원인 1: RAG 검색 쿼리가 너무 일반적
**위치**: `planning-platform/backend/app/services/checkup_design_prompt.py:346-383`

```python
# 기본 검색 쿼리
base_query = f"환자 위험 요인에 대한 의학 가이드라인: {patient_summary}"

# 심층 검색 쿼리
query = f"{concern_name} 검진 가이드라인 및 진료지침"
```

**문제점**:
- 쿼리가 너무 광범위하고 일반적임
- 구체적인 검색어가 부족함 (예: "고혈압 환자의 경동맥 초음파 필요성")
- 검색 결과가 50자로 매우 짧은 이유

**해결 방안**:
- 더 구체적인 쿼리 생성 (연령, 성별, 위험 요인 포함)
- 다단계 검색 (broad → specific)
- 검색 결과가 부족하면 재검색 로직 추가

#### 원인 2: RAG 검색 결과를 단순 텍스트로만 반환
**위치**: `planning-platform/backend/app/services/checkup_design_prompt.py:324-398`

```python
async def get_medical_evidence_from_rag(
    query_engine: Any,
    patient_summary: str,
    concerns: List[Dict[str, Any]]
) -> str:
    # ...
    evidence_parts.append(f"## {concern_name} 관련 가이드라인\n{concern_response.response}\n")
    # ...
    return "\n".join(evidence_parts)
```

**문제점**:
- `response.response`만 추출하여 반환
- 메타데이터 (출처 문서, 페이지, 섹션, 신뢰도 점수) 무시
- LlamaIndex의 `source_nodes`나 `metadata` 활용하지 않음

**해결 방안**:
- `response.source_nodes`에서 메타데이터 추출
- 구조화된 에비던스 객체 반환 (내용 + 출처 + 신뢰도)
- 프롬프트에 상세한 출처 정보 포함

#### 원인 3: RAG 엔진 초기화 오류 시 조용히 실패
**위치**: `planning-platform/backend/app/services/checkup_design_prompt.py:255-322`

```python
except Exception as e:
    print(f"[ERROR] RAG 엔진 초기화 실패: {str(e)}")
    return None
```

**문제점**:
- 초기화 실패 시 `None` 반환하고 계속 진행
- 사용자에게 RAG 실패 알림 없음
- 로그에만 출력되고 추적하기 어려움

**해결 방안**:
- 구조화된 에러 로깅
- 사용자에게 알림 (선택적)
- 대체 전략 (Master DB 사용 등)

### 2.2 가족력 반영 로직

#### 원인 4: 가족력 → 검진 항목 매핑이 프롬프트 지시사항에만 의존
**위치**: `planning-platform/backend/app/services/checkup_design_prompt.py:2656-2657`

```python
- **⚠️ 가족력 반영 필수**: 문진에서 가족력(당뇨, 고혈압 등)이 확인된 경우, 
  해당 질환과 관련된 검진 항목을 priority_1.items에 반드시 포함하세요. 
  예: 가족력에 당뇨가 있으면 '혈당검사'를 priority_1.items에 포함해야 합니다.
```

**문제점**:
- 프롬프트 지시사항으로만 강제 → LLM이 무시할 수 있음
- 가족력 → 검진 매핑 로직이 코드에 없음
- 의학적 타당성 검증 로직 없음

**해결 방안**:
- **Option 1 (RAG 우선)**: 
  ```python
  async def validate_family_history_with_rag(
      query_engine, family_history: List[str]
  ) -> Dict[str, List[str]]:
      # 가족력별로 RAG 검색하여 권장 검진 항목 추출
      mapping = {}
      for fh in family_history:
          query = f"{fh} 가족력이 있는 경우 권장 검진 항목"
          result = await query_engine.query(query)
          mapping[fh] = parse_recommended_items(result)
      return mapping
  ```
  
- **Option 2 (모델 병렬 호출)**:
  ```python
  async def enrich_family_history_with_model(
      family_history: List[str], patient_context: str
  ) -> Dict[str, str]:
      # 각 가족력에 대해 모델에 의학적 타당성 질문
      # 병렬 처리 가능
      pass
  ```

- **Option 3 (하드코딩 매핑 + 검증)**:
  ```python
  FAMILY_HISTORY_CHECKUP_MAPPING = {
      "당뇨": ["혈당검사", "당화혈색소"],
      "고혈압": ["혈압측정"],
      "심장질환": ["심전도", "심장 초음파"],
      # ...
  }
  ```

### 2.3 항목명 일관성

#### 원인 5: priority_1.items와 focus_items 일관성 검증 로직 없음
**위치**: `planning-platform/backend/app/api/v1/endpoints/checkup_design.py:972-998`

```python
# STEP 1과 STEP 2 결과 병합
merged_result = merge_checkup_design_responses(step1_result_dict, ai_response)
```

**문제점**:
- 병합 로직에서 일관성 검증 없음
- priority_1.items = ['혈압'] vs focus_items = [{item_name: '혈압측정'}] 불일치 허용
- 프롬프트 지시사항에만 의존

**해결 방안**:
- **Post-processing 검증 함수 추가**:
  ```python
  def validate_priority1_consistency(priority_1: Dict) -> Dict:
      items = priority_1.get('items', [])
      focus_items = priority_1.get('focus_items', [])
      focus_item_names = [fi.get('item_name') for fi in focus_items]
      
      # 일관성 검증
      missing = [item for item in items if item not in focus_item_names]
      
      if missing:
          # 경고 로그
          print(f"[WARN] priority_1.items에 있지만 focus_items에 없는 항목: {missing}")
          
          # 자동 보정 (선택적)
          # 1) items에서 제거
          # 2) focus_items에 추가 (Master DB에서 기본 정보 가져오기)
      
      return priority_1
  ```

- **프롬프트 강화 + 예시 추가**:
  ```python
  prompt += """
  **⚠️ 절대 금지 예시:**
  - priority_1.items = ['혈압'] ← ❌ 틀림
  - priority_1.focus_items = [{item_name: '혈압측정'}] ← ❌ 틀림
  
  **✅ 올바른 예시:**
  - priority_1.items = ['혈압측정']
  - priority_1.focus_items = [{item_name: '혈압측정', ...}]
  """
  ```

### 2.4 에비던스 품질

#### 원인 6: 에비던스 생성 시 RAG 결과만 의존, 대체 전략 부족
**위치**: `planning-platform/backend/app/services/checkup_design_prompt.py:2476-2483`

```python
- **⚠️ RAG 검색 결과가 없어도 evidence 필수 생성**: 
  RAG 검색 결과가 비어있거나 부족한 경우, 
  Master DB의 지식 베이스와 일반적인 의학 가이드라인을 참고하여 
  evidence를 반드시 생성하세요.
```

**문제점**:
- 프롬프트 지시사항으로만 처리
- RAG 결과가 50자로 짧으면 에비던스도 약함
- Master DB 활용이 제대로 안됨 (LLM 판단에 의존)

**해결 방안**:
- **계층적 에비던스 생성 전략**:
  ```python
  async def generate_evidence_hierarchical(
      rag_evidence: str,
      master_db_evidence: str,
      checkup_item: str
  ) -> str:
      # 1. RAG 우선 (충분히 길면)
      if len(rag_evidence) > 200:
          return rag_evidence
      
      # 2. RAG + Master DB 결합
      if len(rag_evidence) > 50:
          return combine_evidences(rag_evidence, master_db_evidence)
      
      # 3. Master DB + 모델 보강
      enriched = await enrich_with_model(master_db_evidence, checkup_item)
      return enriched
  ```

- **에비던스 형식 표준화**:
  ```python
  class MedicalEvidence:
      guideline: str          # "2025 당뇨병 진료지침"
      guideline_org: str      # "대한당뇨학회"
      evidence_level: str     # "Level A"
      source_doc: str         # 문서명
      source_section: str     # 섹션명
      content_summary: str    # 내용 요약
      references: List[str]   # URL 리스트
  ```

### 2.5 로깅 시스템

#### 원인 7: 로그가 분산되어 추적 어려움
**위치**: 
- `planning-platform/backend/app/services/gpt_service.py:177-236` (프롬프트, 응답 별도 저장)
- `planning-platform/backend/logs/` (별도 파일)

**문제점**:
- 프롬프트와 응답이 별도 파일에 저장됨
- 입력 데이터(health_data, prescription_data 등) 로그 없음
- 타임스탬프 기반으로 매칭해야 함 → 번거로움

**해결 방안**:
- **통합 로그 파일 생성**:
  ```python
  def save_unified_execution_log(
      session_id: str,
      step: str,  # "step1" or "step2"
      inputs: Dict,
      prompt: Dict,
      response: Dict,
      metadata: Dict
  ):
      timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
      log_file = f"logs/unified_execution_{session_id}_{step}_{timestamp}.json"
      
      unified_log = {
          "metadata": {
              "session_id": session_id,
              "step": step,
              "timestamp": timestamp,
              "patient_name": inputs.get("patient_name"),
              "patient_age": inputs.get("patient_age"),
              # ...
          },
          "inputs": {
              "health_data": inputs.get("health_data"),
              "prescription_data": inputs.get("prescription_data"),
              "selected_concerns": inputs.get("selected_concerns"),
              "survey_responses": inputs.get("survey_responses"),
              # ...
          },
          "rag": {
              "query_engine_status": "success" or "failed",
              "search_results": "...",
              "search_length": 50,
              # ...
          },
          "prompt": {
              "system_message": prompt.get("system_message"),
              "user_message": prompt.get("user_message"),
              "model": prompt.get("model"),
              "temperature": prompt.get("temperature"),
              # ...
          },
          "response": {
              "content": response.get("content"),
              "usage": response.get("usage"),
              "success": response.get("success"),
              # ...
          },
          "parsed_output": {
              # 파싱된 JSON 결과
          }
      }
      
      with open(log_file, "w", encoding="utf-8") as f:
          json.dump(unified_log, f, ensure_ascii=False, indent=2)
  ```

### 2.6 프롬프트 구조

#### 원인 8: 프롬프트가 너무 길고 복잡함
**위치**: `planning-platform/backend/app/services/checkup_design_prompt.py:2134-2670`

**문제점**:
- STEP 2 프롬프트가 500라인 이상
- 지시사항이 너무 많아서 LLM이 일부를 무시할 가능성
- 중요한 지시사항이 묻힐 수 있음

**해결 방안**:
- **핵심 지시사항 상단 배치 + 반복**:
  ```python
  prompt = f"""
  {rag_evidence_section}
  
  **⚠️ 가장 중요한 규칙 (반드시 준수):**
  1. priority_1.items와 focus_items는 항목명이 정확히 일치해야 합니다
  2. 가족력(당뇨, 고혈압 등)이 있으면 관련 검진 항목을 priority_1.items에 반드시 포함하세요
  3. priority_1.items는 최소 1개, 최대 3개까지만 선택하세요
  4. 모든 추천 항목에 evidence를 반드시 포함하세요
  
  {rest_of_prompt}
  
  **⚠️ 마지막 확인 (JSON 생성 전):**
  - priority_1.items의 모든 항목이 focus_items에 있는지 확인했나요?
  - 가족력 관련 검진 항목을 포함했나요?
  - 모든 항목에 evidence가 있나요?
  """
  ```

- **Constraint Verification Step 추가**:
  ```python
  # STEP 2 완료 후, 제약조건 검증 STEP 추가
  # 위반 사항이 있으면 재생성 요청
  ```

---

## 3. 종합 원인 요약

### 3.1 RAG 시스템
| 문제 | 원인 | 영향 |
|------|------|------|
| 검색 결과 짧음 (50자) | 쿼리 너무 일반적, 벡터 DB 데이터 부족 | 에비던스 약함 |
| 메타데이터 미활용 | source_nodes 무시 | 출처 불명확 |
| 실패 시 조용히 넘어감 | 에러 처리 부족 | 추적 어려움 |

### 3.2 로직 및 검증
| 문제 | 원인 | 영향 |
|------|------|------|
| 가족력 반영 안됨 | 매핑 로직 없음, 프롬프트 지시사항에만 의존 | 중요 항목 누락 |
| 항목명 불일치 | 일관성 검증 로직 없음 | 사용자 혼란 |
| focus_items 누락 | 완전성 검증 로직 없음 | 정보 불완전 |

### 3.3 프롬프트
| 문제 | 원인 | 영향 |
|------|------|------|
| 지시사항 무시됨 | 프롬프트 너무 길고 복잡함 | LLM이 일부 지시 무시 |
| 에비던스 약함 | RAG 결과에만 의존, 대체 전략 부족 | 근거 부족 |

### 3.4 시스템
| 문제 | 원인 | 영향 |
|------|------|------|
| 로그 분산됨 | 통합 로깅 시스템 없음 | 디버깅 어려움 |
| 에러 추적 어려움 | 구조화된 로깅 부족 | 문제 재현 어려움 |

---

## 4. 해결 우선순위 (작업 순서)

### Phase 1: 핵심 로직 보강 (최우선)
1. **priority_1.items와 focus_items 일관성 보장** ✅
   - Post-processing 검증 함수 추가
   - 프롬프트 강화 (예시 추가)
   
2. **가족력 반영 강화** ✅
   - 가족력 → 검진 매핑 테이블 추가
   - RAG 검증 로직 추가
   - 의학적 타당성 검증

3. **통합 로깅 시스템 구축** ✅
   - 한 파일에 인풋-프롬프트-응답 저장
   - 구조화된 로그 형식

### Phase 2: RAG 시스템 개선
4. **RAG 검색 품질 향상** 
   - 쿼리 구체화 (연령, 성별, 위험 요인 포함)
   - 메타데이터 추출 (출처, 신뢰도)
   - 다단계 검색

5. **에비던스 강화**
   - 계층적 에비던스 생성 전략
   - RAG + Master DB + 모델 보강

### Phase 3: 프롬프트 및 UX 개선
6. **프롬프트 최적화**
   - 핵심 지시사항 상단 배치 + 반복
   - Constraint Verification Step 추가

7. **추천 이유 상세화**
   - priority_2/3 추천 이유 강화
   - 만성질환 연쇄반응 에비던스 추가

8. **용어 및 표현 정확성**
   - 경계/비만 구분
   - 선택 항목 분석 구체화

---

## 5. 다음 단계

1. **Phase 1 작업 시작 (우선순위 1-3)**
   - `priority_1` 일관성 검증 로직 추가
   - 가족력 매핑 테이블 + 검증 로직
   - 통합 로깅 함수 구현

2. **Phase 1 완료 후 사용자 테스트 요청**
   - 로그 파일 제공
   - 개선사항 확인

3. **Phase 2 진행 (우선순위 4-5)**
   - RAG 쿼리 개선
   - 에비던스 강화 로직

4. **Phase 3 진행 (우선순위 6-8)**
   - 프롬프트 최적화
   - UX 개선

---

## 6. 예상 효과

### Phase 1 완료 시
- ✅ priority_1.items와 focus_items 완전 일치
- ✅ 가족력 반영 보장
- ✅ 디버깅 시간 단축 (통합 로그)

### Phase 2 완료 시
- ✅ 에비던스 품질 향상
- ✅ RAG 검색 결과 길이 증가 (50자 → 500자+)
- ✅ 출처 명확화 (문서명, 섹션 포함)

### Phase 3 완료 시
- ✅ 추천 이유 설득력 증가
- ✅ 용어 정확성 향상
- ✅ 전체적인 논리성 강화

---

**작성자**: AI Assistant  
**날짜**: 2025-12-05  
**다음 업데이트**: Phase 1 완료 후
