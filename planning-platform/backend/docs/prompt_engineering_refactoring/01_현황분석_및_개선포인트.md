# í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ë¦¬íŒ©í„°ë§ ë¶„ì„ (Phase 1)

## ğŸ“‹ ë¬¸ì„œ ê°œìš”
- **ì‘ì„±ì¼**: 2024-12-06
- **ëª©ì **: í˜„ì¬ ê²€ì§„ ì„¤ê³„ í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œì˜ êµ¬ì¡° ë¶„ì„ ë° ê°œì„  í¬ì¸íŠ¸ ë„ì¶œ
- **ë²”ìœ„**: STEP 1 (ë¶„ì„) + STEP 2 (ì„¤ê³„) í”„ë¡¬í”„íŠ¸ ì „ì²´
- **ë¶„ì„ ë°©ë²•**: ì½”ë“œ ê²€í† , RAG ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸, ì‚¬ìš©ì ì œì•ˆ ê²€í† 

---

## ğŸ¯ í•µì‹¬ ë¬¸ì œ ì¸ì‹

### ì‚¬ìš©ìê°€ ì§€ì í•œ 5ê°€ì§€ ë¬¸ì œì 

| # | ë¬¸ì œ ì˜ì—­ | AS-IS (í˜„ì¬) | TO-BE (ëª©í‘œ) |
|---|----------|--------------|--------------|
| 1 | **ì„¤ë“ ë…¼ë¦¬** | ì•”/ê³µí¬ ìœ„ì£¼ (BRIDGE_STRATEGY 6ê°œ ì¤‘ 5ê°œê°€ ì•”) | ë§Œì„±ì§ˆí™˜/ë°ì´í„° ì±„ìš°ê¸° ìœ„ì£¼ |
| 2 | **ë°ì´í„° í•´ì„** | ë‹¨ìˆœ ìˆ˜ì¹˜ ë‚˜ì—´ ("140/90") | ì˜ë¯¸ íƒœê¹… ("140/90 [ê³ í˜ˆì•• 2ê¸°, ì¦‰ì‹œ ê´€ë¦¬ í•„ìš”]") |
| 3 | **ë¶„ì„ ê¹Šì´** | íŒŒí¸í™”ëœ ë¦¬ìŠ¤íŠ¸ (ì¥ê¸°ë³„ ë…ë¦½) | ì•…ìˆœí™˜ ê³ ë¦¬ ì„œìˆ  (ì‹œë„ˆì§€ ë¶„ì„) |
| 4 | **ì¶”ì²œ ê°œì—°ì„±** | ê¸°ê³„ì  ë§¤ì¹­ ("ê³ í˜ˆì•• â†’ ê²½ë™ë§¥") | ë‚´ëŸ¬í‹°ë¸Œ ê¸°ë°˜ ì œì•ˆ (ìŠ¤í† ë¦¬í…”ë§) |
| 5 | **ì‹œì˜ì„±** | ê³¼ê±° ë°ì´í„° ë§¹ì‹  (4ë…„ ì „ ë°ì´í„° = í˜„ì¬) | ì¬í‰ê°€ ë¡œì§ ([History] vs [Current] íƒœê·¸) |

---

## ğŸ” í˜„ì¬ ì‹œìŠ¤í…œ êµ¬ì¡° ë¶„ì„

### 1. ì „ì²´ ì•„í‚¤í…ì²˜

```
ğŸ“ checkup_design_prompt.py (3,985 lines)
â”‚
â”œâ”€ [PART 0-1] Master Knowledge Base (line 54-176)
â”‚  â”œâ”€ RISK_ANALYSIS_LOGIC_JSON (ìœ„í—˜ë„ ë¶„ì„ ê¸°ì¤€)
â”‚  â”œâ”€ PROFILE_GUIDELINE_JSON (ìƒì• ì£¼ê¸°/ë§Œì„±ì§ˆí™˜ ê°€ì´ë“œ)
â”‚  â””â”€ BRIDGE_STRATEGY_JSON (ì„¤ë“ ë…¼ë¦¬ í…œí”Œë¦¿) âš ï¸ ë¬¸ì œ 1
â”‚
â”œâ”€ [PART 0-2] RAG System (line 202-688)
â”‚  â”œâ”€ GeminiLLM (Gemini 2.0 Flash ë˜í¼)
â”‚  â”œâ”€ init_rag_engine() (LlamaCloud ì´ˆê¸°í™”)
â”‚  â”œâ”€ generate_specific_queries() (ì¿¼ë¦¬ ìƒì„±)
â”‚  â”œâ”€ extract_evidence_from_source_nodes() (ì—ë¹„ë˜ìŠ¤ ì¶”ì¶œ)
â”‚  â””â”€ get_medical_evidence_from_rag() (í†µí•© ê²€ìƒ‰)
â”‚
â”œâ”€ [PART 1] ë³‘ì› ê²€ì§„ í•­ëª© ë¶„ë¥˜ (line 751-1041)
â”‚  â””â”€ classify_hospital_checkup_items_by_category()
â”‚
â”œâ”€ [PART 2] STEP 1 í”„ë¡¬í”„íŠ¸ (line 2047-2387)
â”‚  â”œâ”€ create_checkup_design_prompt_step1() âš ï¸ ë¬¸ì œ 2, 3, 5
â”‚  â”‚  â”œâ”€ í™˜ì ì •ë³´ ì„¹ì…˜
â”‚  â”‚  â”œâ”€ ê±´ê°•ê²€ì§„ ë°ì´í„° ì„¹ì…˜ (line 2098-2161)
â”‚  â”‚  â”œâ”€ ì²˜ë°©ì „ ë°ì´í„° ì„¹ì…˜
â”‚  â”‚  â”œâ”€ ì—¼ë ¤ í•­ëª© ì„¹ì…˜
â”‚  â”‚  â”œâ”€ ë¬¸ì§„ ì‘ë‹µ ì„¹ì…˜
â”‚  â”‚  â””â”€ ì¶œë ¥ í¬ë§· (JSON)
â”‚  â”‚
â”‚  â””â”€ Output: patient_summary, analysis, risk_profile,
â”‚             chronic_analysis, survey_reflection,
â”‚             selected_concerns_analysis, basic_checkup_guide
â”‚
â”œâ”€ [PART 3] STEP 2 í”„ë¡¬í”„íŠ¸ - í†µí•© ë²„ì „ (line 2391-3283)
â”‚  â””â”€ create_checkup_design_prompt_step2() âš ï¸ ë¬¸ì œ 4
â”‚     â”œâ”€ RAG ê²€ìƒ‰ (line 2417-2473)
â”‚     â”œâ”€ STEP 1 ê²°ê³¼ ì¸ìš©
â”‚     â”œâ”€ í™˜ì/ê²€ì§„ ë°ì´í„°
â”‚     â””â”€ Output: strategies, recommended_items, summary, doctor_comment
â”‚
â””â”€ [PART 4] STEP 2 ë¶„í•  ë²„ì „ (line 3292-3979)
   â”œâ”€ create_checkup_design_prompt_step2_priority1()
   â”‚  â””â”€ Priority 1 (ì¼ë°˜ê²€ì§„ ì£¼ì˜ í•­ëª©) ìƒì„±
   â””â”€ create_checkup_design_prompt_step2_upselling()
      â””â”€ Priority 2, 3, Strategies, doctor_comment ìƒì„±
```

### 2. ë°ì´í„° íë¦„

```
[ì‚¬ìš©ì ì…ë ¥]
   â†“
[STEP 1 í”„ë¡¬í”„íŠ¸ ìƒì„±]
   â”œâ”€ í™˜ì ì •ë³´ (ë‚˜ì´, ì„±ë³„, ì´ë¦„)
   â”œâ”€ ê±´ê°•ê²€ì§„ ë°ì´í„° âš ï¸ ë¬¸ì œ 2, 5
   â”‚  â””â”€ checkup_date, year, location
   â”‚  â””â”€ raw_data.Inspections[].Illnesses[].Items[]
   â”‚      â”œâ”€ Name: "ì´ì½œë ˆìŠ¤í…Œë¡¤"
   â”‚      â”œâ”€ Value: "240"
   â”‚      â”œâ”€ Unit: "mg/dL"
   â”‚      â””â”€ ItemReferences[].Name: "ì§ˆí™˜ì˜ì‹¬" / "ì •ìƒ(B)"
   â”œâ”€ ì²˜ë°©ì „ ë°ì´í„°
   â”œâ”€ ì—¼ë ¤ í•­ëª© (ì‚¬ìš©ì ì„ íƒ)
   â””â”€ ë¬¸ì§„ ì‘ë‹µ (ì„¤ë¬¸)
   â†“
[GPT-4o-mini í˜¸ì¶œ] â†’ STEP 1 ê²°ê³¼
   â†“
[STEP 2 í”„ë¡¬í”„íŠ¸ ìƒì„±]
   â”œâ”€ STEP 1 ê²°ê³¼ ì„ë² ë”©
   â”œâ”€ RAG ê²€ìƒ‰ (Gemini 2.0 + LlamaCloud) âš ï¸ í™œìš©ë„ ë‚®ìŒ
   â””â”€ Bridge Strategy ì ìš© âš ï¸ ë¬¸ì œ 1
   â†“
[GPT-4o í˜¸ì¶œ] â†’ STEP 2 ê²°ê³¼
   â†“
[ìµœì¢… ê²€ì§„ ì„¤ê³„ ì™„ì„±]
```

---

## âš ï¸ ë¬¸ì œì  ìƒì„¸ ë¶„ì„

### ë¬¸ì œ 1: ì„¤ë“ ë…¼ë¦¬ (Bridge Strategy) - ì•” í¸í–¥

#### ğŸ“ ìœ„ì¹˜
`BRIDGE_STRATEGY_JSON` (line 137-176)

#### ğŸ”´ í˜„ì¬ ìƒíƒœ
```json
[
  {"target": "ìœ„ì•”/ì†Œí™”ê¸°", ...},  // ì•”
  {"target": "íì•”", ...},         // ì•”
  {"target": "ë‡Œí˜ˆê´€", ...},       // í˜ˆê´€ (1ê°œë§Œ)
  {"target": "ìœ ë°©ì•”", ...},       // ì•”
  {"target": "ëŒ€ì¥ì•”", ...},       // ì•”
  {"target": "ê°„ì•”", ...}          // ì•”
]
```

**í†µê³„**: 6ê°œ ì¤‘ 5ê°œê°€ ì•” ê´€ë ¨ (83%)

#### ğŸŸ¢ ê°œì„  ë°©í–¥
```json
[
  {"target": "í˜ˆê´€ ê±´ê°• (ê³ í˜ˆì••)", "anchor": "í˜ˆì•• ì¸¡ì •ì€ ê¸°ë³¸ì…ë‹ˆë‹¤", 
   "gap": "í•˜ì§€ë§Œ í˜ˆê´€ ì† íƒ„ë ¥ì„±ê³¼ ë‘ê»˜ëŠ” ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
   "offer": "ê²½ë™ë§¥ ì´ˆìŒíŒŒë¡œ í˜ˆê´€ ë‚˜ì´ë¥¼ í™•ì¸í•˜ì„¸ìš”"},
  
  {"target": "ëŒ€ì‚¬ ê±´ê°• (í˜ˆë‹¹/ì§€ë°©ê°„)", "anchor": "í˜ˆë‹¹ ê²€ì‚¬ëŠ” ì¤‘ìš”í•©ë‹ˆë‹¤",
   "gap": "í•˜ì§€ë§Œ ì·Œì¥ ê¸°ëŠ¥ê³¼ ì¸ìŠë¦° ì €í•­ì„±ì€ í™•ì¸ ë¶ˆê°€í•©ë‹ˆë‹¤",
   "offer": "ê³µë³µ ì¸ìŠë¦°ê³¼ ê°„ ì„¬ìœ í™” ìŠ¤ìº”ìœ¼ë¡œ ëŒ€ì‚¬ ê±´ê°•ì„ ì™„ì„±í•˜ì„¸ìš”"},
  
  {"target": "í™œë ¥ ë² ì´ìŠ¤ë¼ì¸", "anchor": "ì¼ë°˜ ê²€ì§„ìœ¼ë¡œ í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤",
   "gap": "í•˜ì§€ë§Œ ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ ë¯¸ë˜ ë³€í™”ë¥¼ ì¶”ì í•  ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤",
   "offer": "ê³¨ë°€ë„, ì‹¬ì¥ ê¸°ëŠ¥, íí™œëŸ‰ ë“± ë² ì´ìŠ¤ë¼ì¸ ë°ì´í„°ë¥¼ í™•ë³´í•˜ì„¸ìš”"},
  
  // ì•” ê´€ë ¨ì€ ê°€ì¡±ë ¥/ìœ„í—˜êµ°ì¸ ê²½ìš°ì—ë§Œ
  {"target": "íì•” (í¡ì—°ì)", ...},
  {"target": "ìœ„ì•” (ê°€ì¡±ë ¥)", ...}
]
```

**ëª©í‘œ ë¹„ìœ¨**: ë§Œì„±ì§ˆí™˜/ëŒ€ì‚¬ 60%, ì•” 40%

#### ğŸ¯ ìˆ˜ì • í¬ì¸íŠ¸
- `BRIDGE_STRATEGY_JSON` ì „ë©´ ì¬ì‘ì„±
- ë‚˜ì´/ì„±ë³„/ê°€ì¡±ë ¥ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì„ íƒ
- "ì•ˆ í•˜ë©´ ì£½ëŠ”ë‹¤" â†’ "ë°ì´í„° ê³µë°± ì±„ìš°ê¸°" ë…¼ë¦¬ ì „í™˜

---

### ë¬¸ì œ 2: ë°ì´í„° í•´ì„ - Semantic Tagging ë¶€ì¬

#### ğŸ“ ìœ„ì¹˜
`create_checkup_design_prompt_step1()` â†’ ê±´ê°•ê²€ì§„ ë°ì´í„° ì„¹ì…˜ (line 2104-2160)

#### ğŸ”´ í˜„ì¬ ìƒíƒœ
```python
# line 2137-2153
item_name = item.get("Name")       # "ì´ì½œë ˆìŠ¤í…Œë¡¤"
item_value = item.get("Value")     # "240"
item_unit = item.get("Unit")       # "mg/dL"

# ItemReferencesë¡œ ìƒíƒœë§Œ ë¶„ë¥˜
if "ì§ˆí™˜ì˜ì‹¬" in ref_name:
    abnormal_items.append(f"- {item_name}: {item_value} {item_unit} (ì´ìƒ)")
elif "ì •ìƒ(B)" in ref_name:
    warning_items.append(f"- {item_name}: {item_value} {item_unit} (ê²½ê³„)")
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
**ê²½ê³„ í•­ëª©:**
- í˜ˆì••(ìˆ˜ì¶•ê¸°): 135 mmHg (ê²½ê³„)
- ê³µë³µí˜ˆë‹¹: 110 mg/dL (ê²½ê³„)
```

**ë¬¸ì œ**: GPTê°€ "135ê°€ ìœ„í—˜í•œì§€, 110ì´ ì‹¬ê°í•œì§€" ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•´ì•¼ í•¨

#### ğŸŸ¢ ê°œì„  ë°©í–¥
```python
def add_semantic_tag(item_name: str, value: str, unit: str, status: str) -> str:
    """ìˆ˜ì¹˜ì— ì„ìƒì  ì˜ë¯¸ ë¶€ì—¬"""
    
    # í˜ˆì••
    if item_name == "í˜ˆì••(ìˆ˜ì¶•ê¸°)":
        if 130 <= float(value) < 140:
            return f"- {item_name}: {value} {unit} [ê³ í˜ˆì•• 1ê¸° ë²”ìœ„, ìƒí™œìŠµê´€ ê°œì„  í•„ìš”]"
        elif float(value) >= 140:
            return f"- {item_name}: {value} {unit} [ê³ í˜ˆì•• 2ê¸° ë²”ìœ„, ì¦‰ì‹œ ê´€ë¦¬ í•„ìš”]"
    
    # í˜ˆë‹¹
    if item_name == "ê³µë³µí˜ˆë‹¹":
        if 100 <= float(value) < 126:
            return f"- {item_name}: {value} {unit} [ë‹¹ë‡¨ ì „ë‹¨ê³„, 3-6ê°œì›” í›„ ì¬ê²€ ê¶Œì¥]"
        elif float(value) >= 126:
            return f"- {item_name}: {value} {unit} [ë‹¹ë‡¨ ì§„ë‹¨ ê¸°ì¤€, ì •ë°€ ê²€ì‚¬ í•„ìš”]"
    
    # ì½œë ˆìŠ¤í…Œë¡¤
    if item_name == "ì´ì½œë ˆìŠ¤í…Œë¡¤":
        if float(value) >= 240:
            return f"- {item_name}: {value} {unit} [ë†’ìŒ, ì‹¬í˜ˆê´€ ìœ„í—˜ë„ ìƒìŠ¹]"
    
    # ê¸°ë³¸ í¬ë§· (ë§¤í•‘ ì—†ëŠ” ê²½ìš°)
    return f"- {item_name}: {value} {unit} ({status})"
```

**ì¶œë ¥ ì˜ˆì‹œ (ê°œì„ ):**
```
**ê²½ê³„ í•­ëª©:**
- í˜ˆì••(ìˆ˜ì¶•ê¸°): 135 mmHg [ê³ í˜ˆì•• 1ê¸° ë²”ìœ„, ìƒí™œìŠµê´€ ê°œì„  í•„ìš”]
- ê³µë³µí˜ˆë‹¹: 110 mg/dL [ë‹¹ë‡¨ ì „ë‹¨ê³„, 3-6ê°œì›” í›„ ì¬ê²€ ê¶Œì¥]
- ì´ì½œë ˆìŠ¤í…Œë¡¤: 240 mg/dL [ë†’ìŒ, ì‹¬í˜ˆê´€ ìœ„í—˜ë„ ìƒìŠ¹]
```

#### ğŸ¯ ìˆ˜ì • í¬ì¸íŠ¸
- ìƒˆ í•¨ìˆ˜ ì¶”ê°€: `add_semantic_tag()`
- ì£¼ìš” ê²€ì‚¬ í•­ëª©ì— ëŒ€í•œ ì„ìƒ ê¸°ì¤€ ë§¤í•‘ í…Œì´ë¸” êµ¬ì¶•
- ë³‘ì›ì˜ ItemReferencesì™€ ì‹œìŠ¤í…œ ì§€ì‹ ë² ì´ìŠ¤ í†µí•©

---

### ë¬¸ì œ 3: ë¶„ì„ ê¹Šì´ (Step 1) - ì‹œë„ˆì§€ ë¶„ì„ ë¶€ì¬

#### ğŸ“ ìœ„ì¹˜
`CHECKUP_DESIGN_SYSTEM_MESSAGE_STEP1` (line 2256-2386)

#### ğŸ”´ í˜„ì¬ ìƒíƒœ

**STEP 1 ì¶œë ¥ êµ¬ì¡°**:
```json
{
  "risk_profile": [
    {"organ_system": "ê°„", "risk_level": "High", "reason": "..."},
    {"organ_system": "ì‹¬í˜ˆê´€", "risk_level": "Moderate", "reason": "..."},
    {"organ_system": "ì‹ ì¥", "risk_level": "Low", "reason": "..."}
  ]
}
```

**ë¬¸ì œ**: ê° ì¥ê¸°ê°€ ë…ë¦½ì ìœ¼ë¡œ ë‚˜ì—´ë¨. ìƒí˜¸ì‘ìš© ì—†ìŒ.

#### ğŸŸ¢ ê°œì„  ë°©í–¥

**ìƒˆ í•„ë“œ ì¶”ê°€**: `chronic_synergy_narrative`

```json
{
  "risk_profile": [...],  // ê¸°ì¡´ ìœ ì§€
  
  "chronic_synergy_narrative": {
    "metabolic_syndrome_detected": true,
    "synergy_chain": "ë³µë¶€ë¹„ë§Œ(í—ˆë¦¬ë‘˜ë ˆ 90cm) â†’ ì¸ìŠë¦° ì €í•­ì„± â†’ í˜ˆì•• ìƒìŠ¹(135mmHg) â†’ í˜ˆê´€ ì†ìƒ ìœ„í—˜",
    "amplification_factor": "3ê°€ì§€ê°€ ë™ì‹œ ì§„í–‰ ì¤‘ì´ë¯€ë¡œ ë‹¨ë… ìœ„í—˜ë³´ë‹¤ 2-3ë°° ìœ„í—˜ë„ ì¦í­",
    "intervention_priority": "í˜ˆë‹¹ + í˜ˆì•• + ì²´ì¤‘ì„ ë™ì‹œì— ê´€ë¦¬í•´ì•¼ íš¨ê³¼ì . í•˜ë‚˜ë§Œ í•´ê²°í•˜ë©´ ë‹¤ë¥¸ ìš”ì¸ì´ ë‹¤ì‹œ ì•…í™”ì‹œí‚´."
  },
  
  "data_gaps": [
    {
      "missing_data": "ìµœê·¼ 3ë…„ ê°„ ê²€ì§„ ì´ë ¥ ì—†ìŒ",
      "clinical_meaning": "í˜„ì¬ ìƒíƒœ ë¶ˆëª…. ì§€ë‚œ 3ë…„ê°„ ë³€í™” ì¶”ì  ë¶ˆê°€.",
      "recommended_action": "ë² ì´ìŠ¤ë¼ì¸ ì¬êµ¬ì¶• í•„ìš”. í˜„ì¬ ìƒíƒœ ì¬ì¸¡ì • ê¶Œì¥."
    }
  ]
}
```

#### ğŸ¯ ìˆ˜ì • í¬ì¸íŠ¸
- STEP 1 ì¶œë ¥ JSON ìŠ¤í‚¤ë§ˆì— `chronic_synergy_narrative` ì¶”ê°€
- STEP 1 ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— "ìš”ì¸ ê°„ ìƒí˜¸ì‘ìš© ë¶„ì„" ì§€ì‹œ ì¶”ê°€
- "ëŒ€ì‚¬ì¦í›„êµ°", "ë§Œì„±ì—¼ì¦", "ì‹¬ë‡Œí˜ˆê´€ ì—°ì‡„" íŒì • ë¡œì§ ê°•ì œ

---

### ë¬¸ì œ 4: ì¶”ì²œ ê°œì—°ì„± (Step 2) - STEP 1 ì—°ê²° ë¶€ì¡±

#### ğŸ“ ìœ„ì¹˜
`create_checkup_design_prompt_step2()` (line 2391-3283)

#### ğŸ”´ í˜„ì¬ ìƒíƒœ

**STEP 2 í”„ë¡¬í”„íŠ¸ êµ¬ì¡°**:
```
# ğŸ“‹ Context (ì´ì „ ë‹¨ê³„ ë¶„ì„ ê²°ê³¼)
{step1_context}  // STEP 1 ì „ì²´ JSONì„ ë‹¨ìˆœíˆ ë¤í”„

# ğŸ¯ Task
ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê²€ì§„ í•­ëª©ì„ ì„¤ê³„í•˜ì„¸ìš”.
```

**ë¬¸ì œ**: 
- STEP 1ì˜ `chronic_analysis`ê°€ ìˆëŠ”ë°ë„ STEP 2ì—ì„œ ì¬ë¶„ì„
- `risk_profile`ì˜ High Risk ì¥ê¸°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì—°ê²°í•˜ì§€ ì•ŠìŒ

#### ğŸŸ¢ ê°œì„  ë°©í–¥

**STEP 1 ê²°ê³¼ ê°•ì œ ì¸ìš©**:
```
# ğŸ“‹ Context (ì´ì „ ë‹¨ê³„ ë¶„ì„ ê²°ê³¼)

**âš ï¸ ì•„ë˜ëŠ” ì´ë¯¸ ë¶„ì„ì´ ì™„ë£Œëœ ê²°ê³¼ì…ë‹ˆë‹¤. ì ˆëŒ€ ì¬ë¶„ì„í•˜ì§€ ë§ê³ , ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê²€ì§„ í•­ëª©ë§Œ ë§¤ì¹­í•˜ì„¸ìš”.**

1. **High/Very High Risk ì¥ê¸°**: {step1ì˜ risk_profileì—ì„œ High ì´ìƒ ì¶”ì¶œ}
   â†’ ì´ ì¥ê¸°ë“¤ì— ëŒ€í•œ ì •ë°€ ê²€ì‚¬ë¥¼ **ë°˜ë“œì‹œ** recommended_itemsì— í¬í•¨í•˜ì„¸ìš”.

2. **ë§Œì„±ì§ˆí™˜ ì—°ì‡„ ë°˜ì‘**: {step1ì˜ chronic_analysis}
   â†’ chronic_chain ì§€ì‹ ë² ì´ìŠ¤ì™€ ë§¤ì¹­í•˜ì—¬ í•©ë³‘ì¦ ê²€ì‚¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.

3. **ì‹œë„ˆì§€ ì•…ìˆœí™˜**: {step1ì˜ chronic_synergy_narrative}
   â†’ strategies ì‘ì„± ì‹œ ì´ ë‚´ëŸ¬í‹°ë¸Œë¥¼ ê·¸ëŒ€ë¡œ ì¸ìš©í•˜ì„¸ìš”.
   â†’ "ê³ ê°ë‹˜ì€ Aì™€ Bê°€ ê²°í•©ë˜ì–´ C ìœ„í—˜ì´ ì¦í­ ì¤‘ì…ë‹ˆë‹¤" í™”ë²• ì‚¬ìš©.

4. **ë°ì´í„° ê³µë°±**: {step1ì˜ data_gaps}
   â†’ ê³µë°±ì´ ìˆëŠ” ì˜ì—­ì€ "ë¯¸ë˜ ì¶”ì  ê¸°ì¤€ í™•ë³´" ë…¼ë¦¬ë¡œ ì¶”ì²œí•˜ì„¸ìš”.
```

#### ğŸ¯ ìˆ˜ì • í¬ì¸íŠ¸
- STEP 2 í”„ë¡¬í”„íŠ¸ì— "STEP 1 ê°•ì œ ì¸ìš©" ì„¹ì…˜ ì¶”ê°€
- STEP 1 ê²°ê³¼ë¥¼ ë‹¨ìˆœ ë¤í”„ê°€ ì•„ë‹Œ "ì§€ì‹œë¬¸" í˜•íƒœë¡œ ì¬êµ¬ì„±
- "ì´ë¯¸ ë¶„ì„ ì™„ë£Œ. ì¬ë¶„ì„ ê¸ˆì§€. í•­ëª© ë§¤ì¹­ë§Œ ìˆ˜í–‰" ëª…ë ¹ ê°•í™”

---

### ë¬¸ì œ 5: ì‹œì˜ì„± (Time Decay) - ê³¼ê±° ë°ì´í„° ì²˜ë¦¬

#### ğŸ“ ìœ„ì¹˜
`create_checkup_design_prompt_step1()` â†’ ê±´ê°•ê²€ì§„ ë°ì´í„° ë‚ ì§œ í•„í„°ë§ (line 2102-2161)

#### ğŸ”´ í˜„ì¬ ìƒíƒœ

```python
# line 2080-2102
five_years_ago = today - timedelta(days=5*365)

# ìµœê·¼ 3ë…„ ë°ì´í„°ë§Œ ì‚¬ìš©
recent_data = sorted(health_data, key=lambda x: x.get('checkup_date', ''), reverse=True)[:3]

for idx, record in enumerate(recent_data, 1):
    checkup_date = record.get('checkup_date')  # "2020-09-15"
    checkup_year = record.get('year')          # "2020"
    
    health_data_section += f"### {idx}. {date_display} - {hospital_name}\n"
    # ì´ìƒ/ê²½ê³„ í•­ëª© ë‚˜ì—´...
```

**ë¬¸ì œ**:
- 2020ë…„ ë°ì´í„°ë“  2023ë…„ ë°ì´í„°ë“  ë™ë“±í•˜ê²Œ ì·¨ê¸‰
- "4ë…„ ì „ í˜ˆì•• 135"ë¥¼ í˜„ì¬ ìƒíƒœë¡œ ê°„ì£¼
- ì‹œì  êµ¬ë¶„ ì—†ìŒ

#### ğŸŸ¢ ê°œì„  ë°©í–¥

```python
def classify_data_by_recency(checkup_date: str) -> tuple[str, str]:
    """ê²€ì§„ ë°ì´í„° ì‹œì˜ì„± ë¶„ë¥˜"""
    from datetime import datetime
    
    date_obj = datetime.fromisoformat(checkup_date)
    today = datetime.now()
    years_ago = (today - date_obj).days / 365
    
    if years_ago < 2:
        return "[Current]", "í˜„ì¬ ìƒíƒœë¡œ í•´ì„ ê°€ëŠ¥"
    elif years_ago < 5:
        return "[History]", "ê³¼ê±° ì´ë ¥. ì¬í™•ì¸ í•„ìš”ì„± ê·¼ê±°ë¡œë§Œ í™œìš©"
    else:
        return "[Outdated]", "ì˜¤ë˜ëœ ë°ì´í„°. ì°¸ê³ ë§Œ ê°€ëŠ¥"

# í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹œ
health_data_section += f"### {idx}. {date_display} - {hospital_name} {tag}\n"
health_data_section += f"**ì‹œì  í•´ì„**: {meaning}\n"

# ì´ìƒ í•­ëª©
if tag == "[History]":
    abnormal_items.append(
        f"- {item_name}: {item_value} {item_unit} (ë‹¹ì‹œ ì´ìƒ) "
        f"â†’ í˜„ì¬ëŠ” ë³€í™”í–ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¬ê²€ í•„ìš”"
    )
```

**ì¶œë ¥ ì˜ˆì‹œ (ê°œì„ )**:
```
### 1. 2020ë…„ 09/15 - ì„œìš¸ëŒ€ë³‘ì› [History]
**ì‹œì  í•´ì„**: 4ë…„ ì „ ë°ì´í„°. ê³¼ê±° ì´ë ¥ìœ¼ë¡œë§Œ í™œìš©. í˜„ì¬ ìƒíƒœ ì¬í™•ì¸ í•„ìš”.

**ë‹¹ì‹œ ê²½ê³„ í•­ëª©:**
- í˜ˆì••(ìˆ˜ì¶•ê¸°): 135 mmHg (ë‹¹ì‹œ ê²½ê³„) â†’ í˜„ì¬ëŠ” ë³€í™”í–ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¬ê²€ í•„ìš”
- ê³µë³µí˜ˆë‹¹: 110 mg/dL (ë‹¹ì‹œ ê²½ê³„) â†’ 4ë…„ê°„ ì•…í™” ê°€ëŠ¥ì„±. ìµœì‹  ìƒíƒœ í™•ì¸ ì‹œê¸‰
```

#### ğŸ¯ ìˆ˜ì • í¬ì¸íŠ¸
- `classify_data_by_recency()` í•¨ìˆ˜ ì¶”ê°€
- 2ë…„ / 5ë…„ ê¸°ì¤€ìœ¼ë¡œ íƒœê·¸ ë¶„ë¥˜
- í”„ë¡¬í”„íŠ¸ì— ì‹œì ë³„ í•´ì„ ë°©ë²• ëª…ì‹œ

---

### ë¬¸ì œ 6: RAG ì‹œìŠ¤í…œ í™œìš©ë„ (ì¶”ê°€ ë°œê²¬)

#### ğŸ“ ìœ„ì¹˜
`get_medical_evidence_from_rag()` (line 588-650)

#### ğŸ”´ í˜„ì¬ ìƒíƒœ

**RAG ê²€ìƒ‰ ì‹¤í–‰**:
```python
# line 2454-2463
rag_result = await get_medical_evidence_from_rag(
    query_engine=query_engine,
    patient_context=patient_context,
    concerns=selected_concerns
)

rag_evidence_context = rag_result.get("context_text", "")
structured_evidences = rag_result.get("structured_evidences", [])
```

**ê·¸ëŸ¬ë‚˜ ì‹¤ì œ í™œìš©**:
```python
# line 2967ì—ì„œ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€
prompt_parts.append(hospital_items_section)  # ë³‘ì› í•­ëª©
# âŒ rag_evidence_contextë¥¼ í”„ë¡¬í”„íŠ¸ì— ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ!
```

**RAG í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„**:
- âœ… ê²€ìƒ‰ í’ˆì§ˆ: ë§¤ìš° ìš°ìˆ˜ (ì‹ ë¢°ë„ 0.49~0.84)
- âœ… ê°€ì´ë“œë¼ì¸ ì •í™•ë„: ë†’ìŒ (LDL 55, 30ê°‘ë…„ ë“±)
- âš ï¸ **í™œìš©ë„: ë‚®ìŒ** - ê²€ìƒ‰ì€ í•˜ì§€ë§Œ í”„ë¡¬í”„íŠ¸ì— ì§ì ‘ ì£¼ì… ì•ˆí•¨

#### ğŸŸ¢ ê°œì„  ë°©í–¥

```python
# RAG ê²€ìƒ‰ í›„
if rag_evidence_context:
    prompt_parts.append(f"""
# ğŸ”¬ [Critical Evidence] ì˜í•™ì  ê·¼ê±° (RAG ê²€ìƒ‰ ê²°ê³¼)

**ì•„ë˜ëŠ” LlamaCloud ì˜í•™ ì§€ì‹ ë² ì´ìŠ¤ì—ì„œ ê²€ìƒ‰í•œ ìµœì‹  ê°€ì´ë“œë¼ì¸ì…ë‹ˆë‹¤.**
**ëª¨ë“  ì¶”ì²œ í•­ëª©ì˜ evidence í•„ë“œì— ì•„ë˜ ì¸ìš©êµ¬ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ì„¸ìš”.**

{rag_evidence_context}

**ì‚¬ìš© ë°©ë²•**:
1. ìœ„ ì¸ìš©êµ¬ ì¤‘ ê´€ë ¨ ìˆëŠ” ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì„¸ìš”.
2. "[ë¬¸ì„œëª…]ì— ë”°ë¥´ë©´ '[ì¸ìš©êµ¬]'" í˜•ì‹ì„ ìœ ì§€í•˜ì„¸ìš”.
3. RAG ê²°ê³¼ê°€ ì—†ëŠ” í•­ëª©ì€ Master DB ì§€ì‹ ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
""")
```

#### ğŸ¯ ìˆ˜ì • í¬ì¸íŠ¸
- RAG ê²€ìƒ‰ ê²°ê³¼ë¥¼ í”„ë¡¬í”„íŠ¸ì— ëª…ì‹œì ìœ¼ë¡œ ì£¼ì…
- "[Critical Evidence]" ì„¹ì…˜ìœ¼ë¡œ ê°•ì¡°
- "ì´ ì„¹ì…˜ì˜ ì¸ìš©êµ¬ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ë¼" ì§€ì‹œ ì¶”ê°€

---

## ğŸ“Š í˜„ì¬ í”„ë¡¬í”„íŠ¸ í†µê³„

### STEP 1 í”„ë¡¬í”„íŠ¸ êµ¬ì¡°
- **ê¸¸ì´**: ì•½ 3,000~5,000ì (í™˜ì ë°ì´í„°ì— ë”°ë¼ ë³€ë™)
- **ì„¹ì…˜ êµ¬ì„±**:
  - Master Knowledge Base (1,500ì)
  - í™˜ì ì •ë³´ (200ì)
  - ê±´ê°•ê²€ì§„ ë°ì´í„° (500~2,000ì) âš ï¸ ê°€ë³€ì„± í¼
  - ì²˜ë°©ì „ ë°ì´í„° (300~1,000ì)
  - ì—¼ë ¤ í•­ëª© (200ì)
  - ë¬¸ì§„ ì‘ë‹µ (300ì)
  - ì¶œë ¥ í¬ë§· (500ì)

### STEP 2 í”„ë¡¬í”„íŠ¸ êµ¬ì¡°
- **ê¸¸ì´**: ì•½ 8,000~12,000ì
- **ì„¹ì…˜ êµ¬ì„±**:
  - Master Knowledge Base (1,500ì)
  - RAG Evidence (1,000~3,000ì) âš ï¸ ì œëŒ€ë¡œ ì£¼ì… ì•ˆë¨
  - STEP 1 ê²°ê³¼ (1,500ì)
  - í™˜ì/ê²€ì§„ ë°ì´í„° (ê°„ì†Œí™”, 1,000ì)
  - ë³‘ì› ê²€ì§„ í•­ëª© (2,000ì)
  - ì¶œë ¥ í¬ë§· + ì§€ì‹œë¬¸ (3,000ì)

### í† í° ì‚¬ìš©ëŸ‰ ì¶”ì •
- STEP 1: ì•½ 1,200~2,000 í† í° (í”„ë¡¬í”„íŠ¸) + 500~800 í† í° (ì‘ë‹µ)
- STEP 2: ì•½ 3,000~4,500 í† í° (í”„ë¡¬í”„íŠ¸) + 1,500~2,500 í† í° (ì‘ë‹µ)
- **ì´**: ì•½ 6,200~9,800 í† í° (1íšŒ ê²€ì§„ ì„¤ê³„ ë‹¹)

---

## ğŸ”§ RAG ì‹œìŠ¤í…œ í˜„í™© ë¶„ì„

### LlamaCloud í…ŒìŠ¤íŠ¸ ê²°ê³¼ (2024-12-06)

| ì¿¼ë¦¬ | ì†Œìš” ì‹œê°„ | ì°¸ê³  ë¬¸ì„œ | ì‹ ë¢°ë„ | ì‘ë‹µ ê¸¸ì´ | í’ˆì§ˆ í‰ê°€ |
|------|----------|----------|--------|----------|----------|
| ê°„ìˆ˜ì¹˜ ì •ìƒì´ì–´ë„ ì˜ìƒê²€ì‚¬ í•„ìš” | 6.51ì´ˆ | 6ê°œ | 0.49~0.57 | 564ì | âœ… ìš°ìˆ˜ |
| ë‹¹ë‡¨ ì‹ ì¥/ì‹¬í˜ˆê´€ í•©ë³‘ì¦ | 2.89ì´ˆ | 6ê°œ | 0.64~0.80 | 180ì | âœ… ë§¤ìš°ìš°ìˆ˜ |
| ì´ìƒì§€ì§ˆí˜ˆì¦ LDL ëª©í‘œì¹˜ | 4.46ì´ˆ | 6ê°œ | - | 177ì | âœ… ìš°ìˆ˜ |
| í‰ë¶€ X-ray vs ì €ì„ ëŸ‰ CT | 2.69ì´ˆ | 6ê°œ | - | 182ì | âœ… ìš°ìˆ˜ |
| ì•¡ì²´ìƒê²€ ì›ë¦¬ | 3.29ì´ˆ | 6ê°œ | 0.77~0.84 | 432ì | âœ… ë§¤ìš°ìš°ìˆ˜ |

**í†µê³„**:
- í‰ê·  ì‘ë‹µ ì‹œê°„: **3.97ì´ˆ**
- í‰ê·  ì°¸ê³  ë¬¸ì„œ: **6ê°œ**
- í‰ê·  ì‘ë‹µ ê¸¸ì´: **307ì**

**ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„**:
- LlamaCloud Playground ì‘ë‹µ: 300~500ì (ìƒì„¸)
- ìš°ë¦¬ ì‹œìŠ¤í…œ ì‘ë‹µ: 180~564ì (ê°„ê²°)
- **ì›ì¸**: `response_mode="compact"` â†’ **ê°œì„ **: `tree_summarize`ë¡œ ë³€ê²½ âœ…

### RAG ê²€ìƒ‰ í’ˆì§ˆ

**âœ… ê°•ì **:
1. ìµœì‹  ê°€ì´ë“œë¼ì¸ ì •í™•íˆ ê²€ìƒ‰ (2025 ë‹¹ë‡¨ë³‘, 2024 MASLD)
2. êµ¬ì²´ì  ìˆ˜ì¹˜ ì¸ìš© (LDL 55, 30ê°‘ë…„, 20% ì‚¬ë§ë¥  ê°ì†Œ)
3. ì‹ ë¢°ë„ ë†’ì€ ë¬¸ì„œ (0.77~0.84)

**âš ï¸ ì•½ì **:
1. RAG ê²°ê³¼ë¥¼ í”„ë¡¬í”„íŠ¸ì— ëª…ì‹œì ìœ¼ë¡œ ì£¼ì… ì•ˆí•¨
2. ê²€ìƒ‰ë§Œ í•˜ê³  í™œìš©ë„ê°€ ë‚®ìŒ
3. GPTê°€ RAG ê²°ê³¼ë³´ë‹¤ ìì²´ ì§€ì‹ ìš°ì„  ì‚¬ìš© ê°€ëŠ¥

---

## ğŸ’¡ ê°œì„  ìš°ì„ ìˆœìœ„ ì œì•ˆ

### Phase 1: ì¦‰ì‹œ ê°œì„  ê°€ëŠ¥ (Low Hanging Fruit)

| ìˆœìœ„ | ì‘ì—… | íŒŒì¼ | ë¼ì¸ | ì˜ˆìƒ ì‹œê°„ | íš¨ê³¼ |
|-----|------|------|-----|----------|------|
| ğŸ¥‡ | RAG ê²°ê³¼ ëª…ì‹œì  ì£¼ì… | checkup_design_prompt.py | 2967 ë¶€ê·¼ | 30ë¶„ | â­â­â­â­â­ |
| ğŸ¥ˆ | response_mode ë³€ê²½ | checkup_design_prompt.py | 313 | 5ë¶„ | â­â­â­ |
| ğŸ¥‰ | BRIDGE_STRATEGY ì¬ì‘ì„± | checkup_design_prompt.py | 137-176 | 1ì‹œê°„ | â­â­â­â­ |

### Phase 2: êµ¬ì¡° ê°œì„  (Structural Refactoring)

| ìˆœìœ„ | ì‘ì—… | ë³µì¡ë„ | ì˜ˆìƒ ì‹œê°„ | íš¨ê³¼ |
|-----|------|--------|----------|------|
| 1 | Semantic Tagging ì‹œìŠ¤í…œ êµ¬ì¶• | ì¤‘ | 3ì‹œê°„ | â­â­â­â­â­ |
| 2 | Time Decay ë¡œì§ ì¶”ê°€ | ì¤‘ | 2ì‹œê°„ | â­â­â­â­ |
| 3 | STEP 1 ìŠ¤í‚¤ë§ˆ í™•ì¥ (synergy_narrative) | ê³  | 4ì‹œê°„ | â­â­â­â­â­ |
| 4 | STEP 2 ê°•ì œ ì¸ìš© ë¡œì§ | ì¤‘ | 2ì‹œê°„ | â­â­â­â­ |

### Phase 3: ê³ ê¸‰ ìµœì í™” (Advanced Optimization)

| ìˆœìœ„ | ì‘ì—… | ë³µì¡ë„ | ì˜ˆìƒ ì‹œê°„ | íš¨ê³¼ |
|-----|------|--------|----------|------|
| 1 | í”„ë¡¬í”„íŠ¸ A/B í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ | ê³  | 8ì‹œê°„ | â­â­â­â­ |
| 2 | ë™ì  Bridge Strategy ì„ íƒ | ê³  | 6ì‹œê°„ | â­â­â­â­â­ |
| 3 | í† í° ìµœì í™” (ì••ì¶• ì•Œê³ ë¦¬ì¦˜) | ê³  | 10ì‹œê°„ | â­â­â­ |

---

## ğŸ¯ ê¶Œì¥ ì‘ì—… ìˆœì„œ

### ğŸš€ Quick Win (1ì¼ ë‚´)
1. **response_mode ë³€ê²½** (5ë¶„) âœ… ì™„ë£Œ
2. **RAG ê²°ê³¼ ëª…ì‹œì  ì£¼ì…** (30ë¶„)
3. **BRIDGE_STRATEGY ì•” í¸í–¥ í•´ì†Œ** (1ì‹œê°„)

### ğŸ“ˆ Core Improvement (1ì£¼ ë‚´)
4. **Semantic Tagging ì‹œìŠ¤í…œ** (3ì‹œê°„)
5. **Time Decay ë¡œì§** (2ì‹œê°„)
6. **STEP 1 ìŠ¤í‚¤ë§ˆ í™•ì¥** (4ì‹œê°„)
7. **STEP 2 ê°•ì œ ì¸ìš©** (2ì‹œê°„)

### ğŸ”¬ Advanced (2ì£¼ ë‚´)
8. **í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸ ìë™í™”**
9. **ë™ì  ì „ëµ ì„ íƒ ì—”ì§„**
10. **í† í° ìµœì í™”**

---

## ğŸ“Œ ë‹¤ìŒ ë‹¨ê³„

### ì˜¤ëŠ˜ (2024-12-06)
- âœ… response_mode ë³€ê²½ ì™„ë£Œ
- âœ… í˜„í™© ë¶„ì„ ì™„ë£Œ
- â³ RAG ê²°ê³¼ ì£¼ì… ì„¤ê³„ (ë‹¤ìŒ)

### ë‚´ì¼ (2024-12-07)
- RAG ê²°ê³¼ ëª…ì‹œì  ì£¼ì… êµ¬í˜„
- BRIDGE_STRATEGY ì¬ì‘ì„±
- ì‹¤ì œ í™˜ì ë°ì´í„°ë¡œ Before/After í…ŒìŠ¤íŠ¸

### ì´ë²ˆ ì£¼ (2024-12-09ê¹Œì§€)
- Semantic Tagging ì‹œìŠ¤í…œ êµ¬ì¶•
- Time Decay ë¡œì§ ì¶”ê°€
- STEP 1 ìŠ¤í‚¤ë§ˆ í™•ì¥

---

## ğŸ“š ì°¸ê³  ìë£Œ

- **ì½”ë“œ ìœ„ì¹˜**: `planning-platform/backend/app/services/checkup_design_prompt.py`
- **RAG í…ŒìŠ¤íŠ¸**: `planning-platform/backend/test_llamacloud_queries.py`
- **í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸**: `planning-platform/backend/test_prompt.py`
- **í…ŒìŠ¤íŠ¸ ê²°ê³¼**: `planning-platform/backend/llamacloud_test_results_20251206_150526.json`

---

**ì‘ì„±ì**: AI Assistant  
**ìµœì¢… ìˆ˜ì •**: 2024-12-06 15:10

