# 📊 채팅/문진 데이터 플로우 전체 점검 리포트

## 🎯 점검 목적
프론트엔드 ChatInterface에서 수집한 모든 데이터가 백엔드 프롬프트까지 제대로 전달되는지 확인

---

## ✅ STEP 1: 프론트엔드 데이터 수집

### 1.1 ChatInterface - 약품 데이터 수집
**파일**: `frontend/src/components/checkup-design/ChatInterface/index.tsx`

**수집 데이터**:
- `state.selectedPrescriptionEffects`: 사용자가 선택한 약품 효능 리스트
- `prescriptionAnalysis`: 약품 패턴 분석 결과
- `prescriptionAnalysisText`: 분석 결과 텍스트 (HTML 포함)
- `selectedMedicationTexts`: 선택된 약품의 사용자 친화적 텍스트 배열

**코드 위치**: Line 726-847 (`handleSurveySubmit` 함수)

**상태**: ✅ 정상
- 약품 효능별로 패턴 분석
- 사용자 친화적 텍스트 생성
- ConcernSelection 구조와 동일한 형식으로 변환

---

### 1.2 ChatInterface - 검진 데이터 수집
**파일**: `frontend/src/components/checkup-design/ChatInterface/index.tsx`

**수집 데이터**:
- `state.selectedCheckupRecords`: 사용자가 선택한 검진 기록 ID 배열
- `healthData`: 전체 건강검진 데이터
- 각 검진별 이상/경계 항목 분석 (statusCounts)

**코드 위치**: Line 796-832 (`handleSurveySubmit` 함수)

**상태**: ✅ 정상
- 선택된 검진 기록별로 상태 분석
- 이상/경계 항목 개수 계산
- ConcernSelection 구조 호환

---

### 1.3 CheckupDesignSurveyPanel - 문진 응답 수집
**파일**: `frontend/src/components/checkup-design/CheckupDesignSurveyPanel/index.tsx`

**수집 데이터**:
```typescript
interface SurveyResponses {
  weight_change: string;           // 체중 변화
  exercise_frequency: string;      // 운동 빈도
  family_history: string[];        // 가족력 (배열)
  smoking: string;                 // 흡연
  drinking: string;                // 음주
  sleep_hours: string;             // 수면 시간
  stress_level: string;            // 스트레스 수준
  additional_concerns: string;     // 추가 염려사항
  // 선택적 질문
  optional_questions_enabled?: string;
  cancer_history?: string;
  hepatitis_carrier?: string;
  colonoscopy_experience?: string;
  lung_nodule?: string;
  gastritis?: string;
  imaging_aversion?: string[];
  genetic_test?: string;
}
```

**코드 위치**: Line 9-27 (인터페이스), Line 53-64 (초기화)

**상태**: ✅ 정상
- 9개 필수 질문 + 7개 선택적 질문
- 슬라이드 형태로 순차 진행
- 자동 다음 질문 이동 (라디오 선택 시)

---

### 1.4 ChatInterface - 통합 데이터 전송
**파일**: `frontend/src/components/checkup-design/ChatInterface/index.tsx`

**전송 데이터 구조**:
```typescript
const enhancedSurveyResponses = {
  ...surveyResponses,                      // 문진 응답 (9개 필수 + 선택적)
  prescription_analysis_text: string,      // 약품 분석 HTML
  selected_medication_texts: string[]      // 선택된 약품 텍스트 배열
};

onNext(selectedItems, selectedConcerns, enhancedSurveyResponses);
```

**코드 위치**: Line 839-846

**상태**: ✅ 정상
- 문진 응답에 약품 분석 데이터 추가
- 3개 파라미터 전달 (selectedItems, selectedConcerns, enhancedSurveyResponses)

---

## ✅ STEP 2: API 호출 (프론트 → 백)

### 2.1 CheckupDesignPage - API 호출
**파일**: `frontend/src/pages/CheckupDesignPage.tsx`

**STEP 1 호출**:
```typescript
const step1Response = await checkupDesignService.createCheckupDesignStep1({
  uuid,
  hospital_id: hospital,
  selected_concerns: selectedConcerns,
  survey_responses: surveyResponses    // ✅ 문진 데이터 포함
});
```

**코드 위치**: Line 137-142

**STEP 2 호출**:
```typescript
const step2Response = await checkupDesignService.createCheckupDesignStep2({
  uuid,
  hospital_id: hospital,
  step1_result: step1Result,
  selected_concerns: selectedConcerns,
  survey_responses: surveyResponses,   // ✅ 문진 데이터 포함
  ...
});
```

**상태**: ✅ 정상
- STEP 1, STEP 2 모두 survey_responses 전송

---

## ✅ STEP 3: 백엔드 API 수신

### 3.1 API 엔드포인트 - 데이터 수신
**파일**: `backend/app/api/v1/endpoints/checkup_design.py`

**Request 모델**:
```python
class CheckupDesignRequestStep1(BaseModel):
    uuid: str
    hospital_id: str
    selected_concerns: List[ConcernItem]
    survey_responses: Optional[Dict[str, Any]] = None  # ✅ 문진 수신
    ...

class CheckupDesignRequestStep2(BaseModel):
    uuid: str
    hospital_id: str
    step1_result: Step1Result
    selected_concerns: List[ConcernItem]
    survey_responses: Optional[Dict[str, Any]] = None  # ✅ 문진 수신
    ...
```

**코드 위치**: Line 59-96

**상태**: ✅ 정상
- STEP 1, STEP 2 모두 survey_responses 필드 있음

---

### 3.2 API 엔드포인트 - 데이터 정리
**파일**: `backend/app/api/v1/endpoints/checkup_design.py`

**STEP 1 데이터 정리** (Line 647-662):
```python
survey_responses_clean = request.survey_responses or {}
prescription_analysis_text = survey_responses_clean.pop("prescription_analysis_text", None)
selected_medication_texts = survey_responses_clean.pop("selected_medication_texts", None)

# ✅ survey_responses_clean: 순수 문진 데이터만 (약품 데이터 분리됨)
```

**STEP 2 데이터 정리** (Line 895-898):
```python
survey_responses_clean = request.survey_responses or {}
prescription_analysis_text = survey_responses_clean.pop("prescription_analysis_text", None)
selected_medication_texts = survey_responses_clean.pop("selected_medication_texts", None)

# ✅ survey_responses_clean: 순수 문진 데이터만
```

**상태**: ✅ 정상
- 약품 분석 텍스트는 별도 파라미터로 분리
- 문진 응답은 survey_responses_clean으로 전달

---

## ✅ STEP 4: 프롬프트 생성

### 4.1 STEP 1 프롬프트 - 문진 데이터 포함
**파일**: `backend/app/services/checkup_design_prompt.py`

**함수**: `create_checkup_design_prompt_step1` (Line 2079-2379)

**문진 섹션 생성** (Line 2210-2230):
```python
survey_section = ""
if survey_responses:
    survey_section = "\n## 문진 응답\n"
    key_items = ['weight_change', 'exercise_frequency', 'family_history', 
                 'smoking', 'drinking', 'sleep_hours', 'stress_level', 
                 'cancer_history', 'hepatitis_carrier']
    for key in key_items:
        value = survey_responses.get(key)
        if value:
            key_name_map = {
                'weight_change': '체중 변화',
                'exercise_frequency': '운동 빈도',
                'family_history': '가족력',
                ...
            }
            survey_section += f"- {key_name_map.get(key, key)}: {value}\n"
```

**프롬프트 포함** (Line 2290):
```python
prompt = f"""
...
{survey_section}
...
"""
```

**상태**: ✅ 정상
- 9개 핵심 문진 항목 매핑
- 한글 라벨로 변환
- f-string으로 프롬프트에 포함

**테스트 결과**: ✅ 로그 확인됨
```
## 문진 응답
- 체중 변화: increase_more
- 운동 빈도: rarely
- 가족력: ['hypertension', 'heart_disease']
- 흡연: current_smoker
- 음주: monthly_less
- 수면 시간: 7_8
- 스트레스 수준: very_high
```

---

### 4.2 STEP 2 프롬프트 - 문진 데이터 포함 ⚠️ 수정 완료
**파일**: `backend/app/services/checkup_design_prompt.py`

**함수**: `create_checkup_design_prompt_step2` (Line 2390-3178)

**문진 섹션 생성** (Line 2617-2636):
```python
survey_section = ""
if survey_responses:
    survey_section = "\n## 문진 응답\n"
    key_items = ['weight_change', 'exercise_frequency', 'family_history', 
                 'smoking', 'drinking', 'sleep_hours', 'stress_level', 
                 'cancer_history', 'hepatitis_carrier']
    for key in key_items:
        value = survey_responses.get(key)
        if value:
            key_name_map = {...}
            survey_section += f"- {key_name_map.get(key, key)}: {value}\n"
```

**프롬프트 포함** (Line 2870-2883) - ⚠️ **방금 수정함**:
```python
# ❌ 이전 코드 (문제):
# {patient_info}{health_data_section}{prescription_section}{concerns_section}{survey_section}{hospital_items_section}

# ✅ 수정된 코드:
""")
    
# 환자 정보 및 데이터 섹션들 추가
prompt_parts.append(patient_info)
prompt_parts.append(health_data_section)
prompt_parts.append(prescription_section)
prompt_parts.append(concerns_section)
prompt_parts.append(survey_section)          # ✅ 문진 데이터 추가!
prompt_parts.append(hospital_items_section)

prompt_parts.append("""
# Output Format (JSON)
```

**프롬프트 조합** (Line 3175):
```python
prompt = "\n".join(prompt_parts)
```

**상태**: ✅ 수정 완료 (커밋 대기 중)
- **이전 문제**: f-string 플레이스홀더가 prompt_parts에 추가되지 않음
- **해결**: 모든 섹션을 명시적으로 prompt_parts.append()로 추가
- **결과**: 문진 데이터가 STEP 2 프롬프트에 정상 포함됨

---

## 📊 데이터 플로우 요약

```
[프론트엔드]
1. CheckupDesignSurveyPanel
   └─> SurveyResponses 수집 (9개 필수 + 7개 선택)
       - weight_change, exercise_frequency, family_history
       - smoking, drinking, sleep_hours, stress_level
       - cancer_history, hepatitis_carrier, ...

2. ChatInterface
   └─> 약품/검진 데이터 + 문진 응답 통합
       - selectedConcerns (약품 + 검진)
       - enhancedSurveyResponses (문진 + 약품 분석)

3. CheckupDesignPage
   └─> API 호출
       - createCheckupDesignStep1({ ..., survey_responses })
       - createCheckupDesignStep2({ ..., survey_responses })

[백엔드]
4. checkup_design.py (API)
   └─> 데이터 수신 및 정리
       - survey_responses_clean (순수 문진)
       - prescription_analysis_text (약품 분석)
       - selected_medication_texts (선택 약품)

5. checkup_design_prompt.py (STEP 1)
   └─> 문진 섹션 생성
       - survey_section = "\n## 문진 응답\n..."
       - 9개 핵심 항목 매핑
       ✅ 프롬프트에 포함 확인됨

6. checkup_design_prompt.py (STEP 2)
   └─> 문진 섹션 생성
       - survey_section = "\n## 문진 응답\n..."
       - 9개 핵심 항목 매핑
       ✅ prompt_parts에 추가 (방금 수정)

[LLM]
7. OpenAI GPT
   └─> 문진 데이터 기반 분석/설계
       - STEP 1: 위험도 분석 시 문진 반영
       - STEP 2: 검진 추천 시 문진 반영
```

---

## ✅ 최종 검증 체크리스트

### 프론트엔드
- [✅] ChatInterface: 약품 데이터 수집
- [✅] ChatInterface: 검진 데이터 수집
- [✅] SurveyPanel: 문진 응답 수집 (9개 필수)
- [✅] ChatInterface: 통합 데이터 전송
- [✅] CheckupDesignPage: API 호출 (STEP 1)
- [✅] CheckupDesignPage: API 호출 (STEP 2)

### 백엔드 API
- [✅] checkup_design.py: survey_responses 수신 (STEP 1)
- [✅] checkup_design.py: survey_responses 수신 (STEP 2)
- [✅] checkup_design.py: 데이터 정리 (약품 분리)

### 백엔드 프롬프트
- [✅] STEP 1: survey_section 생성
- [✅] STEP 1: 프롬프트 포함 (f-string)
- [✅] STEP 1: 로그 확인 (실제 데이터 포함됨)
- [✅] STEP 2: survey_section 생성
- [✅] **STEP 2: 프롬프트 포함 (방금 수정!)**
- [⏳] STEP 2: 로그 확인 (재시작 후 테스트 필요)

---

## 🚨 발견된 문제 및 해결

### 문제 1: STEP 2 프롬프트에 문진 데이터 누락
**증상**:
- STEP 1 로그에는 문진 데이터 있음
- STEP 2 로그에는 문진 데이터 없음
- 사용자가 입력한 풍부한 문진 내용이 검진 설계에 반영 안됨

**원인**:
```python
# Line 2872 (수정 전)
{patient_info}{health_data_section}{prescription_section}{concerns_section}{survey_section}{hospital_items_section}
```
- f-string 플레이스홀더가 prompt_parts 리스트에 추가되지 않음
- 문자열 연결 방식 변경 시 누락됨

**해결**:
```python
# Line 2870-2883 (수정 후)
""")

# 환자 정보 및 데이터 섹션들 추가
prompt_parts.append(patient_info)
prompt_parts.append(health_data_section)
prompt_parts.append(prescription_section)
prompt_parts.append(concerns_section)
prompt_parts.append(survey_section)          # ✅ 추가!
prompt_parts.append(hospital_items_section)

prompt_parts.append("""
```

**영향**:
- 가족력 기반 검진 추천 정확도 향상
- 생활습관(흡연, 음주, 운동) 맞춤 설계 가능
- 체중 변화, 스트레스 수준 반영 가능

---

## 🎯 결론

### 현재 상태
1. ✅ **프론트엔드 → 백엔드**: 모든 데이터 정상 전달
2. ✅ **STEP 1 프롬프트**: 문진 데이터 정상 포함
3. ✅ **STEP 2 프롬프트**: 문진 데이터 포함 (방금 수정)

### 다음 단계
1. 코드 커밋 및 푸시
2. PM2 재시작 (새 코드 반영)
3. 실제 검진설계 재실행
4. STEP 2 로그 확인 (문진 데이터 포함 여부)

### 예상 결과
문진 데이터가 포함된 후 검진 설계 품질 향상:
- "가족력으로 고혈압, 심장질환이 있으시니 심혈관 정밀검진을 권장합니다"
- "현재 흡연 중이시고 체중이 3kg 이상 증가했으므로 폐/대사 건강 확인이 필요합니다"
- "운동을 거의 안 하시고 스트레스가 매우 높으므로 심혈관 위험이 높습니다"

---

**작성일**: 2025-12-05
**점검자**: AI Assistant
**상태**: 수정 완료, 테스트 대기

