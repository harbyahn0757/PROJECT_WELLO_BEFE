"""
검진설계 문진 ↔ Mediarc 코드 매핑 상수
===========================================

이 파일은 검진설계에서 수집한 문진 데이터를 Mediarc API 요구 형식으로 변환하기 위한
매핑 상수를 정의합니다.

## 데이터 출처

### 1. 검진설계 문진 (Source)
- **위치**: `welno.welno_checkup_design_requests.survey_responses` (JSONB)
- **수집 화면**: CheckupDesignSurveyPanel 컴포넌트
- **질문 수**: 8개 기본 + 1개 조건부 (35세 이상)
- **형식**: { "smoking": "current_smoker", "drinking": "weekly_1_2", ... }

### 2. Mediarc API 요구 형식 (Target)
- **문서**: `/docs/Mediarc_report`
- **형식**: { "smoke": "SMK0003", "drink": "DRK0002", "family": ["FH0002"], ... }
- **필수 여부**: 선택 필드이지만, 없으면 "필수항목 누락" 에러 발생 (API 버그)
- **해결책**: 기본값 (없음) 자동 추가

---

## 검진설계 문진 구조 상세

### 질문 1: 흡연 (smoking)
**프론트엔드 질문**: "흡연하시나요?"
**타입**: 라디오 (단일 선택)
**옵션**:
- `non_smoker`: 비흡연
- `ex_smoker`: 과거 흡연 (금연)
- `current_smoker`: 현재 흡연

**실제 수집 데이터 예시**:
```json
{"smoking": "current_smoker"}
```

### 질문 2: 음주 (drinking)
**프론트엔드 질문**: "음주 빈도는?"
**타입**: 라디오 (단일 선택)
**옵션**:
- `never`: 전혀 안 함
- `monthly_less`: 월 1회 미만
- `monthly_1_2`: 월 1-2회
- `weekly_1_2`: 주 1-2회
- `weekly_3plus`: 주 3회 이상

**실제 수집 데이터 예시**:
```json
{"drinking": "weekly_1_2"}
```

### 질문 3: 가족력 (family_history)
**프론트엔드 질문**: "가족 중에 다음 질환이 있으신가요? (복수 선택 가능)"
**타입**: 체크박스 (복수 선택)
**옵션**:
- `cancer`: 암
- `stroke`: 뇌졸중
- `heart_disease`: 심장질환
- `diabetes`: 당뇨
- `hypertension`: 고혈압
- `none`: 없음

**실제 수집 데이터 예시**:
```json
{"family_history": ["heart_disease", "diabetes"]}
```

### 질문 4-8: 기타 (Mediarc 매핑 불필요)
- `exercise_frequency`: 운동 빈도 (Mediarc 미사용)
- `sleep_hours`: 수면 시간 (Mediarc 미사용)
- `daily_routine`: 일과 패턴 (Mediarc 미사용)
- `weight_change`: 체중 변화 (Mediarc 미사용)
- `additional_concerns`: 자유 텍스트 (Mediarc 미사용)

**참고**: 이 데이터는 검진 설계 GPT 프롬프트와 페르소나 계산에 사용됨

### 질문 9: 대장내시경 (35세 이상 조건부)
- `colonoscopy_experience`: 대장내시경 경험 (Mediarc 미사용)

---

## Mediarc API 코드표 (Target)

### 음주 코드 (drink)
- `DRK0001`: 예 (안마심)
- `DRK0002`: 아니요 (주 1-2회 정도)
- `DRK0003`: (문서 미정의, 추정: 주 3-4회)
- `DRK0004`: (문서 미정의, 추정: 거의매일)

**참고**: Mediarc 문서의 코드표가 불완전하여 추정 필요

### 흡연 코드 (smoke)
- `SMK0001`: 예 (비흡연)
- `SMK0002`: 금연중 (과거흡연)
- `SMK0003`: 아니요 (현재흡연)

### 가족력 코드 (family)
- `FH0001`: 없음
- `FH0002`: 고혈압
- `FH0003`: 뇌혈관질환
- `FH0004`: 당뇨
- `FH0005`: 대장암
- `FH0006`: 심혈관질환
- `FH0007`: 갑상선암
- `FH0008`: 신장암
- `FH0009`: 유방암
- `FH0010`: 전립선암
- `FH0011`: 폐암

### 질환 코드 (disease) - 본인
- `DIS0001`: 없음
- `DIS0002`: 간경화
- `DIS0003`: 갑상선염
- `DIS0004`: 고혈압
- `DIS0005`: 궤양성대장염
- `DIS0006`: 뇌혈관질환
- `DIS0007`: 늦은 폐경
- `DIS0008`: 담낭용종
- `DIS0009`: 담석증
- `DIS0010`: 당뇨
- `DIS0011`: 만성위염
- `DIS0012`: 바이러스성간염 B형
- `DIS0013`: 바이러스성간염 C형
- `DIS0014`: 심혈관질환
- `DIS0015`: 알츠하이머병
- `DIS0016`: 장티푸스 보균자
- `DIS0017`: 췌장염
- `DIS0018`: 헬리코박터균 감염

### 암 코드 (cancer) - 본인
- `CNR0001`: 없음
- `CNR0002`: 간암
- `CNR0003`: 갑상선암
- `CNR0004`: 담낭암
- `CNR0005`: 대장암
- `CNR0006`: 신장암
- `CNR0007`: 위암
- `CNR0008`: 유방암
- `CNR0009`: 전립선암
- `CNR0010`: 췌장암
- `CNR0011`: 폐암

---

## 매핑 근거 및 한계

### 현재 검진설계에서 수집하지 않는 데이터
1. **본인 질환 이력** (`personal-history`)
   - 프론트엔드 코드에는 정의되어 있으나 실제 수집 안 함
   - DB 통계: 0/16건
   - 대응: `DIS0001` (없음) 기본값 사용

2. **본인 암 이력** (`cancer_history`)
   - 가족력은 있지만 본인 암 이력은 미수집
   - 대응: `CNR0001` (없음) 기본값 사용

### 매핑 정확도 제한사항
1. **음주 빈도 근사값 사용**
   - 검진설계: 5단계 (never, monthly_less, monthly_1_2, weekly_1_2, weekly_3plus)
   - Mediarc: 4단계로 추정 (DRK0001-0004)
   - 근사 규칙:
     * monthly_less → DRK0001 (안마심)
     * monthly_1_2 → DRK0002 (주 1-2회로 근사)
     * weekly_1_2 → DRK0002
     * weekly_3plus → DRK0003 (주 3-4회로 근사)

2. **가족력 세분화 제한**
   - 검진설계: 일반 "암" (세부 종류 미구분)
   - Mediarc: 11가지 암 종류 구분
   - 대응: 일반 "암" → FH0003 (뇌혈관질환의 대체값, 임시)
     또는 가장 흔한 FH0005 (대장암) 사용 고려

---
"""

# ============================================================================
# 매핑 상수 정의
# ============================================================================

# ---------------------------------------------------------------------------
# 1. 흡연 매핑 (SMOKING)
# ---------------------------------------------------------------------------
# 검진설계 → Mediarc 1:1 매핑
# 정확도: 100% (완벽 매칭)
# ---------------------------------------------------------------------------
SMOKING_MAP = {
    "non_smoker": "SMK0001",        # 비흡연 → 예 (비흡연)
    "ex_smoker": "SMK0002",         # 과거흡연 (금연) → 금연중
    "current_smoker": "SMK0003"     # 현재흡연 → 아니요 (현재흡연)
}

# ---------------------------------------------------------------------------
# 2. 음주 매핑 (DRINKING)
# ---------------------------------------------------------------------------
# 검진설계 5단계 → Mediarc 4단계 근사 매핑
# 정확도: ~80% (monthly_less, monthly_1_2를 근사 처리)
# 
# 매핑 근거:
# - monthly_less (월 1회 미만): 거의 안 마심 → DRK0001 (안마심)
# - monthly_1_2 (월 1-2회): 가끔 마심 → DRK0002 (주 1-2회로 근사)
# - weekly_1_2 (주 1-2회): 정확 매칭 → DRK0002
# - weekly_3plus (주 3회 이상): 자주 마심 → DRK0003 (주 3-4회로 근사)
# ---------------------------------------------------------------------------
DRINKING_MAP = {
    "never": "DRK0001",             # 전혀 안 함 → 안마심
    "monthly_less": "DRK0001",      # 월 1회 미만 → 안마심 (근사)
    "monthly_1_2": "DRK0002",       # 월 1-2회 → 주 1-2회 (상향 근사)
    "weekly_1_2": "DRK0002",        # 주 1-2회 → 정확 매칭
    "weekly_3plus": "DRK0003"       # 주 3회 이상 → 주 3-4회 (근사)
}

# ---------------------------------------------------------------------------
# 3. 가족력 매핑 (FAMILY HISTORY)
# ---------------------------------------------------------------------------
# 검진설계 6개 항목 → Mediarc 11개 코드 매핑
# 정확도: ~60% (일반 "암"은 세부 구분 불가)
#
# 매핑 근거:
# - cancer (일반 암): 가장 흔한 대장암(FH0005)으로 매핑 (임시)
# - stroke: 뇌혈관질환(FH0003)과 정확 매칭
# - heart_disease: 심혈관질환(FH0006)과 정확 매칭
# - diabetes: 당뇨(FH0004)와 정확 매칭
# - hypertension: 고혈압(FH0002)과 정확 매칭
# - none: 없음(FH0001)과 정확 매칭
#
# 향후 개선:
# - 가족력 "암" 선택 시, 추가 질문으로 세부 종류 수집 권장
#   (대장암, 위암, 폐암, 유방암, 갑상선암 등)
# ---------------------------------------------------------------------------
FAMILY_HISTORY_MAP = {
    "cancer": "FH0005",             # 암 → 대장암 (가장 흔한 암, 임시 매핑)
    "stroke": "FH0003",             # 뇌졸중 → 뇌혈관질환 (정확 매칭)
    "heart_disease": "FH0006",      # 심장질환 → 심혈관질환 (정확 매칭)
    "diabetes": "FH0004",           # 당뇨 → 당뇨 (정확 매칭)
    "hypertension": "FH0002",       # 고혈압 → 고혈압 (정확 매칭)
    "none": "FH0001"                # 없음 → 없음 (정확 매칭)
}

# ---------------------------------------------------------------------------
# 4. 본인 질환 매핑 (PERSONAL HISTORY → DISEASE)
# ---------------------------------------------------------------------------
# 현재 검진설계에서 수집하지 않음!
# - 프론트엔드 코드 정의: 있음 (CheckupDesignSurveyPanel)
# - 실제 수집: 안 함 (DB 통계: 0/16건)
# - 이유: UI 간소화 또는 의도적 제외로 추정
#
# 향후 수집 시 사용할 매핑:
# - survey_data.py의 "personal-history" 질문 활성화 필요
# - 옵션: cancer, stroke, heart_disease, hypertension, diabetes, none
# ---------------------------------------------------------------------------
PERSONAL_HISTORY_MAP = {
    "cancer": "DIS0002",            # 암 → 간경화 (임시, 실제는 암 종류별 세분화 필요)
    "stroke": "DIS0006",            # 뇌졸중 → 뇌혈관질환
    "heart_disease": "DIS0014",     # 심장질환 → 심혈관질환
    "diabetes": "DIS0010",          # 당뇨 → 당뇨
    "hypertension": "DIS0004",      # 고혈압 → 고혈압
    "none": "DIS0001"               # 없음 → 없음
}

# ---------------------------------------------------------------------------
# 5. 본인 암 이력 매핑 (CANCER HISTORY)
# ---------------------------------------------------------------------------
# 현재 검진설계에서 수집하지 않음!
# - 가족력은 "암" 일반으로 수집하지만 본인 암 이력은 미수집
# - 향후 추가 시 세부 암 종류 수집 권장 (위암, 대장암, 폐암 등)
# ---------------------------------------------------------------------------
CANCER_HISTORY_MAP = {
    "stomach": "CNR0007",           # 위암
    "liver": "CNR0002",             # 간암
    "colorectal": "CNR0005",        # 대장암
    "lung": "CNR0011",              # 폐암
    "breast": "CNR0008",            # 유방암
    "thyroid": "CNR0003",           # 갑상선암
    "prostate": "CNR0009",          # 전립선암
    "pancreatic": "CNR0010",        # 췌장암
    "kidney": "CNR0006",            # 신장암
    "gallbladder": "CNR0004",       # 담낭암
    "none": "CNR0001"               # 없음
}

# ============================================================================
# 기본값 정의
# ============================================================================
# Mediarc API 버그로 인해 선택 필드도 필수처럼 동작함
# → 모든 문진 필드에 기본값 (없음) 자동 추가 필요
# ============================================================================

DEFAULT_CODES = {
    "smoke": "SMK0001",             # 기본: 비흡연
    "drink": "DRK0001",             # 기본: 안마심
    "family": ["FH0001"],           # 기본: 가족력 없음
    "disease": ["DIS0001"],         # 기본: 질환 없음
    "cancer": ["CNR0001"]           # 기본: 암 없음
}

# ============================================================================
# 역매핑 (Mediarc → 한글)
# ============================================================================
# DiseaseReportPage에서 화면 표시용
# ============================================================================

SMOKE_LABELS = {
    "SMK0001": "비흡연",
    "SMK0002": "금연중",
    "SMK0003": "현재흡연"
}

DRINK_LABELS = {
    "DRK0001": "안마심",
    "DRK0002": "주 1-2회",
    "DRK0003": "주 3-4회",
    "DRK0004": "거의매일"
}

# ============================================================================
# 매핑 정확도 및 개선 방안
# ============================================================================
"""
현재 매핑 정확도:
- 흡연: 100% (완벽 매칭)
- 음주: ~80% (월 단위 빈도를 주 단위로 근사)
- 가족력: ~60% (일반 "암"을 대장암으로 임시 매핑)
- 본인 질환: 0% (데이터 미수집)
- 본인 암: 0% (데이터 미수집)

개선 방안:
1. 검진설계 문진에 본인 질환 이력 질문 추가 (personal_history 활성화)
2. 가족력 "암" 선택 시 세부 종류 추가 질문 (대장암, 위암, 폐암 등)
3. 음주 빈도 옵션 조정 또는 Mediarc API 세분화 요청
4. 검진 데이터 기반 자동 추론 로직 추가:
   - 혈압 >= 140/90 → DIS0004 (고혈압) 자동 추가
   - 공복혈당 >= 126 → DIS0010 (당뇨) 자동 추가

현재 전략:
- 수집 가능한 데이터만 정확히 매핑
- 미수집 데이터는 기본값 (없음) 사용
- 향후 프론트엔드 개선 시 확장 가능하도록 함수 구조화
"""
