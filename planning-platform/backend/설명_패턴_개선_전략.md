# 🎯 설명 패턴 및 스토리텔링 개선 전략

**작성일**: 2025-12-05 22:30  
**목적**: 반복적 문장 구조 제거 및 통합적 스토리텔링 구현

---

## 🚨 현재 시스템의 근본적 문제

### ❌ 문제 1: 반복적 패턴 ("A하지만 B" 지옥)

#### 현재 출력 예시:
```
[경동맥 초음파]
기본 검진: 혈압 관리를 잘 하고 계시지만, 혈관 속 사정은 알 수 없습니다.
→ 경동맥 초음파를 하세요.

[복부 조영 CT]
기본 검진: 위내시경으로 위 표면을 확인하는 것은 중요하지만, 
          췌장은 볼 수 없습니다.
→ 복부 조영 CT를 하세요.

[저선량 흉부 CT]
기본 검진: X-ray로 폐를 확인하는 것은 필수이지만, 
          사각지대가 있습니다.
→ 저선량 흉부 CT를 하세요.
```

**패턴 분석:**
- 모든 항목이 "A하지만 B / 그래서 C" 구조
- Bridge Strategy가 오히려 단조로움의 원인
- 로봇처럼 들림

---

### ❌ 문제 2: 장기별 독립 설명 (연결 부족)

#### 현재 출력 예시:
```
심혈관 검사:
- 경동맥 초음파 (혈압 때문에)

소화기 검사:
- 복부 조영 CT (소화기 때문에)

폐 검사:
- 저선량 흉부 CT (흡연 때문에)

간 검사:
- 간 섬유화 스캔 (허리둘레 때문에)
```

**문제점:**
- 위, 간, 폐, 심혈관이 따로 놀음
- 실제로는 연결되어 있는데 (대사증후군, 만성염증 등)
- 의사가 환자한테 이렇게 설명 안 함

---

## ✅ 개선 방향

### 🎯 방향 1: 패턴 파괴 (다양한 문장 구조)

#### ✨ 개선된 예시:

**스타일 A: 데이터 기반 연결형**
```
선생님, 지금 혈액검사를 보니 간 수치(AST/ALT)와 혈당이 같이 움직이고 있습니다. 
이는 전형적인 대사성 문제입니다. 허리둘레도 경계 수준이시니, 
간 섬유화 스캔(VCTE)으로 대사이상지방간 여부를 정확히 확인하셔야 합니다.
```

**스타일 B: 질문형 전환**
```
혈압이 정상이어도 뇌졸중이 올 수 있다는 사실, 알고 계셨나요? 
혈관 '속'은 혈압 수치만으로는 알 수 없습니다. 
가족력으로 심장질환이 있으시니, 경동맥 초음파로 10년 후 뇌졸중 위험을 
미리 예측하시는 게 좋겠습니다.
```

**스타일 C: 시나리오형**
```
40대 남성 A씨는 매년 X-ray로 '이상 없음'을 받았습니다. 
그러다 우연히 CT를 찍었고, 5mm 폐암이 발견되었습니다. 
안광수님은 과거 흡연력이 있으시니, 저선량 흉부 CT로 
사각지대 없이 확인하시길 권합니다.
```

**스타일 D: 타임라인형**
```
지금은 허리둘레 89cm로 경계입니다. 
하지만 5년 후? 지방간 → 간 섬유화 → 간경변으로 진행될 수 있습니다. 
지금 간 섬유화 스캔으로 확인하면, 이 악순환을 막을 수 있습니다.
```

**스타일 E: 역발상형**
```
"간 수치 정상이면 괜찮은 거 아닌가요?"
아닙니다. 혈액검사는 간세포가 '이미 파괴된 후'의 결과만 보여줍니다. 
실제 간의 모양이나 섬유화는 VCTE나 초음파로만 확인 가능합니다.
```

---

### 🎯 방향 2: 스토리텔링 (장기 연결)

#### ❌ 현재: 장기별 독립 설명

```
[심혈관 검사] → 혈압 때문
[간 검사] → 간 수치 때문
[췌장 검사] → 당뇨 때문
```

#### ✅ 개선: 연결고리 중심 설명

**패턴 A: 대사증후군 스토리**
```
선생님, 지금 여러 신호가 동시에 깜빡이고 있습니다.

[핵심 문제]
허리둘레 89cm (경계) + 가족력 (당뇨) + 과거 혈당 92mg/dL (경계)

[의학적 연결고리]
허리둘레 ↑ → 복부비만 → 인슐린 저항성 → 
대사이상지방간(MASLD) → 간 섬유화 → 당뇨 위험 ↑

[추천 검사 패키지]
1️⃣ 간 섬유화 스캔 (VCTE): 지방간 → 섬유화 진행 확인
2️⃣ 혈당 정밀 검사 (HbA1c, 인슐린 저항성): 당뇨 위험도
3️⃣ 복부 조영 CT: 췌장 상태 종합 평가

이 3가지는 '대사 건강'이라는 하나의 퍼즐입니다.
```

**패턴 B: 만성염증 스토리**
```
과거 흡연 + 음주 월 1-2회 + 소화성궤양용제 복용 이력

[연결고리]
담배 → 만성염증 → 위/폐/혈관 동시 손상
음주 → 간/췌장 부담
스트레스 very_high → 코르티솔 ↑ → 전신 염증

[추천 검사 통합 패키지]
1️⃣ 저선량 흉부 CT (폐)
2️⃣ 위내시경 + 헬리코박터 (위)
3️⃣ 간 초음파 + 섬유화 스캔 (간)

이것들은 모두 '만성염증 경로'로 연결되어 있습니다.
```

**패턴 C: 심뇌혈관 연쇄 스토리**
```
가족력 (심장질환) + 혈압 경계 (140/90) + 스트레스 매우 높음

[연쇄 반응]
스트레스 → 혈압 ↑ → 혈관 손상 → 
동맥경화반 형성 → 뇌졸중/심근경색 위험

[추천 검사 연쇄 체크]
1️⃣ 경동맥 초음파: 뇌로 가는 혈관 확인
2️⃣ 심전도 + 심장 초음파: 심장 구조 확인
3️⃣ 관상동맥 석회화 CT: 심혈관 위험도

이 3가지는 '심뇌혈관 연쇄 반응'을 완전히 차단하는 전략입니다.
```

---

## 🛠️ 구현 전략

### 전략 1: 프롬프트 레벨 개선 (즉시 적용 가능)

#### A. 패턴 금지 규칙 추가

```python
CHECKUP_DESIGN_SYSTEM_MESSAGE_STEP2 += """

## 🚫 패턴 금지 규칙 (No Repetitive Patterns)

1. **"A하지만 B / 그래서 C" 구조 연속 사용 금지**
   - ❌ 금지: "기본 검진은 중요하지만 한계가 있습니다. 그래서 정밀 검진을 하세요."
   - ❌ 금지: 모든 항목에 동일한 "anchor → gap → offer" 패턴
   
2. **다양한 문장 구조 사용 필수**
   - ✅ 질문형: "혈압이 정상이어도 뇌졸중이 올 수 있다는 사실, 알고 계셨나요?"
   - ✅ 데이터형: "지금 혈액검사를 보니 간 수치와 혈당이 같이 움직이고 있습니다."
   - ✅ 시나리오형: "40대 남성 A씨는 매년 X-ray로 '이상 없음'을 받았습니다. 그러다..."
   - ✅ 타임라인형: "지금은 경계입니다. 하지만 5년 후? 지방간 → 간 섬유화 → 간경변으로..."
   - ✅ 역발상형: "'간 수치 정상이면 괜찮은 거 아닌가요?' 아닙니다."

3. **연속된 항목 간 문장 구조 변경 필수**
   - 첫 번째 항목: 질문형
   - 두 번째 항목: 데이터형
   - 세 번째 항목: 시나리오형
   - (순환 적용)
"""
```

#### B. 스토리텔링 규칙 추가

```python
CHECKUP_DESIGN_SYSTEM_MESSAGE_STEP2 += """

## 🔗 스토리텔링 규칙 (Connect the Dots)

1. **장기별 독립 설명 금지**
   - ❌ 금지: 간 따로, 위 따로, 폐 따로 설명
   - ✅ 필수: 연결고리 찾아서 통합 설명

2. **의학적 연결고리 우선 활용**
   - 대사증후군: 허리둘레 + 간 + 혈당 + 혈압
   - 만성염증: 흡연 + 음주 + 위/폐/혈관 손상
   - 심뇌혈관 연쇄: 혈압 + 경동맥 + 심장 + 뇌
   - 암 가족력: 위/대장/폐 통합 스크리닝

3. **통합 패키지로 제안**
   - ❌ 금지: "경동맥 초음파를 권장합니다." (끝)
   - ✅ 필수: "경동맥 초음파 + 심전도 + 관상동맥 CT는 '심뇌혈관 연쇄 반응'을 
              완전히 차단하는 전략입니다."

4. **의사 톤 사용**
   - "선생님, 지금 혈액검사를 보니..."
   - "여러 신호가 동시에 깜빡이고 있습니다."
   - "이것들은 모두 [연결고리]로 연결되어 있습니다."
"""
```

---

### 전략 2: JSON 응답 구조 개선

#### 현재 구조 (장기별 독립)
```json
{
  "recommended_items": [
    {
      "category": "심혈관 검사",
      "items": [{"name": "경동맥 초음파"}]
    },
    {
      "category": "간 검사",
      "items": [{"name": "간 섬유화 스캔"}]
    }
  ]
}
```

#### 개선 구조 (연결고리 중심)
```json
{
  "recommended_items": [
    {
      "category": "대사 건강 통합 패키지",
      "connection_story": "허리둘레 경계 + 당뇨 가족력 → 대사이상지방간 위험 → 간 섬유화 → 당뇨 연쇄",
      "items": [
        {
          "name": "간 섬유화 스캔 (VCTE)",
          "role_in_story": "지방간 → 섬유화 진행 확인"
        },
        {
          "name": "HbA1c + 인슐린 저항성",
          "role_in_story": "당뇨 위험도 정밀 평가"
        },
        {
          "name": "복부 조영 CT",
          "role_in_story": "췌장 상태 종합 평가"
        }
      ],
      "presentation_style": "metabolic_syndrome_story",
      "opening": "선생님, 지금 여러 신호가 동시에 깜빡이고 있습니다.",
      "connection_explanation": "이 3가지는 '대사 건강'이라는 하나의 퍼즐입니다.",
      "urgency_level": "high"
    },
    {
      "category": "심뇌혈관 연쇄 차단 패키지",
      "connection_story": "가족력 (심장질환) + 혈압 경계 → 혈관 손상 → 동맥경화 → 뇌졸중/심근경색",
      "items": [
        {
          "name": "경동맥 초음파",
          "role_in_story": "뇌로 가는 혈관 확인"
        },
        {
          "name": "심전도 + 심장 초음파",
          "role_in_story": "심장 구조 확인"
        }
      ],
      "presentation_style": "cardiovascular_chain_story",
      "opening": "가족력과 혈압 경계가 만나면, 심뇌혈관 연쇄 반응이 시작됩니다.",
      "connection_explanation": "이 검사들은 연쇄 반응을 완전히 차단하는 전략입니다."
    }
  ]
}
```

---

### 전략 3: 백엔드 후처리 (고급)

```python
def diversify_sentence_patterns(text: str) -> str:
    """
    반복적 패턴 감지 및 다양화
    """
    # "A하지만 B" 패턴 감지
    pattern_count = text.count("하지만") + text.count("그러나")
    
    if pattern_count >= 3:
        # 일부를 다른 구조로 변환
        # "하지만" → "한편", "반면", "그러나", "그렇지만" 등으로 다양화
        pass
    
    # "그래서 C" 패턴 감지 및 변환
    # "따라서", "그러므로", "이에", "이를 위해" 등으로 다양화
    
    return text


def create_connection_story(items: List[Dict]) -> Dict:
    """
    장기별 항목을 연결고리 기반으로 재구성
    """
    # 1. 의학적 연결고리 식별
    connections = identify_medical_connections(items)
    
    # 2. 연결고리별 그룹핑
    grouped_items = group_by_connection(items, connections)
    
    # 3. 스토리텔링 생성
    stories = generate_connection_stories(grouped_items)
    
    return stories
```

---

## 🎯 실전 적용 예시

### 현재 vs 개선

#### ❌ 현재 (패턴 반복 + 독립 설명)

```
[경동맥 초음파]
기본 검진: 혈압 관리를 잘 하고 계시지만, 혈관 속 사정은 알 수 없습니다.
추천 이유: 경동맥 초음파를 통해 뇌졸중 위험을 사전에 평가하세요.

[간 섬유화 스캔]
기본 검진: 간 수치 검사는 중요하지만, 실제 간의 모양은 알 수 없습니다.
추천 이유: 간 섬유화 스캔으로 지방간 진행도를 확인하세요.

[저선량 흉부 CT]
기본 검진: X-ray는 필수이지만, 사각지대가 있습니다.
추천 이유: 저선량 흉부 CT로 폐 건강을 정밀하게 확인하세요.
```

**문제점:**
- 모든 항목이 "A하지만 B / C하세요" 동일 패턴
- 간, 폐, 혈관이 따로 놀음
- 로봇처럼 단조로움

---

#### ✅ 개선 (패턴 다양화 + 연결 스토리)

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 대사 건강 통합 패키지
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

선생님, 지금 혈액검사를 보니 간 수치(AST 27)와 혈당(92mg/dL)이 
같이 경계 수준으로 움직이고 있습니다. 게다가 허리둘레 89cm.
이는 전형적인 '대사이상지방간(MASLD)' 시작 신호입니다.

[의학적 연결고리]
복부비만 → 인슐린 저항성 → 간에 지방 축적 → 
간 섬유화 진행 → 간경변/간암 위험 ↑ → 당뇨 발병 ↑

[추천 검사]
1️⃣ 간 섬유화 스캔 (VCTE)
   └ 역할: 지방간 → 섬유화 진행 단계 정확히 확인
   └ 근거: 허리둘레 경계 + 당뇨 가족력 → MASLD 고위험군

2️⃣ HbA1c + 인슐린 저항성 검사
   └ 역할: 당뇨 위험도 정밀 평가 (공복혈당만으로는 불충분)
   └ 근거: MASLD 환자의 50%가 10년 내 당뇨 발병

3️⃣ 복부 조영 CT (췌장 포함)
   └ 역할: 췌장 상태 종합 평가 (당뇨 가족력 있으면 필수)
   └ 근거: 가족력 + MASLD → 췌장암 위험 2배 ↑

💡 이 3가지는 따로 놓인 검사가 아닙니다. 
'대사 건강'이라는 하나의 퍼즐 조각들입니다.
지금 잡지 않으면, 5년 후 → 지방간 → 섬유화 → 당뇨 → 간경변으로 
연쇄 반응이 진행됩니다.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧠 심뇌혈관 연쇄 차단 패키지
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

"혈압이 140/90으로 경계인데, 괜찮은 거 아닌가요?"
아닙니다. 혈압 수치는 '결과'일 뿐, '원인'은 혈관 속에 숨어있습니다.

[핵심 문제]
가족력 (심장질환) + 혈압 경계 + 스트레스 매우 높음 + 과거 흡연

[연쇄 반응]
스트레스 → 교감신경 ↑ → 혈압 ↑ → 혈관 내피 손상 → 
동맥경화반 형성 → 경동맥 협착 → 뇌졸중 위험 ↑

[추천 검사]
1️⃣ 경동맥 초음파
   └ 역할: 뇌로 가는 혈관 속 동맥경화반 발견
   └ 긴급성: IMT 1.5mm 이상이면 뇌졸중 위험 2-3배 ↑

2️⃣ 심전도 + 심장 초음파
   └ 역할: 혈압으로 인한 심장 구조 변화 (심비대) 확인
   └ 긴급성: 심비대는 돌연사 위험 신호

3️⃣ 관상동맥 석회화 CT (선택)
   └ 역할: 심장 혈관의 석회화 정도 (심근경색 위험도)

이 검사들은 '심뇌혈관 연쇄 반응'을 완전히 차단하는 전략입니다.
지금 동맥경화반이 얼마나 자랐는지 확인하고, 10년 후 뇌졸중 위험을 
미리 예측할 수 있습니다.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**개선점:**
- ✅ 매 항목마다 다른 문장 구조 (질문형, 데이터형, 연결형)
- ✅ 장기를 연결하여 설명 (대사, 심뇌혈관 연쇄)
- ✅ 의사처럼 자연스러운 톤
- ✅ 숫자와 논리로 설득력 강화

---

## 📊 최종 권장사항

### 🥇 1단계: 프롬프트 개선 (즉시 적용)

**`checkup_design_prompt.py` 수정:**
```python
# 패턴 금지 규칙 추가
# 스토리텔링 규칙 추가
# JSON 예시에 connection_story 추가
```

### 🥈 2단계: JSON 구조 개선 (1주 내)

**새로운 응답 구조:**
```json
{
  "recommended_item_packages": [
    {
      "package_name": "대사 건강 통합 패키지",
      "connection_story": "...",
      "items": [...],
      "presentation_style": "metabolic_syndrome"
    }
  ]
}
```

### 🥉 3단계: 백엔드 후처리 (향후)

**패턴 감지 및 다양화 로직 추가**

---

## 🎯 즉시 적용 가능한 프롬프트 수정

```python
# checkup_design_prompt.py의 CHECKUP_DESIGN_SYSTEM_MESSAGE_STEP2에 추가

"""
## 🚫 패턴 금지 및 스토리텔링 규칙

### 1. 반복 패턴 절대 금지
- "A하지만 B / 그래서 C" 구조를 연속 2회 이상 사용 금지
- 각 항목마다 다른 문장 구조 사용 필수

### 2. 연결고리 중심 설명 (Connect the Dots)
- ❌ 금지: 간 따로, 위 따로, 폐 따로 설명
- ✅ 필수: "선생님, 지금 혈액검사를 보니 간 수치와 혈당이 같이 움직이고 있습니다. 
           이는 전형적인 대사성 문제입니다."

### 3. 통합 패키지 제안
- 대사증후군: 간 + 혈당 + 허리둘레 연결
- 심뇌혈관: 혈압 + 경동맥 + 심장 연결
- 만성염증: 흡연 + 음주 + 위/폐/혈관 연결

### 4. 의사 톤 사용
- "선생님, 지금..." / "여러 신호가 동시에..." / "이것들은 모두 연결되어 있습니다."
"""
```

---

**이렇게 개선하면 어떨까요?**
1. 즉시: 프롬프트에 패턴 금지 + 스토리텔링 규칙 추가
2. 다음: JSON 구조 개선 (패키지 개념 도입)
3. 나중: 백엔드 후처리 로직

