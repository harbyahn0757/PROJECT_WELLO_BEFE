# 가족력 → 검진 항목 로직 (정확한 설명)

## 실행 시간: 2025-12-05 20:40

---

## ❌ 잘못된 이해: "강제 매핑"

**잘못된 로직:**
```
당뇨 가족력 있음 → 무조건 혈당검사 추천
고혈압 가족력 있음 → 무조건 혈압측정 추천
```

**문제점:**
- 의학적 근거 없이 기계적으로 매핑
- RAG 검색 결과 무시
- 환자 개별 상황(연령, 과거 검진 등) 고려 안함

---

## ✅ 정확한 로직: "RAG 기반 검증 후 다채로운 추천"

### 단계별 프로세스

#### 1단계: 가족력 감지
```python
# 문진에서 가족력 확인
family_history = survey_responses.get('family_history', [])
# ['diabetes', 'hypertension']
```

#### 2단계: RAG 검색으로 의학적 근거 확인
```python
for fh in family_history:
    if fh == 'diabetes':
        # 구체적인 쿼리 생성
        age = patient_age  # 44세
        gender = patient_gender  # 남성
        
        rag_query = f"{age}세 {gender} 당뇨 가족력이 있는 경우 혈당검사 필요성"
        
        # RAG 검색
        rag_result = query_engine.query(rag_query)
        
        # RAG 결과 분석
        if rag_result and len(rag_result.response) > 100:
            # 충분한 근거 있음
            # source_nodes에서 상세 내용 추출
            evidence = extract_evidence_from_nodes(rag_result.source_nodes)
            
            # 추천 생성
            recommendation = {
                "item": "혈당검사",
                "reason": f"RAG에서 찾은 근거: {rag_result.response[:200]}",
                "evidence": f"2025 당뇨병 진료지침: '{evidence.citation}'",
                "confidence": rag_result.source_nodes[0].score  # 0.499
            }
        else:
            # 근거 부족
            # 추천하지 않거나, 매우 약한 추천
            recommendation = None
```

#### 3단계: 다채로운 판단
```python
# RAG 결과를 바탕으로 다양한 판단
if recommendation and recommendation['confidence'] > 0.4:
    # 신뢰도 높음 → priority_1 추가
    priority_1_items.append({
        "item_name": "혈당검사",
        "why_important": f"{age}세 남성으로 당뇨 가족력이 있는 경우, "
                        f"2025 당뇨병 진료지침에 따르면 '직계 가족에 당뇨가 있으면 "
                        f"선별검사가 필요하다'고 명시되어 있습니다.",
        "evidence_detail": recommendation['evidence']
    })
elif recommendation and recommendation['confidence'] > 0.2:
    # 신뢰도 중간 → priority_2 추가
    priority_2_items.append({...})
else:
    # 신뢰도 낮음 → 추천하지 않음
    pass
```

---

## 🎯 핵심: RAG가 판단의 주체

### RAG 역할
1. **의학적 근거 검색**: "당뇨 가족력 → 혈당검사" 관계의 실제 가이드라인 찾기
2. **근거 강도 평가**: source_nodes의 신뢰도 점수 (0.0 ~ 1.0)
3. **상세 내용 제공**: 실제 가이드라인 텍스트, 인용구

### 매핑 테이블의 역할
```python
FAMILY_HISTORY_MAPPING = {
    "diabetes": {
        "candidate_items": ["혈당검사", "당화혈색소", "안저검사"],  # 후보 항목
        "rag_queries": [  # RAG 검색 쿼리 템플릿
            "{age}세 {gender} 당뇨 가족력 혈당검사 필요성",
            "{age}세 {gender} 당뇨 가족력 합병증 검사"
        ],
        "min_confidence": 0.4  # 최소 신뢰도 (이하면 추천 안함)
    }
}
```

**매핑 테이블은:**
- ❌ "당뇨 가족력 → 무조건 혈당검사" (절대 아님!)
- ✅ "당뇨 가족력 → RAG 검색 쿼리 생성 → 근거 찾기 → 신뢰도 기반 추천"

---

## 📊 실제 예시

### 예시 1: 당뇨 가족력 (RAG 근거 강함)

**입력:**
- 가족력: 당뇨
- 연령: 44세
- 성별: 남성

**RAG 검색:**
```
쿼리: "44세 남성 당뇨 가족력 혈당검사 필요성"

결과:
- 응답: "35세 이상이거나, 19세 이상 성인이라도 과체중 또는 비만(체질량지수 23 kg/m2 이상), 
        복부비만(허리둘레 남성 90 cm, 여성 85 cm 이상), 직계가족(부모, 형제자매)에 
        당뇨병이 있는 경우 당뇨병 선별검사를 받아야 한다."
- 출처: 2025 당뇨병 진료지침, 42페이지
- 신뢰도: 0.499 (높음)
```

**판단:**
→ ✅ 혈당검사를 priority_1에 추천
→ evidence: "2025 당뇨병 진료지침에 따르면 '직계가족에 당뇨병이 있는 경우...'"

### 예시 2: 희귀 질환 가족력 (RAG 근거 약함)

**입력:**
- 가족력: 희귀질환X
- 연령: 44세
- 성별: 남성

**RAG 검색:**
```
쿼리: "44세 남성 희귀질환X 가족력 검사 필요성"

결과:
- 응답: (검색 결과 없음 또는 관련성 낮음)
- 신뢰도: 0.05 (매우 낮음)
```

**판단:**
→ ❌ 추천하지 않음
→ 또는 "전문의 상담 권장" 정도만

### 예시 3: 당뇨 가족력 + 최근 혈당검사 정상 (맥락 고려)

**입력:**
- 가족력: 당뇨
- 연령: 44세
- 과거 검진: 3개월 전 혈당검사 정상 (공복혈당 85)

**RAG 검색:**
```
쿼리: "당뇨 가족력 최근 정상 혈당 재검사 필요성"

결과:
- 응답: "정상 범위의 혈당이라도 연 1회 검사 권장"
- 신뢰도: 0.35 (중간)
```

**판단:**
→ ⚠️ priority_2 또는 priority_3에 추천 (최근 정상이라 우선순위 낮춤)
→ "최근 정상 수치이나 연 1회 정기 검사 권장"

---

## 🔧 구현 방식

### 함수 구조

```python
async def validate_and_recommend_family_history_items(
    family_history: List[str],
    patient_context: Dict,
    query_engine: Any
) -> Dict[str, Any]:
    """
    가족력을 RAG로 검증하고 다채롭게 추천
    
    Returns:
        {
            "priority_1_recommendations": [...],
            "priority_2_recommendations": [...],
            "no_recommendation": [...],  # 근거 부족으로 추천 안함
            "evidence_details": {...}
        }
    """
    recommendations = {
        "priority_1": [],
        "priority_2": [],
        "no_recommendation": []
    }
    
    for fh in family_history:
        # 1. 매핑 테이블에서 후보 항목 및 쿼리 템플릿 가져오기
        mapping = FAMILY_HISTORY_MAPPING.get(fh)
        if not mapping:
            continue
        
        # 2. 구체적인 RAG 쿼리 생성
        age = patient_context.get('age', 40)
        gender = '남성' if patient_context.get('gender') == 'male' else '여성'
        
        for query_template in mapping['rag_queries']:
            query = query_template.format(age=age, gender=gender)
            
            # 3. RAG 검색
            rag_result = await query_engine.query(query)
            
            if not rag_result or not hasattr(rag_result, 'source_nodes'):
                continue
            
            # 4. 신뢰도 평가
            confidence = rag_result.source_nodes[0].score if rag_result.source_nodes else 0.0
            
            # 5. 상세 에비던스 추출
            evidence = extract_citation_from_nodes(rag_result.source_nodes)
            
            # 6. 신뢰도 기반 추천
            if confidence >= mapping.get('min_confidence', 0.4):
                # 신뢰도 높음 → priority_1
                for candidate_item in mapping['candidate_items']:
                    recommendations['priority_1'].append({
                        "item_name": candidate_item,
                        "reason": f"{age}세 {gender}으로 {fh} 가족력이 있는 경우, {evidence.source}",
                        "evidence": evidence.citation,
                        "confidence": confidence,
                        "rag_query": query
                    })
            elif confidence >= 0.2:
                # 신뢰도 중간 → priority_2
                recommendations['priority_2'].append({...})
            else:
                # 신뢰도 낮음 → 추천 안함
                recommendations['no_recommendation'].append({
                    "family_history": fh,
                    "reason": "의학적 근거 부족",
                    "confidence": confidence
                })
    
    return recommendations
```

---

## 🎯 정리

### ❌ "강제 매핑"이 아닙니다
```
당뇨 가족력 → 무조건 혈당검사 (X)
```

### ✅ "RAG 기반 검증 후 다채로운 추천"입니다
```
당뇨 가족력 
→ RAG 검색 ("44세 남성 당뇨 가족력 혈당검사 필요성")
→ 근거 발견 (2025 당뇨병 진료지침, 신뢰도 0.499)
→ 근거 충분 판단
→ 혈당검사 추천 (with 인용구)
```

### 핵심 3원칙

1. **RAG가 주체**: 매핑 테이블은 쿼리 템플릿만 제공
2. **신뢰도 기반**: RAG 신뢰도 점수로 추천 여부 결정
3. **맥락 고려**: 연령, 성별, 과거 검진 등 종합 판단

---

**작성자**: AI Assistant  
**날짜**: 2025-12-05 20:40
