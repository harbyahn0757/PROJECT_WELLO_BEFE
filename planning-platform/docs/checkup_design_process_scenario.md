# 검진 설계 프로세스 시나리오

## 실제 소요 시간 (백엔드 로그 기준)

### STEP 1: AI 분석
- **소요 시간**: 약 15초
- **시작 시점**: 사용자가 "다음" 버튼 클릭 후 즉시
- **완료 시점**: 약 15초 후

### STEP 2: 검진 설계 생성
- **소요 시간**: 약 60초
- **시작 시점**: STEP 1 완료 직후
- **완료 시점**: STEP 1 완료 후 약 60초 후

### 전체 프로세스
- **총 소요 시간**: 약 77초 (약 1분 17초)
- **데이터 준비**: 약 2초
- **서버 전송**: 약 1초
- **STEP 1 분석**: 약 15초
- **STEP 2 설계**: 약 60초
- **결과 저장**: 약 2초

---

## 사용자 경험 시나리오

### 1단계: 데이터 준비 (약 2초)
**화면 표시:**
- 스피너: 회전 중
- 제목: "데이터 준비 중"
- 설명: "선택하신 건강 항목과 설문 응답을 정리하고 있습니다."
- 진행 단계:
  - ✓ 선택한 염려 항목 확인
  - ○ 설문 응답 데이터 정리
  - ○ 건강검진 이력 데이터 준비
  - ○ 약물 복용 이력 데이터 준비

**사용자 경험:**
- 빠르게 진행되어 거의 즉시 다음 단계로 이동

---

### 2단계: 서버 전송 (약 1초)
**화면 표시:**
- 스피너: 회전 중
- 제목: "서버로 전송 중"
- 설명: "정리된 데이터를 서버로 안전하게 전송하고 있습니다."
- 진행 단계:
  - ✓ 데이터 암호화 처리
  - ○ 서버 연결 확인
  - ○ 데이터 전송 진행
  - ○ 전송 완료 확인

**사용자 경험:**
- 매우 빠르게 진행되어 거의 즉시 다음 단계로 이동

---

### 3단계: STEP 1 - AI 분석 (약 15초) ⭐ 핵심 단계
**화면 표시:**
- 스피너: 회전 중
- 제목: "STEP 1: AI 분석 중"
- 설명: "Perplexity AI가 최신 의학 논문과 가이드라인을 참고하여 빠르게 분석하고 있습니다."
- 예상 시간: "약 15초"
- 진행 단계:
  - ✓ 환자 데이터 수집
  - ⟳ 최신 의학 논문 검색
  - ○ 건강검진 가이드라인 참조
  - ○ 환자 상태 종합 분석
  - ○ 문진 내용 반영 분석
  - ○ 선택 항목별 추이 분석

**사용자 경험:**
- 약 15초 동안 진행 표시
- **중요**: STEP 1 완료 후 즉시 타이핑 효과로 분석 결과 표시 시작
  - "문진 내용 반영" 카드: 설문 응답에 대한 분석 내용이 타이핑 효과로 표시
  - "선택 항목 분석" 카드: 선택한 염려 항목별 추이 분석이 타이핑 효과로 표시
- 사용자는 이 분석 내용을 읽는 동안 백그라운드에서 STEP 2가 진행됨

**STEP 1 완료 후 표시되는 내용:**
1. **문진 내용 반영** (survey_reflection)
   - 설문 응답에 대한 AI의 분석 및 해석
   - 타이핑 효과로 표시 (약 3-5초 소요)

2. **선택 항목 분석** (selected_concerns_analysis)
   - 각 선택한 염려 항목별 추이 분석
   - 추이 분석, 반영 여부 등 상세 정보
   - 타이핑 효과로 표시 (약 5-8초 소요)

---

### 4단계: STEP 2 - 검진 설계 생성 (약 60초) ⭐ 가장 긴 단계
**화면 표시:**
- 스피너: 계속 회전 중 (STEP 1 결과는 그대로 유지)
- 제목: "STEP 2: 검진 설계 생성 중"
- 설명: "분석 결과를 바탕으로 맞춤형 검진 계획을 생성하고 의학적 근거를 확보하고 있습니다."
- 예상 시간: "약 60초"
- 진행 단계:
  - ✓ STEP 1 분석 결과 확인
  - ⟳ 우선순위별 검진 항목 선정
  - ○ 카테고리별 분류
  - ○ 의학적 근거 및 참고 자료 검색
  - ○ 의사 추천 메시지 작성
  - ○ Citations(참고 자료) 수집

**사용자 경험:**
- STEP 1에서 표시된 분석 내용은 그대로 유지
- 스피너는 계속 회전하며 STEP 2 진행 상황 표시
- 사용자는 STEP 1 분석 내용을 읽으면서 대기
- 약 60초 후 STEP 2 완료

**STEP 2에서 수행하는 작업:**
1. STEP 1의 분석 결과를 컨텍스트로 활용
2. 우선순위별 검진 항목 선정
3. 카테고리별 분류 (혈액검사, 영상검사, 기능검사 등)
4. 각 항목에 대한 의학적 근거 검색
5. 의사 추천 메시지 작성
6. 최신 논문 및 가이드라인 링크 수집 (Citations)

---

### 5단계: 결과 저장 (약 2초)
**화면 표시:**
- 스피너: 회전 중
- 제목: "결과 저장 중"
- 설명: "생성된 검진 설계 결과를 안전하게 저장하고 있습니다."
- 진행 단계:
  - ✓ 검진 설계 데이터 저장
  - ○ 업셀링 데이터 기록
  - ○ 저장 완료 확인
  - ○ 결과 페이지 준비

**사용자 경험:**
- 빠르게 진행되어 거의 즉시 결과 페이지로 이동

---

## 전체 타임라인

```
[0초] 사용자 "다음" 버튼 클릭
  ↓
[0-2초] 데이터 준비
  ↓
[2-3초] 서버 전송
  ↓
[3-18초] STEP 1: AI 분석 (15초)
  ├─ [3-8초] 데이터 수집 및 논문 검색
  ├─ [8-13초] 환자 상태 분석
  └─ [13-18초] 문진 및 선택 항목 분석
  ↓
[18초] STEP 1 완료 → 타이핑 효과로 분석 결과 표시 시작
  ├─ [18-23초] "문진 내용 반영" 타이핑 표시
  └─ [23-31초] "선택 항목 분석" 타이핑 표시
  ↓
[18-78초] STEP 2: 검진 설계 생성 (60초) [백그라운드 진행]
  ├─ [18-25초] 검진 항목 선정
  ├─ [25-45초] 의학적 근거 검색
  ├─ [45-70초] 의사 추천 메시지 작성
  └─ [70-78초] Citations 수집
  ↓
[78-80초] 결과 저장
  ↓
[80초] 결과 페이지로 이동
```

---

## 사용자 경험 개선 포인트

### 1. 즉각적인 피드백
- STEP 1 완료 후 약 15초 만에 분석 결과를 볼 수 있어 대기 시간이 짧게 느껴짐

### 2. 정보 제공
- 각 단계별 예상 소요 시간 표시로 사용자가 대기 시간을 예측 가능
- 실제 프로세스 단계를 상세히 표시하여 투명성 제공

### 3. 시각적 피드백
- 타이핑 효과로 분석 결과가 실시간으로 표시되어 진행 상황을 명확히 인지
- 스피너와 단계별 진행 상황으로 전체 프로세스 상태 파악 가능

### 4. 백그라운드 처리
- STEP 1 결과를 읽는 동안 STEP 2가 백그라운드에서 진행되어 대기 시간 최소화

---

## 기술적 세부사항

### STEP 1 API 호출
- **모델**: `sonar` (빠른 응답)
- **최대 토큰**: 4,096
- **응답 길이**: 약 2,000-3,000 문자
- **실제 소요 시간**: 약 15초

### STEP 2 API 호출
- **모델**: `sonar-pro` (강력한 추론 및 검색)
- **최대 토큰**: 16,384
- **응답 길이**: 약 16,000-20,000 문자
- **실제 소요 시간**: 약 60초
- **Citations**: 약 5-10개

### 데이터 병합
- STEP 1 결과와 STEP 2 결과를 병합하여 기존 형식과 동일한 최종 JSON 생성
- 프론트엔드 호환성 유지

---

## 테스트 시나리오

### 정상 케이스
1. 사용자가 설문을 완료하고 "다음" 버튼 클릭
2. 약 15초 후 STEP 1 분석 결과가 타이핑 효과로 표시
3. 사용자가 분석 내용을 읽는 동안 STEP 2 진행
4. 약 60초 후 STEP 2 완료 및 결과 저장
5. 결과 페이지로 자동 이동

### 에러 케이스
1. **STEP 1 실패**: 기존 방식으로 폴백하거나 재시도
2. **STEP 2 실패**: STEP 1 결과는 유지하고 나머지 섹션은 기본값 표시
3. **네트워크 오류**: 재시도 로직 또는 에러 메시지 표시

---

## 향후 개선 방향

1. **STEP 1 최적화**: 더 빠른 모델 또는 프롬프트 최적화로 10초 이내 단축
2. **STEP 2 최적화**: 병렬 처리 또는 캐싱으로 40초 이내 단축
3. **프로그레스 바**: 더 정확한 진행률 표시
4. **취소 기능**: 사용자가 중간에 취소할 수 있는 기능 추가

