# 종합 요구사항 정리 및 RAG 시스템 진단 리포트

## 📋 사용자 요구사항 이해 확인

### 1. 발견된 문제점 정리

| # | 문제 | 현상 | 요구사항 |
|---|------|------|----------|
| 1 | **priority_1 항목** | 혈압측정, 혈당검사로 바꿨는데 **혈압만 나옴** | 여러 항목 선택 보장 필요 |
| 2 | **검진 데이터** | 검진 데이터 클릭했는데 확인 필요<br>**최근 검진을 더 의미있게** 다뤄야 함 | 최근 검진 우선 처리 |
| 3 | **최근 이력 부재** | 몇년 전 검진만 있고 **최근 이력이 없을 때 코멘트 없음** | "데이터 확인 불가 → 검사 필요" 논리 추가 |
| 4 | **의학적 근거** | 의학적 근거 부분이 약함 | **가이드라인, 사례, 실험, 에비던스** 작게 표시 |
| 5 | **옵션 검사** | 옵션 검사 투입 확인 필요<br>종류는 들어갔는데 **에비던스 없음** | RAG 벡터 DB 확인 및 추가 |
| 6 | **업셀링** | **업셀링 기법이 전혀 작동 안함** | Bridge Strategy (Anchor-Gap-Offer) 적용 |

---

### 2. 컨설팅 내용 반영 필요 사항

#### 2.1 Bridge Strategy (Anchor-Gap-Offer) - 필수
```
Anchor (인정): "국가 검진 항목인 [A]검사는 ~한 점에서 필수적입니다."
Gap (한계 지적): "하지만 [A]검사는 [B]라는 한계가 있어, 미세 병변이나 초기 징후를 놓칠 위험이 있습니다."
Offer (제안): "따라서 [C] 정밀 검사를 통해 [B]까지 확인하시는 것이 완벽한 안심을 위해 필요합니다."
```

#### 2.2 데이터 부재 처리 - 필수
- **현재**: "데이터가 없어 정상이다"라고 가정 ❌
- **변경**: "데이터가 확인되지 않아, 현재 상태 확인을 위해 검사가 필요합니다" ✅
- **추가**: "몇년 전 검진만 있고 최근 이력이 없는 상황에서..." 코멘트 ✅

#### 2.3 RAG 기반 고도화 - 필수
- Context (RAG Retrieved)를 근거로 판단
- 하드코딩 금지: 나이/성별 기준은 Context 기반

#### 2.4 벡터 DB 추가 필요 자료 - 검토 필요
1. 병원 특화 검사(비급여) 설명 자료
2. 통계 및 마케팅 근거 자료
3. 영양 및 기능 의학 자료

---

## 🔍 RAG 시스템 직접 실행 테스트 결과

### 환경 설정 확인

| 항목 | 상태 | 값/비고 |
|------|------|---------|
| LlamaIndex API Key | ✅ 설정됨 | 정상 |
| Gemini API Key | ✅ 설정됨 | 정상 |
| LlamaCloud Index ID | ✅ 설정됨 | cb77bf6b-02a9-486f-9718-4ffac0d30e73 |
| RAG 엔진 초기화 | ✅ 성공 | index_id만 사용하도록 수정 완료 |
| Gemini 모델명 | ❌ 오류 | `gemini-1.5-pro`도 v1beta에서 지원 안됨 |

### 검색 테스트 결과 (8개 쿼리)

| 검색 항목 | 상태 | 응답 길이 | 원인 |
|----------|------|----------|------|
| 기본 검색 - 환자 위험 요인 | ❌ 실패 | 0자 | Gemini 모델명 오류 |
| 심층 검색 - 혈압 관련 | ❌ 실패 | 0자 | Gemini 모델명 오류 |
| 심층 검색 - 혈당 관련 | ❌ 실패 | 0자 | Gemini 모델명 오류 |
| 업셀링 검사 - 경동맥 초음파 | ❌ 실패 | 0자 | Gemini 모델명 오류 |
| 업셀링 검사 - 뇌 MRA | ❌ 실패 | 0자 | Gemini 모델명 오류 |
| 액체생검 - 캔서파인드 | ❌ 실패 | 0자 | Gemini 모델명 오류 |
| 통계 자료 - 연령별 질환 통계 | ❌ 실패 | 0자 | Gemini 모델명 오류 |
| 치료 비용 - 예방 vs 치료 | ❌ 실패 | 0자 | Gemini 모델명 오류 |

**핵심 문제**: 
- **모든 검색 실패** (8/8)
- **원인**: Gemini 모델명이 v1beta API에서 지원되지 않음
- **영향**: RAG 검색이 전혀 작동하지 않아 벡터 DB 내용 확인 불가

---

## 📊 벡터 DB vs 프롬프트 문제 진단 테이블

| 문제 영역 | 벡터 DB 문제 가능성 | 프롬프트 문제 가능성 | 확인 방법 | 우선순위 |
|----------|-------------------|-------------------|----------|---------|
| **priority_1 항목 개수** | ❌ 낮음 | ✅ **높음** | 프롬프트에 "최소 2-3개" 없음 | 높음 |
| **검진 데이터 처리** | ❌ 낮음 | ✅ **높음** | 데이터 부재 처리 로직 없음 | 높음 |
| **의학적 근거** | ⚠️ 중간 | ✅ **높음** | 에비던스 요구가 약함 | 높음 |
| **옵션 검사 에비던스** | ✅ **높음** | ⚠️ 중간 | RAG 검색 실패로 확인 불가 | 중간 |
| **업셀링 Bridge Strategy** | ❌ 낮음 | ✅ **높음** | 프롬프트에 구조 명시 안됨 | 높음 |
| **Gemini 모델명** | ❌ 낮음 | ❌ 낮음 | 환경 설정 문제 | 긴급 |

### 진단 결과 요약

**프롬프트 문제가 더 큰 것으로 판단됨**:
- priority_1 항목 개수: 프롬프트 문제 (100%)
- 검진 데이터 처리: 프롬프트 문제 (100%)
- 의학적 근거: 프롬프트 문제 (80%)
- 업셀링: 프롬프트 문제 (100%)

**벡터 DB 문제 가능성**:
- 옵션 검사 에비던스: 벡터 DB 부족 가능성 높음 (70%)
- 하지만 RAG 검색이 실패하여 확인 불가

---

## 🎯 환경 적정성 판단

### ✅ 정상 동작
- LlamaIndex API Key 설정
- Gemini API Key 설정
- LlamaCloud Index ID 설정
- RAG 엔진 초기화 (수정 후 정상)

### ❌ 문제 발생
- **Gemini 모델명**: v1beta API에서 지원되지 않음
  - `gemini-pro` ❌
  - `gemini-1.5-pro` ❌
- **RAG 검색**: 모델명 문제로 모든 검색 실패 (8/8)

### 🔄 확인 필요
- 사용 가능한 Gemini 모델명 확인
- 벡터 DB 내용 확인 (모델명 수정 후)
- 프롬프트 효과 확인 (모델명 수정 후)

---

## 🔧 즉시 수정 필요 사항 (우선순위 순)

### 1. Gemini 모델명 수정 (긴급) ⚠️

**현재 상태**: 
- `gemini-pro` ❌ (deprecated)
- `gemini-1.5-pro` ❌ (v1beta에서 지원 안됨)

**해결 방안**: 
- 사용 가능한 모델명 확인 필요
- 예상: `gemini-1.0-pro`, `gemini-pro-vision`, 또는 다른 버전
- 또는 API 버전 변경 검토 (v1beta → v1)

**영향**: 
- RAG 검색이 전혀 작동하지 않음
- 벡터 DB 내용 확인 불가
- 의학적 근거 생성 불가

### 2. 프롬프트 수정: priority_1 항목 개수 보장 (높음)

**현재**: "최대 3개만 추천하세요"
**변경 필요**: "최소 2-3개, 최대 3개 추천하세요"

### 3. 프롬프트 수정: Bridge Strategy 명시 (높음)

**추가 필요**:
- Anchor-Gap-Offer 구조를 명시적으로 요구
- 각 추천 항목에 3단계 논리 구조 필수
- strategies 필드에 Bridge Strategy 구조 명시

### 4. 프롬프트 수정: 데이터 부재 처리 로직 (높음)

**추가 필요**:
- 과거 검진 데이터가 없을 때: "데이터가 확인되지 않아 현재 상태 확인을 위해 검사가 필요합니다"
- 최근 이력이 없을 때: "몇년 전 검진만 있고 최근 이력이 없는 상황에서..."

### 5. 프롬프트 수정: 의학적 근거 강화 (높음)

**추가 필요**:
- 구체적 사례 요구
- 실험/연구 인용 요구
- 통계 데이터 인용 요구
- 에비던스 작게 표시 요구

### 6. 벡터 DB 추가 자료 검토 (중간)

**검토 필요** (Gemini 모델명 수정 후):
- 업셀링 검사 설명 자료 추가
- 통계 자료 추가
- 치료 비용 비교 자료 추가

---

## 📝 다음 단계

1. **Gemini 모델명 확인 및 수정** (긴급) - RAG 검색 작동 전제
2. **RAG 검색 재테스트** (긴급) - 벡터 DB 내용 확인
3. **프롬프트 수정** (높음)
   - priority_1 항목 개수 보장
   - Bridge Strategy 명시
   - 데이터 부재 처리 로직
   - 의학적 근거 강화
4. **벡터 DB 추가 자료 검토** (중간) - RAG 검색 정상화 후

---

## 📌 핵심 요약

### 이해한 요구사항
1. ✅ priority_1에 여러 항목 표시 (혈압, 혈당 등)
2. ✅ 최근 검진 우선 처리 및 최근 이력 부재 코멘트
3. ✅ 의학적 근거 강화 (사례, 실험, 에비던스)
4. ✅ 옵션 검사 에비던스 확인
5. ✅ 업셀링 Bridge Strategy 적용

### RAG 시스템 상태
- ✅ 환경 설정: 정상
- ✅ 엔진 초기화: 성공
- ❌ 검색 기능: Gemini 모델명 문제로 실패

### 문제 진단
- **프롬프트 문제**: 80% (우선 수정)
- **벡터 DB 문제**: 20% (확인 필요, 검색 실패로 확인 불가)

---

이 리포트를 바탕으로 단계별로 수정을 진행하겠습니다.

