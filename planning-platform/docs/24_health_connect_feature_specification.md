# Health Connect 기능 정의서

## 1. 개요

### 1.1 목적
김현우내과의원 건강검진 플랫폼에 Tilko API를 통한 국민건강보험공단 데이터 연동 기능을 추가하여, 환자들이 자신의 건강검진 이력과 처방전 정보를 통합적으로 조회할 수 있도록 합니다.

### 1.2 범위
- 카카오 로그인 후 건강 데이터 연동 플로우
- Tilko API를 통한 건강검진 및 처방전 데이터 조회
- 사용자 친화적인 데이터 시각화 및 필터링
- 모바일 최적화된 반응형 UI

### 1.3 주요 이해관계자
- **환자**: 건강 데이터 조회 및 관리
- **의료진**: 환자 이력 확인 및 진료 참고
- **개발팀**: 시스템 구현 및 유지보수
- **운영팀**: 서비스 모니터링 및 지원

## 2. 기능 요구사항

### 2.1 사용자 인증 (F001)

#### 2.1.1 카카오 로그인 연동
- **설명**: 기존 카카오 로그인과 Tilko 인증 연계
- **입력**: 카카오 사용자 정보
- **처리**: 
  1. 카카오 사용자 정보를 Tilko 인증 형식으로 변환
  2. Tilko 간편인증 API 호출
  3. 인증 토큰 발급 및 저장
- **출력**: Tilko 인증 토큰
- **예외처리**: 
  - 카카오 정보 부족 시 추가 정보 입력 요청
  - Tilko 인증 실패 시 에러 메시지 표시

#### 2.1.2 본인인증
- **설명**: 국민건강보험공단 데이터 접근을 위한 본인인증
- **입력**: 이름, 주민등록번호, 휴대폰번호
- **처리**: Tilko 간편인증 API 호출
- **출력**: 인증 성공/실패 결과
- **보안**: AES/RSA 암호화를 통한 안전한 데이터 전송

### 2.2 건강검진 데이터 조회 (F002)

#### 2.2.1 검진 결과 목록
- **설명**: 연도별 건강검진 결과 조회
- **데이터 항목**:
  - 검진일자, 의료기관명, 담당의
  - 검진 항목별 수치 및 정상/이상 여부
  - 종합 판정 결과
  - 권고사항
- **필터링**: 연도별, 의료기관별, 검진 유형별
- **정렬**: 날짜순, 의료기관순, 상태순

#### 2.2.2 검진 결과 상세
- **설명**: 개별 검진 결과의 상세 정보
- **표시 항목**:
  - 기본 검진: 신장, 체중, 혈압, 시력 등
  - 혈액 검사: 혈당, 콜레스테롤, 간기능 등
  - 영상 검사: X-ray, 초음파 등
  - 암 검진: 위암, 대장암, 유방암 등
- **시각화**: 수치 트렌드 그래프, 정상 범위 표시

### 2.3 처방전 데이터 조회 (F003)

#### 2.3.1 처방전 목록
- **설명**: 기간별 처방전 이력 조회
- **데이터 항목**:
  - 처방일자, 의료기관명, 진료과, 담당의
  - 진단명, 처방 의약품 목록
  - 총 진료비, 본인부담금
- **필터링**: 기간별, 의료기관별, 진료과별
- **검색**: 의약품명, 진단명 검색

#### 2.3.2 처방전 상세
- **설명**: 개별 처방전의 상세 정보
- **표시 항목**:
  - 처방 의약품별 용법, 용량, 투약 일수
  - 복용 방법 및 주의사항
  - 약품 정보 및 효능
- **기능**: 복용 일정 알림 설정, 공유 기능

### 2.4 데이터 통합 관리 (F004)

#### 2.4.1 대시보드
- **설명**: 건강 데이터 요약 정보 제공
- **표시 항목**:
  - 최근 검진 결과 요약
  - 주요 수치 트렌드
  - 복용 중인 약물 현황
  - 다음 검진 일정 안내
- **통계**: 연도별 검진 횟수, 의료기관 이용 현황

#### 2.4.2 데이터 내보내기
- **설명**: 건강 데이터 다운로드 및 공유
- **형식**: PDF, CSV, JSON
- **범위**: 전체 또는 선택된 기간/항목
- **보안**: 개인정보 마스킹 옵션

## 3. 비기능 요구사항

### 3.1 성능 요구사항
- **응답 시간**: API 호출 30초 이내
- **처리량**: 동시 사용자 100명
- **가용성**: 99.9% 이상
- **확장성**: 사용자 증가에 따른 확장 가능

### 3.2 보안 요구사항
- **암호화**: 전송 및 저장 데이터 암호화
- **인증**: 다단계 인증 (카카오 + Tilko)
- **접근 제어**: 사용자별 데이터 접근 권한
- **개인정보보호**: GDPR/개인정보보호법 준수

### 3.3 사용성 요구사항
- **반응형 디자인**: 모바일/태블릿/데스크톱 지원
- **접근성**: WCAG 2.1 AA 준수
- **국제화**: 한국어 지원
- **브라우저 호환성**: Chrome, Safari, Firefox 최신 버전

### 3.4 호환성 요구사항
- **API 버전**: Tilko API v2.0 이상
- **운영체제**: iOS 14+, Android 8+, Windows 10+
- **데이터베이스**: PostgreSQL 13+
- **백엔드**: Python 3.9+, FastAPI 0.104+

## 4. 시스템 아키텍처

### 4.1 전체 구조
```
[사용자] → [React Frontend] → [FastAPI Backend] → [Tilko API] → [건보공단]
                ↓                       ↓
            [로컬 스토리지]         [PostgreSQL]
```

### 4.2 컴포넌트 구조

#### 4.2.1 프론트엔드
```
src/
├── components/health/          # 건강 데이터 컴포넌트
│   ├── HealthDataViewer/      # 메인 뷰어
│   ├── FilterSection/         # 필터링
│   ├── ResultsSection/        # 검진 결과
│   ├── PrescriptionSection/   # 처방전
│   └── LoadingSpinner/        # 로딩 상태
├── hooks/health/              # 커스텀 훅
│   ├── useHealthData.ts       # 데이터 관리
│   └── useHealthDataState.ts  # 상태 관리
├── services/health/           # API 서비스
│   └── HealthConnectService.ts
└── types/health/              # 타입 정의
    └── index.ts
```

#### 4.2.2 백엔드
```
app/
├── api/v1/endpoints/
│   └── health_connect.py      # Health Connect API
├── services/
│   └── tilko_service.py       # Tilko API 연동
├── models/
│   └── health_data.py         # 데이터 모델
└── utils/
    └── encryption.py          # 암호화 유틸리티
```

### 4.3 데이터 플로우

#### 4.3.1 인증 플로우
1. **카카오 로그인**: 사용자 기본 정보 획득
2. **추가 정보 입력**: 주민등록번호, 휴대폰번호 (필요시)
3. **Tilko 인증**: 간편인증 API 호출
4. **토큰 저장**: 인증 토큰 저장 및 관리

#### 4.3.2 데이터 조회 플로우
1. **API 호출**: 프론트엔드에서 백엔드 API 호출
2. **토큰 검증**: 저장된 인증 토큰 유효성 확인
3. **Tilko API**: 건강검진/처방전 데이터 조회
4. **데이터 변환**: API 응답을 UI 형식으로 변환
5. **캐싱**: 조회된 데이터 임시 저장
6. **UI 렌더링**: 사용자 인터페이스에 데이터 표시

## 5. 사용자 인터페이스

### 5.1 화면 구성

#### 5.1.1 메인 대시보드
- **위치**: "내 검진 결과 추이 보기" 카드 클릭 후
- **구성요소**:
  - 상단: 뒤로가기 버튼, 페이지 제목
  - 통계 카드: 검진 횟수, 처방전 수, 방문 병원 수
  - 탭 메뉴: 검진 결과 / 처방전
  - 하단: 새로고침 버튼

#### 5.1.2 검진 결과 화면
- **필터 섹션**: 연도, 검진 종류, 병원명, 검색어
- **정렬 옵션**: 날짜순, 병원순, 상태순
- **결과 카드**: 
  - 검진일, 병원명, 담당의
  - 종합 상태 (정상/이상/관찰)
  - 주요 검진 항목 요약
  - 상세보기/공유 버튼

#### 5.1.3 처방전 화면
- **필터 섹션**: 기간, 진료과, 병원명
- **처방전 카드**:
  - 처방일, 병원명, 진료과, 담당의
  - 진단명, 주요 처방 의약품
  - 총 비용, 본인부담금
  - 상세보기/복용일정/공유 버튼

### 5.2 상호작용

#### 5.2.1 터치 최적화
- **최소 터치 영역**: 44px x 44px (iOS 가이드라인)
- **스와이프 제스처**: 카드 선택, 필터 토글
- **풀 투 리프레시**: 데이터 새로고침

#### 5.2.2 피드백
- **로딩 상태**: 스피너, 스켈레톤 UI
- **성공 피드백**: 체크 아이콘, 성공 메시지
- **에러 피드백**: 경고 아이콘, 재시도 버튼

### 5.3 접근성

#### 5.3.1 스크린 리더 지원
- **의미 있는 레이블**: 모든 UI 요소에 적절한 레이블
- **구조화된 헤딩**: H1-H6 계층 구조
- **대체 텍스트**: 아이콘 및 이미지 설명

#### 5.3.2 키보드 내비게이션
- **탭 순서**: 논리적인 포커스 이동
- **키보드 단축키**: 주요 기능 빠른 접근
- **포커스 표시**: 명확한 포커스 인디케이터

## 6. 데이터 모델

### 6.1 검진 결과 (CheckupResult)
```typescript
interface CheckupResult {
  id: string;                    // 고유 식별자
  date: string;                  // 검진일자 (ISO 8601)
  hospitalName: string;          // 의료기관명
  doctorName?: string;           // 담당의명
  categories: CheckupCategory[]; // 검진 카테고리들
  overallStatus: string;         // 종합 판정
  recommendations?: string[];    // 권고사항
}

interface CheckupCategory {
  name: string;                  // 카테고리명 (기본검진, 혈액검사 등)
  items: CheckupItem[];          // 검진 항목들
}

interface CheckupItem {
  name: string;                  // 검진 항목명
  value: string;                 // 측정값
  unit?: string;                 // 단위
  normalRange?: string;          // 정상 범위
  isNormal: boolean;             // 정상 여부
  reference?: string;            // 참고사항
}
```

### 6.2 처방전 (Prescription)
```typescript
interface Prescription {
  id: string;                    // 고유 식별자
  date: string;                  // 처방일자 (ISO 8601)
  hospitalName: string;          // 의료기관명
  doctorName: string;            // 담당의명
  department: string;            // 진료과
  diagnosis?: string;            // 진단명
  medications: Medication[];     // 처방 의약품들
  totalCost?: number;            // 총 비용
  insuranceCoverage?: number;    // 보험 적용 금액
}

interface Medication {
  name: string;                  // 의약품명
  dosage: string;                // 용량
  frequency: string;             // 복용 횟수
  duration: string;              // 복용 기간
  instructions?: string;         // 복용 방법
  totalAmount?: number;          // 총 처방량
}
```

### 6.3 API 응답 (HealthDataResponse)
```typescript
interface HealthDataResponse {
  success: boolean;              // 성공 여부
  data?: HealthData;             // 건강 데이터
  message: string;               // 응답 메시지
  errorCode?: string;            // 에러 코드
}

interface HealthData {
  checkupResults: CheckupResult[]; // 검진 결과들
  prescriptions: Prescription[];   // 처방전들
  lastUpdated: string;             // 마지막 업데이트 시간
}
```

## 7. 에러 처리

### 7.1 에러 분류

#### 7.1.1 사용자 에러 (4xx)
- **401 Unauthorized**: 인증 실패
- **403 Forbidden**: 권한 없음
- **422 Unprocessable Entity**: 입력 데이터 검증 실패

#### 7.1.2 시스템 에러 (5xx)
- **500 Internal Server Error**: 서버 내부 오류
- **502 Bad Gateway**: Tilko API 연결 실패
- **503 Service Unavailable**: 서비스 일시 중단
- **504 Gateway Timeout**: 응답 시간 초과

### 7.2 에러 메시지

#### 7.2.1 사용자 친화적 메시지
```typescript
const errorMessages = {
  'AUTH_FAILED': '입력하신 정보로 본인인증을 할 수 없습니다. 정보를 다시 확인해주세요.',
  'TOKEN_EXPIRED': '인증이 만료되었습니다. 다시 로그인해주세요.',
  'NETWORK_ERROR': '네트워크 연결을 확인해주세요.',
  'SERVICE_UNAVAILABLE': '서비스가 일시적으로 이용할 수 없습니다. 잠시 후 다시 시도해주세요.',
  'DATA_NOT_FOUND': '조회된 데이터가 없습니다. 다른 조건으로 검색해보세요.'
};
```

#### 7.2.2 기술적 세부사항
- **로그 레벨**: ERROR, WARN, INFO, DEBUG
- **스택 트레이스**: 개발 환경에서만 표시
- **에러 코드**: 문제 해결을 위한 고유 식별자

### 7.3 복구 전략

#### 7.3.1 자동 재시도
- **조건**: 일시적 네트워크 오류 (5xx)
- **횟수**: 최대 3회
- **간격**: 지수 백오프 (1초, 2초, 4초)

#### 7.3.2 사용자 액션
- **재시도 버튼**: 수동 재시도 옵션
- **새로고침**: 전체 데이터 다시 로드
- **뒤로가기**: 이전 화면으로 복귀

## 8. 테스트 계획

### 8.1 단위 테스트
- **백엔드**: TilkoService, HealthConnectAPI
- **프론트엔드**: HealthConnectService, React 훅
- **커버리지**: 90% 이상

### 8.2 통합 테스트
- **API 엔드포인트**: 전체 플로우 테스트
- **데이터 변환**: API 응답 → UI 데이터 변환
- **에러 시나리오**: 각종 에러 상황 테스트

### 8.3 사용자 테스트
- **사용성 테스트**: 실제 사용자 대상
- **접근성 테스트**: 스크린 리더, 키보드 내비게이션
- **성능 테스트**: 다양한 기기 및 네트워크 환경

## 9. 배포 및 운영

### 9.1 배포 환경
- **개발**: Docker 컨테이너 기반
- **스테이징**: 운영과 동일한 환경
- **운영**: AWS/GCP 클라우드 인프라

### 9.2 모니터링
- **성능 메트릭**: 응답 시간, 처리량, 에러율
- **비즈니스 메트릭**: 사용자 수, 데이터 조회 횟수
- **알림**: 임계치 초과 시 자동 알림

### 9.3 유지보수
- **로그 분석**: 사용 패턴 및 에러 분석
- **정기 점검**: 주간 성능 리뷰
- **업데이트**: 월간 기능 개선 및 보안 패치

## 10. 부록

### 10.1 용어 정의
- **Tilko**: 국민건강보험공단 데이터 연동 서비스
- **건보공단**: 국민건강보험공단
- **간편인증**: 휴대폰 인증을 통한 본인인증
- **JWT**: JSON Web Token, 인증 토큰 형식

### 10.2 참고 문서
- [Tilko API 문서](https://docs.tilko.net)
- [국민건강보험공단 데이터 명세](https://nhis.or.kr)
- [개인정보보호법](https://privacy.go.kr)
- [의료법](https://law.go.kr)

### 10.3 변경 이력
| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2024-01-01 | 초기 작성 | 개발팀 |

---

**문서 관리**
- 작성일: 2024-01-01
- 최종 수정일: 2024-01-01
- 승인자: [프로젝트 매니저]
- 문서 상태: 승인됨
