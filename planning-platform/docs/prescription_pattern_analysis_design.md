# 처방 패턴 분석 및 채팅 인터페이스 설계

## 1. 처방 패턴 분석 로직

### 1.1 데이터 구조
```typescript
PrescriptionRecord {
  JinRyoGaesiIl: "2023-06-20",  // 진료개시일
  RetrieveTreatmentInjectionInformationPersonDetailList: [
    {
      ChoBangYakPumMyung: "아스피린",      // 약품명
      ChoBangYakPumHyoneung: "혈액응고방지", // 약품 효능
      TuyakIlSoo: "30",                    // 투약일수
      JinRyoChoBangIlja: "2023-06-20"     // 처방일자
    }
  ]
}
```

### 1.2 분석 패턴 종류

#### A. 효능별 집계 (우선순위)
- **기준**: `ChoBangYakPumHyoneung` (없으면 `ChoBangYakPumMyung`)
- **집계 항목**:
  - 총 복용일수 (`TuyakIlSoo` 합산)
  - 처방 횟수
  - 첫 처방일 / 마지막 처방일
  - 복용한 연도 목록
  - 연속 복용 기간 (30일 이내 재처방 시 연속으로 간주)
  - 해당 효능의 약품 목록

#### B. 연속 복용 기간 계산 (개선된 버전)
- **전체 기간 분석**: 첫 처방일부터 마지막 처방 종료일까지 모든 패턴 추적
- **연속 복용 규칙**: 처방 종료일(처방일 + 투약일수)과 다음 처방일의 간격이 30일 이내면 연속으로 간주
- **분석 항목**:
  1. **연속 복용 기간들**: 모든 연속 기간 추적
  2. **중단 기간들**: 처방 간격이 30일 초과인 모든 중단 기간
  3. **복용 밀도**: 실제 복용일수 / 전체 기간 (0~1)
  4. **재시작 횟수**: 중단 후 재시작한 횟수
  5. **평균 중단 기간**: 중단 기간들의 평균 일수
- **예시**:
  ```
  2023-01-01: 30일 처방 (종료일: 2023-01-31)
  2023-02-15: 30일 처방 (15일 간격 → 연속, 종료일: 2023-03-17)
  2023-04-01: 30일 처방 (15일 간격 → 연속, 종료일: 2023-05-01)
  2023-07-01: 30일 처방 (61일 간격 → 중단 후 재시작, 종료일: 2023-07-31)
  ```
  → 연속 기간 2개: 
    - (2023-01-01 ~ 2023-05-01, 총 90일, 3회 처방)
    - (2023-07-01 ~ 2023-07-31, 총 30일, 1회 처방)
  → 중단 기간 1개: (2023-05-01 ~ 2023-07-01, 61일)
  → 전체 기간: (2023-01-01 ~ 2023-07-31, 211일)
  → 복용 밀도: 120일 / 211일 = 0.57 (57%)
  → 재시작 횟수: 1회

#### C. 우선순위 점수 계산 (개선된 버전)
```
우선순위 = (총 복용일수/365) × 35% 
         + (처방 횟수/50) × 25%
         + (최근성 점수) × 20%
         + (복용 밀도) × 15%
         + (재시작 패널티) × 5%
```

- **최근성**: 마지막 처방 종료일 기준 (최근 1년 내면 높은 점수)
- **복용 밀도**: 실제 복용일수 / 전체 기간 (0~1, 높을수록 좋음)
- **재시작 패널티**: 재시작 횟수가 적을수록 높은 점수 (최대 10회 기준)

#### D. 특수 패턴 분류
- **장기 복용**: 6개월(180일) 이상 복용한 효능
- **최근 복용**: 최근 1년 내 복용한 효능
- **상위 효능**: 우선순위 상위 5개

### 1.3 분석 결과 구조
```typescript
PrescriptionPatternAnalysis {
  effectPatterns: MedicationEffectPattern[],  // 효능별 패턴 (우선순위 정렬)
  yearlyPatterns: YearlyPattern[],            // 연도별 패턴
  topEffects: MedicationEffectPattern[],      // 상위 5개 효능
  longTermMedications: MedicationEffectPattern[], // 장기 복용 (6개월 이상)
  recentMedications: MedicationEffectPattern[],    // 최근 복용 (1년)
  summary: {
    totalYears: number,           // 분석 기간
    totalPrescriptions: number,   // 총 처방 횟수
    uniqueEffects: number,        // 고유 효능 수
    mostFrequentEffect: string,   // 가장 자주 복용
    longestMedication: string     // 가장 오래 복용
  }
}
```

## 2. 채팅 인터페이스 설계

### 2.1 메시지 타입
```typescript
type MessageType = 
  | 'bot_intro'           // 봇 인사말
  | 'bot_analysis'        // 분석 결과 제시
  | 'bot_question'        // 질문/선택 요청
  | 'user_selection'      // 사용자 선택
  | 'bot_confirmation'    // 확인 메시지
  | 'bot_progress'        // 진행 상태
```

### 2.2 메시지 구조
```typescript
interface ChatMessage {
  id: string;
  type: MessageType;
  sender: 'bot' | 'user';
  content: string;
  timestamp: Date;
  options?: ChatOption[];  // 선택 옵션 (봇 메시지에만)
  data?: any;              // 메시지 관련 데이터
}

interface ChatOption {
  id: string;
  label: string;
  description?: string;
  icon?: string;
  data: any;              // 선택 시 전달할 데이터
}
```

### 2.3 단계별 플로우

#### Step 1: 약국 처방 패턴 분석 및 선택
```
[봇] 안녕하세요! 검진 항목을 설계하기 위해 먼저 처방 이력을 확인해볼게요.

[봇] 분석 결과, 다음과 같은 약품을 복용하셨어요:
     - 혈액응고방지: 2021년부터 2024년까지 총 8개월간 복용 (15회 처방)
     - 고혈압: 2022년부터 2024년까지 총 12개월간 복용 (20회 처방)
     - 소화불량: 2023년부터 2024년까지 총 3개월간 복용 (5회 처방)

[봇] 특히 고민해야 할 처방 이력을 선택해주세요:
     [선택 버튼 1] 혈액응고방지 (장기 복용)
     [선택 버튼 2] 고혈압 (장기 복용)
     [선택 버튼 3] 소화불량 (최근 복용)
     [선택 버튼 4] 모두 선택
     [선택 버튼 5] 건너뛰기

[사용자] 혈액응고방지 선택

[봇] 혈액응고방지를 선택하셨네요. 
     이 약품은 2021년부터 지속적으로 복용하신 것으로 보입니다.
     검진 설계 시 혈관 관련 항목을 중점적으로 확인하겠습니다.
```

#### Step 2: 검진 카드 선택
```
[봇] 이제 검진 이력을 확인해볼게요.

[봇] 다음 검진 기록 중에서 특히 주의 깊게 봐야 할 항목을 선택해주세요:
     [검진 카드 1] 2023년 건강검진 - 이상 3건, 경계 5건
     [검진 카드 2] 2022년 건강검진 - 이상 1건, 경계 2건
     [검진 카드 3] 2021년 건강검진 - 이상 0건, 경계 3건

[사용자] 2023년 건강검진 선택

[봇] 2023년 건강검진을 선택하셨네요.
     이상 소견이 3건 있어서 이번 검진 설계 시 특히 주의 깊게 확인하겠습니다.
```

#### Step 3: 진료 기록 선택 (선택적)
```
[봇] 마지막으로 진료 기록 중에서 걱정되는 부분이 있으신가요?
     [선택 버튼 1] 2023년 내과 진료 (3회 방문)
     [선택 버튼 2] 2022년 정형외과 진료 (2회 방문)
     [선택 버튼 3] 없음

[사용자] 없음 선택

[봇] 알겠습니다. 선택하신 정보를 바탕으로 검진 설계를 진행하겠습니다.
```

## 3. UI 컴포넌트 구조

### 3.1 채팅 인터페이스 컴포넌트
```
ChatInterface/
├── ChatMessage.tsx          // 메시지 버블
├── ChatOptionButton.tsx    // 선택 버튼
├── MedicationCard.tsx      // 약품 카드 (효능별)
├── CheckupCard.tsx         // 검진 카드
├── PrescriptionCard.tsx    // 처방 카드
└── styles.scss
```

### 3.2 스타일 가이드
- **봇 메시지**: 왼쪽 정렬, 회색 배경
- **사용자 메시지**: 오른쪽 정렬, 브랜드 색상 배경
- **선택 버튼**: 카드 형태, 호버 효과
- **애니메이션**: 메시지 등장 시 페이드인, 스크롤 자동

## 4. 구현 단계

### Phase 1: 처방 패턴 분석 로직 ✅
- [x] 효능별 집계
- [x] 연속 복용 기간 계산
- [x] 우선순위 점수 계산
- [x] 연도별 패턴 분석

### Phase 2: 채팅 인터페이스 컴포넌트
- [ ] ChatMessage 컴포넌트
- [ ] ChatOptionButton 컴포넌트
- [ ] MedicationCard 컴포넌트
- [ ] CheckupCard 컴포넌트
- [ ] 애니메이션 효과

### Phase 3: 단계별 플로우 로직
- [ ] Step 1: 처방 패턴 분석 → 선택
- [ ] Step 2: 검진 카드 → 선택
- [ ] Step 3: 진료 기록 → 선택 (선택적)
- [ ] 진행 상태 관리
- [ ] 데이터 전달 (기존 API 형식 유지)

### Phase 4: 통합 및 테스트
- [ ] CheckupDesignPage와 통합
- [ ] 데이터 변환 로직 (ConcernItemForAPI)
- [ ] 에러 처리
- [ ] 사용자 테스트

## 5. 고려사항

### 5.1 데이터 품질
- 효능 정보가 없는 경우: 약품명으로 대체
- 날짜 정보가 없는 경우: 해당 처방전 제외
- 투약일수가 0인 경우: 제외

### 5.2 사용자 경험
- **점진적 공개**: 한 번에 모든 정보를 보여주지 않고 단계별로
- **명확한 안내**: 각 단계에서 무엇을 선택해야 하는지 명확히
- **되돌리기**: 선택 취소 가능
- **진행 표시**: 현재 단계 표시 (1/3, 2/3, 3/3)

### 5.3 성능
- 대량 데이터 처리: 가상화 스크롤 고려
- 분석 로직: 메모이제이션 활용
- 애니메이션: CSS 트랜지션 우선

