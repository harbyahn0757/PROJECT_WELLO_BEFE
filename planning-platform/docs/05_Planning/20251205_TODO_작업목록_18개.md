# TODO 작업 목록 (총 18개)

## 작성 시간: 2025-12-05 20:50

---

## 🔴🔴🔴 Phase 1A: RAG 시스템 완전 개선 (긴급) - 4-5시간

### TODO-1: RAG 검색 쿼리 구체화
- **우선순위**: 🔴🔴🔴 긴급
- **위치**: `checkup_design_prompt.py:324-398`
- **작업**:
  1. `generate_specific_queries()` 함수 추가
  2. 가족력, 연령, 성별, 과거 검진 이상 항목 기반 구체적 쿼리
  3. 환자별 맞춤 쿼리 5-10개 생성
- **예상**: ~150 lines, 1-2시간
- **효과**: RAG 검색 결과 88자 → 355자 (4배)

### TODO-2: source_nodes 메타데이터 완전 활용
- **우선순위**: 🔴🔴🔴 긴급
- **위치**: `checkup_design_prompt.py:324-398`
- **작업**:
  1. `response.source_nodes` 반복
  2. 각 node에서 metadata, text, score 추출
  3. 구조화된 에비던스 객체 반환
  4. 프롬프트에 상세 내용 포함 (1,500자+)
- **예상**: ~200 lines, 2시간
- **효과**: 에비던스 "가이드라인" → "2025 당뇨병 진료지침: '직계 가족에...'"

### TODO-3: 에비던스를 인용구 형식으로 변환 ⭐ 가장 중요!
- **우선순위**: 🔴🔴🔴 긴급
- **위치**: `checkup_design_prompt.py:324-398` + 프롬프트
- **작업**:
  1. `format_evidence_as_citation()` 함수 추가
  2. source_nodes의 실제 텍스트에서 인용 가능한 문장 추출
  3. 인용구 형식으로 변환: "2025 당뇨병 진료지침에 따르면 '직계 가족에...'"
  4. 프롬프트에 인용구 포함 지시
  5. LLM이 evidence 필드 생성 시 인용구 사용하도록 강제
- **예상**: ~100 lines, 1시간
- **효과**: 수검자가 이해 가능한 에비던스

---

## 🔴🔴 Phase 1B: 핵심 로직 보강 (최고) - 4-5시간

### TODO-4: 가족력 RAG 기반 검증 후 추천
- **우선순위**: 🔴🔴 최고
- **위치**: 새 파일 `family_history_mapper.py` + `checkup_design.py`
- **작업**:
  1. 가족력 매핑 테이블 (쿼리 템플릿만 제공)
  2. `validate_and_recommend_family_history_items()` 함수
  3. RAG 검색 → 신뢰도 평가 → 다채로운 추천 (0.4 이상: priority_1, 0.2-0.4: priority_2, 0.2 미만: 추천 안함)
  4. **강제 매핑 아님! RAG가 판단 주체**
- **예상**: ~150 lines, 1-2시간
- **효과**: 당뇨 가족력 → 혈당검사 자동 포함 (근거 충분 시)

### TODO-5: priority_1 일관성 검증 및 자동 보정
- **우선순위**: 🔴🔴 최고
- **위치**: `checkup_design.py:1007-1095`
- **작업**:
  1. `validate_and_fix_priority1_consistency()` 함수
  2. 항목명 매핑 테이블 (혈압 → 혈압측정)
  3. items와 focus_items 일관성 검증
  4. 불일치 시 자동 보정
- **예상**: ~100 lines, 1시간
- **효과**: '혈압' vs '혈압측정' 불일치 해결

### TODO-6: focus_items 완전성 보장
- **우선순위**: 🔴🔴 최고
- **위치**: `checkup_design.py:1007-1095`
- **작업**:
  1. priority_1.items의 모든 항목이 focus_items에 있는지 검증
  2. 누락된 항목 발견 시: RAG 검색 → Master DB → 기본 템플릿 순서로 생성
  3. 자동 생성된 focus_item 추가
- **예상**: ~120 lines, 1-2시간
- **효과**: '허리둘레' focus_item 자동 생성

### TODO-7: 만성질환 연쇄반응 로직 추가
- **우선순위**: 🔴🔴 최고
- **위치**: 새 파일 `chronic_disease_cascade.py` + `checkup_design.py`
- **작업**:
  1. 만성질환 연쇄반응 매핑 테이블 (고혈압 → 눈/콩팥/심장)
  2. `generate_cascade_recommendations()` 함수
  3. STEP 1의 chronic_analysis 확인하여 연쇄 추천 생성
  4. RAG 검색으로 에비던스 보강
- **예상**: ~180 lines, 2시간
- **효과**: 고혈압 → 눈/콩팥/심장 검사 자동 추천 + 에비던스

---

## 🔴 Phase 1C: 프롬프트 및 검증 로직 강화 (높음) - 3-4시간

### TODO-8: 선택 항목 분석 구체화
- **우선순위**: 🔴 높음
- **위치**: `checkup_design_prompt.py` - 프롬프트
- **작업**:
  1. 프롬프트에 "여러 항목" 금지, 구체적 항목명 나열 지시
  2. 검증 로직 추가 (Post-processing)
- **예상**: ~50 lines, 30분-1시간
- **효과**: "여러 항목" → "혈압, 허리둘레가 경계"

### TODO-9: 검진 설계 전략 용어 정확성 검증
- **우선순위**: 🔴 높음
- **위치**: `checkup_design.py:1007-1095` - Post-processing
- **작업**:
  1. 용어 정확성 검증 함수
  2. strategies 필드에서 부정확한 용어 감지
  3. 자동 수정 또는 경고
- **예상**: ~60 lines, 1시간
- **효과**: "비만"(X) → "허리둘레 경계"(O)

### TODO-10: 간호사 노트 표시 확인 및 강화
- **우선순위**: 🔴 높음
- **위치**: `checkup_design_prompt.py` + 프론트엔드
- **작업**:
  1. 프롬프트에서 national_checkup_note 강화 지시
  2. 프론트엔드에서 표시 확인
  3. 미표시 시 표시 로직 추가
- **예상**: ~40 lines, 30분-1시간
- **효과**: 간호사 노트 확실히 표시

### TODO-11: 프롬프트 Role 및 금지어 강화
- **우선순위**: 🔴 높음
- **위치**: `checkup_design_prompt.py:2450-2455`
- **작업**:
  1. Role: "대학병원 검진센터장 + 업셀링 전문가"
  2. 금지어: "모릅니다", "확실하지 않습니다", "의사와 상의하세요"
  3. 소스 강제 연결: 인용구 형식 강제
- **예상**: ~80 lines, 1시간
- **효과**: 업셀링 논리 강화, 소극적 표현 제거

### TODO-12: 핵심 지시사항 상단 배치 및 반복
- **우선순위**: 🔴 높음
- **위치**: `checkup_design_prompt.py:2134-2670`
- **작업**:
  1. 프롬프트 최상단에 핵심 규칙 배치
  2. 프롬프트 최하단에 체크리스트 형식 반복
  3. 부정 예시 추가
- **예상**: ~100 lines, 1-2시간
- **효과**: LLM의 규칙 준수율 향상

---

## 🟡 Phase 1D: 논리 및 관계 명확화 (중간) - 2-3시간

### TODO-13: 대사 건강-간 섬유화 관계 명확화
- **우선순위**: 🟡 중간
- **위치**: `checkup_design_prompt.py` - 프롬프트
- **작업**:
  1. RAG 쿼리 추가: "대사이상지방간 간섬유화 관계"
  2. 프롬프트에 지시사항 추가 (MASLD → 간 섬유화 → 간경변)
  3. reason 필드에 논리 연결 강제
- **예상**: ~60 lines, 1시간
- **효과**: "왜 간 섬유화 스캔?" → "대사이상→지방간→섬유화" 논리 명확

### TODO-14: 논리적 연결고리 전반 강화
- **우선순위**: 🟡 중간
- **위치**: `checkup_design_prompt.py` - 프롬프트
- **작업**:
  1. 추천 이유 작성 시 논리 구조 강제 (4단계: 현재 상태 → 위험 요인 → 연결고리 → 추천 검사)
  2. strategies 필드에서 Bridge Strategy 강제
- **예상**: ~80 lines, 1-2시간
- **효과**: 논리적 설득력 증가

---

## 🟡 Phase 2: 통합 및 UX 개선 (중간) - 2시간

### TODO-15: 통합 로깅 시스템 구축
- **우선순위**: 🟡 중간
- **위치**: 새 파일 `unified_logging.py` + `checkup_design.py`
- **작업**:
  1. `save_unified_execution_log()` 함수
  2. 한 JSON 파일에 모든 정보 저장 (inputs, rag, prompts, responses, parsed_output)
- **예상**: ~100 lines, 1시간
- **효과**: 디버깅 시간 50% 단축

---

## 🔴🔴 Phase 3: 데이터 파이프라인 확장 (최고) - 4시간

### TODO-16: API 응답 구조 확장
- **우선순위**: 🔴🔴 최고
- **위치**: `checkup_design.py:972-998` - API 응답 생성
- **작업**:
  1. `recommended_items[].evidence_details` 필드 추가
  2. `rag_evidences` 최상위 필드 추가
  3. 구조화된 에비던스 메타데이터 포함
  4. TypeScript 타입 정의 업데이트
- **예상**: ~60 lines, 1시간
- **효과**: RAG 메타데이터를 프론트엔드까지 전달

### TODO-17: 프론트엔드 에비던스 UI 컴포넌트
- **우선순위**: 🔴🔴 최고
- **위치**: 새 파일 `EvidenceDisplay.tsx` + SCSS
- **작업**:
  1. 구조화된 에비던스 표시 컴포넌트
  2. 출처 문서, 조직명, 연도 표시
  3. 신뢰도 배지 (높음/중간/낮음)
  4. 인용구 blockquote 스타일
  5. 모바일 반응형
- **예상**: ~150 lines, 2시간
- **효과**: 📄 2025 당뇨병 진료지침 (대한당뇨학회) [높은 신뢰도] + 인용구 표시

### TODO-18: 데이터 파이프라인 변수 추가
- **우선순위**: 🔴 높음
- **위치**: `checkup_design_prompt.py` + `checkup_design.py`
- **작업**:
  1. RAG 검색 결과를 API 응답까지 전달하는 변수 추가
  2. `request_context['rag_evidences']` 활용
  3. 각 단계에서 데이터 손실 방지
  4. 로깅 추가
- **예상**: ~80 lines, 1-2시간
- **효과**: RAG → 프롬프트 → LLM → API → 프론트 전 과정 데이터 손실 방지

---

## 🎯 작업 우선순위 (실행 순서)

### 1차 긴급 (Phase 1A) - 즉시 시작
- TODO-1: RAG 쿼리 구체화
- TODO-2: source_nodes 활용
- TODO-3: 인용구 형식 변환 ⭐

### 2차 최고 (Phase 1B)
- TODO-4: 가족력 RAG 검증
- TODO-5: priority_1 일관성
- TODO-6: focus_items 완전성
- TODO-7: 만성질환 연쇄반응

### 3차 최고 (Phase 3) - Phase 1A와 병행 가능
- TODO-16: API 응답 구조
- TODO-17: 프론트 UI
- TODO-18: 파이프라인 변수

### 4차 높음 (Phase 1C)
- TODO-8 ~ TODO-12: 프롬프트 강화

### 5차 중간 (Phase 1D, Phase 2)
- TODO-13 ~ TODO-15: 논리/로깅

---

## 📊 예상 총 작업 시간

- Phase 1A: 4-5시간 (긴급)
- Phase 1B: 4-5시간 (최고)
- Phase 1C: 3-4시간 (높음)
- Phase 1D: 2-3시간 (중간)
- Phase 2: 2시간 (중간)
- Phase 3: 4시간 (최고)

**총 예상 시간: 19-23시간**

---

## 🚨 가장 중요한 것 (절대 잊지 말 것!)

### TODO-3: 에비던스를 인용구 형식으로 변환

**❌ 현재:**
```
evidence: "※ 대한고혈압학회 가이드라인, Level A 에비던스"
```

**✅ 목표:**
```
evidence: "2025 당뇨병 진료지침에 따르면 '직계 가족(부모, 형제자매)에 
당뇨병이 있는 경우 19세 이상의 모든 성인은 당뇨병 선별검사를 받아야 한다'고 
명시되어 있습니다. 특히 35세 이상이거나 과체중(BMI 23 이상)인 경우 반드시 
검사가 필요하며, 이는 대한당뇨학회의 공식 권고사항입니다."
```

---

## 📝 참고 문서

- `가족력_로직_정확한_설명.md` - 가족력 RAG 검증 로직
- `데이터_파이프라인_검토.md` - RAG → 프론트 전체 파이프라인
- `정확한_TODO_리스트_최종.md` - 상세 TODO 설명
- `정확한_현재상황_분석.md` - 현재 문제 상황
- `RAG_문제_정확한_원인분석.md` - RAG 시스템 분석

---

**작성자**: AI Assistant  
**작성 시간**: 2025-12-05 20:50  
**다음 단계**: 커밋 푸시 후 Phase 1A (TODO 1-3) 즉시 시작
