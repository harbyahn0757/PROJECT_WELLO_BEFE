# 틸코 인증 화면 체크포인트 및 투두 리스트

## 📋 체크포인트 요약

### 1. 서버에서 사용자 정보가 안 오는 경우
### 2. 단계별 이동 간 입력값 처리 (플레인 텍스트 처리)
### 3. 인증 방식이 제대로 안 넘어가는 경우

---

## 🔍 현재 코드 분석 결과

### 발견된 잠재적 문제점

#### 1. 서버 사용자 정보 조회 실패 처리
- **위치**: `AuthForm.tsx` (라인 441-482), `patients.py` (라인 51-100)
- **문제**: 
  - 환자 정보 API 실패 시 에러 처리만 있고, 사용자에게 명확한 안내 없음
  - `patient`가 null인 경우에도 계속 진행하려고 시도
  - URL 파라미터만으로는 데이터 부족 시 처리 미흡

#### 2. 입력값 처리 문제 (플레인 텍스트)
- **위치**: `AuthForm.tsx` (라인 1832-1947)
- **문제**:
  - DOM에서 직접 `input.value`를 읽는 방식 사용
  - 입력 필드가 사라진 후에도 DOM에서 읽으려고 시도
  - 여러 소스에서 값을 가져오는 우선순위가 복잡함
  - `editableName`, `editablePhone`, `editableBirthday` state와 DOM 값이 불일치 가능

#### 3. 인증 방식 전달 문제
- **위치**: `AuthForm.tsx` (라인 62-65, 1844-1892, 2019), `tilko_auth.py` (라인 186, 267)
- **문제**:
  - 여러 fallback 로직으로 인해 항상 기본값 '0' (카카오톡)으로 설정될 위험
  - localStorage > confirmationData > DOM > state > 기본값 순서
  - 사용자가 통신사Pass('4')를 선택해도 '0'으로 강제될 수 있음
  - 백엔드에서 `str(user_info.get("private_auth_type", "0")).strip()` - 기본값 '0' 강제

---

## ✅ 체크포인트별 상세 투두 리스트

### 📌 체크포인트 1: 서버에서 사용자 정보가 안 오는 경우

#### 1.1 프론트엔드 환자 정보 조회 실패 처리
- [ ] **환자 정보 API 호출 실패 시 명확한 에러 메시지 표시**
  - 파일: `AuthForm.tsx` (라인 441-482)
  - 현재: `actions.loadPatientData()` 실패 시 에러 처리 없음
  - 수정: try-catch로 감싸고 사용자에게 안내 메시지 표시
  - 검증: API 실패 시 "환자 정보를 불러올 수 없습니다" 메시지 표시 확인

- [ ] **patient가 null인 경우 인증 진행 차단**
  - 파일: `AuthForm.tsx` (라인 472-476)
  - 현재: patient가 없어도 URL 파라미터만으로 진행 시도
  - 수정: patient 데이터가 없으면 에러 모달 표시하고 진행 차단
  - 검증: patient=null일 때 인증 시작 버튼 비활성화 확인

- [ ] **환자 정보 로딩 상태 표시**
  - 파일: `AuthForm.tsx`
  - 현재: 로딩 중 상태 표시 없음
  - 수정: 로딩 스피너 및 "환자 정보를 불러오는 중..." 메시지 표시
  - 검증: API 호출 중 로딩 상태 확인

#### 1.2 백엔드 환자 정보 조회 실패 처리
- [ ] **환자 정보 조회 API 에러 응답 개선**
  - 파일: `backend/app/api/v1/endpoints/patients.py` (라인 51-100)
  - 현재: 404 에러만 반환
  - 수정: 상세한 에러 메시지와 함께 사용자 친화적 메시지 반환
  - 검증: 존재하지 않는 UUID로 요청 시 명확한 에러 메시지 확인

- [ ] **환자 정보 필수 필드 검증**
  - 파일: `backend/app/api/v1/endpoints/patients.py` (라인 75-95)
  - 현재: name, phone, birthday가 null일 수 있음
  - 수정: 필수 필드 검증 추가 및 누락 시 명확한 에러 반환
  - 검증: 필수 필드 누락 시 400 에러와 함께 상세 메시지 확인

#### 1.3 통합 테스트
- [ ] **환자 정보 없음 시나리오 테스트**
  - 시나리오: 존재하지 않는 UUID로 접속
  - 예상 결과: 명확한 에러 메시지 표시, 인증 진행 불가
  - 검증: 실제 화면에서 에러 메시지 확인

- [ ] **환자 정보 부분 누락 시나리오 테스트**
  - 시나리오: name은 있지만 phone 또는 birthday가 null
  - 예상 결과: 누락된 필드에 대한 명확한 안내
  - 검증: 각 필드별 에러 메시지 확인

---

### 📌 체크포인트 2: 단계별 이동 간 입력값 처리 (플레인 텍스트)

#### 2.1 입력값 검증 강화
- [ ] **각 단계 이동 전 입력값 검증 추가**
  - 파일: `AuthForm.tsx` (라인 1670-1700, 1832-1947)
  - 현재: `handleAllConfirmed`에서만 최종 검증
  - 수정: 각 단계(`name` → `phone` → `birthday` → `auth_method`) 이동 전 검증
  - 검증: 빈 값으로 다음 단계 이동 시도 시 에러 메시지 표시 확인

- [ ] **DOM 직접 읽기 대신 state 우선 사용**
  - 파일: `AuthForm.tsx` (라인 1863-1883)
  - 현재: DOM에서 직접 읽는 로직이 우선순위 높음
  - 수정: state 값 우선, DOM은 보조로만 사용
  - 검증: 입력 필드가 사라진 후에도 state 값으로 정상 동작 확인

- [ ] **입력값 정규화 및 검증 함수 추가**
  - 파일: `AuthForm.tsx`
  - 현재: 여러 곳에서 개별적으로 검증
  - 수정: 공통 검증 함수 생성 (`validateAuthInput`)
  - 검증: 이름, 전화번호, 생년월일 형식 검증 통일 확인

#### 2.2 단계별 검증 메시지
- [ ] **이름 단계 검증**
  - 파일: `AuthForm.tsx` (라인 2227-2260)
  - 현재: 빈 값 체크만 있음
  - 수정: 이름 형식 검증 (한글 2-10자, 특수문자 제한)
  - 검증: 잘못된 이름 입력 시 메시지 표시 확인

- [ ] **전화번호 단계 검증**
  - 파일: `AuthForm.tsx` (라인 2260-2310)
  - 현재: 정규식 검증 있음 (라인 1687)
  - 수정: 검증 실패 시 명확한 메시지 표시
  - 검증: 잘못된 전화번호 입력 시 "올바른 전화번호 형식이 아닙니다" 메시지 확인

- [ ] **생년월일 단계 검증**
  - 파일: `AuthForm.tsx` (라인 2310-2349)
  - 현재: 8자리 체크만 있음
  - 수정: 날짜 유효성 검증 (예: 20240230 같은 잘못된 날짜 체크)
  - 검증: 잘못된 생년월일 입력 시 메시지 표시 확인

- [ ] **인증 방식 선택 검증**
  - 파일: `AuthForm.tsx` (라인 2035-2045)
  - 현재: 빈 값 체크만 있음
  - 수정: 유효한 인증 방식인지 확인 ('0', '4', '6'만 허용)
  - 검증: 잘못된 인증 방식 선택 시 에러 확인

#### 2.3 입력값 동기화
- [ ] **state와 DOM 값 동기화 보장**
  - 파일: `AuthForm.tsx`
  - 현재: state 업데이트와 DOM 읽기가 분리됨
  - 수정: 입력 필드 변경 시 즉시 state 업데이트
  - 검증: 입력 후 다음 단계 이동 시 값이 정확히 전달되는지 확인

- [ ] **히스토리 상태와 실제 입력값 일치 확인**
  - 파일: `AuthForm.tsx` (라인 1828-1842)
  - 현재: 히스토리 상태를 우선 사용
  - 수정: 히스토리 상태는 참고만 하고, 실제 입력값 우선
  - 검증: 브라우저 뒤로가기 후 값이 정확한지 확인

---

### 📌 체크포인트 3: 인증 방식이 제대로 안 넘어가는 경우

#### 3.1 프론트엔드 인증 방식 전달 검증
- [ ] **인증 방식 선택 시 즉시 state 업데이트**
  - 파일: `AuthForm.tsx` (라인 3343-3360)
  - 현재: `setSelectedAuthType` 호출하지만 타이밍 이슈 가능
  - 수정: 선택 즉시 state 업데이트 및 localStorage 저장 확인
  - 검증: 통신사Pass 선택 시 state와 localStorage에 '4' 저장 확인

- [ ] **인증 방식 fallback 로직 단순화**
  - 파일: `AuthForm.tsx` (라인 1886-1892)
  - 현재: 5단계 fallback (localStorage > confirmationData > DOM > state > 기본값)
  - 수정: state 우선, localStorage 보조, 기본값은 마지막
  - 검증: 각 단계에서 올바른 인증 방식이 선택되는지 확인

- [ ] **인증 방식 전달 전 최종 검증 로그 추가**
  - 파일: `AuthForm.tsx` (라인 2065-2077)
  - 현재: 로그는 있지만 검증 없음
  - 수정: 전달 전 인증 방식 유효성 검증 및 불일치 시 경고
  - 검증: 통신사Pass 선택했는데 '0'이 전달되면 에러 로그 확인

#### 3.2 백엔드 인증 방식 처리 검증
- [ ] **세션 시작 시 인증 방식 검증**
  - 파일: `backend/app/api/v1/endpoints/tilko_auth.py` (라인 151-218)
  - 현재: `str(request.private_auth_type).strip()` 만 처리
  - 수정: 유효한 인증 방식인지 검증 ('0', '4', '6'만 허용)
  - 검증: 잘못된 인증 방식 전달 시 400 에러 반환 확인

- [ ] **세션 저장 시 인증 방식 보존**
  - 파일: `backend/app/api/v1/endpoints/tilko_auth.py` (라인 186)
  - 현재: `str(request.private_auth_type).strip()` - 기본값 없음
  - 수정: 기본값 '0' 제거하고 필수 필드로 처리
  - 검증: 인증 방식 없이 요청 시 400 에러 확인

- [ ] **simple-auth 호출 시 인증 방식 확인 로그 강화**
  - 파일: `backend/app/api/v1/endpoints/tilko_auth.py` (라인 267-280)
  - 현재: 로그는 있지만 실제 틸코 API 호출 시 검증 없음
  - 수정: 틸코 API 호출 전 인증 방식 재확인 및 불일치 시 에러
  - 검증: 세션에 '4' 저장했는데 틸코 API에 '0' 전달되는지 확인

#### 3.3 통합 테스트
- [ ] **통신사Pass 선택 시나리오 테스트**
  - 시나리오: 인증 방식 선택 화면에서 통신사Pass('4') 선택
  - 예상 결과: 
    - 프론트엔드 state에 '4' 저장
    - 세션 시작 API에 `private_auth_type: '4'` 전달
    - 백엔드 세션에 '4' 저장
    - simple-auth API에 '4' 전달
    - 틸코 API에 '4' 전달
  - 검증: 각 단계별 로그에서 '4' 확인

- [ ] **네이버 선택 시나리오 테스트**
  - 시나리오: 네이버('6') 선택
  - 예상 결과: 위와 동일하되 '6' 확인
  - 검증: 각 단계별 로그에서 '6' 확인

- [ ] **기본값 카카오톡 시나리오 테스트**
  - 시나리오: 인증 방식 선택 없이 진행
  - 예상 결과: 기본값 '0' 사용
  - 검증: 각 단계별 로그에서 '0' 확인

- [ ] **인증 방식 변경 후 재시도 테스트**
  - 시나리오: 카카오톡 선택 → 통신사Pass로 변경 → 인증 시작
  - 예상 결과: 최종 선택한 통신사Pass('4') 사용
  - 검증: 최종 선택값이 정확히 전달되는지 확인

---

## 🧪 통합 테스트 시나리오

### 시나리오 1: 환자 정보 없음
1. 존재하지 않는 UUID로 접속
2. 예상: "환자 정보를 찾을 수 없습니다" 에러 메시지
3. 인증 진행 불가 확인

### 시나리오 2: 입력값 누락
1. 이름만 입력하고 다음 단계 이동
2. 예상: "전화번호를 입력해주세요" 메시지
3. 생년월일 없이 인증 시작 시도
4. 예상: "생년월일을 입력해주세요" 메시지

### 시나리오 3: 통신사Pass 선택
1. 인증 방식 선택 화면에서 통신사Pass 선택
2. 인증 시작
3. 예상: 백엔드 로그에서 `private_auth_type: '4'` 확인
4. 틸코 API 호출 시 '4' 전달 확인

### 시나리오 4: 입력값 불일치
1. 이름 입력: "홍길동"
2. 다음 단계에서 이름 필드에 "홍길"로 수정 (DOM에서만)
3. 인증 시작
4. 예상: state 값("홍길동") 또는 DOM 값("홍길") 중 어느 것이 전달되는지 확인
5. 일관성 있게 처리되는지 확인

---

## 📝 수정 우선순위

### 높음 (즉시 수정 필요)
1. ✅ 체크포인트 3: 인증 방식 전달 문제 (무조건 카카오톡으로 되는 문제)
2. ✅ 체크포인트 2: 입력값 검증 강화 (값이 없는데 넘어가는 문제)

### 중간 (빠른 시일 내 수정)
3. ✅ 체크포인트 1: 서버 사용자 정보 실패 처리

### 낮음 (개선 사항)
4. 입력값 동기화 개선
5. 에러 메시지 사용자 친화성 개선

---

## 🔧 수정 작업 시작 전 확인사항

1. 현재 코드베이스 상태 백업
2. 테스트 환경 준비 (개발 서버 실행)
3. 각 체크포인트별 테스트 시나리오 준비
4. 수정 후 단계별 테스트 계획

---

## 📌 참고 파일 목록

### 프론트엔드
- `planning-platform/frontend/src/components/AuthForm.tsx` - 메인 인증 폼
- `planning-platform/frontend/src/contexts/WelloDataContext.tsx` - 환자 데이터 컨텍스트
- `planning-platform/frontend/src/utils/layoutMapper.ts` - 환자 정보 조회 유틸

### 백엔드
- `planning-platform/backend/app/api/v1/endpoints/tilko_auth.py` - 틸코 인증 API
- `planning-platform/backend/app/api/v1/endpoints/patients.py` - 환자 정보 API
- `planning-platform/backend/app/utils/tilko_utils.py` - 틸코 유틸리티

---

## ✅ 완료 체크리스트

각 항목 완료 시 체크박스에 체크 표시:

- [ ] 체크포인트 1 완료
- [ ] 체크포인트 2 완료
- [ ] 체크포인트 3 완료
- [ ] 통합 테스트 완료
- [ ] 사용자 테스트 완료

---

## 📋 단계별 테스트 로그 확인 포인트

### 1단계: 인증 페이지 진입 시

#### 프론트엔드 로그 (브라우저 콘솔)
- `🔄 [인증페이지] AuthForm 마운트`
- `🔄 [StorageManager] 인증 페이지 초기화 - 인증 방식 선택 리셋`
- `🔄 [인증페이지] 인증 방식 선택 리셋 완료 - 기본값 '0' (카카오톡)으로 시작`

**확인 사항:**
- ✅ `resetAuthPage()` 호출 확인
- ✅ 인증 방식이 기본값 '0'으로 리셋되는지 확인
- ⚠️ localStorage 사용 불가 시 메모리 모드 로그 확인

---

### 2단계: 인증 방식 선택 시

#### 프론트엔드 로그 (브라우저 콘솔)
- `🔘 [인증방법선택] 사용자가 선택: { value: '4', label: '통신사Pass' }`
- `💾 [인증방법선택] localStorage에 저장: 4` 또는 `💾 [인증방법선택] 메모리에 저장: 4`

**확인 사항:**
- ✅ 선택한 인증 방식 값이 정확한지 ('0', '4', '6')
- ✅ 저장 성공 여부 확인

---

### 3단계: 정보 확인 완료 후 인증 시작

#### 프론트엔드 로그 (브라우저 콘솔)
- `🔍 [handleAllConfirmed] 인증 방법 확인: { state, 메모리, localStorage, 최종결정 }`
- `📤 [세션시작] 요청 데이터: { private_auth_type: '4', ... }`

**확인 사항:**
- ✅ 최종 결정된 인증 방식이 선택한 값과 일치하는지
- ✅ `private_auth_type`이 정확히 전달되는지

---

### 4단계: 백엔드 세션 시작 API

#### 백엔드 로그 (PM2 로그)
- `📥 [세션시작] 받은 요청 데이터: { private_auth_type: 4, ... }`
- `💾 [세션생성] 저장할 user_info: { private_auth_type: '4', ... }`

**확인 사항:**
- ✅ `private_auth_type`이 문자열 '4'로 전달되는지
- ✅ 세션에 저장되는 값이 '4'인지
- ❌ 기본값 '0'이 저장되지 않는지

---

### 5단계: 백엔드 simple-auth 호출

#### 백엔드 로그 (PM2 로그)
- `📋 [simple-auth] 세션에서 가져온 user_info: { private_auth_type: 4, ... }`
- `🚨 [틸코API최종검증] simple_auth 호출 전 최종 확인: { 인증방법: 통신사Pass (코드: 4), 최종 전달값: 4 }`
- `🔍 [틸코API] simple_auth 파라미터: { private_auth_type: '4', ... }`

**확인 사항:**
- ✅ 세션에서 가져온 값이 '4'인지
- ✅ 최종 검증 로그에서 '4' 확인
- ✅ 틸코 API 호출 파라미터에 '4' 전달되는지
- ❌ 기본값 '0'으로 fallback되지 않는지

---

### 6단계: 틸코 API 응답

#### 백엔드 로그 (PM2 로그)
- `🔍 [틸코API] simple_auth 응답: { Status: 'OK', ... }`
- `🚨 [틸코검증] 틸코 Status 확인: 'OK'`
- `✅ [틸코성공] 통신사Pass 인증 메시지 발송 성공 - CxId: {cx_id}`

**확인 사항:**
- ✅ Status가 'OK'인지
- ✅ CxId가 정상적으로 반환되는지
- ✅ 인증 방식에 맞는 메시지가 표시되는지

---

### 7단계: 입력값 검증 로그

#### 프론트엔드 로그 (브라우저 콘솔)
- 이름: `📝 [handleNextStep] 이름 확인: { finalName: '홍길동', ... }`
- 전화번호: `📞 [handleNextStep] 전화번호 확인: { finalPhone: '01012345678', ... }`
- 생년월일: `📅 [handleNextStep] 생년월일 확인: { finalBirthday: '19810927', ... }`

**확인 사항:**
- ✅ 각 단계에서 입력값이 정확히 읽히는지
- ✅ 검증 실패 시 명확한 에러 메시지 표시 확인

---

## 🔍 로그 확인 방법

### 프론트엔드 로그
1. 브라우저 개발자 도구 (F12) → Console 탭
2. 필터링: `[인증페이지]`, `[세션시작]`, `[인증방법선택]` 등

### 백엔드 로그
```bash
# 최신 로그 확인
tail -100 /root/.pm2/logs/Todayon-BE-out.log | grep -E "(세션시작|simple-auth|private_auth_type|인증방법|틸코API)"

# 실시간 모니터링
pm2 logs Todayon_BE --lines 0

# 특정 키워드 필터링
tail -200 /root/.pm2/logs/Todayon-BE-out.log | grep "private_auth_type"
```

---

## 🚨 문제 발생 시 확인할 로그

### 인증 방식이 '0'으로 강제되는 경우
1. 프론트엔드: `handleAllConfirmed` 로그에서 `최종결정` 값 확인
2. 백엔드: `[세션시작]` 로그에서 `private_auth_type` 값 확인
3. 백엔드: `[틸코API최종검증]` 로그에서 `최종 전달값` 확인

### 입력값이 전달되지 않는 경우
1. 프론트엔드: `handleNextStep` 로그에서 각 단계별 입력값 확인
2. 백엔드: `[세션시작]` 로그에서 받은 요청 데이터 확인

