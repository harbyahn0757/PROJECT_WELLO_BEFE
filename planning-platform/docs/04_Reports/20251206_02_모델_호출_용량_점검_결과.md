# 모델 호출 용량 및 데이터 전달 점검 결과

작성일: 2025-12-06  
점검 대상: GPT-4o-mini, GPT-4o, Gemini-2.0-flash

---

## 📊 점검 결과 요약

### ✅ 전체 상태: 정상

| 항목 | 상태 | 비고 |
|-----|------|-----|
| 모든 스텝 용량 적합 | ✅ | 모든 단계에서 컨텍스트 윈도우 제한 내 |
| JSON 파싱 성공 | ✅ | 모든 응답이 올바른 JSON 형식 |
| 데이터 전달 흐름 | ✅ | 각 단계 간 데이터 정확히 전달됨 |

---

## 🎯 단계별 상세 점검

### **STEP 1: 건강 분석 (Risk Stratification)**

**모델:** `gpt-4o-mini` (빠른 모델)

#### 입력 용량
- 시스템 메시지: 3,646자 (~1,215 토큰)
- 사용자 메시지: 9,522자 (~3,174 토큰)
- **총 입력: ~4,389 토큰**

#### 출력 용량
- 요청한 max_tokens: 4,096
- 실제 응답: 659 토큰 (요청의 16%)
- **출력 효율: 매우 효율적** ✅

#### 용량 상태
- Context Window: 128,000 토큰
- **사용률: 3.43%** (매우 여유)
- 남은 출력 용량: 123,611 토큰

#### 응답 품질
- JSON 파싱: ✅ 성공
- 리턴 키:
  - `patient_summary` ✅
  - `analysis` ✅
  - `risk_profile` ✅
  - `chronic_analysis` ✅
  - `survey_reflection` ✅
  - `selected_concerns_analysis` ✅
  - `basic_checkup_guide` ✅

#### 평가
✅ **용량 매우 여유로움** - 입력+출력 합계가 전체 용량의 4% 미만  
✅ **응답 구조 완벽** - 필요한 모든 필드 포함  
✅ **다음 단계로 전달 가능** - 데이터 구조 정확

---

### **STEP 2-1: Priority 1 검진 설계 + RAG 검색**

**모델:** `gpt-4o` (강력한 모델) + `gemini-2.0-flash` (RAG 검색)

#### 입력 용량
- 시스템 메시지: 3,896자 (~1,298 토큰)
- 사용자 메시지: 7,204자 (~2,401 토큰)
  - ⚠️ **STEP 1 결과 전체 포함됨**
  - ⚠️ **RAG 검색 결과 9개 인용구 포함됨**
- **총 입력: ~3,699 토큰**

#### 출력 용량
- 요청한 max_tokens: 2,000
- 실제 응답: 258 토큰 (요청의 13%)
- **출력 효율: 매우 효율적** ✅

#### 용량 상태
- Context Window: 128,000 토큰
- **사용률: 2.89%** (매우 여유)
- 남은 출력 용량: 124,301 토큰

#### RAG 검색 (Gemini API 호출)
- **쿼리 수:** 생성된 쿼리 개수 (실시간 로그 확인 필요)
- **검색된 에비던스:** 9개 의학 가이드라인 인용구
- **신뢰도 분포:**
  - 높음 (0.4~0.8): 5개
  - 중간 (0.3~0.4): 4개

#### 응답 품질
- JSON 파싱: ✅ 성공
- 리턴 키:
  - `summary` ✅
  - `priority_1` ✅

#### 평가
✅ **용량 매우 여유로움** - STEP 1 결과 + RAG 결과 포함해도 3% 미만  
✅ **RAG 통합 성공** - 의학적 근거가 프롬프트에 정확히 포함됨  
✅ **Priority 1 생성 정상** - 필수 필드 모두 포함  
✅ **다음 단계로 전달 가능**

---

### **STEP 2-2: Priority 2,3 + Upselling 전략**

**모델:** `gpt-4o` (강력한 모델) + `gemini-2.0-flash` (RAG 검색)

#### 입력 용량
- 시스템 메시지: 3,896자 (~1,298 토큰)
- 사용자 메시지: 8,350자 (~2,783 토큰)
  - ⚠️ **STEP 1 결과 전체 포함됨**
  - ⚠️ **STEP 2-1 결과 전체 포함됨**
  - ⚠️ **RAG 검색 결과 9개 인용구 포함됨**
- **총 입력: ~4,081 토큰**

#### 출력 용량
- 요청한 max_tokens: 3,000
- 실제 응답: 829 토큰 (요청의 28%)
- **출력 효율: 효율적** ✅

#### 용량 상태
- Context Window: 128,000 토큰
- **사용률: 3.19%** (매우 여유)
- 남은 출력 용량: 123,919 토큰

#### 응답 품질
- JSON 파싱: ✅ 성공
- 리턴 키:
  - `priority_2` ✅
  - `priority_3` ✅
  - `strategies` ✅ (4개 검진 항목별 전략)
  - `doctor_comment` ✅

#### 평가
✅ **용량 매우 여유로움** - STEP 1 + STEP 2-1 + RAG 포함해도 4% 미만  
✅ **업셀링 전략 완성** - 모든 검진 항목에 대한 개별 전략 생성  
✅ **최종 응답 구조 완벽** - 필요한 모든 필드 포함

---

## 🔗 데이터 전달 흐름 검증

### STEP 1 → STEP 2-1 전달

| 검증 항목 | 상태 | 비고 |
|----------|------|-----|
| STEP 1 결과 포함 | ✅ | "STEP 1 분석 결과" 섹션 확인 |
| `patient_summary` 전달 | ✅ | 프롬프트 내 정확히 포함됨 |
| `analysis` 전달 | ✅ | 전체 분석 텍스트 포함됨 |
| `risk_profile` 전달 | ✅ | 위험도 평가 결과 포함됨 |
| `chronic_analysis` 전달 | ✅ | 만성질환 분석 포함됨 |

**전달 방식:** JSON 형식으로 stringify하여 user_message에 포함

---

### STEP 2-1 → STEP 2-2 전달

| 검증 항목 | 상태 | 비고 |
|----------|------|-----|
| STEP 1 결과 포함 | ✅ | "STEP 1 분석 결과" 섹션 유지 |
| STEP 2-1 결과 포함 | ✅ | "STEP 2-1 결과" 섹션 신규 추가 |
| `priority_1` 데이터 전달 | ✅ | focus_items 포함 전체 전달 |
| `summary` 데이터 전달 | ✅ | key_health_issues 등 전달 |

**전달 방식:** JSON 형식으로 stringify하여 user_message에 포함  
**중복 제거:** Priority 1과 중복되지 않도록 명시적으로 지시

---

## 📈 모델별 성능 분석

### GPT-4o-mini (STEP 1)

| 지표 | 값 |
|-----|-----|
| Context Window | 128K 토큰 |
| 실제 사용 | 4,389 토큰 (3.43%) |
| 응답 속도 | 13.859초 |
| 비용 효율 | 매우 높음 |
| 정확도 | 높음 (분석 전용) |

**평가:** 분석 작업에 최적화된 선택 ✅

---

### GPT-4o (STEP 2-1, 2-2)

| 지표 | STEP 2-1 | STEP 2-2 |
|-----|----------|----------|
| Context Window | 128K 토큰 | 128K 토큰 |
| 실제 사용 | 3,699 토큰 (2.89%) | 4,081 토큰 (3.19%) |
| 응답 시간 | ~14초 | ~10초 |
| 비용 효율 | 높음 | 높음 |
| 정확도 | 매우 높음 | 매우 높음 |

**평가:** 복잡한 추론과 업셀링 전략 생성에 적합 ✅

---

### Gemini-2.0-flash (RAG 검색)

| 지표 | 값 |
|-----|-----|
| 사용 목적 | 의학 가이드라인 검색 |
| 검색 방식 | LlamaIndex QueryEngine |
| 검색 결과 | 9개 인용구 |
| 신뢰도 | 중간~높음 (0.3~0.8) |
| 통합 방식 | 인용구 형식으로 프롬프트 주입 |

**평가:** 의학적 근거 확보에 효과적 ✅

---

## ⚠️ 잠재적 문제점 및 개선 방안

### 1. 토큰 추정 정확도

**현재:**
- 간단한 문자 수 기반 추정 (3자 = 1토큰)
- 실제 토큰과 오차 발생 가능

**개선 방안:**
```python
# tiktoken 라이브러리 사용
import tiktoken

encoding = tiktoken.encoding_for_model("gpt-4o")
actual_tokens = len(encoding.encode(text))
```

---

### 2. RAG 검색 로그 부재

**현재:**
- Gemini API 호출 횟수 불명확
- 쿼리 생성 로직의 효율성 측정 불가

**개선 방안:**
- `get_medical_evidence_from_rag()` 함수에 로그 추가
- 쿼리별 API 호출 시간 측정
- 검색 결과의 유용성 평가 메트릭 추가

---

### 3. 프롬프트 크기 증가 가능성

**현재:**
- 최대 사용률 3.43% (매우 여유)
- 하지만 환자 데이터가 많아지면 증가 가능

**시나리오:**
- 5년치 검진 데이터: ~10,000자 추가
- 처방전 100건: ~20,000자 추가
- **예상 총 입력:** ~15,000 토큰 (여전히 안전)

**모니터링 필요:**
- 입력 토큰 > 30,000 시 경고
- 입력 토큰 > 60,000 시 데이터 요약 필요

---

### 4. max_tokens 설정 검토

**현재 설정:**
- STEP 1: 4,096 토큰 (실제 사용: 659)
- STEP 2-1: 2,000 토큰 (실제 사용: 258)
- STEP 2-2: 3,000 토큰 (실제 사용: 829)

**최적화 가능:**
- STEP 2-1은 2,000 → 1,500으로 감소 가능
- 하지만 안전 마진 고려 시 현재 설정 유지 권장

---

## 💰 비용 분석

### STEP 1 (gpt-4o-mini)

```
입력: 4,389 토큰 × $0.15/1M = $0.00066
출력: 659 토큰 × $0.60/1M = $0.00040
총 비용: $0.00106 (약 1.5원)
```

### STEP 2-1 (gpt-4o)

```
입력: 3,699 토큰 × $2.50/1M = $0.00925
출력: 258 토큰 × $10.00/1M = $0.00258
총 비용: $0.01183 (약 16원)
```

### STEP 2-2 (gpt-4o)

```
입력: 4,081 토큰 × $2.50/1M = $0.01020
출력: 829 토큰 × $10.00/1M = $0.00829
총 비용: $0.01849 (약 25원)
```

### **1회 검진 설계 총 비용**

```
STEP 1 + STEP 2-1 + STEP 2-2
= $0.00106 + $0.01183 + $0.01849
= $0.03138 (약 42원)
```

**RAG 검색 비용 (Gemini):**
- Gemini-2.0-flash는 무료 티어 또는 매우 저렴
- 추가 비용 미미 (<$0.001)

**결론:** 1회 검진 설계당 약 **40-50원** 수준 ✅

---

## 🎯 결론 및 권장사항

### ✅ 현재 시스템 강점

1. **용량 매우 여유로움**
   - 모든 단계에서 사용률 4% 미만
   - 환자 데이터 10배 증가해도 안전

2. **데이터 전달 완벽**
   - 각 단계 간 데이터 누락 없음
   - JSON 구조 일관성 유지

3. **비용 효율 높음**
   - 1회당 40-50원 수준
   - mini + 4o 조합으로 최적화됨

4. **RAG 통합 성공**
   - 의학적 근거 자동 검색
   - 인용구 형식으로 신뢰도 확보

---

### 📋 권장 사항

#### 우선순위 1: 모니터링 강화

```python
# gpt_service.py에 토큰 사용량 로그 추가
logger.info(f"📊 [토큰 사용량] 입력: {input_tokens}, 출력: {output_tokens}, 사용률: {usage_percent}%")

# 경고 임계치 설정
if input_tokens > 30000:
    logger.warning(f"⚠️ 입력 토큰이 30K 초과: {input_tokens}")
```

#### 우선순위 2: RAG 로그 상세화

```python
# checkup_design_prompt.py의 get_medical_evidence_from_rag() 개선
print(f"[RAG] 쿼리 실행: {query} (카테고리: {category})")
print(f"[RAG] 검색 결과: {len(evidences)}개 에비던스 (신뢰도: {avg_confidence})")
```

#### 우선순위 3: tiktoken 도입

```bash
pip install tiktoken
```

```python
import tiktoken

def count_tokens(text: str, model: str) -> int:
    encoding = tiktoken.encoding_for_model(model)
    return len(encoding.encode(text))
```

#### 우선순위 4: 알림 시스템

- 토큰 사용량 > 50K 시 Slack 알림
- JSON 파싱 실패 시 즉시 알림
- 비용 일일 합계 리포트

---

## 📚 참고 자료

- [OpenAI GPT-4o 공식 문서](https://platform.openai.com/docs/models/gpt-4o)
- [OpenAI GPT-4o-mini 공식 문서](https://platform.openai.com/docs/models/gpt-4o-mini)
- [Google Gemini API 문서](https://ai.google.dev/docs)
- [tiktoken 라이브러리](https://github.com/openai/tiktoken)

---

**점검 완료일:** 2025-12-06  
**다음 점검 예정:** 2025-12-13 (주간 단위)


