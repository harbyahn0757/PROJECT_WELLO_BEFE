# 사용자 요구사항 정리 및 이해 확인

## 📋 이해한 요구사항 요약

### 1. 발견된 문제점

#### 1.1 priority_1 항목 문제
- **현상**: 혈압측정, 혈당검사 항목으로 바꿨는데 **혈압만 나옴**
- **원인 추정**: 
  - GPT가 여러 항목을 선택하지 않음
  - 프롬프트에서 "최대 3개"라고 했지만 실제로는 1개만 선택
  - 혈당 관련 데이터가 부족하여 혈압만 선택

#### 1.2 검진 데이터 처리 문제
- **현상 1**: 검진 데이터 클릭했는데 확인 필요 - **최근 검진을 더 의미있게 다뤄야 함**
- **현상 2**: 몇년 전 검진만 있고 **최근 이력이 없을 때의 코멘트가 없음**
- **원인 추정**:
  - 과거 검진 데이터가 있으면 최근 이력 부재를 언급하지 않음
  - "데이터가 확인되지 않아 현재 상태 확인을 위해 검사가 필요합니다" 논리 미적용

#### 1.3 의학적 근거 부족
- **현상**: 의학적 근거 부분이 약함
- **요구사항**: 
  - 가이드라인에 따르면 **어떤 사례, 어떤 실험, 어떤 것 때문에** 머머한다
  - 그에 대한 **에비던스가 작게 표시**되어야 함
- **현재 상태**: 단순히 "가이드라인에 따르면..." 수준

#### 1.4 옵션 검사 투입 확인
- **현상**: 옵션 검사가 투입되었는지 궁금
- **현상**: 종류는 들어갔는데 **에비던스가 없거나 RAG에 없는 검사**인지 확인 필요
- **원인 추정**:
  - RAG 벡터 DB에 해당 검사 자료가 부족
  - 프롬프트에서 에비던스 요구가 약함

#### 1.5 업셀링 기법 미작동
- **현상**: **업셀링 기법이 전혀 작동 안함**
- **요구사항**: Bridge Strategy (Anchor-Gap-Offer) 적용 필요
- **현재 상태**: 단순 추천만 하고, 기본 검진의 한계를 지적하지 않음

---

### 2. 컨설팅 내용 반영 필요 사항

#### 2.1 Bridge Strategy (Anchor-Gap-Offer) 적용
```
- Anchor (인정): "국가 검진 항목인 [A]검사는 ~한 점에서 필수적입니다."
- Gap (한계 지적): "하지만 [A]검사는 [B]라는 한계가 있어, 미세 병변이나 초기 징후를 놓칠 위험이 있습니다."
- Offer (제안): "따라서 [C] 정밀 검사를 통해 [B]까지 확인하시는 것이 완벽한 안심을 위해 필요합니다."
```

#### 2.2 데이터 부재 처리
- **현재**: "데이터가 없어 정상이다"라고 가정
- **변경 필요**: "데이터가 확인되지 않아, 현재 상태 확인을 위해 검사가 필요합니다"
- **추가 필요**: "몇년 전 검진만 있고 최근 이력이 없는 상황에서..." 코멘트

#### 2.3 RAG 기반 고도화 프롬프트
- Context (RAG Retrieved)를 근거로 판단
- 하드코딩 금지: 나이/성별에 따른 검진 기준은 Context를 근거로 판단

#### 2.4 벡터 DB에 추가 필요 자료
1. **병원 특화 검사(비급여) 설명 자료**
   - 최신 영상 진단 장비 설명서 (MRI, CT)
   - 신규 바이오마커 및 액체생검 자료
   
2. **통계 및 공포/안심 마케팅 근거 자료**
   - 연령별/성별 질환 통계
   - 질환 진행 시 치료 비용/삶의 질 저하 데이터
   
3. **영양 및 기능 의학 자료**
   - 기능 의학 검사 가이드
   - 생활습관 교정 가이드

---

## 🔍 RAG 시스템 점검 결과

### 환경 설정 상태

| 항목 | 상태 | 비고 |
|------|------|------|
| LlamaIndex API Key | ✅ 설정됨 | 정상 |
| Gemini API Key | ✅ 설정됨 | 정상 |
| LlamaCloud Index ID | ✅ 설정됨 | 정상 |
| RAG 엔진 초기화 | ✅ 성공 | index_id만 사용하도록 수정 완료 |
| Gemini 모델명 | ❌ 오류 | `gemini-pro` 모델이 더 이상 사용 불가 |

### 검색 테스트 결과

| 검색 항목 | 상태 | 원인 |
|----------|------|------|
| 기본 검색 - 환자 위험 요인 | ❌ 실패 | Gemini 모델명 오류 |
| 심층 검색 - 혈압 관련 | ❌ 실패 | Gemini 모델명 오류 |
| 심층 검색 - 혈당 관련 | ❌ 실패 | Gemini 모델명 오류 |
| 업셀링 검사 - 경동맥 초음파 | ❌ 실패 | Gemini 모델명 오류 |
| 업셀링 검사 - 뇌 MRA | ❌ 실패 | Gemini 모델명 오류 |
| 액체생검 - 캔서파인드 | ❌ 실패 | Gemini 모델명 오류 |
| 통계 자료 - 연령별 질환 통계 | ❌ 실패 | Gemini 모델명 오류 |
| 치료 비용 - 예방 vs 치료 | ❌ 실패 | Gemini 모델명 오류 |

**핵심 문제**: Gemini 모델명 `gemini-pro`가 더 이상 사용 불가. 최신 모델명으로 변경 필요.

---

## 📊 문제점 진단 및 해결 방안 테이블

| 문제 영역 | 문제점 | 원인 | 해결 방안 | 우선순위 | 상태 |
|----------|--------|------|----------|---------|------|
| **RAG 엔진** | 초기화 실패 | 파라미터 충돌 | `index_id`만 사용 | 긴급 | ✅ 수정 완료 |
| **Gemini 모델** | API 호출 실패 | `gemini-pro` deprecated | 최신 모델명으로 변경 | 긴급 | 🔄 수정 필요 |
| **priority_1** | 혈압만 나옴 | GPT가 여러 항목 선택 안함 | "최소 2-3개" 명시 | 높음 | 🔄 수정 필요 |
| **검진 데이터** | 최근 이력 부재 코멘트 없음 | 데이터 부재 처리 로직 미적용 | "데이터 확인 불가 → 검사 필요" 논리 추가 | 높음 | 🔄 수정 필요 |
| **의학적 근거** | 단순 "가이드라인에 따르면" | 에비던스 요구가 약함 | 구체적 사례, 실험, 통계 요구 | 높음 | 🔄 수정 필요 |
| **옵션 검사** | 에비던스 없음 | RAG 벡터 DB 부족 | 벡터 DB에 업셀링 검사 자료 추가 | 중간 | 🔄 검토 필요 |
| **업셀링** | Bridge Strategy 미작동 | 프롬프트에 명시 안됨 | Anchor-Gap-Offer 구조 명시 | 높음 | 🔄 수정 필요 |

---

## 🔧 즉시 수정 필요 사항

### 1. Gemini 모델명 수정 (긴급)

**현재**: `gemini-pro` (deprecated)
**변경 필요**: `gemini-1.5-pro` 또는 `gemini-1.5-flash`

### 2. 프롬프트 수정: Bridge Strategy 명시 (높음)

**추가 필요**:
- Anchor-Gap-Offer 구조를 명시적으로 요구
- 각 추천 항목에 3단계 논리 구조 필수

### 3. 데이터 부재 처리 로직 추가 (높음)

**추가 필요**:
- 과거 검진 데이터가 없을 때: "데이터가 확인되지 않아 현재 상태 확인을 위해 검사가 필요합니다"
- 최근 이력이 없을 때: "몇년 전 검진만 있고 최근 이력이 없는 상황에서..."

### 4. 의학적 근거 강화 (높음)

**추가 필요**:
- 구체적 사례 요구
- 실험/연구 인용 요구
- 통계 데이터 인용 요구
- 에비던스 작게 표시 요구

### 5. priority_1 항목 개수 보장 (높음)

**수정 필요**:
- "최대 3개" → "최소 2-3개, 최대 3개"
- 여러 항목 선택 강제

---

## 📝 다음 단계

1. **Gemini 모델명 수정** (긴급) - `gemini-1.5-pro`로 변경
2. **RAG 검색 재테스트** - 모델명 수정 후 검색 가능 여부 확인
3. **프롬프트 Bridge Strategy 적용** (높음)
4. **데이터 부재 처리 로직 추가** (높음)
5. **의학적 근거 강화** (높음)
6. **priority_1 항목 개수 보장** (높음)
7. **벡터 DB 추가 자료 검토** (중간)

---

이 리포트를 바탕으로 단계별로 수정을 진행하겠습니다.

