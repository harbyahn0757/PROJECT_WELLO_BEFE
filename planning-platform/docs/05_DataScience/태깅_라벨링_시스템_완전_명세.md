# WELNO 채팅 태깅 · 라벨링 시스템 — 완전 명세

> **작성일**: 2026-02-15
> **목적**: 데이터 사이언스 / 마이닝 분석을 위한 태깅 시스템 전체 스키마 · 값 도메인 · 생성 로직 문서화
> **대상 테이블**: `welno.tb_chat_session_tags` (태그), `welno.tb_partner_rag_chat_log` (원본 상담 로그)

---

## 1. 아키텍처 개요

```
사용자 상담 완료
       ↓
[tag_chat_session()]  ← chat_tagging_service.py
       ├─ LLM 분석 (Gemini 2.0 Flash Lite) ─── 성공 시 LLM 결과 사용
       └─ 규칙 기반 폴백 ─────────────────────── 실패 시 키워드 매칭
       ↓
[welno.tb_chat_session_tags]  UPSERT (ON CONFLICT → UPDATE)
```

### 하이브리드 태깅 전략
| 항목 | LLM (Gemini) | 규칙 기반 |
|------|-------------|----------|
| interest_tags | LLM이 대화에서 추출 (topic + intensity) | INTEREST_KEYWORDS 사전 매칭 |
| risk_tags | — | health_metrics의 `_abnormal` 필드에서 추출 (항상 규칙 기반) |
| keyword_tags | — | INTEREST_KEYWORDS 사전 매칭 (항상 규칙 기반) |
| sentiment | LLM 분석 | 마지막 메시지 키워드 매칭 |
| risk_level | LLM 판단 vs 규칙 기반 중 **더 높은 값** 채택 | `_abnormal` 심각도 키워드 기반 |
| conversation_summary | LLM 요약 | "첫 질문 / 마지막 질문" 간이 조합 |
| conversation_depth | LLM 판단 | 반복 언급 주제 수 + 메시지 수 기반 |
| engagement_score | LLM 판단 | 반복 주제(×25) + 언급 총수(×5) + 메시지 수(×3) |
| action_intent | LLM 판단 | 행동 키워드 매칭 |
| nutrition_tags | LLM 추출 ∪ 규칙 기반 (병합) | NUTRITION_KEYWORDS 사전 매칭 |
| key_concerns | LLM 추출 | 빈 배열 |
| counselor_recommendations | LLM 추출 | 빈 배열 |
| follow_up_needed | LLM 판단 ∨ (risk_level == "high") | risk_level == "high" |

---

## 2. 테이블 스키마: `welno.tb_chat_session_tags`

### 2.1 전체 컬럼

| # | 컬럼명 | 타입 | Default | 설명 |
|---|--------|------|---------|------|
| 1 | `id` | BIGSERIAL | auto | PK |
| 2 | `session_id` | VARCHAR(255) | NOT NULL | 상담 세션 ID |
| 3 | `partner_id` | VARCHAR(50) | NOT NULL | 파트너 ID |
| 4 | `interest_tags` | JSONB | `'[]'` | 관심사 태그 배열 |
| 5 | `risk_tags` | JSONB | `'[]'` | 건강 위험 태그 배열 |
| 6 | `keyword_tags` | JSONB | `'[]'` | 핵심 키워드 태그 배열 |
| 7 | `sentiment` | VARCHAR(20) | — | 감정 분석 결과 |
| 8 | `conversation_summary` | TEXT | — | 대화 요약 |
| 9 | `data_quality_score` | SMALLINT | 0 | 검진 데이터 완성도 (0-100) |
| 10 | `has_discrepancy` | BOOLEAN | false | CLIENT_RAG_DISCREPANCY 발생 여부 |
| 11 | `risk_level` | VARCHAR(20) | `'low'` | 종합 위험도 |
| 12 | `key_concerns` | JSONB | `'[]'` | 환자 핵심 우려사항 |
| 13 | `follow_up_needed` | BOOLEAN | false | 추가 조치 필요 여부 |
| 14 | `tagging_model` | VARCHAR(50) | `'rule-based'` | 태깅에 사용된 모델 |
| 15 | `tagging_version` | INTEGER | 1 | 태깅 스키마 버전 |
| 16 | `counselor_recommendations` | JSONB | `'[]'` | 상담사 핵심 조언 |
| 17 | `conversation_depth` | VARCHAR(20) | `'shallow'` | 대화 깊이 |
| 18 | `engagement_score` | SMALLINT | 0 | 참여도 점수 (0-100) |
| 19 | `action_intent` | VARCHAR(20) | `'passive'` | 행동 의향 |
| 20 | `nutrition_tags` | JSONB | `'[]'` | 식단·영양 관심 태그 |
| 21 | `created_at` | TIMESTAMPTZ | NOW() | 최초 생성 시각 |
| 22 | `updated_at` | TIMESTAMPTZ | NOW() | 최종 갱신 시각 (트리거 자동 갱신) |

**제약조건**: `UNIQUE (session_id, partner_id)` → UPSERT 지원

**인덱스**:
- `idx_chat_tags_session` → session_id
- `idx_chat_tags_partner` → partner_id
- `idx_chat_tags_interest` → interest_tags (GIN)
- `idx_chat_tags_risk` → risk_tags (GIN)
- `idx_chat_tags_created` → created_at DESC

---

## 3. 각 필드 상세 명세

### 3.1 `interest_tags` (JSONB 배열)

**형식**: `[{"topic": "주제명", "intensity": "high|medium|low"}, ...]`

| intensity | 의미 | LLM 판단 기준 |
|-----------|------|--------------|
| `high` | 환자가 반복적으로 파고든 주제 | 후속 질문으로 2회 이상 언급 |
| `medium` | 환자가 구체적으로 질문한 주제 | 명시적 질문 1회 |
| `low` | 가볍게 언급한 주제 | 첫 질문에서만 나온 주제 |

**규칙 기반 폴백 시**: 모든 태그가 `intensity: "medium"`

**주요 관심사 주제 도메인** (INTEREST_KEYWORDS 사전):
| 태그 | 매칭 키워드 |
|------|-----------|
| 다이어트 | 다이어트, 살, 체중, 비만, BMI, 감량 |
| 혈압 | 혈압, 고혈압, 저혈압, 수축기, 이완기 |
| 당뇨 | 당뇨, 혈당, 공복혈당, 인슐린, HbA1c |
| 간기능 | 간, AST, ALT, 감마, GGT, 지방간 |
| 콜레스테롤 | 콜레스테롤, 중성지방, HDL, LDL, 이상지질 |
| 신장 | 신장, 크레아티닌, 사구체, GFR, 콩팥 |
| 암 | 암, 종양, 용종, 조직검사 |
| 위장 | 위, 위내시경, 위암, 헬리코박터, 역류 |
| 갑상선 | 갑상선, TSH, T3, T4 |
| 빈혈 | 빈혈, 혈색소, 헤모글로빈, 철분 |
| 심장 | 심장, 심전도, 부정맥, 협심증 |
| 폐 | 폐, 흉부, X-ray, 결핵 |

> LLM은 사전에 없는 주제도 자유롭게 추출 가능 (예: "신사구체여과율", "복용 약", "스트레스" 등)

---

### 3.2 `risk_tags` (JSONB 배열)

**형식**: `["metric_status", ...]` (예: `["혈압_경계", "혈당_이상"]`)

**생성 로직**: 항상 규칙 기반 (`health_metrics`에서 추출)
```python
for key, val in health_metrics.items():
    if key.endswith("_abnormal") and val and val != "정상":
        risks.append(f"{metric_name}_{val}")
```

**health_metrics 내 `_abnormal` 필드 목록**:
- `systolic_bp_abnormal`, `diastolic_bp_abnormal`
- `fasting_glucose_abnormal`
- `total_cholesterol_abnormal`, `hdl_cholesterol_abnormal`, `ldl_cholesterol_abnormal`
- `hemoglobin_abnormal`
- `sgot_ast_abnormal`, `sgpt_alt_abnormal`, `gamma_gtp_abnormal`
- `creatinine_abnormal`, `gfr_abnormal`
- `bmi_abnormal`
- 기타 검진 항목별 `_abnormal` 접미사

**가능한 상태값**: `정상`, `경계`, `주의`, `전단계`, `이상`, `위험`, `질환의심` 등

---

### 3.3 `risk_level` (VARCHAR)

**가능한 값**: `low`, `medium`, `high`

**계산 로직** (LLM + 규칙 기반 중 더 높은 값):

| 조건 | 결과 |
|------|------|
| `_abnormal`에 "위험/이상/질환의심" ≥ 1개 또는 총 이상 ≥ 5개 | `high` |
| `_abnormal`에 "경계/주의/전단계" ≥ 2개 또는 총 이상 ≥ 2개 | `medium` |
| 그 외 | `low` |

---

### 3.4 `sentiment` (VARCHAR)

**가능한 값**: `positive`, `negative`, `neutral`, `worried`, `grateful`

| 값 | LLM 기준 | 규칙 기반 키워드 |
|----|---------|---------------|
| positive | 환자 감정 긍정적 | 감사, 고마워, 좋아, 도움, 이해 |
| negative | 환자 감정 부정적 | 싫, 틀렸, 불만, 화나, 짜증 |
| neutral | 중립 | (기본값) |
| worried | 걱정/불안 표현 | — (LLM 전용) |
| grateful | 감사 표현 | — (LLM 전용) |
| confused | 혼란 | 모르겠, 어렵, 복잡, 이해가 안 |

> 규칙 기반은 `confused` 포함 가능, LLM은 `worried`/`grateful` 가능

---

### 3.5 `conversation_depth` (VARCHAR)

**가능한 값**: `shallow`, `moderate`, `deep`

| 값 | 의미 | LLM 기준 | 규칙 기반 |
|----|------|---------|----------|
| deep | 같은 주제를 깊이 파고듦 | 동일 주제 2회+ 후속질문 | 반복 주제 ≥2 또는 (반복≥1 & 메시지≥4) |
| moderate | 구체적 질문 있음 | 구체적 질문 | 언급 총수 ≥2 또는 메시지 ≥3 |
| shallow | 단순 질문 | 기본값 | 기본값 |

---

### 3.6 `engagement_score` (SMALLINT, 0-100)

**LLM**: 대화 분석 기반 종합 점수 (반복질문, 후속질문, 질문 수 종합)

**규칙 기반 공식**:
```
score = min(100, (반복주제수 × 25) + (총언급수 × 5) + (메시지수 × 3))
```

---

### 3.7 `action_intent` (VARCHAR)

**가능한 값**: `active`, `considering`, `passive`

| 값 | 의미 | 규칙 기반 키워드 |
|----|------|---------------|
| active | 병원방문/생활개선 의지 표현 | 가볼게, 예약, 병원, 검사받, 시작, 실천, 바꿔 |
| considering | 고민 중 | 고민, 생각, 고려, 해볼까, 괜찮을까 |
| passive | 특별한 행동 의지 없음 | (기본값) |

---

### 3.8 `nutrition_tags` (JSONB 배열)

**형식**: `["태그명", ...]` (문자열 배열)

**도메인** (NUTRITION_KEYWORDS 사전):
| 태그 | 매칭 키워드 |
|------|-----------|
| 식단관리 | 식단, 식사, 음식, 먹, 섭취, 칼로리, 탄수화물, 저염, 저당 |
| 영양제 | 영양제, 비타민, 오메가, 유산균, 프로바이오틱, 철분제, 칼슘, 마그네슘 |
| 다이어트식단 | 다이어트, 감량, 체중조절, 저탄고지, 간헐적단식 |
| 운동 | 운동, 걷기, 헬스, 유산소, 근력, 스트레칭 |

> LLM은 사전에 없는 태그도 추출 가능. 규칙 기반 결과와 합집합(∪)으로 병합.

---

### 3.9 `keyword_tags` (JSONB 배열)

**형식**: `["키워드", ...]` (최대 20개)

**생성**: 항상 규칙 기반. 사용자(환자) 메시지에서만 추출 (AI 응답 제외).
INTEREST_KEYWORDS 사전의 모든 키워드를 개별 매칭하여 수집.

---

### 3.10 `data_quality_score` (SMALLINT, 0-100)

**계산**: 항상 규칙 기반.

**필수 필드 15개**:
`height`, `weight`, `bmi`, `systolic_bp`, `diastolic_bp`, `fasting_glucose`, `total_cholesterol`, `hdl_cholesterol`, `ldl_cholesterol`, `hemoglobin`, `sgot_ast`, `sgpt_alt`, `gamma_gtp`, `creatinine`, `gfr`

```
score = (유효 필드 수 / 15) × 100
```

유효 조건: `val is not None and val != 0 and val != "" and val != "0"`

---

### 3.11 `key_concerns` (JSONB 배열)

**형식**: `["우려사항 문장", ...]` (최대 3개)

**생성**: LLM 전용. 환자가 명시적으로 표현한 걱정/우려만 추출.
규칙 기반 폴백 시 빈 배열.

---

### 3.12 `counselor_recommendations` (JSONB 배열)

**형식**: `["조언 요약", ...]` (최대 3개)

**생성**: LLM 전용. 상담사(AI)가 제공한 핵심 조언 요약.
규칙 기반 폴백 시 빈 배열.

---

### 3.13 `tagging_model` (VARCHAR)

| 값 | 의미 |
|----|------|
| `rule-based` | 규칙 기반 태깅 (LLM 실패 시) |
| `gemini-gemini-2.0-flash-lite` | Gemini Flash Lite LLM 태깅 |

---

### 3.14 `tagging_version` (INTEGER)

| 버전 | 변경 내용 |
|------|----------|
| 1 | 초기 태깅 (interest, risk, keyword, sentiment, summary, quality) |
| 2 | LLM 태깅 + 확장 (risk_level, key_concerns, follow_up, counselor_recommendations, conversation_depth, engagement_score, action_intent, nutrition_tags) |

---

## 4. 원본 테이블: `welno.tb_partner_rag_chat_log`

| # | 컬럼명 | 타입 | 설명 |
|---|--------|------|------|
| 1 | `id` | BIGSERIAL | PK |
| 2 | `partner_id` | VARCHAR | 파트너 ID |
| 3 | `hospital_id` | VARCHAR | 병원 ID |
| 4 | `user_uuid` | VARCHAR | 사용자 UUID |
| 5 | `session_id` | VARCHAR | 세션 ID (태그 테이블 FK) |
| 6 | `client_info` | JSONB | 클라이언트 정보 |
| 7 | `initial_data` | JSONB | 초기 데이터 (health_metrics 포함) |
| 8 | `conversation` | JSONB | 전체 대화 내용 `[{role, content, timestamp}]` |
| 9 | `message_count` | INTEGER | 메시지 수 |
| 10 | `created_at` | TIMESTAMPTZ | 생성 시각 |
| 11 | `updated_at` | TIMESTAMPTZ | 갱신 시각 |

### `initial_data.health_metrics` 구조

검진 데이터를 포함하는 JSONB 객체:
- 수치 필드: `height`, `weight`, `bmi`, `systolic_bp`, `diastolic_bp`, `fasting_glucose`, `total_cholesterol`, `hdl_cholesterol`, `ldl_cholesterol`, `hemoglobin`, `sgot_ast`, `sgpt_alt`, `gamma_gtp`, `creatinine`, `gfr` 등
- 상태 필드: `*_abnormal` 접미사 (예: `systolic_bp_abnormal: "경계"`)

---

## 5. 현재 데이터 현황 (2026-02-15 기준)

### 5.1 기본 통계

| 지표 | 값 |
|------|-----|
| 총 상담 세션 | 41건 |
| 태깅 완료 | 41건 (100%) |
| 미태깅 | 0건 |
| 태깅 모델 | 전부 gemini-2.0-flash-lite |
| 태깅 버전 | 전부 v2 |
| 파트너 | medilinx (단일) |
| 데이터 기간 | 2026-02-12 ~ 2026-02-14 |

### 5.2 분포 현황

**risk_level:**
| 값 | 건수 | 비율 |
|----|------|------|
| low | 16 | 39% |
| medium | 14 | 34% |
| high | 11 | 27% |

**sentiment:**
| 값 | 건수 | 비율 |
|----|------|------|
| neutral | 33 | 80% |
| worried | 8 | 20% |

**conversation_depth:**
| 값 | 건수 | 비율 |
|----|------|------|
| shallow | 34 | 83% |
| moderate | 6 | 15% |
| deep | 1 | 2% |

**action_intent:**
| 값 | 건수 | 비율 |
|----|------|------|
| passive | 28 | 68% |
| considering | 13 | 32% |
| active | 0 | 0% |

**data_quality_score 분포:**
| 범위 | 건수 |
|------|------|
| 0 (없음) | 6 |
| 26-50 (낮음) | 22 |
| 51-75 (보통) | 13 |

**follow_up_needed:**
| 값 | 건수 |
|----|------|
| true | 32 (78%) |
| false | 9 (22%) |

**engagement_score 분포:**
| 범위 | 건수 |
|------|------|
| 0 | 4 |
| 1-25 | 24 |
| 26-50 | 6 |
| 51-75 | 7 |

---

## 6. 마이그레이션 이력

| 순서 | 파일 | 내용 |
|------|------|------|
| 1 | `add_chat_session_tags.sql` | 기본 테이블 생성: id, session_id, partner_id, interest_tags, risk_tags, keyword_tags, sentiment, conversation_summary, data_quality_score, has_discrepancy, created_at, updated_at |
| 2 | `add_llm_tagging_columns.sql` | LLM 태깅 컬럼 추가: risk_level, key_concerns, follow_up_needed, tagging_model, tagging_version, counselor_recommendations |
| 3 | `add_tagging_matrix_columns.sql` | 태깅 매트릭스 고도화: conversation_depth, engagement_score, action_intent, nutrition_tags |

---

## 7. 일괄 재태깅 API

### `POST /api/v1/embedding-management/retag`

기존 세션을 일괄 재태깅합니다.

| 파라미터 | 타입 | 설명 |
|---------|------|------|
| hospital_id | string (optional) | 특정 병원만 재태깅 |
| force | boolean | true면 이미 LLM 태깅된 것도 재처리 |

- 태그 없는/규칙기반 세션만 대상 (force=false)
- 5건마다 1초 대기 (API rate limit)
- 실패 시 Slack 알림

---

## 8. 데이터 사이언스 활용 가이드

### 8.1 권장 분석 쿼리

**관심사 주제별 세션 수:**
```sql
SELECT elem->>'topic' AS topic,
       elem->>'intensity' AS intensity,
       COUNT(*) AS cnt
FROM welno.tb_chat_session_tags,
     jsonb_array_elements(interest_tags) elem
GROUP BY topic, intensity
ORDER BY cnt DESC;
```

**위험도별 감정 교차 분석:**
```sql
SELECT risk_level, sentiment, COUNT(*) AS cnt
FROM welno.tb_chat_session_tags
GROUP BY risk_level, sentiment
ORDER BY risk_level, cnt DESC;
```

**참여도 vs 행동 의향 상관관계:**
```sql
SELECT action_intent,
       AVG(engagement_score) AS avg_engagement,
       COUNT(*) AS cnt
FROM welno.tb_chat_session_tags
GROUP BY action_intent;
```

**데이터 품질 vs 위험도:**
```sql
SELECT risk_level,
       AVG(data_quality_score) AS avg_quality,
       COUNT(*) AS cnt
FROM welno.tb_chat_session_tags
GROUP BY risk_level;
```

**전체 JOIN (태그 + 원본 대화):**
```sql
SELECT l.session_id, l.hospital_id, l.message_count,
       l.initial_data->'health_metrics' AS health_metrics,
       l.conversation,
       t.interest_tags, t.risk_tags, t.keyword_tags,
       t.sentiment, t.risk_level, t.conversation_summary,
       t.data_quality_score, t.engagement_score,
       t.conversation_depth, t.action_intent,
       t.nutrition_tags, t.key_concerns,
       t.counselor_recommendations, t.follow_up_needed
FROM welno.tb_partner_rag_chat_log l
JOIN welno.tb_chat_session_tags t
  ON l.session_id = t.session_id AND l.partner_id = t.partner_id
ORDER BY l.created_at DESC;
```

### 8.2 엑셀 내보내기

백오피스 **검진결과 상담** 페이지에서 "엑셀" 버튼 클릭 시 다음 필드가 모두 포함됩니다:
- 날짜, 이름, 성별, 병원, 검진일, 연락처, 메시지수
- 관심사 (interest_tags), 위험태그 (risk_tags), 키워드 (keyword_tags)
- 감정 (sentiment), 대화요약 (conversation_summary), 데이터품질 (data_quality_score)

---

## 9. Semantic Tagging 시스템 (검진 수치 → 임상 의미)

검진 설계 프롬프트에서 사용하는 별도의 태깅 시스템입니다.

### 적용 항목 및 임상 기준

| 검사항목 | 정상 | 주의/경계 | 이상 | 위험 | 가이드라인 |
|---------|------|----------|------|------|-----------|
| 혈압(수축기) | <120 | 120-130 주의 / 130-140 고혈압1기 | 140-180 고혈압2기 | ≥180 위기 | 2022 대한고혈압학회 |
| 공복혈당 | <100 | 100-126 당뇨전단계 | 126-200 당뇨진단 | ≥200 고혈당 | 2025 당뇨병 진료지침 |
| 총콜레스테롤 | <200 | 200-240 경계 | ≥240 높음 | — | 2022 이상지질혈증 진료지침 |
| LDL콜레스테롤 | <100 | 100-130 경계 | 130-160 높음 | ≥160 매우높음 | 동일 |
| AST | <40 | 40-80 경도상승 | 80-200 중등도 | ≥200 고도 | — |
| ALT | <40 | 40-80 경도상승 | 80-200 중등도 | ≥200 고도 | — |
| 크레아티닌(남) | <1.2 | 1.2-2.0 저하의심 | ≥2.0 장애 | — | — |
| 크레아티닌(여) | <1.0 | 1.0-1.5 저하의심 | ≥1.5 장애 | — | — |
| 허리둘레(남) | <90 | 90-102 경계 | ≥102 비만 | — | — |
| 허리둘레(여) | <85 | 85-102 경계 | ≥102 비만 | — | — |

### 대사증후군 시너지 분석

5가지 대사 요인 (혈압, 혈당, 콜레스테롤, 허리둘레, 중성지방) 중:
- **3개 이상 이상** → 대사증후군 가능성 높음 (단독 위험 2-3배 증폭)
- **2개 이상** → 대사증후군 진행 가능성

---

## 10. 서베이 데이터 테이블

| 테이블 | 건수 | 용도 |
|--------|------|------|
| `welno.tb_hospital_survey_responses` | 81건 | 기본 설문 응답 (고정 문항) |
| `welno.tb_survey_responses_dynamic` | 0건 | 동적 설문 응답 (사용자 정의 문항) |

---

**문서 끝**
