# 검진 설계 프롬프트 코드 비교 분석 및 통합 방안

## 1. 코드 비교 분석

### 1.1 제공된 코드 (Untitled-1)의 특징

#### 장점
1. **Master DB 구조화**: 
   - `RISK_ANALYSIS_LOGIC_JSON`, `PROFILE_GUIDELINE_JSON`, `BRIDGE_STRATEGY_JSON`을 명확히 분리
   - `build_master_knowledge_section()` 함수로 공통 지식 섹션을 체계적으로 구성
   - 런타임 안정성을 위한 JSON 파싱 및 검증 로직 포함

2. **2단계 프로세스 명확화**:
   - STEP 1: 위험도 평가 전문가 (분석 전용)
   - STEP 2: 검진 설계 및 세일즈 큐레이터 (설계 전용)
   - 각 단계별로 명확한 역할과 출력 형식 정의

3. **시스템 메시지 분리**:
   - `CHECKUP_DESIGN_SYSTEM_MESSAGE_STEP1`: 위험도 평가 전문가 역할
   - `CHECKUP_DESIGN_SYSTEM_MESSAGE_STEP2`: 검진 설계 전문가 역할
   - 각 단계에 맞는 명확한 지시사항

4. **레거시 호환성 유지**:
   - `create_checkup_design_prompt_legacy()` 함수로 기존 코드와 호환성 유지
   - 점진적 마이그레이션 가능

#### 단점
1. **병원 검진 항목 구조 미반영**:
   - `hospital_national_checkup`의 카테고리 구분(일반/종합/옵션)을 명확히 설명하지 않음
   - 프롬프트에서 병원별 검진 항목의 실제 구조를 제대로 전달하지 않음

2. **데이터베이스 연동 부족**:
   - 실시간 데이터베이스의 병원별 추천 항목을 반영하는 로직이 없음
   - 병원 설정의 추가 추천 항목이 프롬프트에 제대로 포함되지 않음

3. **불완전한 구현**:
   - 일부 함수가 주석으로만 표시되어 있음 (예: `create_checkup_design_prompt_step2`의 일부 섹션)

### 1.2 기존 코드의 특징

#### 장점
1. **병원 검진 항목 구조 인식**:
   - `hospital_national_checkup`의 카테고리 구분(일반/종합/옵션)을 인식하고 있음
   - 프롬프트에서 카테고리별 우선순위 분류 규칙을 명시

2. **실제 데이터베이스 연동**:
   - `wello_data_service.get_hospital_by_id()`를 통해 실제 병원 데이터 조회
   - `external_checkup_items` 매핑 테이블을 통한 프리미엄 항목 조회

3. **완전한 구현**:
   - 모든 함수가 완전히 구현되어 있음
   - 실제 프로덕션 환경에서 사용 중

#### 단점
1. **Master DB 구조화 부족**:
   - Master DB 로직이 코드 내에 하드코딩되어 있음
   - JSON 파싱 및 검증 로직이 없음

2. **2단계 프로세스 불명확**:
   - STEP 1과 STEP 2의 역할 구분이 명확하지 않음
   - 시스템 메시지가 단일 버전으로만 존재

3. **코드 중복**:
   - 프롬프트 생성 로직이 여러 함수에 중복되어 있음
   - 유지보수 어려움

## 2. 핵심 문제점 분석

### 2.1 병원 검진 항목 카테고리 구분 문제

**현재 상황**:
- 데이터베이스에는 `national_checkup_items` 내부에 "일반", "종합", "옵션" 카테고리가 존재
- 프롬프트에서는 이 구분을 인식하고 있지만, **실제 데이터 구조를 명확히 전달하지 않음**

**문제 원인**:
1. `hospital_national_checkup` 데이터가 JSON으로 전달되지만, 카테고리별로 분류되어 전달되지 않음
2. GPT가 각 항목의 `category` 필드를 확인해야 하는데, 프롬프트에서 이를 명확히 지시하지 않음
3. 병원별로 다른 구조를 가질 수 있는데, 이를 고려하지 않음

**해결 방안**:
1. 병원 검진 항목을 카테고리별로 분류하여 프롬프트에 전달
2. 각 카테고리별 항목을 명확히 구분하여 표시
3. 프롬프트에서 카테고리별 우선순위 분류 규칙을 더 명확히 지시

### 2.2 실시간 데이터베이스 연동 문제

**현재 상황**:
- 병원 설정에 추가 추천 항목이 있지만, 프롬프트에 제대로 반영되지 않음
- `recommended_items`와 `external_checkup_items`가 분리되어 있지만, 통합적으로 활용되지 않음

**문제 원인**:
1. 병원별 추천 항목이 프롬프트에 포함되지만, 구조가 명확하지 않음
2. 실시간으로 변경되는 병원 설정이 프롬프트에 반영되지 않을 수 있음

**해결 방안**:
1. 병원 검진 항목을 카테고리별로 분류하여 프롬프트에 전달
2. 각 카테고리별 항목의 상세 정보를 포함
3. 실시간 데이터베이스 조회 결과를 프롬프트에 명확히 반영

## 3. 통합 방안

### 3.1 Master DB 구조 통합

**제공된 코드의 Master DB 구조를 기존 코드에 통합**:
1. `RISK_ANALYSIS_LOGIC_JSON`, `PROFILE_GUIDELINE_JSON`, `BRIDGE_STRATEGY_JSON`을 기존 코드에 추가
2. `build_master_knowledge_section()` 함수를 기존 코드에 통합
3. JSON 파싱 및 검증 로직 추가

### 3.2 병원 검진 항목 구조 개선

**병원 검진 항목을 카테고리별로 분류하여 프롬프트에 전달**:
1. `hospital_national_checkup`를 카테고리별로 분류 (일반/종합/옵션)
2. 각 카테고리별 항목을 명확히 구분하여 표시
3. 프롬프트에서 카테고리별 우선순위 분류 규칙을 더 명확히 지시

### 3.3 2단계 프로세스 명확화

**제공된 코드의 2단계 프로세스를 기존 코드에 통합**:
1. STEP 1: 위험도 평가 전문가 (분석 전용) - 기존 코드 유지
2. STEP 2: 검진 설계 및 세일즈 큐레이터 (설계 전용) - 제공된 코드 구조 적용
3. 각 단계별 시스템 메시지 분리

### 3.4 실시간 데이터베이스 연동 강화

**병원별 추천 항목을 실시간으로 반영**:
1. 병원 검진 항목 조회 시 카테고리별로 분류
2. 각 카테고리별 항목의 상세 정보를 프롬프트에 포함
3. 실시간 데이터베이스 조회 결과를 프롬프트에 명확히 반영

## 4. 구현 계획

### Phase 1: Master DB 구조 통합
- [ ] `RISK_ANALYSIS_LOGIC_JSON`, `PROFILE_GUIDELINE_JSON`, `BRIDGE_STRATEGY_JSON` 추가
- [ ] `build_master_knowledge_section()` 함수 통합
- [ ] JSON 파싱 및 검증 로직 추가

### Phase 2: 병원 검진 항목 구조 개선
- [ ] 병원 검진 항목을 카테고리별로 분류하는 함수 추가
- [ ] 프롬프트에 카테고리별 항목을 명확히 전달
- [ ] 카테고리별 우선순위 분류 규칙 명확화

### Phase 3: 2단계 프로세스 명확화
- [ ] STEP 1 시스템 메시지 분리
- [ ] STEP 2 시스템 메시지 분리
- [ ] 각 단계별 프롬프트 생성 함수 개선

### Phase 4: 실시간 데이터베이스 연동 강화
- [ ] 병원 검진 항목 조회 시 카테고리별 분류 로직 추가
- [ ] 프롬프트에 카테고리별 항목 상세 정보 포함
- [ ] 실시간 데이터베이스 조회 결과 검증

## 5. 예상 효과

1. **검진 설계 정확도 향상**: Master DB 구조화로 일관된 분석 및 설계 가능
2. **병원별 맞춤 설계**: 실시간 데이터베이스 연동으로 병원별 특화 검진 항목 반영
3. **코드 유지보수성 향상**: 구조화된 코드로 유지보수 용이
4. **확장성 향상**: 새로운 Master DB 항목 추가 시 확장 용이


