# 키 사용 현황 점검 문서
**작성일**: 2026-01-25  
**목적**: localStorage 및 세션 키 사용 일관성 점검 및 정리

---

## 1. 프론트엔드 localStorage 키 현황

### 1.1 STORAGE_KEYS에 정의된 키들

#### Tilko 세션 관련
- `TILKO_SESSION_ID` (`'tilko_session_id'`) - ✅ 사용 중
- `TILKO_SESSION_DATA` (`'tilko_session_data'`) - ✅ 사용 중
- `TILKO_AUTH_COMPLETED` (`'tilko_auth_completed'`) - ✅ 사용 중
- `TILKO_AUTH_REQUESTED` (`'tilko_auth_requested'`) - ✅ 사용 중
- `TILKO_COLLECTED_DATA` (`'tilko_collected_data'`) - ✅ 사용 중
- `TILKO_SELECTED_AUTH_TYPE` (`'tilko_selected_auth_type'`) - ✅ 사용 중
- `TILKO_TERMS_AGREED` (`'tilko_terms_agreed'`) - ✅ 사용 중

#### 환자 정보
- `PATIENT_UUID` (`'welno_patient_uuid'`) - ✅ 사용 중
- `HOSPITAL_ID` (`'welno_hospital_id'`) - ✅ 사용 중
- `PATIENT_NAME` (`'welno_patient_name'`) - ✅ 사용 중
- `PATIENT_BIRTH_DATE` (`'welno_patient_birth_date'`) - ✅ 사용 중

---

### 1.2 하드코딩된 키들 (STORAGE_KEYS에 없음) ⚠️

#### 문제 1: `'tilko_manual_collect'`
**사용처**: 10곳
- `useAuthFlow.ts`: 5곳 (removeItem)
- `AuthForm.tsx`: 5곳 (setItem 1, removeItem 4)
- `App.tsx`: 1곳 (정리 목록)

**용도**: 수동 데이터 수집 플래그

**문제점**: STORAGE_KEYS에 정의되지 않음

---

#### 문제 2: `'tilko_collecting_status'`
**사용처**: 9곳
- `useAuthFlow.ts`: 5곳 (removeItem)
- `AuthForm.tsx`: 1곳 (removeItem)
- `App.tsx`: 2곳 (정리 목록, getItem)
- `WelnoRagChatButton.tsx`: 1곳 (getItem)

**용도**: 데이터 수집 상태 플래그

**문제점**: STORAGE_KEYS에 정의되지 않음

---

#### 문제 3: `'tilko_auth_waiting'`
**사용처**: 10곳
- `useAuthFlow.ts`: 6곳 (setItem 1, removeItem 5)
- `AuthForm.tsx`: 3곳 (removeItem)
- `App.tsx`: 1곳 (정리 목록)

**용도**: 인증 대기 플래그

**문제점**: STORAGE_KEYS에 정의되지 않음

---

#### 문제 4: `'tilko_auth_method_selection'`
**사용처**: 8곳
- `useAuthFlow.ts`: 5곳 (removeItem)
- `App.tsx`: 3곳 (정리 목록, getItem, storage 이벤트)

**용도**: 인증 방식 선택 플래그

**문제점**: STORAGE_KEYS에 정의되지 않음

---

#### 문제 5: `'tilko_patient_uuid'` (레거시)
**사용처**: 5곳
- `MainPage.tsx`: 3곳 (getItem)
- `ResultsTrendPage.tsx`: 1곳 (getItem)
- `WelnoDataContext.tsx`: 1곳 (getItem)

**용도**: 환자 UUID (레거시)

**문제점**: 
- STORAGE_KEYS에는 `PATIENT_UUID` (`'welno_patient_uuid'`)가 있음
- 레거시 키 `'tilko_patient_uuid'`와 혼용됨

---

#### 문제 6: `'tilko_hospital_id'` (레거시)
**사용처**: 5곳
- `MainPage.tsx`: 3곳 (getItem)
- `ResultsTrendPage.tsx`: 1곳 (getItem)
- `WelnoDataContext.tsx`: 1곳 (getItem)

**용도**: 병원 ID (레거시)

**문제점**: 
- STORAGE_KEYS에는 `HOSPITAL_ID` (`'welno_hospital_id'`)가 있음
- 레거시 키 `'tilko_hospital_id'`와 혼용됨

---

## 2. 백엔드 세션 키 현황

### 2.1 기본 세션 구조 (redis_session_manager.py)

**기본 키들**:
```python
{
    "session_id": str,
    "user_info": dict,
    "status": str,
    "created_at": str,
    "updated_at": str,
    "expires_at": str,
    "last_activity": str,
    "auth_data": dict | None,
    "health_data": dict | None,
    "prescription_data": dict | None,
    "progress": {
        "auth_requested": bool,
        "auth_completed": bool,
        "health_data_fetched": bool,
        "prescription_data_fetched": bool,
        "completed": bool
    },
    "messages": list
}
```

---

### 2.2 추가된 커스텀 키들 (tilko_auth.py)

#### 새로 추가된 키들 (2026-01-25)
- `redirect_path` - 진입 경로 (`/disease-report` 등)
- `terms_agreed` - 약관 동의 여부 (bool)
- `terms_agreed_at` - 약관 동의 시각 (ISO string)
- `terms_expires_at` - 약관 만료 시각 (ISO string)

**사용처**:
- 세션 생성 시 저장: `tilko_auth.py:223-231`
- 진입 경로 확인: `tilko_auth.py:1516`
- 약관 DB 저장: `tilko_auth.py:1894, 1907`

---

#### 기존 커스텀 키들
- `patient_uuid` - 환자 UUID
- `hospital_id` - 병원 ID
- `oid` - 캠페인 주문번호
- `temp_auth_data` - 임시 인증 데이터
- `collection_started` - 수집 시작 플래그
- `collection_completed` - 수집 완료 플래그
- `collection_end_time` - 수집 종료 시각

**사용처**: 128곳 (tilko_auth.py 전체)

---

## 3. 문제점 요약

### 3.1 프론트엔드
1. **하드코딩된 키 6개**: STORAGE_KEYS에 정의되지 않음
2. **레거시 키 혼용**: `tilko_patient_uuid` vs `welno_patient_uuid`
3. **일관성 부족**: 같은 용도의 키가 여러 이름으로 사용됨

### 3.2 백엔드
1. **세션 키 문서화 부족**: 커스텀 키들이 어디서 추가되는지 명확하지 않음
2. **키 접근 패턴 혼용**: `.get()` vs 직접 접근

---

## 4. 정리 우선순위

### 우선순위 1: 하드코딩 키 상수화
1. `tilko_manual_collect` → `STORAGE_KEYS.TILKO_MANUAL_COLLECT`
2. `tilko_collecting_status` → `STORAGE_KEYS.TILKO_COLLECTING_STATUS`
3. `tilko_auth_waiting` → `STORAGE_KEYS.TILKO_AUTH_WAITING`
4. `tilko_auth_method_selection` → `STORAGE_KEYS.TILKO_AUTH_METHOD_SELECTION`

### 우선순위 2: 레거시 키 마이그레이션
1. `tilko_patient_uuid` → `welno_patient_uuid` (STORAGE_KEYS.PATIENT_UUID)
2. `tilko_hospital_id` → `welno_hospital_id` (STORAGE_KEYS.HOSPITAL_ID)

### 우선순위 3: 백엔드 세션 키 문서화
1. 세션 키 타입 정의 추가
2. 커스텀 키 추가 위치 명확화

---

## 5. 정리 계획

### Phase 1: STORAGE_KEYS 확장
- 누락된 키 4개 추가
- 레거시 키 마이그레이션 가이드 작성

### Phase 2: 하드코딩 키 교체
- 각 파일별로 하나씩 교체
- 테스트 후 다음 파일로 진행

### Phase 3: 레거시 키 마이그레이션
- 읽기 시 양쪽 키 모두 확인 (하위 호환)
- 쓰기 시 새 키만 사용
- 점진적 마이그레이션

### Phase 4: 백엔드 세션 키 정리
- 세션 키 타입 정의
- 커스텀 키 추가 헬퍼 함수

---

## 6. 파일별 정리 대상

### 프론트엔드
1. `storage.ts` - STORAGE_KEYS 확장
2. `useAuthFlow.ts` - 하드코딩 키 5개 교체
3. `AuthForm.tsx` - 하드코딩 키 3개 교체
4. `App.tsx` - 정리 로직 상수화
5. `MainPage.tsx` - 레거시 키 마이그레이션 (3곳)
6. `ResultsTrendPage.tsx` - 레거시 키 마이그레이션 (1곳)
7. `WelnoDataContext.tsx` - 레거시 키 마이그레이션 (1곳)
8. `WelnoRagChatButton.tsx` - 하드코딩 키 교체 (1곳)

### 백엔드
1. `redis_session_manager.py` - 세션 구조 문서화
2. `tilko_auth.py` - 세션 키 접근 패턴 통일 (선택적)

---

## 7. 검증 체크리스트

- [ ] 모든 하드코딩 키가 STORAGE_KEYS로 교체됨
- [ ] 레거시 키 읽기 시 하위 호환성 유지
- [ ] 레거시 키 쓰기 시 새 키 사용
- [ ] App.tsx 정리 로직이 상수 사용
- [ ] 세션 키 문서화 완료
