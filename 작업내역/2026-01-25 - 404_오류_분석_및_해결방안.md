# 404 오류 분석 및 해결방안
**작성일**: 2026-01-25  
**문제**: `/api/v1/welno/patients/{uuid}` 및 `/api/v1/welno/patient-health-data` 404 오류 반복 발생

---

## 🔍 문제 현상

### 로그 분석
```
✅ [IndexedDB] 건강 데이터 조회 완료: 9f323028-a630-4e55-85f6-29bdfdd09894
❌ GET /api/v1/welno/patients/9f323028-a630-4e55-85f6-29bdfdd09894 → 404
❌ GET /api/v1/welno/patient-health-data?uuid=...&hospital_id=PEERNINE → 404
⚠️ [동기화] 서버 데이터 조회 실패: 404
```

### 특징
1. **IndexedDB에는 데이터 존재**: 로컬 캐시에 환자 데이터가 있음
2. **서버에는 데이터 없음**: DB에 환자 정보가 아직 저장되지 않음
3. **반복 호출**: 동일한 API가 여러 번 호출됨

---

## 📊 원인 분석

### 1. 데이터 저장 시점 불일치

**현재 플로우**:
```
Tilko 데이터 수집 완료
  ↓
IndexedDB 저장 (즉시) ← ✅ 여기서는 성공
  ↓
파일 시스템 저장 (백엔드)
  ↓
PostgreSQL 저장 (비동기) ← ⚠️ 여기서 지연 가능
  ↓
API 조회 가능
```

**문제점**:
- 프론트엔드는 IndexedDB에 즉시 저장
- 백엔드는 파일 → DB 저장이 비동기로 처리되어 지연 가능
- 이 사이에 API 호출 시 404 발생

### 2. 코드 분석

#### `WelnoDataContext.tsx:274-289` - 동기화 함수
```typescript
const syncIndexedDBWithServer = useCallback(async (uuid: string, hospitalId: string) => {
  // ...
  const response = await fetch(API_ENDPOINTS.HEALTH_DATA(uuid, hospitalId));
  if (!response.ok) {
    console.warn('[동기화] 서버 데이터 조회 실패:', response.status); // ⚠️ 404도 여기서 처리
    return; // 조용히 종료
  }
  // ...
}, []);
```

**문제점**:
- 404를 경고로 처리하지만, 실제로는 **정상적인 상태**일 수 있음
- IndexedDB에만 있고 서버에는 아직 없는 경우가 정상

#### `WelnoDataContext.tsx:664-681` - loadPatientData
```typescript
if (!patientResponse.ok) {
  if (patientResponse.status === 404) {
    // 404는 정상 상태 (데이터 없음)
    console.log('[환자 API] 데이터 없음 (새 사용자):', { uuid: cleanUuid, hospital: cleanHospital });
    patientData = null;
    rawPatientData = null;
  } else {
    // 실제 에러 처리
    throw new Error(`환자 정보 조회 실패: ${patientResponse.status}`);
  }
}
```

**현재 처리**:
- ✅ `loadPatientData`에서는 404를 정상 상태로 처리
- ⚠️ `syncIndexedDBWithServer`에서는 경고로 처리

### 3. 백엔드 응답 분석

#### `welno_data_service.py:856-879`
```python
async def get_patient_health_data(self, uuid: str, hospital_id: str) -> Dict[str, Any]:
    # UUID + hospital_id로 조회
    patient_row = await conn.fetchrow(patient_query, uuid, hospital_id)
    
    # 없으면 UUID만으로 재시도
    if not patient_row:
        patient_row = await conn.fetchrow(patient_query_uuid_only, uuid)
    
    if not patient_row:
        return {"error": "환자를 찾을 수 없습니다"}  # ← 이게 404로 변환됨
```

#### `welno_data.py:75-76`
```python
if "error" in result:
    raise HTTPException(status_code=404, detail=result["error"])
```

**404 발생 조건**:
1. `welno_patients` 테이블에 해당 UUID + hospital_id 조합이 없음
2. UUID만으로도 찾을 수 없음

---

## ✅ 해결 방안

### 방안 1: 404를 정상 상태로 명확히 처리 (권장)

**목적**: IndexedDB에만 있고 서버에는 아직 없는 경우를 정상 상태로 처리

**변경 사항**:
```typescript
// WelnoDataContext.tsx:274-289
const syncIndexedDBWithServer = useCallback(async (uuid: string, hospitalId: string) => {
  try {
    console.log('[동기화] 시작:', { uuid, hospitalId });
    
    // 1. IndexedDB 데이터 확인
    const { WelnoIndexedDB } = await import('../services/WelnoIndexedDB');
    const indexedData = await WelnoIndexedDB.getHealthData(uuid);
    
    // 2. 서버 DB 데이터 확인
    const response = await fetch(API_ENDPOINTS.HEALTH_DATA(uuid, hospitalId));
    
    if (response.status === 404) {
      // ✅ 404는 정상 상태 (IndexedDB에만 있고 서버에는 아직 없음)
      console.log('[동기화] 서버에 데이터 없음 (IndexedDB만 존재, 정상 상태):', { uuid, hospitalId });
      return; // 조용히 종료 (에러 아님)
    }
    
    if (!response.ok) {
      // 404가 아닌 다른 에러만 경고
      console.warn('[동기화] 서버 데이터 조회 실패:', response.status);
      return;
    }
    
    // 정상 응답 처리
    // ...
  } catch (error) {
    console.error('[동기화] 오류:', error);
  }
}, []);
```

**효과**:
- 불필요한 경고 로그 제거
- 404를 정상 상태로 명확히 처리
- 사용자 경험 개선 (에러처럼 보이지 않음)

---

### 방안 2: 재시도 로직 추가 (선택적)

**목적**: 서버 저장이 완료될 때까지 재시도

**변경 사항**:
```typescript
const syncIndexedDBWithServer = useCallback(async (uuid: string, hospitalId: string) => {
  const maxRetries = 3;
  const retryDelay = 2000; // 2초
  
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    const response = await fetch(API_ENDPOINTS.HEALTH_DATA(uuid, hospitalId));
    
    if (response.ok) {
      // 성공 시 처리
      break;
    }
    
    if (response.status === 404 && attempt < maxRetries - 1) {
      // 404이고 재시도 가능하면 대기 후 재시도
      console.log(`[동기화] 서버 데이터 없음, 재시도 ${attempt + 1}/${maxRetries}...`);
      await new Promise(resolve => setTimeout(resolve, retryDelay));
      continue;
    }
    
    // 최종 실패 또는 다른 에러
    if (response.status === 404) {
      console.log('[동기화] 서버에 데이터 없음 (IndexedDB만 존재, 정상 상태)');
    } else {
      console.warn('[동기화] 서버 데이터 조회 실패:', response.status);
    }
    return;
  }
}, []);
```

**효과**:
- 서버 저장 지연 시 자동으로 재시도
- 사용자 경험 개선 (자동 동기화)

**단점**:
- 불필요한 네트워크 요청 증가 가능
- 서버 부하 증가

---

### 방안 3: 로그 레벨 조정 (간단)

**목적**: 404를 정보 로그로 변경

**변경 사항**:
```typescript
if (!response.ok) {
  if (response.status === 404) {
    // ✅ 경고 → 정보로 변경
    console.log('[동기화] 서버 데이터 없음 (IndexedDB만 존재):', response.status);
  } else {
    console.warn('[동기화] 서버 데이터 조회 실패:', response.status);
  }
  return;
}
```

**효과**:
- 간단한 수정으로 로그 레벨 조정
- 경고처럼 보이지 않음

---

## 🎯 권장 사항

### 즉시 적용: 방안 1 (404를 정상 상태로 명확히 처리)

**이유**:
1. **현재 상황이 정상**: IndexedDB에만 있고 서버에는 아직 없는 것은 정상적인 상태
2. **사용자 경험**: 에러처럼 보이지 않음
3. **코드 명확성**: 의도가 명확해짐

### 추가 고려: 방안 2 (재시도 로직)

**조건**:
- 서버 저장이 자주 지연되는 경우
- 사용자가 즉시 서버 데이터를 필요로 하는 경우

**주의사항**:
- 재시도 횟수와 간격을 적절히 설정
- 서버 부하 고려

---

## 📝 구현 체크리스트

- [ ] `WelnoDataContext.tsx`의 `syncIndexedDBWithServer` 함수 수정
  - [ ] 404를 정상 상태로 처리
  - [ ] 로그 레벨 조정 (경고 → 정보)
- [ ] (선택) 재시도 로직 추가
  - [ ] 최대 재시도 횟수 설정
  - [ ] 재시도 간격 설정
- [ ] 테스트
  - [ ] IndexedDB에만 있는 경우 정상 동작 확인
  - [ ] 서버에 데이터가 있는 경우 정상 동작 확인
  - [ ] 실제 에러(500 등)는 여전히 경고로 처리되는지 확인

---

## 🔗 관련 파일

- `planning-platform/frontend/src/contexts/WelnoDataContext.tsx`
  - `syncIndexedDBWithServer` 함수 (line 274-289)
  - `loadPatientData` 함수 (line 444-796)
- `planning-platform/backend/app/api/v1/endpoints/welno_data.py`
  - `/patients/{uuid}` 엔드포인트 (line 238-253)
  - `/patient-health-data` 엔드포인트 (line 54-76)
- `planning-platform/backend/app/services/welno_data_service.py`
  - `get_patient_health_data` 함수 (line 856-996)

---

## 💡 결론

**현재 404 오류는 정상적인 상태**입니다:
- IndexedDB에는 데이터가 있음 (Tilko 수집 완료)
- 서버에는 아직 저장되지 않음 (비동기 처리 지연)
- 프론트엔드는 IndexedDB 데이터로 정상 동작 가능

**개선 방향**:
- 404를 에러가 아닌 정상 상태로 명확히 처리
- 로그 레벨 조정으로 불필요한 경고 제거
- 필요 시 재시도 로직 추가 고려
