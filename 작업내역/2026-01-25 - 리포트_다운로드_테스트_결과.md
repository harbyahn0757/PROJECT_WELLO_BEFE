# 리포트 다운로드 기능 테스트 결과
**작성일**: 2026-01-25  
**목적**: 백엔드 프록시 API를 통한 리포트 다운로드 기능 테스트

---

## 📋 테스트 개요

### 구현된 기능
1. ✅ 백엔드 프록시 API (접근 제어 포함)
   - WELNO 케이스: `/api/v1/welno/mediarc-report/download`
   - 파트너 케이스: `/api/v1/campaigns/disease-prediction/report/download`
2. ✅ 프론트엔드 다운로드 로직 개선
   - 백엔드 프록시를 주된 방법으로 사용
   - 명확한 에러 메시지 제공

---

## 🧪 테스트 결과

### 1. DB 데이터 확인 ✅
```bash
python3 scripts/check_mediarc_reports.py
```

**결과:**
- 리포트 1건 확인
- patient_uuid: `c254eba4-aa34-4ef6-be70-59cc2f842e02`
- hospital_id: `PEERNINE`
- report_url: NCloud Storage Presigned URL (591자)
- ✅ 리포트 데이터 정상

### 2. 백엔드 API 엔드포인트 확인 ✅

**라우터 등록 확인:**
```python
# welno_data.py에 엔드포인트 정의됨
@router.get("/mediarc-report/download")
```

**라우터 등록 상태:**
- ✅ `/mediarc-report/download` 경로 등록 확인
- ✅ main.py에서 welno_data.router 등록 확인

### 3. API 호출 테스트 ⚠️

**테스트 스크립트:**
```bash
python3 scripts/test_report_download.py
```

**결과:**
- ❌ HTTP 404 Not Found
- **원인**: 서버가 재시작되지 않아 새로 추가한 엔드포인트가 반영되지 않음

**확인 사항:**
- ✅ 다른 welno 엔드포인트는 정상 작동 (`/api/v1/welno/mediarc-report`)
- ✅ uvicorn 서버 실행 중 (포트 8082)
- ⚠️ 서버 재시작 필요

---

## 🔧 해결 방법

### 서버 재시작 필요

**방법 1: PM2 사용 (권장)**
```bash
cd /home/workspace/PROJECT_WELNO_BEFE/planning-platform/backend
pm2 restart wello-backend
# 또는
pm2 restart all
```

**방법 2: 수동 재시작**
```bash
# 현재 프로세스 종료
pkill -f "uvicorn app.main:app"

# 재시작
cd /home/workspace/PROJECT_WELNO_BEFE/planning-platform/backend
./scripts/backend/start_wello.sh
```

**방법 3: --reload 옵션 확인**
- uvicorn이 `--reload` 옵션으로 실행 중이면 자동 재시작되어야 함
- 현재 실행 중인 프로세스 확인:
  ```bash
  ps aux | grep uvicorn
  ```

---

## 📝 테스트 체크리스트

### 백엔드 테스트
- [ ] 서버 재시작 후 API 엔드포인트 접근 가능 확인
- [ ] 정상 케이스: 올바른 uuid + hospital_id로 다운로드 성공
- [ ] 접근 제어: 다른 사용자의 uuid로 요청 시 403 에러
- [ ] 리포트 없음: 존재하지 않는 uuid로 요청 시 404 에러
- [ ] URL 만료: 만료된 Presigned URL 처리 확인

### 프론트엔드 테스트
- [ ] 다운로드 버튼 클릭 시 백엔드 프록시 API 호출
- [ ] 다운로드 성공 시 PDF 파일 다운로드 확인
- [ ] 에러 발생 시 명확한 에러 메시지 표시
- [ ] 파트너 케이스 (oid) 다운로드 테스트
- [ ] WELNO 케이스 (uuid + hospital_id) 다운로드 테스트

---

## 🎯 다음 단계

1. **서버 재시작**
   - PM2 또는 수동으로 서버 재시작
   - 새로 추가한 엔드포인트 반영 확인

2. **API 테스트 재실행**
   ```bash
   python3 scripts/test_report_download.py
   ```

3. **프론트엔드 통합 테스트**
   - 브라우저에서 리포트 페이지 접속
   - 다운로드 버튼 클릭
   - 브라우저 콘솔에서 로그 확인

4. **접근 제어 테스트**
   - 다른 사용자의 uuid로 다운로드 시도
   - 403 에러 확인

---

## 📊 구현 완료 사항

### 백엔드
- ✅ 다운로드 프록시 API 구현
- ✅ 접근 제어 (JWT 토큰 검증, UUID 소유권 확인)
- ✅ 에러 처리 (403, 404, 410 등)
- ✅ URL 만료 처리

### 프론트엔드
- ✅ 백엔드 프록시를 주된 방법으로 사용
- ✅ 명확한 에러 메시지 제공
- ✅ 파트너/WELNO 케이스 모두 지원

---

## ⚠️ 주의사항

1. **서버 재시작 필수**
   - 새로 추가한 엔드포인트가 반영되려면 서버 재시작 필요

2. **접근 제어**
   - JWT 토큰이 있으면 토큰의 uuid와 요청 uuid 일치 확인
   - 토큰이 없으면 DB에서 환자 정보 확인 (약한 인증)

3. **프로덕션 환경**
   - 프로덕션에서는 HTTPS 사용 필수
   - CORS 설정 확인 필요

---

## 📚 관련 파일

- 백엔드 API: `planning-platform/backend/app/api/v1/endpoints/welno_data.py`
- 프론트엔드: `planning-platform/frontend/src/features/disease-report/pages/DiseaseReportPage.tsx`
- 테스트 스크립트: `scripts/test_report_download.py`
- DB 확인 스크립트: `scripts/check_mediarc_reports.py`
