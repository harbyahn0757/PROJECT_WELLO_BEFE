# 플로우 개선 상세 구현 계획
**작성일**: 2026-01-25  
**목적**: 진입 경로별 최적화된 화면 전환 및 토스트 알림

---

## ✅ 발견 사항

### 1. 매트릭스 상태 시스템 **이미 존재!**

**백엔드 상태**:
```python
# welno_unified_status.py
ACTION_REQUIRED    # 데이터 부족
PAYMENT_REQUIRED   # 결제 필요
REPORT_PENDING     # 리포트 생성 중 ⭐
REPORT_READY       # 리포트 완료
REPORT_EXPIRED     # 리포트 만료
```

**프론트 스피너**:
```typescript
// DiseaseReportPage.tsx:1357
if (unifiedStatus?.status === 'REPORT_PENDING') {
  return (
    <div className="loading-spinner">
      <div className="spinner"></div>
      <p>질병예측 리포트를 생성하는 중입니다...</p>
      <p>리포트 생성에는 약 2-3분이 소요됩니다.</p>
    </div>
  );
}
```

### 2. 토스트 알림 시스템 있음!

**사용법**:
```typescript
// WelnoDataContext
actions.addNotification({
  type: 'success',  // success | error | warning | info
  title: '제목',
  message: '내용'
});
```

### 3. 세션 매니저 구조

**Redis 기반**: `RedisSessionManager` (30분 TTL)
```python
session_data = {
    "session_id": session_id,
    "user_info": {...},
    "status": "initiated",
    "auth_data": None,
    "health_data": None,
    "prescription_data": None,
    "progress": {...},
    "messages": [...]
}
```

**메서드**:
- `get_session(session_id)`: 세션 조회
- `update_session_status(session_id, status, message)`: 상태 업데이트
- `update_health_data()`, `update_auth_data()` 등

**결론**: 세션에 **어떤 데이터든 저장 가능!** (redirect, terms_agreed 등)

---

## 🎯 화면 전환 전략 (진입 경로별)

### Case 1: 추이보기 (일반 Tilko)
```
[AuthForm]
검진 데이터 수집 완료
  ↓
즉시 화면 전환 → /results-trend ← ✅
토스트: "검진 데이터 수집 완료! 추이보기 화면으로 이동합니다."
  ↓
[ResultsTrendPage]
처방전 수집 중... (백그라운드)
  ↓
처방전 완료
토스트: "처방전 데이터도 수집되었습니다!" ← ✅
```

**특징**:
- 검진 완료 시 **즉시 이동** (기존 로직 활용)
- 비밀번호는 나중에 (추이보기에서)
- Mediarc는 조용히 백그라운드

### Case 2: 질병예측리포트 (캠페인/매트릭스) ⭐
```
[AuthForm]
검진 데이터 수집 완료
토스트: "검진 데이터 수집 완료!" ← ✅
스피너 유지 (화면 이동 안함!)
  ↓
Mediarc 생성 시작
토스트: "질병예측 리포트를 생성하고 있습니다..." ← ✅
  ↓
Mediarc 완료
토스트: "리포트 생성 완료!" ← ✅
비밀번호 모달 표시
  ↓
[사용자] 비밀번호 설정
  ↓
화면 전환 → /disease-report ← ✅
  ↓
[DiseaseReportPage]
매트릭스 상태: REPORT_READY → 리포트 표시
  ↓
처방전 완료 (백그라운드)
토스트: "처방전 데이터도 수집되었습니다!" ← ✅
```

**특징**:
- 검진 완료 시 **화면 이동 안함** (AuthForm에 머묾)
- Mediarc 완료까지 대기 (스피너 + 토스트)
- 비밀번호 → 리포트 페이지 이동

---

## 📋 구현 계획 (상세)

### Phase 1: 세션에 진입 경로 및 약관 저장

**백엔드**: `tilko_auth.py` - 세션 생성 시

**현재 세션 구조**:
```python
# redis_session_manager.py:42
session_data = {
    "session_id": session_id,
    "user_info": {...},
    "status": "initiated",
    "auth_data": None,
    "health_data": None,
    "prescription_data": None,
    # ✅ 이 외에도 커스텀 필드 추가 가능!
}
```

**수정**: 세션 생성 시 추가 데이터 저장
```python
# tilko_auth.py: 세션 생성 로직 찾아서 수정
session_data = session_manager.get_session(session_id) or {}

# ✅ 진입 경로 및 약관 데이터 추가
session_data["redirect_path"] = request.redirect or request.return_to  # /disease-report 또는 None
session_data["terms_agreed"] = request.terms_agreed if hasattr(request, 'terms_agreed') else None
session_data["terms_agreed_at"] = request.terms_agreed_at if hasattr(request, 'terms_agreed_at') else None

session_manager._save_session(session_id, session_data)
```

---

### Phase 2: 건강검진 완료 시 진입 경로별 분기

**위치**: `tilko_auth.py:1476` (health_data_completed)

```python
# ✅ 건강검진 완료 알림
await notify_streaming_status(
    session_id,
    "health_data_completed",
    health_success_message,
    {
        "count": health_count,
        "patient_uuid": patient_uuid,
        "hospital_id": hospital_id
    }
)

# ✅ 진입 경로 확인
session_data = session_manager.get_session(session_id)
redirect_path = session_data.get("redirect_path", "")
is_disease_report = 'disease-report' in redirect_path

if is_disease_report:
    # Case 2: 질병예측리포트 - Mediarc 생성 시작
    print(f"🎨 [플로우] 질병예측리포트 케이스 - Mediarc 생성 시작")
    
    # Mediarc 생성 백그라운드 시작
    import asyncio
    from app.services.mediarc import generate_mediarc_report_async
    
    asyncio.create_task(
        _generate_mediarc_with_notification(
            patient_uuid=patient_uuid,
            hospital_id=hospital_id,
            session_id=session_id,
            service=welno_service
        )
    )
else:
    # Case 1: 추이보기 - 화면 전환만 (Mediarc는 나중에)
    print(f"📊 [플로우] 추이보기 케이스 - 화면 전환 알림만")
    # 추가 처리 없음 (기존 로직)
```

**Mediarc 생성 헬퍼 함수** (새로 추가):
```python
async def _generate_mediarc_with_notification(
    patient_uuid: str,
    hospital_id: str,
    session_id: str,
    service
):
    """Mediarc 생성 및 WebSocket 알림"""
    try:
        # 생성 시작 알림
        await notify_streaming_status(
            session_id,
            "mediarc_generating",
            "질병예측 리포트를 생성하고 있습니다...",
            {"patient_uuid": patient_uuid}
        )
        
        # Mediarc 생성 (await - 완료까지 대기)
        result = await generate_mediarc_report_async(
            patient_uuid=patient_uuid,
            hospital_id=hospital_id,
            session_id=session_id,
            service=service
        )
        
        if result.get("success"):
            # 성공 알림 + 비밀번호 모달 트리거
            await notify_streaming_status(
                session_id,
                "mediarc_completed_password_ready",
                "리포트 생성 완료!",
                {
                    "patient_uuid": patient_uuid,
                    "hospital_id": hospital_id,
                    "report_url": result.get("report_url")
                }
            )
            print(f"✅ [Mediarc] 생성 완료 및 비밀번호 모달 트리거")
        else:
            # 실패 알림
            await notify_streaming_status(
                session_id,
                "mediarc_failed",
                f"리포트 생성 실패: {result.get('error')}",
                {"error": result.get("error")}
            )
            print(f"❌ [Mediarc] 생성 실패")
            
    except Exception as e:
        print(f"❌ [Mediarc] 예외 발생: {e}")
        await notify_streaming_status(
            session_id,
            "mediarc_failed",
            f"리포트 생성 중 오류: {str(e)}",
            {"error": str(e)}
        )
```

---

### Phase 3: UUID 생성 후 약관 DB 저장

**위치**: `tilko_auth.py:1827` (UUID 생성 직후)

```python
new_uuid = str(uuid_lib.uuid4())

# 환자 정보 저장
patient_id = await welno_service.save_patient_data(
    uuid=new_uuid,
    hospital_id=hospital_id,
    user_info=user_info_for_save,
    session_id=session_id
)

# ✅ 약관 데이터 DB 저장
session_data = session_manager.get_session(session_id)
if session_data and session_data.get("terms_agreed"):
    try:
        import asyncpg
        from app.core.config import settings
        
        conn = await asyncpg.connect(
            host=settings.DB_HOST if hasattr(settings, 'DB_HOST') else '10.0.1.10',
            port=settings.DB_PORT if hasattr(settings, 'DB_PORT') else 5432,
            database=settings.DB_NAME if hasattr(settings, 'DB_NAME') else 'p9_mkt_biz',
            user=settings.DB_USER if hasattr(settings, 'DB_USER') else 'peernine',
            password=settings.DB_PASSWORD if hasattr(settings, 'DB_PASSWORD') else 'autumn3334!'
        )
        
        await conn.execute("""
            INSERT INTO welno.tb_wello_terms_agreement (
                patient_uuid, hospital_id, agreed, agreed_at, expires_at
            ) VALUES ($1, $2, $3, $4, $5)
            ON CONFLICT (patient_uuid, hospital_id) DO UPDATE SET
                agreed = EXCLUDED.agreed,
                agreed_at = EXCLUDED.agreed_at,
                expires_at = EXCLUDED.expires_at,
                updated_at = NOW()
        """, 
            new_uuid, hospital_id, 
            True,
            session_data.get("terms_agreed_at"),
            session_data.get("terms_expires_at")
        )
        
        await conn.close()
        print(f"✅ [약관] DB 저장 완료: {new_uuid}")
    except Exception as e:
        print(f"⚠️ [약관] DB 저장 실패 (계속 진행): {e}")
```

---

### Phase 4: 프론트 진입 경로별 처리

**위치**: `AuthForm.tsx:514` (health_data_completed)

**현재 로직** (추이보기용 - 유지):
```typescript
if (type === 'health_data_completed') {
  console.log('✅ [health_data_completed] 검진 데이터 확보 완료 → 즉시 화면 전환');
  
  const uuid = StorageManager.getItem(STORAGE_KEYS.PATIENT_UUID);
  const hospital = StorageManager.getItem(STORAGE_KEYS.HOSPITAL_ID);
  const sessionId = authFlow.state.sessionId;
  
  if (uuid && hospital && sessionId) {
    // 추이보기로 즉시 이동
    navigate(`/results-trend?uuid=${uuid}&hospital=${hospital}&sessionId=${sessionId}`, { 
      replace: true 
    });
  }
}
```

**수정**: 진입 경로 체크 추가
```typescript
if (type === 'health_data_completed') {
  console.log('✅ [health_data_completed] 검진 데이터 완료');
  
  // WebSocket 데이터에서 UUID 받기
  const uuid = data?.patient_uuid || StorageManager.getItem(STORAGE_KEYS.PATIENT_UUID);
  const hospital = data?.hospital_id || StorageManager.getItem(STORAGE_KEYS.HOSPITAL_ID);
  const sessionId = authFlow.state.sessionId;
  
  // 진입 경로 확인
  const urlParams = new URLSearchParams(location.search);
  const redirectParam = urlParams.get('redirect');
  const isDiseaseReport = redirectParam === '/disease-report';
  
  if (isDiseaseReport) {
    // Case 2: 질병예측리포트 - 화면 이동 안함, Mediarc 대기
    console.log('🎨 [질병예측리포트] Mediarc 생성 대기 중...');
    
    // 토스트 표시
    actions.addNotification({
      type: 'success',
      title: '검진 데이터 수집 완료',
      message: '질병예측 리포트를 생성하고 있습니다...'
    });
    
    setStatusMessage('질병예측 리포트를 생성하고 있습니다...');
    setIsCollecting(true); // 스피너 유지
    
  } else {
    // Case 1: 추이보기 - 즉시 화면 전환 (기존)
    console.log('📊 [추이보기] 즉시 화면 전환');
    
    // 토스트 표시
    actions.addNotification({
      type: 'success',
      title: '검진 데이터 수집 완료',
      message: '추이보기 화면으로 이동합니다.'
    });
    
    if (uuid && hospital && sessionId) {
      navigate(`/results-trend?uuid=${uuid}&hospital=${hospital}&sessionId=${sessionId}`, { 
        replace: true 
      });
    }
  }
  
  return;
}
```

**Mediarc 완료 핸들러** (새로 추가):
```typescript
// mediarc_completed_password_ready 이벤트
if (type === 'mediarc_completed_password_ready') {
  console.log('✅ [Mediarc 완료] 비밀번호 모달 표시');
  
  const uuid = data?.patient_uuid;
  const hospital = data?.hospital_id;
  
  // 토스트 표시
  actions.addNotification({
    type: 'success',
    title: '리포트 생성 완료',
    message: '비밀번호를 설정해주세요.'
  });
  
  setIsCollecting(false); // 스피너 중지
  setPasswordSetupData({ 
    uuid, 
    hospital,
    type: 'setup'
  });
  setShowPasswordSetupModal(true);
  
  return;
}

// mediarc_failed 이벤트
if (type === 'mediarc_failed') {
  console.log('❌ [Mediarc 실패] 메인 페이지로 이동');
  
  // 토스트 표시
  actions.addNotification({
    type: 'error',
    title: '리포트 생성 실패',
    message: data?.error || '리포트 생성 중 오류가 발생했습니다.'
  });
  
  setIsCollecting(false);
  
  // 3초 후 메인으로
  setTimeout(() => {
    navigate('/', { replace: true });
  }, 3000);
  
  return;
}
```

---

### Phase 5: 처방전 완료 시 토스트 알림

**위치**: 처방전 완료 시점

**백엔드**: `tilko_auth.py` (처방전 수집 완료)
```python
# 처방전 완료 알림
await notify_streaming_status(
    session_id,
    "prescription_completed",  # ← 새 이벤트
    f"처방전 데이터 {prescription_count}건 수집했습니다.",
    {
        "count": prescription_count,
        "patient_uuid": patient_uuid,
        "hospital_id": hospital_id
    }
)
```

**프론트**: `AuthForm.tsx` + `ResultsTrendPage`/`DiseaseReportPage`
```typescript
// prescription_completed 핸들러
if (type === 'prescription_completed') {
  console.log('💊 [처방전 완료] 토스트 표시');
  
  // 토스트 표시
  actions.addNotification({
    type: 'success',
    title: '처방전 수집 완료',
    message: `처방전 데이터 ${data?.count || 0}건이 추가되었습니다.`
  });
  
  return;
}
```

**ResultsTrendPage에서도 동일하게 처리** (WebSocket 연결 유지)

---

### Phase 3: 비밀번호 모달 타이밍 (진입 경로별 분기)

**핵심**: 진입 경로에 따라 비밀번호 타이밍이 달라야 함!

#### Case 1: 추이보기 (일반 Tilko) - 현재 로직 유지
```
건강검진 완료 → 처방전 수집
  ↓
처방전 완료 → "completed"
  ↓
비밀번호 모달 ← 여기!
  ↓
추이보기 페이지
```

#### Case 2: 질병예측리포트 (캠페인/매트릭스) - 변경 필요!
```
건강검진 완료 → Mediarc 생성 시작
  ↓
Mediarc 완료 → "mediarc_completed"
  ↓
비밀번호 모달 ← 여기!
  ↓
리포트 페이지
```

**구분 방법**: 
- URL 파라미터 `redirect` 또는 세션 데이터로 판단
- `redirect=/disease-report` → 질병예측리포트 케이스
- 없음 → 추이보기 케이스

**구현**:

```python
# tilko_auth.py: Mediarc 완료 시
async def on_mediarc_completed(patient_uuid, hospital_id, session_id):
    """Mediarc 생성 완료 콜백"""
    
    # 세션에서 redirect 정보 확인
    session_data = session_manager.get(session_id)
    redirect_path = session_data.get("redirect") or session_data.get("return_to")
    
    # 질병예측리포트 케이스: 비밀번호 모달 트리거
    if redirect_path and 'disease-report' in redirect_path:
        await notify_streaming_status(
            session_id,
            "mediarc_completed_password_ready",  # ← 새 이벤트
            "리포트 생성 완료! 비밀번호를 설정해주세요.",
            {
                "patient_uuid": patient_uuid,
                "hospital_id": hospital_id,
                "report_url": report_url
            }
        )
    # 추이보기 케이스: 알림만 (비밀번호는 completed에서)
    else:
        await notify_streaming_status(
            session_id,
            "mediarc_completed",
            "리포트 생성 완료!",
            {"report_url": report_url}
        )
```

```typescript
// AuthForm.tsx: 진입 경로별 비밀번호 모달
onDataCollectionProgress: (type, message, data) => {
  // Case 1: 질병예측리포트 - Mediarc 완료 시 비밀번호
  if (type === 'mediarc_completed_password_ready') {
    console.log('🎨 [Mediarc 완료] 비밀번호 모달 표시');
    setPasswordSetupData({ 
      uuid: data.patient_uuid, 
      hospital: data.hospital_id,
      type: 'setup'
    });
    setShowPasswordSetupModal(true);
    return;
  }
  
  // Case 2: 추이보기 - 처방전 완료 시 비밀번호 (기존)
  if (type === 'completed') {
    console.log('✅ [처방전 완료] 비밀번호 모달 표시');
    // 기존 로직 유지
    setPasswordSetupData({ uuid, hospital, type: 'setup' });
    setShowPasswordSetupModal(true);
    return;
  }
}
```

---

## 🔄 최종 플로우 (진입 경로별)

### Case 1: 추이보기 경로 (일반 Tilko)
```
[랜딩 페이지]
약관 동의 → 세션 저장
  ↓
[Tilko] 인증
  ↓
[백엔드] 건강검진 완료
  ├─ Mediarc 시작 (백그라운드, 알림 없음)
  └─ 처방전 수집 시작
       ↓
[백엔드] 처방전 완료
  └─ "completed" 알림
       ↓
[프론트] 비밀번호 모달 ← 여기!
  ↓
[사용자] 비밀번호 설정
  ↓
[프론트] 추이보기 페이지
```

### Case 2: 질병예측리포트 (캠페인/매트릭스) ⭐
```
[AuthForm - /login?redirect=/disease-report]
Tilko 인증
  ↓
건강검진 완료
  ├─ 토스트: "검진 데이터 수집 완료!" ← ✅
  ├─ 스피너 유지 (화면 이동 안함!) ← ✅
  └─ Mediarc 생성 시작
       ↓
     토스트: "질병예측 리포트를 생성하고 있습니다..." ← ✅
       ↓
     Mediarc 완료 (2-3분)
       ├─ 토스트: "리포트 생성 완료!" ← ✅
       └─ 비밀번호 모달 표시 ← ✅
  
동시에:
처방전 수집 (백그라운드, 조용히 진행)
       
[사용자] 비밀번호 설정
  ↓
화면 전환 → /disease-report ← ✅
  ↓
[DiseaseReportPage]
매트릭스 상태 조회
  - REPORT_READY → 리포트 표시 ← ✅
  
처방전 완료 (백그라운드)
  └─ 토스트: "처방전 데이터 {count}건이 추가되었습니다!" ← ✅
```

**핵심 차이**:
- 추이보기: 검진 완료 → **즉시 화면 전환** → 처방전 토스트
- 질병예측리포트: 검진 완료 → **Mediarc 대기** → 비밀번호 → 화면 전환 ⭐

---

## 📊 상태 전환도

```
[랜딩 페이지]
ACTION_REQUIRED (데이터 부족)
  ↓ 
PAYMENT_REQUIRED (결제 필요) ← 랜딩에서 처리
  ↓ [결제 완료]
  ↓
[Tilko 진입] ← 이 시점부터는 결제 완료됨!
  ↓
REPORT_PENDING (리포트 생성 중) ← ✅ 스피너 표시
  ↓ [Mediarc 완료]
  ↓
REPORT_READY (리포트 완료)
  ↓ [7일 경과]
  ↓
REPORT_EXPIRED (리포트 만료)
```

---

## ⚡ 구현 포인트

### 1. 진입 경로 구분 (세션에 저장)
```python
# tilko_auth.py: 세션 시작
@router.post("/start-session")
async def start_auth_session(request: AuthSessionRequest):
    session_id = str(uuid.uuid4())
    
    session_manager.store({
        "session_id": session_id,
        "redirect": request.redirect,  # ← /disease-report 또는 None
        "return_to": request.return_to,
        "terms_agreed": request.terms_agreed
    })
    
    return {"session_id": session_id}
```

### 2. Mediarc 완료 시 진입 경로 체크
```python
# report_service.py: Mediarc 완료 콜백
async def run_disease_report_pipeline(...):
    # Mediarc API 호출
    response = await call_mediarc_api(...)
    
    # DB 저장
    await save_to_db(...)
    
    # ✅ 진입 경로별 알림
    session_data = session_manager.get(session_id)
    redirect_path = session_data.get("redirect")
    
    if redirect_path and 'disease-report' in redirect_path:
        # 질병예측리포트: 비밀번호 모달 트리거
        await notify_streaming_status(
            session_id,
            "mediarc_completed_password_ready",
            "리포트 생성 완료!",
            {"patient_uuid": patient_uuid, "hospital_id": hospital_id}
        )
    else:
        # 추이보기: 조용히 완료
        await notify_streaming_status(
            session_id,
            "mediarc_completed",
            "리포트 생성 완료",
            {}
        )
```

### 3. 프론트 비밀번호 모달 분기
```typescript
// AuthForm.tsx
onDataCollectionProgress: (type, message, data) => {
  // 질병예측리포트: Mediarc 완료 시 비밀번호
  if (type === 'mediarc_completed_password_ready') {
    setPasswordSetupData({ 
      uuid: data.patient_uuid, 
      hospital: data.hospital_id,
      type: 'setup'
    });
    setShowPasswordSetupModal(true);
  }
  
  // 추이보기: 처방전 완료 시 비밀번호 (기존)
  if (type === 'completed') {
    // 기존 로직 유지
    setPasswordSetupData({ uuid, hospital, type: 'setup' });
    setShowPasswordSetupModal(true);
  }
}
```

### 4. 매트릭스는 건들지 않음
```typescript
// DiseaseReportPage.tsx: 매트릭스 그대로 활용
if (unifiedStatus?.status === 'REPORT_PENDING') {
  // 스피너 표시 (기존)
}
if (unifiedStatus?.status === 'REPORT_READY') {
  // 리포트 표시 (기존)
}
```

---

## 🎯 장점

1. **진입 경로별 최적화**: 추이보기 vs 질병예측리포트
2. **기존 매트릭스 활용**: 새로운 UI 불필요
3. **상태 일원화**: 백엔드 통합 상태 API 신뢰
4. **UX 개선**: 
   - 추이보기: 모든 데이터 수집 후 비밀번호
   - 질병예측리포트: 리포트 완료 후 바로 비밀번호 → 리포트 표시
5. **비밀번호 타이밍**: 사용자 목적에 맞춤

---

## ⚠️ 주의사항 및 검증 포인트

### 1. 세션 매니저 커스텀 필드 추가 가능 여부
**검증 완료**: ✅ 가능
- `RedisSessionManager`는 dict 구조로 자유롭게 필드 추가 가능
- `session_data["redirect_path"]`, `session_data["terms_agreed"]` 추가 가능
- Redis TTL 30분 → 충분한 시간

### 2. WebSocket 이벤트 핸들러 확장 가능 여부
**검증 완료**: ✅ 가능
- `useWebSocketAuth.ts`에 새 이벤트 타입 추가 가능
- `mediarc_generating`, `mediarc_completed_password_ready`, `prescription_completed` 추가
- `onDataCollectionProgress` 콜백으로 전달

### 3. 토스트 알림 시스템 활용 가능 여부
**검증 완료**: ✅ 가능
- `WelnoDataContext`의 `addNotification()` 사용
- AuthForm에서 `actions.addNotification()` 호출 가능
- ResultsTrendPage, DiseaseReportPage에서도 사용 가능

### 4. 화면 전환 조건 분기 가능 여부
**검증 완료**: ✅ 가능
- URL 파라미터 `redirect` 확인
- `health_data_completed` 시점에 분기 처리
- Case 1: 즉시 navigate()
- Case 2: 화면 유지 + 스피너

### 5. 처방전 백그라운드 수집 영향
**검증 완료**: ✅ 문제 없음
- 처방전 수집은 이미 독립적인 백그라운드 태스크
- Mediarc 생성과 병렬로 진행 가능
- WebSocket으로 완료 알림 가능

---

## ✅ 실현 가능성 결론

**모두 구현 가능합니다!**

1. **세션에 진입 경로 저장**: ✅
2. **진입 경로별 화면 전환**: ✅
3. **토스트 알림 (5개 시점)**: ✅
4. **Mediarc 완료 후 비밀번호**: ✅
5. **처방전 백그라운드 토스트**: ✅
6. **매트릭스 상태 활용**: ✅ (건들지 않음)

---

## 📊 최종 토스트 타임라인

### Case 1: 추이보기
```
시간축: ─────────────────────────────────→

[AuthForm]
  ↓ 20초
토스트 1: "검진 데이터 수집 완료! 추이보기 화면으로 이동합니다."
화면 전환 → /results-trend

[ResultsTrendPage]
  ↓ 15초
토스트 2: "처방전 데이터 9건이 추가되었습니다!"
```

### Case 2: 질병예측리포트
```
시간축: ─────────────────────────────────→

[AuthForm - 화면 유지]
  ↓ 20초
토스트 1: "검진 데이터 수집 완료!"
토스트 2: "질병예측 리포트를 생성하고 있습니다..."
스피너: "리포트 생성 중..."
  ↓ 120초 (2분)
토스트 3: "리포트 생성 완료!"
비밀번호 모달 표시
  ↓ 10초
비밀번호 설정
화면 전환 → /disease-report

[DiseaseReportPage]
매트릭스: REPORT_READY → 리포트 표시
  ↓ 5초
토스트 4: "처방전 데이터 9건이 추가되었습니다!"
```

---

## 🎯 구현 우선순위

### Phase 1: 백엔드 핵심 수정 (필수)
1. ✅ **UUID 전달**: `tilko_auth.py:1477` (완료)
2. ✅ **Mediarc DB 저장**: `report_service.py:68` (완료)
3. ✅ **재업로드 제거**: `AuthForm.tsx:120` (완료)
4. **약관 세션 저장**: 세션 생성 시 terms_agreed 추가
5. **약관 DB 저장**: UUID 생성 후 저장
6. **진입 경로 분기**: health_data_completed 시 redirect_path 체크
7. **Mediarc 헬퍼 함수**: `_generate_mediarc_with_notification()` 추가
8. **처방전 완료 알림**: `prescription_completed` 이벤트 추가

### Phase 2: 프론트 화면 전환 (필수)
1. **health_data_completed 분기**: 진입 경로별 처리
2. **토스트 5개 추가**: 검진/처방전/Mediarc 시작/완료/실패
3. **Mediarc 이벤트 핸들러**: 3개 추가
4. **에러 처리**: Mediarc 실패 시 메인 이동

### Phase 3: 테스트
1. 추이보기 플로우
2. 질병예측리포트 플로우
3. 토스트 표시 확인
4. DB 데이터 확인
