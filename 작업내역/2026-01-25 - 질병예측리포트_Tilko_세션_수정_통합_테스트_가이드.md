# Tilko 세션 → Mediarc 리포트 자동 생성 통합 테스트

## 📋 테스트 목적

Tilko 인증 후 건강검진 데이터 수집이 완료되면:
1. 백엔드에서 자동으로 Mediarc 리포트 생성 시작
2. `session_id`를 통해 WebSocket으로 완료 알림 전송
3. 프론트엔드에서 자동으로 리포트 표시

---

## ✅ 사전 준비

### 1. 안광수 테스트 데이터 정리

```bash
# ✅ 완료됨 (UUID: 9f323028-a630-4e55-85f6-29bdfdd09894)
```

### 2. 백엔드 재시작 (변경사항 적용)

```bash
cd /home/workspace/PROJECT_WELNO_BEFE/planning-platform/backend
pm2 restart welno-backend
# 또는
pm2 restart all
```

**확인:**
```bash
pm2 logs welno-backend --lines 50
```

### 3. 프론트엔드 재시작

```bash
# 프론트엔드가 자동 리로드되는지 확인
# 또는 수동 재시작
cd /home/workspace/PROJECT_WELNO_BEFE/planning-platform/frontend
npm run start
```

---

## 🧪 테스트 시나리오 1: 신규 사용자 (Tilko → 자동 리포트)

### 1단계: 로그인 페이지 진입

```
http://localhost:9282/login?redirect=/disease-report
```

**확인 사항:**
- 약관 동의 모달 표시
- 3일 유효기간 토스트 정상 동작

---

### 2단계: Tilko 인증 시작

1. 약관 동의 완료
2. "본인 인증 시작" 버튼 클릭
3. Tilko 인증 진행

**백엔드 로그 확인:**
```bash
pm2 logs welno-backend | grep "session_id"
```

**예상 로그:**
```
✅ [Tilko] 세션 생성: session_id=xxxxx
```

---

### 3단계: 건강검진 데이터 수집 완료

**백엔드 로그 (자동 확인):**
```
================================================================================
🔄 [Tilko → Mediarc 자동 트리거] 검증 시작
  - patient_uuid: xxxxx
  - hospital_id: PEERNINE
  - session_id: xxxxx
  - MEDIARC_ENABLED: True
  - health_count: N건
================================================================================

✅ [Tilko → Mediarc] 조건 충족 → 리포트 생성 시작
🚀 [Tilko → Mediarc] 백그라운드 태스크 등록 (session_id=xxxxx)
✅ [Tilko → Mediarc] 백그라운드 태스크 등록 완료
   → WebSocket 알림 예상: ws://.../{session_id}
================================================================================
```

**프론트엔드 로그 (브라우저 콘솔):**
```javascript
📡 [AuthForm → DiseaseReport] session_id 전달: xxxxx
🚀 [비밀번호설정완료] 대상 페이지로 이동: /disease-report?uuid=...&session_id=xxxxx&generate=true
```

---

### 4단계: 리포트 페이지 자동 이동 및 WebSocket 연결

**URL 확인:**
```
http://localhost:9282/disease-report?uuid=xxxxx&hospital=PEERNINE&session_id=xxxxx&generate=true
```

**프론트엔드 로그:**
```javascript
📡 [DiseaseReportPage] 리포트 생성 API 호출 (session_id=xxxxx)
[리포트 조회] 리포트 없음 → Mediarc 생성 요청 시작
[리포트 생성] 백그라운드 생성 시작 → WebSocket 대기
```

**백엔드 로그:**
```
================================================================================
🔄 [Mediarc 수동 생성 요청] 시작
  - uuid: xxxxx
  - hospital_id: PEERNINE
  - session_id: xxxxx
================================================================================

🚀 [Mediarc 수동 생성] 백그라운드 태스크 등록
   → WebSocket 알림 활성화 (session_id=xxxxx)
✅ [Mediarc 수동 생성] 백그라운드 태스크 등록 완료
```

---

### 5단계: Mediarc API 호출 및 완료 알림

**백엔드 로그 (예상 30초~2분 소요):**
```
🔄 [Mediarc Pipeline] 리포트 생성 시작
   - patient_uuid: xxxxx
   - session_id: xxxxx
   
... (Mediarc API 호출 중) ...

✅ [Mediarc Pipeline] 리포트 생성 완료
📢 [Pipeline] WebSocket 알림 전송 완료 (session=xxxxx)
```

**프론트엔드 로그 (WebSocket 수신):**
```javascript
📨 [DiseaseReportPage WebSocket] 이벤트: mediarc_report_completed, sessionId=xxxxx
🎉 [DiseaseReportPage] Mediarc 완료 → 리포트 재조회
[리포트 조회] 응답: Object { ... }
```

---

### 6단계: 리포트 자동 표시

**확인 사항:**
- ✅ 스피너 자동 종료
- ✅ 리포트 데이터 표시 (체나이, 질병 예측, 암 예측)
- ✅ 반짝임 효과 (ageCardGlow)
- ✅ 페이지 새로고침 없이 자동 갱신

---

## 🧪 테스트 시나리오 2: 기존 사용자 (수동 리포트 생성)

### 1단계: 메인 페이지에서 질병예측 리포트 클릭

```
http://localhost:9282
→ "질병예측 리포트" 버튼 클릭
```

**확인 사항:**
- 데이터가 충분하면 바로 `/disease-report`로 이동
- `session_id` 없음 (URL에 포함 안됨)

---

### 2단계: 리포트 생성 API 호출

**프론트엔드 로그:**
```javascript
📡 [DiseaseReportPage] 리포트 생성 API 호출 (session_id=없음)
[리포트 생성] 백그라운드 생성 시작 → 폴링 대기 (session_id 없음)
```

**백엔드 로그:**
```
================================================================================
🔄 [Mediarc 수동 생성 요청] 시작
  - uuid: xxxxx
  - hospital_id: PEERNINE
  - session_id: 없음 (WebSocket 알림 skip)
================================================================================

🚀 [Mediarc 수동 생성] 백그라운드 태스크 등록
   → WebSocket 알림 비활성화 (폴링으로 확인 필요)
```

---

### 3단계: 폴링으로 리포트 확인

**프론트엔드:**
- 5초마다 `/api/v1/welno/user-status` 폴링
- 또는 수동 새로고침으로 확인

**확인 사항:**
- ❌ WebSocket 알림 없음 (정상)
- ✅ 폴링 또는 새로고침 시 리포트 표시

---

## 🔍 검증 포인트

### 백엔드

| 항목 | 확인 방법 | 예상 결과 |
|-----|---------|----------|
| Tilko 자동 트리거 | `pm2 logs \| grep "Tilko → Mediarc"` | `session_id` 전달 확인 |
| 수동 생성 API | `pm2 logs \| grep "Mediarc 수동 생성"` | `session_id` Optional 동작 |
| WebSocket 알림 | `pm2 logs \| grep "WebSocket 알림"` | `session_id` 있으면 전송 |

### 프론트엔드

| 항목 | 확인 방법 | 예상 결과 |
|-----|---------|----------|
| AuthForm session_id 전달 | 브라우저 콘솔 → `session_id 전달` | URL에 `session_id=xxx` 포함 |
| DiseaseReportPage WebSocket | 브라우저 콘솔 → `WebSocket 이벤트` | `mediarc_report_completed` 수신 |
| 자동 리포트 표시 | 화면 확인 | 새로고침 없이 자동 갱신 |

---

## ❌ 예상 오류 및 해결

### 1. `session_id`가 URL에 없음

**원인:**
- AuthForm에서 `authFlow.state.sessionId`가 `null`
- Tilko 인증 시작 전 페이지 이동

**해결:**
```javascript
// AuthForm.tsx 확인
console.log('sessionId:', authFlow.state.sessionId);
```

---

### 2. WebSocket 연결 실패

**원인:**
- `session_id`가 Redis에서 만료됨 (30분 TTL)
- 백엔드 WebSocket 서버 미실행

**해결:**
```bash
# 백엔드 로그 확인
pm2 logs welno-backend | grep "WebSocket"

# Redis 세션 확인
redis-cli -h 10.0.1.10 -p 6379
> KEYS tilko_session:*
```

---

### 3. 리포트 생성 무한 대기

**원인:**
- Mediarc API 호출 실패
- `MEDIARC_ENABLED=False`

**해결:**
```python
# settings.py 확인
MEDIARC_ENABLED = True
```

---

## 📊 성공 기준

- ✅ Tilko 인증 후 자동으로 리포트 생성 시작
- ✅ `session_id` 파라미터가 백엔드/프론트엔드 간 전달
- ✅ WebSocket으로 `mediarc_report_completed` 이벤트 수신
- ✅ 페이지 새로고침 없이 리포트 자동 표시
- ✅ 수동 생성 시 폴링으로 대체 (session_id 없음)

---

## 🎯 다음 단계 (선택)

Phase 4: 파트너 케이스 개선
- 파트너 결제 완료 시 session_id 생성
- 또는 폴링 유지 (현재 동작)

**권장:** 일단 Tilko 케이스만 완료하고, 파트너는 폴링 유지
